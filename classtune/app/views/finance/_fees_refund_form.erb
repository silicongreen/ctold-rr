<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<div id="refund">
<% unless flash[:notice].nil? %>
  <div id="errorExplanation" class="errorExplanation"><p><%= t('there_were_pblm') %></p><ul><li><%= flash[:notice] %></li></ul></div>
<% end %>

<% unless flash[:warning].nil? %><p class="flash-msg"><%= flash[:warning] %></p><% end %>
<div class="fee_structure">
    <h2 style="font-size: 20px;"><%= @fee_category.name %> (<%= @fee_collection.name %>)</h2>
    <hr style="border-top: 1px solid #ccc;" />
    <div class="extender"></div>
</div>
<br />

<div class="height-fixer"> </div>
<div class="extender"></div>
<% total_fees =0 %>
<% form_remote_for :fees, :id=> 'fees_form', :url => {:action => 'fees_refund_student', :id => @student.id,:date => @date.id, :fine=>@fine},:html => {:id => "fees_form"},:before=>"prev_double()",:complete=>"set_back()" do |form| %>

  <% unless @fee_particulars.nil? %>
    <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
      <thead><!-- class="thead-inverse" -->
        <tr>
          <th style="font-weight: normal; width: 8%;"><%= t('sl_no') %> </th>
          <th style="font-weight: normal; width: 72%; text-align: left;"><%= t('particulars') %></th>
          <th style="font-weight: normal; width: 20%; text-align: right;"><%= t('amount') %> (<%= currency %>  )</th>
        </tr>
      </thead>
      <tbody>
      <% i = 0 %>
      <% @fee_particulars.each do |fee| %>
        <tr class="<%= cycle("odd","even") %>">
          <td class="col-1"><%= i +=1 %></td>
          <td class="col-2"><%= fee.name %></td>
          <td class="col-6" style="text-align: right;"><%=precision_label(fee.amount)%></td>
        </tr>
        <% total_fees += fee.amount %>
      <% end %>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_amount') %> </td>
        <td class="col-6" style="text-align: right;">
          <%= precision_label(total_fees) %>
        </td>
      </tr>   

      <% unless @total_discount == 0 %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
          <% @onetime_discounts.each do |d| %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1"><%= i+1 %></td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;">
                <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
                  <%= precision_label(@onetime_discounts_amount[d.id]) %>
                <% else %>
                <%= precision_label(@total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100)) %>
                <% end %>
              </td>
            </tr>
            <% i += 1 %>
          <% end %>
        <% end %>  
        <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
          <% @discounts.each do |d| %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1"><%= i+1 %></td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;">
                <% unless @discounts_amount[d.id].nil? or @discounts_amount[d.id].blank? %>  
                  <%= precision_label(@discounts_amount[d.id]) %>
                <% else %>
                <%= precision_label(@total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100)) %>
                <% end %>
              </td>
            </tr>
            <% i += 1 %>
          <% end %>
        <% end %>

        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>

        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_discount') %> </td>
          <td class="col-6" style="text-align: right;">
            <%= precision_label(@total_discount) %>
          </td>
        </tr>

        <% total_fees = (@total_payable-@total_discount)%>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_fees') %> </td>
          <td class="col-6"  style="text-align: right;">
            <%= precision_label(total_fees) %>
          </td>
        </tr>


      <% end %>

      <% unless @paid_fees.nil? or @paid_fees.empty? or @paid_fees.blank? %>
        <% unless @paid_fees.blank? %>
          <% @paid_fees.each do |trans| %>
            <% if trans.fine_included and trans.fine_amount.to_f > 0.00 %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1"><%= i+=1 %></td>
                <td class="col-2"><span class="themed_text"><%= t('fine_on') %> <%= trans.transaction_date %></span></td>
                <td class="col-6"  style="text-align: right;">
                  <%= precision_label(trans.fine_amount) %>
                </td>
              </tr>
              <% total_fees += trans.fine_amount.to_f %>
            <% end %>
            
            <% if trans.vat_included and trans.vat_included.to_f > 0.00 %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1"><%= i+=1 %></td>
                <td class="col-2"><span class="themed_text"><%= "Vat" %></span></td>
                <td class="col-6"  style="text-align: right;">
                  <%= precision_label(trans.vat_amount) %>
                </td>
              </tr>
              <% total_fees += trans.vat_amount.to_f %>
            <% end %>
              
          <% end %>
        <% end %>
      <% end %>

      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('amount_paid') %> </td>
        <td class="col-6"  style="text-align: right;">
          <%= precision_label(total_fees) %>
        </td>
      </tr>

     
        <% unless @refund_rule.nil? %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
            <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('refund_percentage') %> </td>
            <td class="col-6" style="text-align: right;"><%=precision_label(@refund_rule.refund_percentage).to_s + "%" %></td>
        </tr>
        <%end%>
        <%balance=@financefee.balance.to_f+@fine.to_f%>
        <%unless @fee_refund or @financefee.fee_refund%>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('amount_to_refund') %></td>
          <td class="col-6" style="text-align: right;"><%= precision_label(@refund_amount) %></td>
          <%=  hidden_field_tag 'fees[amount]', @refund_amount %>
        </tr>

     
        <tr>
          <td colspan="3">
            <div class="payment_details">
              <%if @refund_rule.nil?%>
                <h4 style="margin-top:45px;"><%= t('no_refund_exists') %></h4>
              <%else%>
                  <div class="payment_details" style="width: 100%;">
                    <div style="width: 59%; float: left; border-right: 1px solid #ccc;">
                      <div class="label-field-pair" style="width: 99%;">
                        <div class="label-container"><%= t('description') %> </div>
                        <div class="input-container"><%= form.text_area :reason,:cols => 50, :rows => 1 %></div>
                      </div>
                    </div>
                    <div style="width: 38%; float: left; padding-left: 2%;">
                      <%= submit_tag "► #{t('refund')}",:class=>'submit_button', :id => 'submit_button' , :disable_with => "► #{t('please_wait')}",:data_disable_with=>"► #{t('please_wait')}" %>
                    </div>      
                    <div style="clear: both; height: 1px;"></div>  
                  </div>
              <%end%>
            </div>
          </td>
        </tr>
      
       <%else%>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('amount_refunded') %></td>
          <td class="col-6" style="text-align: right;"><%=precision_label(@fee_refund.amount.to_f) %></td>
        </tr>

      <tr>
        <td colspan="3">
          <div class="pay_fees">
            <div id="payment_mode"></div>


              <div class="pay_fees_buttons">
                <h4><%= t('amount_refunded') %></h4>
              </div>

          </div>
        </td>
      </tr>
        <%end%>

    <%end%>
    </tbody>
  </table>
<% end %>
</div>
<script type="text/javascript">
  j('.submit_button').click( function(){
    j('.submit_button').attr('value',j('.submit_button').attr('data_disable_with'));
  });
</script>
