<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>


<div id="content-header">
<%= show_header_icon %>
  <h1><%= t('online_payment') %></h1>
<div class='header-sep'>|</div>
<div class='sub-header'><%= t('transactions') %></div>
<div id="inner-tab-menu">
  <ul>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "Settings", settings_online_payments_path %></li>
  </ul>
</div>
</div>
<div id="page-yield">
  <div id="flash-box">
    <% unless flash[:notice].nil? %>
      <p class="flash-msg"> <%= flash[:notice] %> </p>
    <% end %>
  </div>
  <% form_for :payment_transaction,:url => transactions_online_payments_url do %>
    <div class="label-field-pair">
      <label for="start_date"><%= t('start_date') %></label>
      <div class="text-input-bg"><%= calendar_date_select_tag 'start_date', params[:start_date].present? ? params[:start_date] : I18n.l(Date.today,:format=>:default),:readonly=>true,:popup=>"force" %></div>
    </div>
    <div class="label-field-pair">
      <label for="start_date"><%= t('end_date') %></label>
      <div class="text-input-bg"><%= calendar_date_select_tag 'end_date', params[:end_date].present? ? params[:end_date] : I18n.l(Date.today,:format=>:default),:readonly=>true,:popup=>"force" %></div>
    </div>
    <%= submit_tag 'Search',:name => "search",:class => "submit-button" %>
  <% end %>
  <% unless @online_payments.empty? %>
    <div class="box">
      <table id ="listing" align="center" width="100%" cellpadding="1" cellspacing="1">
        <tr class="tr-head">
          <td class="sl_no"><%= t('serial_no') %></td>
          <td class="gateway_name"><%= t("gateway_name") %></td>
          <td class="payee_name"><%= t("payee_name") %></td>
          <td class="fee_name"><%= t("fee_name") %></td>
          <td class="amount"><%= t("amount") %></td>
          <td class="gateway_status"><%= t("gateway_status") %></td>
          <td class="online_transaction_id"><%= t("online_transaction_id") %></td>
          <td class="transaction_date"><%= t("transaction_date") %></td>
        </tr>
        <% @online_payments.each_with_index do |payment,index| %>
          <tr class="tr-<%= cycle('odd', 'even') %>">
            <td class="sl_no"><%= ((@online_payments.current_page - 1) * @online_payments.per_page) + index + 1 %></td>
            <td class="gateway_name">
              <% gateway_name = (payment.gateway_response.keys.include? :x_trans_id) ? "Authorize.net" : "Paypal" %>
              <%= gateway_name %>
            </td>
            <% payee_user = payment.payee.try(:user).try(:username) unless payment.payee.class.name == "Applicant" %>
            <td class="payee_name"><%= "#{payment.payee_name}(#{payment.payee_user})" %></td>
            <% payment_type = String.new
            if payment.payment_type == "FinanceFee"
              payment_type = payment.finance_transaction.try(:finance).try(:finance_fee_collection).try(:name)
            elsif payment.payment_type == "HostelFee"
              payment_type = payment.finance_transaction.try(:finance).try(:hostel_fee_collection).try(:name)
            elsif payment.payment_type == "TransportFee"
              payment_type = payment.finance_transaction.try(:finance).try(:transport_fee_collection).try(:name)
            else
              payment_type = "Application"
            end
          %>
            <td class="fee_name"><%= payment_type %></td>
            <% amount = payment.gateway_response[:amount]
            amount ||= payment.gateway_response[:x_amount]%>

            <td class="amount"><%= amount %></td>
            <td class="gateway_status">
              <% gateway_status = "Failed"
              if gateway_name == "Paypal"
                gateway_status = "Completed" if payment.gateway_response[:status] == "Completed"
              elsif gateway_name == "Authorize.net"
                gateway_status = "Completed" if payment.gateway_response[:x_response_reason_code] == "1"
              end %>
              <%= gateway_status %>
            </td>
            <td class="online_transaction_id">
              <% transaction_id = nil
              if gateway_name == "Paypal"
                transaction_id = payment.gateway_response[:transaction_id]
              elsif gateway_name == "Authorize.net"
                transaction_id = payment.gateway_response[:x_trans_id]
              end %>
              <%= transaction_id %>
            </td>
            <td class="transaction_date">
              <%= I18n.l(payment.created_at,:format=>"%d %b %Y") %>
            </td>
          </tr>
        <% end %>
      </table>
      <%= will_paginate @online_payments,:params=>{:start_date => params[:start_date],:end_date => params[:end_date]} %>
    </div>
  <% else %>
    <div id="flash-box">
      <p class="flash-msg"  style="float: left;margin-top: 50px;width: 100%;">No Payments present</p>
    </div>
  <% end %>

</div>
