<% c = 'even' %>
 <div id="page-yield"  class="available_sections sjws subject-result-landscape"> 
<div class="container_body">
    <div id="grouped_exam_report">        
        <table id="pdf-table" class="sjws_table_intro sjws_table_head" width="100%" cellspacing="0">
            <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">                          
                <% total_mark = 0 %>
                <% full_mark = 0 %>
                <% month_number =@connect_exam_obj.published_date.blank? ? @connect_exam_obj.created_at.strftime("%-m"):@connect_exam_obj.published_date.strftime("%-m") %>
                <td class="col-pdf" colspan="2" class="sub_exam">
                    <span class="td-align-left"><%= subjects['name'] %></span>
                    <span class="td-align-right">

                      <%= @connect_exam_obj.name %>&nbsp;
                      <% if month_number.to_i>6 %>
                        <%= @connect_exam_obj.published_date.blank? ? @connect_exam_obj.created_at.strftime("%Y"):@connect_exam_obj.published_date.strftime("%Y") %>-<%= @connect_exam_obj.published_date.blank? ? @connect_exam_obj.created_at.strftime("%Y").to_i+1:@connect_exam_obj.published_date.strftime("%Y").to_i+1 %>        
                      <% else %>
                        <%= @connect_exam_obj.published_date.blank? ? @connect_exam_obj.created_at.strftime("%Y").to_i-1:@connect_exam_obj.published_date.strftime("%Y").to_i-1 %>-<%= @connect_exam_obj.published_date.blank? ? @connect_exam_obj.created_at.strftime("%Y"):@connect_exam_obj.published_date.strftime("%Y") %>
                      <% end %>  
                    </span>
                </td>
                <td class="col-pdf rotate" rowspan="2"><div><span>Below Requirement</span></div></td>
                <td class="col-pdf rotate" rowspan="2"><div><span>With help</span></div></td>
                <td class="col-pdf rotate" rowspan="2"><div><span>Without help</span></div></td>
                <td class="col-pdf rotate" rowspan="2"><div><span>High level</span></div></td>
            </tr>     
            <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>"> 
                <td class="col-pdf" colspan="2">
                    <h4>NAME : <%= @student.full_name %></h4>
                    <h4>Class : <%= @batch.course.course_name %>&nbsp;Class : <%= @batch.course.course_name %> </h4>
                </td>
            </tr> 
            <% subject_groups = get_subject_group(subjects['id']) %>          
            <% ilooop = 0 %>  <% @group_loop = 0 %> <% all_total_mark = 0 %><% all_full_mark = 0 %>                   
            <% subject_groups.each do |group_name| %>
              <% groupCount = 1 %>
              <% subject_subgroup = get_subject_sub_group(group_name.id) %>

              <% if subject_subgroup %>
                <% groupCount = subject_subgroup.count %>
                <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                    <td class="text_left" rowspan="<%=groupCount.to_i %>" colspan="1"><%= group_name.name.to_s %><%=groupCount.to_i %></td>  
                    <% isublooop = 0 %>
                    <% subject_subgroup.each do |sub_group_name| %>
                      <% if isublooop > 0 %>
                    <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                      <% end %>
                      <td class="text_left" colspan="1"> 
                          <%= sub_group_name %>
                      </td>
                      <% unless @report_data['report']['exams'].blank? %>  
                        <% total_mark = 0 %><% full_mark = 5 %><% avg_counter = 0 %>
                        <% @report_data['report']['exams'].each do |report| %>                              
                          <% if report['exam_category'].to_i == 4 %>                          
                            <% unless report['result'][report['exam_id']][subjects['id']]['remarks'].blank?  %>
                              <% wordString = report['result'][report['exam_id']][subjects['id']]['remarks'] %>
                              <% wordString_split = wordString.split("|") %>
                              <% exam_group_remarks = "" %>
                              <% unless wordString_split[isublooop.to_i].blank? %>
                                <% exam_group_remarks = wordString_split[@group_loop.to_i] %>
                                <% total_mark = total_mark + exam_group_remarks.to_i %>
                                <% avg_counter = avg_counter +1 %>
                      
                                <% all_total_mark = all_total_mark + exam_group_remarks.to_i %>
                                <% all_full_mark = all_full_mark + 5 %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>

                      <% total_avg = total_mark.to_f/avg_counter.to_i %>                                                          
                      <% mark_percentage = (total_avg.to_f/full_mark.to_f)*100 %>  
                      <% if mark_percentage.to_f < 50 %>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 50 && mark_percentage.to_f < 70 %>                          
                        <td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 70 && mark_percentage.to_f < 85 %> 
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 85 %>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                      <% else %>
                        
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% end %>  
                      <% @group_loop = @group_loop+1 %>
                    </tr>
                    <% isublooop = isublooop+1 %>   
                <% end %>
              <% else %>
                <% total_mark = 0 %><% full_mark = 5 %><% avg_counter = 0 %>
                
                <% @report_data['report']['exams'].each do |report| %>     
                  <% if report['exam_category'].to_i == 4 %>
                    <% unless report['result'][report['exam_id']][subjects['id']]['remarks'].nil?  %>
                      <% wordString = report['result'][report['exam_id']][subjects['id']]['remarks'] %>
                      <% wordString_split = wordString.split("|") %>
                      <% exam_group_remarks = "" %>
                      <% unless wordString_split[ilooop.to_i].blank? %>
                        <% exam_group_remarks = wordString_split[@group_loop.to_i] %>
                        <% total_mark = total_mark + exam_group_remarks.to_i %>
                        <% avg_counter = avg_counter +1 %>
                    
                        <% all_total_mark = all_total_mark + exam_group_remarks.to_i %>
                        <% all_full_mark = all_full_mark + 5 %>
                      <% end %>                                                            
                    <% end %>

                  <% end %>  
                <% end %>  
                <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                    <td colspan="2" class="text_left"><%= group_name.name.to_s %></td> 

                    <% total_avg = total_mark.to_f/avg_counter.to_i %>                                                          
                    <% mark_percentage = (total_avg.to_f/full_mark.to_f)*100 %>  

                      <% if mark_percentage.to_f < 50 %>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 50 && mark_percentage.to_f < 70 %>                          
                        <td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 70 && mark_percentage.to_f < 85 %> 
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                        <td class="col-pdf text_center">&nbsp;</td>
                      <% elsif  mark_percentage.to_f >= 85 %>
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                        <td class="col-pdf text_center">
                            *
                        </td>
                      <% else %>
                        
                        <td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td><td class="col-pdf text_center">&nbsp;</td>
                      <% end %> 

                </tr>  
              <% end %>
               
              <% @group_loop = @group_loop+1 %>
              <% ilooop = ilooop+1 %>   
            <% end %>
            <%
              exam_comment = "<br/>"
              exam_effort = ""
              @exam_comments = ExamConnectSubjectComment.find(:first, :conditions => {:exam_connect_id=>@connect_exam_obj.id,:subject_id => subjects['id'], :student_id => @student.id} )
              if !@exam_comments.blank?
                exam_comment = @exam_comments['comments']
                exam_effort = @exam_comments['effort']
                end
            %>
            <% if subjects['no_exams_sjws'].to_i == 1 %>
                
                <% all_mark_percentage = (all_total_mark.to_f/all_full_mark.to_f)*100 %>
                <%  grade = GradingLevel.percentage_to_grade(all_mark_percentage, @batch.id) %>
                <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                  <td colspan="2" class="text_left"><b>Accumulation of assessment criteria</b></td>
                <% if !grade.blank? and !grade.name.blank? %>
                  <td colspan="2" class="text_left"><b>Grade:<%= grade.name %></b></td>
                  <td colspan="2" class="text_left"><b>Effort: <%= exam_effort %></b></td>
                <% else %>
                  <td class="col-2"><b>N/A</b></td>
                  <td colspan="2" class="text_left"><b>Effort: <%= exam_effort %></b></td> 
                <% end %>                              		  
                </tr>
            <% else %>               
            
              <% unless @report_data['report']['exams'].blank? %>  
                <% written_total_mark = 0 %><% written_full_mark = 0 %>
                <% @report_data['report']['exams'].each do |report| %>                              
                  <% if report['exam_category'].to_i != 4 %>                          
                    <% if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][subjects['id']].blank?  and !report['result'][report['exam_id']][subjects['id']]['marks_obtained'].blank? %>
                      <% written_total_mark = written_total_mark.to_f+report['result'][report['exam_id']][subjects['id']]['marks_obtained'].to_f %>
                    <% end %>
                    <% if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][subjects['id']].blank?  and !report['result'][report['exam_id']][subjects['id']]['full_mark'].blank? %>
                      <% written_full_mark = written_full_mark+report['result'][report['exam_id']][subjects['id']]['full_mark'].to_i %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
              <% 
                if total_mark.to_f>0 and full_mark.to_f>0
                  written_main_mark = (written_total_mark.to_f/written_full_mark.to_f)*100 
                else
                  written_main_mark = 0
                end  
              %>
              <%  grade = GradingLevel.percentage_to_grade(written_main_mark, @batch.id) %>
              
              <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                <td colspan="2" class="text_left"><b>Accumulated grade on written work in class</b></td>
              <% if !grade.blank? and !grade.name.blank? %>
                 <td colspan="2" class="text_left"><b>Grade:<%= grade.name %></b></td>
                 <td colspan="2" class="text_left"><b>Effort: <%= exam_effort %></b></td> 
              <% else %>
                 <td class="col-2"><b>N/A</b></td>
                 <td colspan="2" class="text_left"><b>Effort: <%= exam_effort %></b></td> 
              <% end %>            		  
              </tr>    
            <% end %>
              
            <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                <td colspan="6" class="text_left"><b>COMMENTS:</b></td> 		  
            </tr>
            <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                <td colspan="6" rowspan="6" class="text_left"><%=exam_comment%></td> 		  
            </tr>
        </table>
        <p>&nbsp;</p>
        <table class='sjws_table_head' width="100%" >                 
            <tr>
                <td class="col-pdf">TEACHER'S SIGNATURE: .................................... </td>                          
                <td class="col-pdf">DATE: <%=Time.now.strftime("%d-%m-%Y")%> </td>                          
            </tr> 
        </table>
    </div>
</div>

</div>

<style>
    td.sub_exam .td-align-right
    {
        float: right !important;
        width: 49% !important;
        text-align: right !important;
        border:1px solid black;
    }
    td.sub_exam .td-align-left
    {
        float: left !important;
        width: 49% !important;
        text-align: left !important;
        border:1px solid black;
    }

</style>    