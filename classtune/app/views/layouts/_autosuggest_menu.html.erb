<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<script type="text/javascript">
  jq=jQuery.noConflict();
  function __highlight(s, t) {
    var matcher = new RegExp("("+jq.ui.autocomplete.escapeRegex(t)+")", "ig" );
    return s.replace(matcher, "<strong>$1</strong>");
  }

  jq.ui.autocomplete.prototype._renderItem = function (ul, item) {
    //  item.label = item.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + jQuery.ui.autocomplete.escapeRegex(this.term) + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<strong>$1</strong>");
    if (item.menutype == 'action')    {
      return jq("<li></li>")
      .data("item.autocomplete",item)
      .append("<a class='action'>"+ item.label +"</a>")
      .appendTo(ul);
    }
    item.label = __highlight(item.label, this.term)
    return jq("<li></li>")
    .data("item.autocomplete", item)
    .append("<a>" + item.label + "</a>")
    .appendTo(ul);
  };
  
  /** Turn of shortcut key q for search **/
  /*jq(document).bind('keypress', 'q', function(){jq("input#autosuggest_menu_input").focus();return false;});*/
  gotoLink = function(event,ui){
    window.location.href = ui.item.value;
    return false;
  };
  searchoptions = function (request,response){
    var query=request.term;
    var available_options = <%= autosuggest_menuitems %>;
    var options = jq.ui.autocomplete.filter(available_options,query).slice(0,11);
    options.push({'menutype': 'action',
      'label' : '<%=t('autosuggest_menu.search_students')%> : <strong>'+query+'</strong>',
      'value' : "/student/advanced_search?search%5Border%5D=&search%5Bfirst_name_or_middle_name_or_last_name_like%5D="+query+"&search%5Badmission_no_equals%5D=&advv_search%5Bcourse_id%5D=&search%5Bbatch_id_equals%5D=&search%5Bstudent_category_id_equals%5D=&search%5Bgender_equals%5D=&search%5Bblood_group_like%5D=&search%5Bnationality_id_equals%5D=&advv_search%5Bdoa_option%5D=&advv_search%5Bdoa_year%5D=&advv_search%5Bdob_option%5D=&advv_search%5Bdob_year%5D=&commit=Search"})

    options.push({'menutype': 'action',
      'label' : '<%=t('autosuggest_menu.search_employees')%>: <strong>'+query+'</strong>',
      'value' : "/employee/advanced_search?search%5Border%5D=&search%5Bfirst_name_or_middle_name_or_last_name_like%5D="+query+"&search%5Bemployee_number_equals%5D=&search%5Bgender_equals%5D=&search%5Bblood_group_like%5D=&search%5Bmarital_status_like%5D=&search%5Bnationality_id_equals%5D=&search%5Bemployee_category_id_equals%5D=&search%5Bemployee_department_id_equals%5D=&search%5Bemployee_position_id_equals%5D=&search%5Bemployee_grade_id_equals%5D=&adv_search%5Bdoj_option%5D=&adv_search%5Bdoj_year%5D=&adv_search%5Bdob_option%5D=&adv_search%5Bdob_year%5D=&search%5Bstatus_equals%5D=true&commit=Search"})

    response(options)
  }


  jq(document).ready(function() {
    jq("input#autosuggest_menu_input").autocomplete({
      source: searchoptions,
      select : gotoLink,
      focus: function(event, ui) { return false; }
    });
    
    jq('body').click(function (event)
    {
      jq("#divResult").html("").hide();
    });  
    
    jq("#s-auto").keyup(function ()
        {
            var loading = '<div class="display_box" align="left" style="float:left; clear:both; width:93%;"><span style="font-size:13px; color:black" class="name">Loading...</div></div>';
            var no_result = '<div class="display_box" align="left" style="float:left; clear:both; width:93%;"><span style="font-size:13px; color:black" class="name">No Result Found</div></div>'
            var inputSearch = jq(this).val();
            var dataString = 'term=' + inputSearch;
            if (inputSearch != '' && inputSearch.length > 2)
            {
                jq("#divResult").html(loading).show();
                jq.ajax({
                    type: "POST",
                    url: "/dashboards/getglobalsearch",
                    data: dataString,
                    cache: false,
                    success: function (html)
                    {

                        if (html)
                        {
                            jq("#divResult").html(html).show();
                        }
                        else
                        {
                            jq("#divResult").html(no_result).show();
                        }
                    }
                });
            }
            else
            {
                jq("#divResult").html("").hide();
            }
            return false;
        });
    
    
  });
</script>

<input class="field" autocomplete="off" name="s" id="s-auto" class='search' placeholder="Global Search" type="search" style="width: 100%; height:30px;">
<div id="divResult"></div>

<style>
  #divResult
    {
        background-color: white;
        border-color: #dedede;
        border-style: solid;
        border-width: 0 1px 1px;
        clear: both;
        display: none;
        margin-top: -1px;
        max-height: 400px;
        overflow-y: auto;
        position: absolute;
        left : 0px;
        top : 31px;
        width: 350px;
        z-index: 1000;
    }
    #divResult span.name
    {
        float: none;
    }
    .display_box
    {
        padding:7px; border-top:solid 1px #dedede; 
        font-size:12px;
    }
    .display_box:hover
    {
        background:#3bb998;
        color:#FFFFFF;
        cursor:pointer;
    }
    #toPopup
    {
        z-index: 999 !important;
    }
    
</style>

