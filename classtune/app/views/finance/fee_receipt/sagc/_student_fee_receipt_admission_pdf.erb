<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<%
copy = []
copy << "Student Copy"
copy << "Teacher Copy"
copy << "Office Copy"
copy << "Bank Copy"

%>
<div class="main-pdf-div-wrapper"> 
    <% @jloop = 0 %>
    <div id="page-yield" class="available_sections">
        <% copy.each do |cp| %>
          <% @jloop = @jloop+1 %>
          <div class="div-24 div_number_<%= @jloop %>" >
              <div class="header-sagc">
                  <div class="header-sagc-left">
                      <div class="logo-left"><%= wicked_pdf_image_tag "/"+("#{Rails.root}/"+ ("public/images/school_logo/352/sagc_logo.png")),:width=> '88%',:style=>" margin-top: 10%;" %></div>
                      <div class="school-name-left">
                          <h4 class="school-heading"><%=Configuration.get_config_value('InstitutionName') %></h4>
                          <strong class="dhaka-cant">Dhaka Cantonment</strong>
                          <strong class="pay-slip">Payment Slip (<%= cp %>)</strong>
                      </div>
                  </div>
              </div>

              <% total_fees = 0 %>    

              <%
              batchsplit = @student.batch.name.split(" ")
              version = ""
              batch = batchsplit[0]
              unless batchsplit[1].blank?
                version = batchsplit[1]
                end
              unless batchsplit[2].blank?
                version = version+" "+batchsplit[2]
                end
              std_category = ""
              unless @student.student_category.blank?
                std_category = @student.student_category.name
                end
            %>
              <%
              trans_data = ""
              trans_id = ""
              trans_type = ""
            %>
              <% unless @paid_fees.blank? %>
                <% payment = Payment.find_by_payment_id(@financefee.id) %>
                <%
                unless payment.nil? or payment.blank?
                  trans_data = I18n.l(payment.transaction_datetime.to_date,:format=>"%d-%m-%Y")
                  #trans_data = I18n.l((payment.created_at.to_time + 6.hours).to_datetime,:format=>"%d-%m-%Y")
                  trans_id = payment.gateway_response[:order_id]
                  if payment.gateway_response[:payment_type] == "MB"
                    trans_type = "TBL Mobile banking"
                    else
                    trans_type = "TBL Card Payment"
                  end
                  else
                  @paid_fees.each do |p|
                    trans_data += I18n.l(p.transaction_date.to_date,:format=>"%d-%m-%Y") + ","
                    trans_id += p.id.to_s + ","
                    trans_type += p.payment_mode.to_s + ","
                    end
                  trans_data = trans_data[0...trans_data.length - 1]
                  trans_id = trans_id[0...trans_id.length - 1]
                  trans_type = trans_type[0...trans_type.length - 1]
                  end
              %>
              <% end %>


              <div class="content-area">
                  <table class="std_info" id="pdf-table" width="100%">
                      <tr class="table-header">
                          <td>ID No: </div>
                          <td><%=  "#{@student.admission_no}" %></td>
                          <td>Category: </td>
                          <td><%=  std_category %></td>
                      </tr>
                      <tr class="table-header">
                          <td colspan="2">Student Name:</div>
                          <td colspan="2"></td>
                      </tr>
                      <tr class="table-header">
                          <td>Class: </div>
                          <td><%= @student.batch.course.course_name %></td>
                          <td>Group: </div>
                          <td><%= @student.batch.course.group %></td>
                      </tr>
                      <tr class="table-header">
                          <td>Section: </div>
                          <td></td>
                          <td>Roll: </div>
                          <td></td>
                      </tr>
                      <tr class="table-header">
                          <td>Version: </div>
                          <td><%= version %></td>
                          <td>Shift: </div>
                          <td><%=  batch %></td>
                      </tr>
                  </table>
                  <table class="std_info_payments" id="pdf-table">
                      <tr class="table-header-main">
                          <td class="desc">Description</td>
                          <td class="amt">Amount</td>
                      </tr>
                      <% k = 0 %>
                      <% total_fees = 0 %>
                      <% @fee_particulars.each do |fee| %>
                        <% unless @paid_fees.blank? %>
                          <% transaction_ids = @paid_fees.map(&:id) %>
                          <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type IN ('Fee Collection', 'Advance') AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                          <% unless paidFess.blank? %>
                            <% amount =  paidFess.map(&:amount).sum  %>
                            <tr class="table-header">
                                <%k+=1%>

                                <td><%= fee.name %></td>
                                <td class="amount"><% if amount.to_i > 0 %><%= "#{precision_label(amount.to_s)}" %><% else %>-<% end %></td>
                            </tr>
                            <% total_fees += amount %>   
                          <% end %>
                        <% else %>
                          <tr class="table-header">
                              <%k+=1%>
                              <td><%= fee.name %></td>
                              <td class="amount"><% if fee.amount.to_i > 0 %><%= "#{precision_label(fee.amount.to_s)}" %><% else %>-<% end %></td>
                          </tr>
                          <% total_fees += fee.amount %>   
                        <% end %>
                      <% end %>    
                      <% total_discount = 0 %>
                      <% unless @total_discount == 0 %>
                        <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
                          <% @onetime_discounts.each do |d| %>
                            <% amount = 0 %>
                            <% already_paid = false %>
                            <% unless @paid_fees.blank? %>
                              <% transaction_ids = @paid_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                              <% already_paid = true %>
                              <% amount =  paidFess.map(&:amount).sum  %>
                            <% else %>  
                              <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
                                <% amount = @onetime_discounts_amount[d.id] %>
                              <% else %>
                                <% amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                              <% end %>
                            <% end %>
                            <% k += 1 %>
                            <% if amount > 0 and already_paid %>
                              <tr class="table-header">

                                  <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                  <td><%= discount_text %></td>
                                  <td class="amount">
                                      <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= precision_label(amount) %>
                                      <% total_discount += amount %>
                                  </td>
                              </tr>
                            <% elsif already_paid == false and amount.to_i > 0 %>
                              <tr class="table-header">

                                  <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                  <td><%= discount_text %></td>
                                  <td class="amount">
                                      <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= precision_label(amount) %>
                                      <% total_discount += amount %>
                                  </td>
                              </tr>
                            <% end %>
                          <% end %>
                        <% end %> 
                        <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
                          <% @discounts.each do |d| %>
                            <% amount = 0 %>
                            <% already_paid = false %>
                            <% unless @paid_fees.blank? %>
                              <% transaction_ids = @paid_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                              <% already_paid = true %>
                              <% amount =  paidFess.map(&:amount).sum  %>
                            <% else %>  
                              <% unless @discounts[d.id].nil? or @discounts[d.id].blank? %>  
                                <% amount = @discounts_amount[d.id] %>
                              <% else %>
                                <% amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                              <% end %>
                            <% end %>
                            <%  k += 1%>
                            <% if amount > 0 and already_paid %>
                              <tr class="table-header">

                                  <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                  <td><%= discount_text %></td>
                                  <td class="amount">
                                      <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= precision_label(amount) %>
                                      <% total_discount += amount %>
                                  </td>
                              </tr>
                            <% elsif already_paid == false and amount.to_i > 0 %>
                              <tr class="table-header">

                                  <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                  <td><%= discount_text %></td>
                                  <td class="amount">
                                      <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= precision_label(amount) %>
                                      <% total_discount += amount %>
                                  </td>
                              </tr>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>      

                      <tr class="table-header">
                          <% vat_amount = 0 %>
                          <% balance=total_fees-total_discount %>
                          <td style="text-align: right;">Total</td>
                          <td class="amount"><%= precision_label balance %></td>
                      </tr>
                  </table>
                  <p style="margin-left:9px; font-size:10px;"><b>(In words): <%= in_words(balance.to_i).split.map(&:capitalize).join(' ') if total_fees.to_i > 0 %></b></p>
                  <p style="margin-left:9px; font-size:10px;"><b>Deposit these fees at Fees Counter within <%= @date.due_date.to_date.strftime("%d-%m-%Y").to_s %>

                          <h3>&nbsp;</h3>
                          <h3>&nbsp;</h3>
                          <table class="signature">
                              <tr>
                                  <td class="width-38">
                                      Authorised Signature<br/>(Account)<br/>Prepared By
                                  </td>
                                  <td class="gap"></td>
                                  <td>Class Teacher<br/>&nbsp;<br/>&nbsp;</td>
                                  <td class="gap"></td>
                                  <td class="width-38">Authorised Signature<br/>(Bank)<br/>Received By</td>
                              </tr>
                          </table>
              </div>
          </div>
        <% end %>
    </div>
</div>
<style>
    table.signature tr td.gap
    {
        border-top:none !important;
        width: 2%;
    }
    table.signature tr td.width-38
    {
        width: 30%;
    }
    table.signature tr td
    {
        border-top: 1px solid black;
        padding: 3px 0px;
        width: 20%;
        text-align: center;
        font-size: 8px;
    }
    #page-yield .div_number_1
    {
        padding-left: 0px !important;
        margin-left: 20px !important;
    }
    #page-yield div.div-24
    {
        width: 22% !important;
        border:none !important;
        margin-left: 20PX;
    }
    #page-yield div.div-33
    {
        float:left;
        width: 32%;
        margin-right: 15px;
        border: 1px solid black;
        min-height: 680px
    } 
    #page-yield div.div-33 .section .general-header
    {
        width: 100%;
    }
    #page-yield div.div-33:last-child
    {
        margin-right: 0px;
    }
    table.vat_area tr td
    {
        font-size: 10px;
    }
    .registration_numer
    {
        font-size: 10px;
    }
    .logo-left-div
    {
        float:left;
        width: 20%;
        margin-left: 1px;
    }
    .school-left-div
    {
        float: left;
        width: 75%;
        margin-left: 3px;
        font-size: 14px;
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .left-clear
    {
        float:left;
        clear:both;
    }
    center.due
    {
        clear:both;
        margin-top: 30px;
        font-size: 12px;
        font-weight: bold;
    }
    center
    {
        clear:both;
        margin-top: 1px;
        font-size: 10px;
    }
    center.small
    {
        font-size: 10px;
        margin-top:10px;
        margin-bottom: -15px;
    }
    table#pdf-table{
        border: none;
        border-bottom: 1px solid #ccc;
        border-collapse:collapse;
        margin-top:10px;
    }
    table.std_info
    {
        width:90%;
    }
    table.signature
    {
        width: 100%;
        margin-top:5px;
    }

    .in-words
    {
        float:left;
        clear:both;
        margin-top: 10px;
        padding: 3px;
        font-size: 10px;
        letter-spacing:normal !important;

    }
    div.no-padding-no-margin
    {
        padding: 0px 5px !important;
        font-size: 10px;
        margin-top: 5px !important;
        margin-bottom: -15px !important;
        font-weight: bold;
    }
    tr.table-header td.align-right
    {
        text-align: right !important;
    }
    tr.table-header td.align-center
    {
        text-align: center;
    }
    .no-warp
    {
        white-space: nowrap;
    }
</style>  

<style>
    tr.table-header td.amount{
        text-align: right;
    }
    .header-sagc{
        width: 100%;
        padding-bottom: 0px;
        margin-left: 10px;
    }
    .sub-header-sagc{
        width: 100%;
        height: 200px;
    }
    .content-area{
        width: 100%;
        margin-top: 20px;
        height: 900px;
    }
    .content-area table{
        width: 100%;
    }
    .content-area table tr.thead, .content-area table tr.tfoot{
        width: 100%;
        background: #A5A5A5;
        height: 40px;
        border: none;
    }
    .content-area table tr.content{
        width: 100%;
        background: #E5E5E5;
        height: 20px;
        border: none;
    }
    .content-area table tr.content td{
        padding: 2px 20px;
    }
    .content-area table tr.content td.amount{
        text-align: right;
    }
    .content-area table tr.thead td{
        height: 20px;
        text-align: center;
    }
    .content-area table tr.thead td.sri{
        width: 5%;
    }
    .content-area table tr.tfoot td{
        height: 20px;
        text-align: left;
        padding: 2px 20px;
    }
    .content-area table tr.tfoot td span{
        float: right;
        font-weight: bold;
        font-size: 10px;
    }
    .content-area table tr.tfoot td h2{
        font-weight: bold;
        font-size: 10px;
    }
    .header-sagc-left{
        width: 100%;
        vertical-align: top;
        display: inline-table;
    }
    .sub-header-sagc-left{
        width: 100%;
        vertical-align: top;
        display: inline-table;
        padding: 4px;
        margin: 0 auto;
    }
    .sub-header-sagc-right{
        width: 39%;
        vertical-align: top;
        display: inline-table;
        padding: 4px;
        margin: 0 auto;
    }
    .sub-header-sagc-left .std-area{
        width: 100%;
        border: 1px solid #ccc;
        display: inline-table;
        background: #E5E5E5;
        padding: 5px;
    }
    .sub-header-sagc-left .std-items{
        width: 50%;
        border-bottom: 1px solid #fff;
        display: inline-table;
        padding-bottom: 6px;
    }
    .sub-header-sagc-left .std-items-full{
        width: 100%;
        border-bottom: 1px solid #fff;
        display: inline-table;
        padding-bottom: 6px;
    }
    .sub-header-sagc-left .std-items .label{
        width: 70%;
        padding-right: 5%;
        display: inline-table;
        text-align: right;
        font-size: 10px;
        font-weight: bold;
    }
    .sub-header-sagc-left .std-items-full .label{
        width: 40%;
        padding-right: 2%;
        display: inline-table;
        text-align: right;
        font-size: 10px;
        font-weight: bold;
    }
    .sub-header-sagc-left .std-items .text{
        width: 24%;
        display: inline-table;
        font-size: 10px;
    }
    .sub-header-sagc-left .std-items-full .text{
        width: 57%;
        display: inline-table;
        font-size: 10px;
    }
    .sub-header-sagc-right .receipt-area{
        width: 100%;
        border: 1px solid #ccc;
        display: inline-table;
        height: 176px;
        border-radius: 8px;
        background: #E5E5E5;
        -webkit-box-shadow: 1px 1px 5px 0px rgba(0,0,0,0.75);
        -moz-box-shadow: 1px 1px 5px 0px rgba(0,0,0,0.75);
        box-shadow: 1px 1px 5px 0px rgba(0,0,0,0.75);
    }
    .sub-header-sagc-right .receipt-area .money_receipt{
        width: 100%;
        border: 1px solid #ccc;
        display: inline-table;
        height: 50px;
        border-radius: 8px;
        background: #A5A5A5;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        padding: 0 auto;
        font-size: 20px;
        font-weight: bold;
        padding: 10px 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    .sub-header-sagc-right .receipt-area .std-items-full{
        width: 100%;
        padding-bottom: 10px;
        display: inline-table;
    }
    .sub-header-sagc-right .receipt-area .std-items-full .label{
        width: 50%;
        padding-right: 2%;
        display: inline-table;
        text-align: right;
        font-size: 10px;
        font-weight: bold;
    }
    .sub-header-sagc-right .receipt-area .std-items-full .text{
        width: 48%;
        display: inline-table;
        font-size: 10px;
    }
    .header-sagc-left .logo-left{
        width: 13%;
        display: inline-block;
    }
    .header-sagc-left .school-name-left{
        width: 87%;
        margin-top: -8px;
        margin-bottom: -8px;
        display: inline-table;
        vertical-align: top;
    }
    .header-sagc-left .school-name-left h2{
        font-size: 16px;
        margin-bottom: 10px;
        margin-top: 5px;
    }
    #page-yield .header-sagc .header-sagc-left .school-name-left span:first-child{
        margin-top: 0px; 
    }
    #page-yield .header-sagc .header-sagc-left .school-name-left span{
        font-size: 15px !important;
        display: block;
        vertical-align: top;
        margin-top: -10px;
    }
    .header-sagc-right span{
        font-size: 15px;
        display: block;
        vertical-align: top;
        padding-bottom: 10px;
    }
    .header-sagc-right{
        width: 19%;
        vertical-align: top;
        display: inline-table;
        text-align: center;
        margin-top: 5px;
    }
    .school-heading{
        font-size:12px;
        text-align: center;
        font-family: serif;
        font-weight: bold;
        margin-bottom: 3px;
    }
    .dhaka-cant{
        text-align: center;
        font-family: sans-serif;
        display: block;
        font-size: 9px;
        margin-bottom: 5px;
    }
    .pay-slip{
        text-align: center;
        font-family: sans-serif;
        display: block;
        font-size: 10px;
    }
    .main-pdf-div-wrapper{
        width:96%;
        margin-left:4%;
    }
    .desc{font-size:10px;}
    .amt{font-size:10px;}
    
    
    .std_info .table-header td{
        border: 1px solid #DADADA !important;
        font-weight: bold;
        background: #fff;
        font-size: 10px;
    }
    .std_info .table-header-main td{
        padding: 5px !important;
        font-weight: bold;
        border-top: 1px solid #ccc !important;
        border-right: 1px solid #ccc !important;
        border-left: 1px solid #ccc !important;
        background: #fff;
        font-size: 10px;
        text-align: center;
    }
    .std_info tr.table-header td.border-left-none
    {
        border-left: none !important;
    }
    .std_info tr.table-header td.border-right-none
    {
        border-right: none !important;
    }
    
    .std_info_payments .table-header td{
        padding: 1px 10px !important;
        border: 1px solid #DADADA !important;
        font-weight: normal;
        background: #fff;
        font-size: 10px;
    }
    .std_info_payments .table-header-main td{
        padding: 5px !important;
        font-weight: bold;
        border: 1px solid #ccc !important;
        background: #fff;
        font-size: 10px;
        text-align: center;
    }
    .std_info_payments tr.table-header td.border-left-none
    {
        border-left: none !important;
    }
    .std_info_payments tr.table-header td.border-right-none
    {
        border-right: none !important;
    }

</style>

