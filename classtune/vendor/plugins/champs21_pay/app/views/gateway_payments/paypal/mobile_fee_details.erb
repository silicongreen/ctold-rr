<!DOCTYPE html>
<html>
    <!-- Latest compiled and minified CSS -->
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Pay Fees</title>
    </head>
    <body>
        <% if @current_user.parent? %>
          <% 
          student_id = @current_user.guardian_entry.current_ward_id                 
        %>
        <% end %>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"> <%= link_to "All Fees", {:controller => 'student',:action=>:fees, :id=>student_id,:mobile_view=>1} %></li>
                <li class="breadcrumb-item active" aria-current="page"><%= @date.name.capitalize  %></li>
            </ol>
        </nav>

        <div class="alert alert-info" role="alert"><%= @student.full_name %></div>

        <% unless flash[:success].nil? %>
          <div class="alert alert-success" role="alert"><%= flash[:success] %></div>
        <% end %>
        <% unless flash[:warning].nil? %>
          <div class="alert alert-danger" role="alert"><%= flash[:warning] %></div>
        <% end %>

        <% unless @fee_particulars.nil? %>



          <% total_fees = 0  %>
          <table class="table table-striped">
              <thead><!-- class="thead-inverse" -->
                  <tr>
                      <th><%= t('sl_no') %> </th>
                      <th><%= t('particulars') %></th>
                      <th><%= t('amount') %> (<%= currency %>  )</th>
                  </tr>
              </thead>
              <% i = 0 %>
              <tbody>
                  <% @fee_particulars.each do |fee| %>
                    <tr>
                        <td><%= i+=1 %></td>
                        <td><%= fee.name %></td>
                        <td>
                            <%= precision_label fee.amount %>
                        </td>
                    </tr>
                    <% total_fees += fee.amount %>
                  <% end %>
                  <tr cellpadding="1" cellspacing="1">
                      <td colspan="2"  style="font-weight: bold;"><%= t('total_amount') %> </td>
                      <td>
                          <%= precision_label(total_fees) %>
                      </td>
                  </tr>  
                  <% unless @total_discount == 0 %>
                    <tr cellpadding="1" cellspacing="1">
                        <td></td>
                        <td colspan="2"><span><%= t('discount') %></span></td>
                    </tr>
                    <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
                      <% @onetime_discounts.each do |d| %>
                        <tr>
                            <td><%= i+1 %></td>
                            <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                            <td><%= discount_text %></td>
                            <td>
                                <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
                                  <%= precision_label(@onetime_discounts_amount[d.id]) %>
                                <% else %>
                                  <%= precision_label(@total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100)) %>
                                <% end %>
                            </td>
                        </tr>
                        <% i += 1 %>
                      <% end %>
                    <% end %>  
                    <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
                      <% @discounts.each do |d| %>
                        <tr>
                            <td><%= i+1 %></td>
                            <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                            <td><%= discount_text %></td>
                            <td>
                                <% unless @discounts_amount[d.id].nil? or @discounts_amount[d.id].blank? %>  
                                  <%= precision_label(@discounts_amount[d.id]) %>
                                <% else %>
                                  <%= precision_label(@total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100)) %>
                                <% end %>
                            </td>
                        </tr>
                        <% i += 1 %>
                      <% end %>
                    <% end %>
                    <tr cellpadding="1" cellspacing="1">
                        <td colspan="2"  style="font-weight: bold;"><%= t('total_discount') %> </td>
                        <td>
                            <%= precision_label(@total_discount) %>
                        </td>
                    </tr>

                    <% total_fees = (@total_payable-@total_discount)%>
                    <tr cellpadding="1" cellspacing="1">
                        <td colspan="2"  style="font-weight: bold;"><%= t('total_fees') %> </td>
                        <td>
                            <%= precision_label(total_fees) %>
                        </td>
                    </tr>

                  <% end %>

                  <% unless @vat.nil? and @paid_fees.blank? %>
                    <% if @vat.to_f > 0.00 %>
                      <tr>
                          <td><%= i+=1 %></td>
                          <td><span><%= "VAT" %></span></td>
                          <td>
                              <%= precision_label(@vat.to_f) %>
                          </td>
                      </tr>
                      <% unless @financefee.is_paid? == true %>
                        <% total_fees += @vat.to_f %>
                      <% else %>
                        <% total_fees = @vat %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <% unless @fine.nil? %>
                    <% if @fine.to_f > 0.00 %>
                      <tr>
                          <td><%= i+=1 %></td>
                          <td><span><%= t('fine_on') %> <%= Date.today %></span></td>
                          <td>
                              <%= precision_label(@fine.to_f) %>
                          </td>
                      </tr>
                      <% unless @financefee.is_paid? == true %>
                        <% total_fees += @fine.to_f %>
                      <% else %>
                        <% total_fees = @fine %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <%total_fees1=total_fees%>
                  <% if @paid_fees%>


                    <% unless @paid_fees.blank? %>
                      <% @paid_fees.each do |trans| %>
                        <% if trans.fine_included %>
                          <%  if @fine_rule and @has_fine_discount %>
                            <tr>
                                <td><%= i+=1 %></td>
                                <td><span><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span></td>
                                <td><%= precision_label(@new_fine_amount) %></td>
                            </tr>
                            <% if @has_fine_discount %>    
                              <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
                                <% @discounts_on_lates.each do |d| %>
                                  <% if @discounts_late_amount[d.id] > 0 %>
                                    <tr>
                                        <td><%= i+1 %></td>
                                        <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                        <td><%= discount_text %></td>
                                        <td>
                                            <%= precision_label(@discounts_late_amount[d.id]) %>
                                        </td>
                                    </tr>
                                  <% end %>
                                  <% i += 1 %>
                                <% end %>
                              <% end %> 
                            <%end%>
                          <%end%>
                          <tr>
                              <td><%= i+=1 %></td>
                              <td><span><%= t('payment_fine') %> </span></td>
                              <td>
                                  <%= precision_label(trans.fine_amount) %>
                              </td>
                          </tr>
                          <% total_fees += trans.fine_amount.to_f %>
                        <% end %>

                        <% if trans.vat_included %>
                          <% if trans.vat_amount.to_f > 0.00 %>
                            <tr>
                                <td><%= i+=1 %></td>
                                <td><span><%= "Vat" %></span></td>
                                <td>
                                    <%= precision_label(trans.vat_amount) %>
                                </td>
                            </tr>
                            <% total_fees += trans.vat_amount.to_f %>
                          <% end %>
                        <% end %>

                      <% end %>
                    <% end %>
                  <% end %>
                  <%unless @financefee.is_paid%>
                    <%if @fine_rule%>
                      <tr>
                          <td><%= i+=1 %></td>
                          <td><span><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span></td>
                          <td><%= precision_label(@new_fine_amount) %></td>
                      </tr>
                    <%end%>
                    <% if @has_fine_discount %>    
                      <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
                        <% @discounts_on_lates.each do |d| %>
                          <% if @discounts_late_amount[d.id] > 0 %>
                            <tr>
                                <td><%= i+1 %></td>
                                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                                <td><%= discount_text %></td>
                                <td>
                                    <%= precision_label(@discounts_late_amount[d.id]) %>
                                </td>
                            </tr>
                          <% end %>
                          <% i += 1 %>
                        <% end %>
                      <% end %> 
                      <tr cellpadding="1" cellspacing="1">
                          <td colspan="2"  style="font-weight: bold;">Fine</td>
                          <td>
                              <%= precision_label(@fine_amount) %>
                          </td>
                      </tr>    
                    <%end%>  
                  <% end %>      
                  <% unless @paid_fees.nil? %>
                    <% paid=0 %>
                    <% @paid_fees.each{|a| paid += a.amount.to_f} %>
                    <% total_fees -= paid %>
                    <tr cellpadding="1" cellspacing="1">
                        <td colspan="2"  style="font-weight: bold;"><%= t('payment_done') %></td>
                        <td>
                            <%= precision_label(paid) %>
                        </td>
                    </tr>
                  <% end %>
                  <%balance=@financefee.balance.to_f+@fine.to_f+@vat.to_f%>
                  <tr cellpadding="1" cellspacing="1">
                      <td colspan="2" style="font-weight: bold;"><%= t('amount_to_pay') %> :</td>
                      <td>
                          <% unless precision_label(balance+@fine_amount.to_f).to_f == 0 %>
                            <%= precision_label(balance+@fine_amount.to_f) %>
                          <% else %>
                            <%= precision_label(0) %>
                          <% end %>
                      </td>
                  </tr>
                  <% if @student_has_due == false %>
                    <%unless @financefee.balance == 0 %> 
                      <% @amount_to_pay = precision_label(balance+@fine_amount.to_f) %>
                      <tr>
                          <td colspan="3">
                              <div class="pay_fees">
                                  <div class="pay_fees_buttons">

                                      <% if @active_gateway == "Paypal" %>
                                        <%= paypal_pay_button(@certificate,@merchant_id,"FEE #{@fee_collection.name}",total_fees,"http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1",@paid_fees,"float: right;margin: 18px 0 0;") %>
                                      <% elsif @active_gateway == "Authorize.net" %>
                                        <%= authorize_net_pay_button(@merchant_id,@certificate,total_fees,"Fee (#{@student.full_name}-#{@student.admission_no}-#{@fee_collection.name})","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1&only_path=false",@paid_fees,"float: right;margin: 18px 0 0;") %>
                                      <% elsif @active_gateway == "ssl.commerce" %>
                                        <%= ssl_commerce_pay_button(@store_id,@store_password,total_fees,"Fee (#{@student.full_name}-#{@student.admission_no}-#{@fee_collection.name})","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_cancel_transaction=1","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_fail_transaction=3",@trans_id_ssl_commerce,@paid_fees,"float: right;margin: 18px 0 0;") %>
                                      <% elsif @active_gateway == "trustbank" %>
                                        <% 
                                        require 'securerandom'
                                        o = [('a'..'z'), (1..9)].map(&:to_a).flatten
                                        string = (0...8).map { o[rand(o.length)] }.join 
                                      %>
                                        <% email = 'sagc.fee@classtune.com' %>
                                        <% unless @student.immediate_contact.nil? or @student.immediate_contact.blank? %>
                                          <% unless @student.immediate_contact.email.blank? %>
                                            <% email = @student.immediate_contact.email %>
                                          <% end %>
                                        <% end %>     
                                        <%= trustbank_pay_button(@merchant_id,total_fees,@student.full_name, email, "http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1", SecureRandom.random_number(1000000)) %>
                                      <% end %>

                                  </div>
                              </div>  
                          </td>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                        <td colspan="3">
                <center><font color="red">***Student Has Previous Due***</font></center> 
            </td>
        </tr>    

      <% end %>   
  </tbody>    
  </table>
<% end %> 
</body>

</html>