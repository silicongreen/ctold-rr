<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<div class="row" style="width:50%">
    <div class="row_label" >
      <div>
        Start date
      </div>
    </div>
    <div class="row_data calender-div">
      <div>
        <%= calendar_date_select_tag "start_date",I18n.l(@date_today,:format=>"%d %b %Y"), :readonly=> true,:onchange => "#{remote_function(
      :url => { :action => 'class_today' },
      :with => "'employee_id="+@employee.id.to_s+"&date_report='+value+'&end_date='+$('end_date').value",
      :before => "Element.show('loader')",
      :success => "Element.hide('loader')"  )}", :popup=>:force, :placeholder => '', :image => '/images/icons/calendar/calendar-icon.png' %>
      </div>
    </div>
  </div>
  <div class="row" style="width:50%">
    <div class="row_label" >
      <div>
        End date
      </div>
    </div>
    <div class="row_data calender-div">
      <div>
        <%= calendar_date_select_tag "end_date",I18n.l(@end_date,:format=>"%d %b %Y"), :readonly=> true,:onchange => "#{remote_function(
      :url => { :action => 'class_today' },
      :with => "'employee_id="+@employee.id.to_s+"&end_date='+value+'&date_report='+$('start_date').value",
      :before => "Element.show('loader')",
      :success => "Element.hide('loader')"  )}", :popup=>:force, :placeholder => '', :image => '/images/icons/calendar/calendar-icon.png' %>
      </div>
    </div>
  </div>
   <div class="loader-image">
        <%= image_tag("loader.gif",
          :align => "absmiddle",
          :border => 0,
          :id => "loader",
          :style =>"display: none;" ) %>
    </div>
<% unless @subjects.blank? %>

<% if @date_to_use == @end_date %>    
  <table width="700" style="margin-top:10px;">
    <tr class="even">
      <td>Class</td>
      <td>Subject</td>
      <td>Start Time</td>
      <td>Attendance Taken</td>
      <td>Assignment</td>
      <td>Classwork</td>
    </tr>  
    <% has_event = @events.find{|val| val.start_date.strftime("%a %d %y") >= @date_to_use.strftime("%a %d %y") and val.end_date.strftime("%a %d %y") <= @date_to_use.strftime("%a %d %y")  }%>
    <% unless has_event.blank? %>
      <tr class="odd">
        <td colspan="100">No Class Today</td>
      </tr>
    <% else %>
      <% @subjects.each do |sub| %>
      <tr class="odd">
        <td><%= sub.batch.full_name %></td>
        <td><%= sub.name %></td>
        <% entry = @entries.find{|val| val.subject_id.to_i == sub.id.to_i }%>
        
        <td><%= entry.class_timing.start_time.strftime("%I:%M %p") unless entry.blank? %></td>
        <% attendance = @attenadnce_register.find{|val| val.subject_id.to_i == sub.id.to_i }%>
        <td><%= "Yes" unless attendance.blank? %></td>
        <% assignment = @assignment_register.find{|val| val.subject_id.to_i == sub.id.to_i }%>
        <td><%= assignment.title  unless assignment.blank? %></td>
        <% classwork = @classwork_register.find{|val| val.subject_id.to_i == sub.id.to_i }%>
        <td><%= classwork.title  unless classwork.blank? %></td>
      </tr>
      <% end %>
    <% end %>


  </table>
  
<% else %>
  <table width="700" style="margin-top:10px;">
    <tr class="even">
      <td>Date</td>
      <td>Class</td>
      <td>Subject</td>
      <td>Start Time</td>
      <td>Attendance Taken</td>
      <td>Assignment</td>
      <td>Classwork</td>
    </tr> 
    <% (@date_to_use..@end_date).each do |date| %> 
      <% weekday_id = date.strftime("%w") %>
      <% sublists = [] %>
      <% has_event = @events.find{|val| date.strftime("%y%m%d") >= val.start_date.strftime("%y%m%d")  and date.strftime("%y%m%d") <= val.end_date.strftime("%y%m%d")   }%>
      <% if has_event.blank? %>
        <% @subjects.each do |sub| %>
        
        <% entry = @entries.find{|val| val.subject_id.to_i == sub.id.to_i and val.weekday_id.to_i == weekday_id.to_i }%>
          <% unless entry.blank? or sublists.include?(sub.id.to_i)%>
          <% sublists << sub.id.to_i %>
            
            <tr class="odd">
              <td><%= date.strftime("%Y-%m-%d")%></td>
              <td><%= sub.batch.full_name %></td>
              <td><%= sub.name %></td>
              
              <td><%= entry.class_timing.start_time.strftime("%I:%M %p") unless entry.blank? %></td>
              <% attendance = @attenadnce_register.find{|val| val.subject_id.to_i == sub.id.to_i and val.attendance_date.strftime("%a %d %y") == date.strftime("%a %d %y")  }%>
              <td><%= "Yes" unless attendance.blank? %></td>
              <% assignment = @assignment_register.find{|val| val.subject_id.to_i == sub.id.to_i and val.created_at.strftime("%a %d %y") == date.strftime("%a %d %y") }%>
              <%= debug sub.id.to_i %>
              <%= debug assignment.inspect %>
              <td><%= assignment.title  unless assignment.blank? %></td>
              <% classwork = @classwork_register.find{|val| val.subject_id.to_i == sub.id.to_i and val.created_at.strftime("%a %d %y") == date.strftime("%a %d %y") }%>
              <td><%= classwork.title  unless classwork.blank? %></td>
            </tr>
          <% end %>
        <% end %>
      <% else %>
        <tr class="odd">
              <td><%= date.strftime("%Y-%m-%d")%></td>
              <td colspan="6">No Class Today</td>
       </tr>
      <% end %>
    <% end %>


  </table>
  <%= link_to "â–º#{t('pdf_report')}", {:controller=>'employee', :action=> 'att_report',:id=>@employee.id,:date_report=> @date_today ,:end_date => @end_date } ,{:target => '_blank',:class=>'user_button' } %>
<% end %>  
<% else %>

<table width="700" style="margin-top:10px;">
  <tr class="even">
    <td>No Class Today</td>
  </tr>

</table>
<% end %>  


<style>
.calender-div img
{
    width: 30px;
    margin-bottom: -10px;
}
.calender-div input
{
    height: 27px;
    width: 200px;
}
</style>