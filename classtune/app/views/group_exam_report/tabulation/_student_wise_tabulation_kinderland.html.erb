<%
if @std_subject_hash.nil?
  std_subject = StudentsSubject.find_all_by_batch_id(@batch.id)
  @std_subject_hash = []
  unless std_subject.blank?
    std_subject.each do |std_sub|
      @std_subject_hash << std_sub.student_id.to_s+"_"+std_sub.subject_id.to_s
    end
  end
  end
@main_student = @students
@students = []
if !@main_student.blank?
  @main_student.each do |student|
    @student = student
    off_rank = false
    exam_score = []
    @exams.each do |exam| 
      exam_score.push exam.exam_scores.find_by_student_id(@student.id) unless exam.exam_scores.find_by_student_id(@student.id).nil?  
      end
    total = 0

    @exams.each do |exam|
      if exam.subject.no_exams or MultiSchool.current_school.id == 7
      next
        end 

      this_exam_score = 0
      unless exam_score.blank?
        exam_score.each do |es|
          if es.exam.subject.id.to_i == exam.subject.id.to_i
            this_exam_score = this_exam_score+1
            if es.grading_level.blank? or es.grading_level.name == "F"
              off_rank = true
            else

              end
            total = total+1
          end  
        end  
        end
      subjectdata = Subject.find(exam.subject.id.to_i)
      has_exam_student = true
      check_std_subject = false
      if @std_subject_hash.include?(student.id.to_s+"_"+exam.subject.id.to_s)
        check_std_subject = true
        end

      if check_std_subject == false and subjectdata.elective_group_id.to_i != 0
        has_exam_student = false 
        end
      if this_exam_score == 0 and has_exam_student == true
        off_rank = true
      end  
      end 
    if total == 0
      off_rank = true
      end  
    if off_rank == false
      @students << student
    end
  end  
  end
@main_student.each do |student|
  unless @students.include?(student)
    @students << student
  end
  end  
%>



<div id="page-yield" class="available_sections1">
    <div class="page1"> </div>
    <div class="section1 row" >
        <center>
            <div id="pdf-header-south" class="general-header">
                <h4 align="center"><%= wicked_pdf_image_tag "/"+("#{Rails.root}/"+ (current_school_detail.logo.path||"public/images/application/c.png")),:width=> '4%' %></h4>
                <h2 align="center"><%=Configuration.get_config_value('InstitutionName'); %></h2>
            </div>
            <h4 align="center">Tabulation Sheet, <%= @exam_group.name %></h4>
            <table width="100%" >
                <thead>
                    <tr>
                        <td><b>Year: <%= @exam_group.exam_date.blank? ? @exam_group.created_at.strftime("%B-%Y"):@exam_group.exam_date.strftime("%B-%Y") %> </b></td>
                        <td align="right"><b>Class : 
                                <% if @batch.name == "General" %>
                                  <%= @batch.course.full_name %>
                                <% else %>
                                  <%= @batch.name %> ,<%= @batch.course.full_name %>
                                <% end %></b>
                        </td>
                    </tr>
                </thead>    
            </table>

            <% if !@students.blank? %>
              <% extender = 0 %>
              <% std_count = 0 %>
              <% c  = 'even' %>
              <% j = 0 %>
              <% rank = 0 %>  
              <% last_mark = 0 %>
              <table id="pdf-table" width="100%" cellspacing="0">
                  <tr class="table-header">
                      <td class="col-pdf">Roll</td>
                      <td class="col-pdf">Name</td>
                      <% total_subject = 0 %>
                      <% @exams.each do |exam|  %>
                        <td><%= exam.subject.code %></td>
                        <% total_subject = total_subject+1 %>
                      <% end %>
                     
                      <td class="col-pdf">Total</td>
                       <td class="col-pdf">Full Mark</td>
                      <td class="col-pdf">Percentage</td>
                      <% if MultiSchool.current_school.id != 246 %>
                        <td class="col-pdf">Position</td>
                      <% end %>
                  </tr>
                  <% colspan_total = total_subject+4 %>
                  <% colspan_fourth = colspan_total.to_f/4 %>
                  <% colspan_fourth_int = colspan_fourth.to_i %>
                  <% last_colspan = colspan_total-(colspan_fourth_int*3) %>

                  <% @students.each do |student| %>
                    <% 
                    @student = student
                    exam_score = []

                    @exams.each do |exam| 
                      exam_score.push exam.exam_scores.find_by_student_id(@student.id) unless exam.exam_scores.find_by_student_id(@student.id).nil?  
                      end

                  %>
                    <% exam_full_mark = 0 %>
                    <% j = j+1 %>
                    <%  std_count = std_count+1; %>
                    <% if std_count>25 && extender ==0 %>
                      <% std_count = 0 %>
                      <% extender = 1 %>

                      <tr class="page-break2">
                          <td colspan="100">&nbsp;</td>
                      </tr> 
                      <tr class="table-header">
                          <td class="col-pdf">Roll</td>
                          <td class="col-pdf">Name</td>

                          <% @exams.each do |exam|  %>
                            <td><%= exam.subject.code %></td>
                          <% end %>
                          <td class="col-pdf">Total</td>
                          <td class="col-pdf">Full Mark</td>
                          <td class="col-pdf">Percentage</td>
                          <% if MultiSchool.current_school.id != 246 %>
                            <td class="col-pdf">Position</td>
                          <% end %>

                      </tr>
                    <% elsif std_count>26 && extender ==1 %>
                      <% std_count = 0 %>
                      <% extender = 1 %>

                      <tr class="page-break1">
                          <td colspan="100">&nbsp;</td>
                      </tr> 
                      <tr class="table-header">
                          <td class="col-pdf">Roll</td>
                          <td class="col-pdf">Name</td>

                          <% @exams.each do |exam|  %>
                            <td><%= exam.subject.code %></td>
                          <% end %>
                          <td class="col-pdf">Total</td>
                          <td class="col-pdf">Full Mark</td>
                          <td class="col-pdf">Percentage</td>
                          <% if MultiSchool.current_school.id != 246 %>
                            <td class="col-pdf">Position</td>
                          <% end %>
                      </tr>
                    <% end %>
                    <tr class="<%= cycle(c,(["odd","even"]-[c]).first) %>">
                        <td class="name-std"><%= student.class_roll_no %></td>
                        <td class="name-std"><%= student.full_name %></td>
                        <% total = 0 %>
                        <% off_rank  = false %>
                        <% @exams.each do |exam|  %>
                          <% this_exam_score = 0 %> 
                          <% unless exam_score.blank? %>
                            
                            <td> 

                                <% exam_score.each do |es| %>

                                  <% if es.exam.subject.id.to_i == exam.subject.id.to_i %> 
                                    <% exam_full_mark = exam_full_mark+exam.maximum_marks %>
                                    <%  this_exam_score = this_exam_score+1%>
                                    <%  if exam.subject.no_exams %>
                                      <%= es.remarks %>
                                    <% else %>
                                      <%= es.marks.present? ? es.marks.to_f: '0' %>


                                      <% if es.marks.present? %>
                                        <% total = total+es.marks.to_f %>
                                      <% end %>


                                      <% if es.grading_level.blank? or es.grading_level.name == "F" %>
                                        <% off_rank = true %>
                                      <% end %>
                                      <% if MultiSchool.current_school.id == 7 %>
                                        <% off_rank = false %>
                                      <% end %>
                                    <% end %> 
                                  <% end %> 

                                <% end %>  

                            </td>
                            <%
                            subjectdata = Subject.find(exam.subject.id.to_i)
                            has_exam_student = true
                            check_std_subject = false
                            if @std_subject_hash.include?(student.id.to_s+"_"+exam.subject.id.to_s)
                              check_std_subject = true
                              end

                            if check_std_subject == false and subjectdata.elective_group_id.to_i != 0
                              has_exam_student = false 
                              end
                          %>
                            <% if has_exam_student == true and this_exam_score == 0 and MultiSchool.current_school.id != 7 %>
                              <% off_rank = true %>
                            <% end %>
                          <% else %>
                            <td class="height-hr"></td>
                          <% end %>


                        <% end %>
                        <% if total == 0 and MultiSchool.current_school.id != 7 %>
                          <% off_rank = true %>
                        <% end %>      
                        <% if total != last_mark && off_rank == false %>
                          <% rank = rank+1 %>
                          <% last_mark = total %>
                        <% end %>    
                        <td class="col-pdf"><%= total %></td>
                        <td class="col-pdf"><%= exam_full_mark %></td>
                        <% percentage = 0 %>

                        <% if total > 0 %>
                          <% percentage = (total.to_f/exam_full_mark.to_f)*100 %>
                        <% end %>
                        <td class="col-pdf"><%= sprintf( "%0.02f", percentage) %></td>

                        <% if off_rank == false %>
                          <td class="name-std"><%= rank %></td>
                        <% else %>
                          <td class="name-std"><%= "-" %></td>
                        <% end %>


                    </tr>

                  <% end %>
                <% end %>
      <style>
          tr td.height-hr
          {
              height: 20px !important;
          }
          .odd{
              font-size: 13px;

          }

          .even{

              height:auto;
              background: #fff;
              font-size: 13px;


          }
          .name-std
          {
              white-space: nowrap !important;
          }
          .even td{

              padding: 5px 5px 5px 8px;
              border: 1px solid #000000;
              border-top: 0px solid #fff;
              text-align: center;

          }

          .odd td{
              padding: 3px;
              border: 1px solid #000000;
              border-top: 0px solid #fff;
              text-align: center;

          }
          .table-header td{
              padding: 3px;
              border: 1px solid #000000;
              color: #000000;
              background: #ffffff;
              font-weight: bold;
              text-align: center;
              font-size: 13px;
          }
      </style>    
