(function(e,t){e.widget("daredevel.tree",{_attachLi:function(n,r,i){var s=r.find("ul:first");if(s.length){if(t==i||s.children("li").length<i){s.append(n)}else{if(i==0){i=i+1}s.children("li:nth-child("+i+")").before(n)}}else{s=e("<ul/>");r.append(s.append(n))}},_attachNode:function(e,n,r){if(t==n){var i=this.element;this._attachLi(e,i,r);this._initializeNode(e)}else{var i=n;this._attachLi(e,i,r);i.removeClass("leaf collapsed").addClass("expanded");this._initializeNode(e);this._initializeNode(i)}},_buildNode:function(t){t=e.extend(true,this.options.defaultNodeAttributes,t);var n=e("<span/>",t.span);var r=e("<li/>",t.li);if(e.inArray("checkbox",this.options.components)>-1){var i=e("<input/>",t.input);r.append(i)}r.append(n);return r},_create:function(){var t=this;this.options.core=this;this.element.addClass("ui-widget ui-widget-content daredevel-tree");if(this.options.checkbox){this._createCheckbox()}if(this.options.collapsible){this._createCollapsible()}if(this.options.dnd){this._createDnd()}if(this.options.selectable){this._createSelectable()}this.element.find("li").each(function(){t._initializeNode(e(this))});if(this.options.nodes!=null){e.each(this.options.nodes,function(e,n){t.options.core.addNode(n)})}},_destroy:function(){e.Widget.prototype.destroy.call(this)},_detachNode:function(e){var t=this.options.core.parentNode(e);var n=t.find("ul:first");if(n.children().length==1){n.detach();t.removeClass("collapsed expanded").addClass("leaf")}else{e.detach()}this.options.core._initializeNode(t)},_initializeComponents:function(){for(var e in this.options.components){var t="element.tree"+this.options.components[e]+"(options);";run=new Function("options","element",t);run(this.options,this.element)}},_initializeNode:function(e){e.children("span:last").addClass("daredevel-tree-label");if(this.options.checkbox){this._initializeCheckboxNode(e)}if(this.options.collapsible){this._initializeCollapsibleNode(e)}if(this.options.dnd){this._initializeDndNode(e)}if(this.options.selectable){this._initializeSelectableNode(e)}},addNode:function(n,r,i){var s=this;var o=this._buildNode(n);if(t==r||0==r.length){this._attachNode(e(o),t,i)}else{this._attachNode(e(o),e(r),i)}if(t!=n.children){e.each(n.children,function(e,t){s.addNode(e,o)})}s._trigger("add",true,o)},isRoot:function(t){t=e(t);var n=t.parentsUntil(".daredevel-tree");return 1==n.length},moveNode:function(n,r,i){this._detachNode(e(n));if(t==r||0==r.length){this._attachNode(e(n),t,i)}else{this._attachNode(e(n),e(r),i)}this._trigger("move",true,e(n))},parentNode:function(t){return e(t).parents("li:first")},removeNode:function(t){this._detachNode(e(t));this._trigger("remove",true,e(t))},_allDescendantChecked:function(e){return e.find("li input:checkbox:not(:checked)").length==0},_checkAncestors:function(e){e.parentsUntil("daredevel-tree").filter("li").find("input:checkbox:first:not(:checked)").prop("checked",true).change()},_checkDescendants:function(e){e.find("li input:checkbox:not(:checked)").prop("checked",true).change()},_checkOthers:function(t){var n=this;t.addClass("exclude");t.parents("li").addClass("exclude");t.find("li").addClass("exclude");e(this.element).find("li").each(function(){if(!e(this).hasClass("exclude")){e(this).find("input:checkbox:first:not(:checked)").prop("checked",true).change()}});e(this.element).find("li").removeClass("exclude")},_createCheckbox:function(){var t=this;this.element.on("click","input:checkbox:not(:checked)",function(){t.uncheck(t.options.core.parentNode(e(this)))});this.element.on("click","input:checkbox:checked",function(){t.check(t.options.core.parentNode(e(this)))});if(this.options.onUncheck.node=="collapse"){this.element.on("click","input:checkbox:not(:checked)",function(){t.options.core.collapse(t.options.core.parentNode(e(this)))})}else if(this.options.onUncheck.node=="expand"){this.element.on("click","input:checkbox:not(:checked)",function(){t.options.core.expand(t.options.core.parentNode(e(this)))})}if(this.options.onCheck.node=="collapse"){this.element.on("click","input:checkbox:checked",function(){t.options.core.collapse(t.options.core.parentNode(e(this)))})}else if(this.options.onCheck.node=="expand"){this.element.on("click","input:checkbox:checked",function(){t.options.core.expand(t.options.core.parentNode(e(this)))})}},_initializeCheckboxNode:function(e){},_uncheckAncestors:function(e){e.parentsUntil("daredevel-tree").filter("li").find("input:checkbox:first:checked").prop("checked",false).change()},_uncheckDescendants:function(e){e.find("li input:checkbox:checked").prop("checked",false).change()},_uncheckOthers:function(t){var n=this;t.addClass("exclude");t.parents("li").addClass("exclude");t.find("li").addClass("exclude");e(this.element).find("li").each(function(){if(!e(this).hasClass("exclude")){e(this).find("input:checkbox:first:checked").prop("checked",false).change()}});e(this.element).find("li").removeClass("exclude")},check:function(t){t=e(t);t.find("input:checkbox:first:not(:checked)").prop("checked",true).change();if(this.options.onCheck.others=="check"){this._checkOthers(t)}else if(this.options.onCheck.others=="uncheck"){this._uncheckOthers(t)}if(this.options.onCheck.descendants=="check"){this._checkDescendants(t)}else if(this.options.onCheck.descendants=="uncheck"){this._uncheckDescendants(t)}if(this.options.onCheck.ancestors=="check"){this._checkAncestors(t)}else if(this.options.onCheck.ancestors=="uncheck"){this._uncheckAncestors(t)}else if(this.options.onCheck.ancestors=="checkIfFull"){var n=this.options.core.isRoot(t);var r=this._allDescendantChecked(this.options.core.parentNode(t));if(!n&&r){this.check(this.options.core.parentNode(t))}}},checkAll:function(){e(this.element).find("input:checkbox:not(:checked)").prop("checked",true).change()},uncheck:function(t){t=e(t);t.find("input:checkbox:first:checked").prop("checked",false).change();if(this.options.onUncheck.others=="check"){this._checkOthers(t)}else if(this.options.onUncheck.others=="uncheck"){this._uncheckOthers(t)}if(this.options.onUncheck.descendants=="check"){this._checkDescendants(t)}else if(this.options.onUncheck.descendants=="uncheck"){this._uncheckDescendants(t)}if(this.options.onUncheck.ancestors=="check"){this._checkAncestors(t)}else if(this.options.onUncheck.ancestors=="uncheck"){this._uncheckAncestors(t)}},uncheckAll:function(){e(this.element).find("input:checkbox:checked").prop("checked",false).change()},_createCollapsible:function(){var t=this;this.element.on("click","li span.daredevel-tree-anchor",function(){var n=t.options.core.parentNode(e(this));if(n.hasClass("collapsed")){t.expand(n)}else if(n.hasClass("expanded")){t.collapse(n)}})},_initializeCollapsibleNode:function(t){var n=this;var r=t.children("span.daredevel-tree-anchor");if(r.length<1){t.prepend(e("<span />",{"class":"daredevel-tree-anchor"}))}if(t.hasClass("leaf")){n._markAsLeaf(t)}else if(t.hasClass("collapsed")){n.collapse(t,false,true)}else if(t.hasClass("expanded")){n.expand(t,false,true)}else if(t.is("li:not(:has(ul))")){n._markAsLeaf(t)}else{n._markAsExpanded(t)}},_markAsCollapsed:function(e){var t=e.children("span.daredevel-tree-anchor");t.removeClass("ui-icon "+this.options.expandUiIcon+" "+this.options.leafUiIcon);if(this.options.collapseUiIcon.length>0){t.addClass("ui-icon "+this.options.collapseUiIcon)}e.removeClass("leaf").removeClass("expanded").addClass("collapsed")},_markAsExpanded:function(e){var t=e.children("span.daredevel-tree-anchor");t.removeClass("ui-icon "+this.options.collapseUiIcon+" "+this.options.leafUiIcon);if(this.options.expandUiIcon.length>0){t.addClass("ui-icon "+this.options.expandUiIcon)}e.removeClass("leaf").removeClass("collapsed").addClass("expanded")},_markAsLeaf:function(e){var t=e.children("span.daredevel-tree-anchor");t.removeClass("ui-icon "+this.options.collapseUiIcon+" "+this.options.expandUiIcon);if(this.options.leafUiIcon.length>0){t.addClass("ui-icon "+this.options.leafUiIcon)}e.removeClass("collapsed").removeClass("expanded").addClass("leaf")},_unmark:function(){li.removeClass("collapsed expanded leaf")},collapse:function(n,r,i){n=e(n);if(i==t){i=false}if(!i&&(n.hasClass("collapsed")||n.hasClass("leaf"))){return}if(r==t){r=true}var s=this;if(r){n.children("ul").hide(this.options.collapseEffect,{},this.options.collapseDuration);setTimeout(function(){s._markAsCollapsed(n,s.options)},s.options.collapseDuration)}else{n.children("ul").hide();s._markAsCollapsed(n,s.options)}s.options.core._trigger("collapse",true,n)},collapseAll:function(){var t=this;e(this.element).find("li.expanded").each(function(){t.collapse(e(this))})},expand:function(n,r,i){n=e(n);if(i==t){i=false}if(!i&&(n.hasClass("expanded")||n.hasClass("leaf"))){return}if(r==t){r=true}var s=this;if(r){n.children("ul").show(s.options.expandEffect,{},s.options.expandDuration);setTimeout(function(){s._markAsExpanded(n,s.options)},s.options.expandDuration)}else{n.children("ul").show();s._markAsExpanded(n,s.options)}s.options.core._trigger("expand",true,n)},expandAll:function(){var t=this;e(this.element).find("li.collapsed").each(function(){t.expand(e(this))})},_createDnd:function(){var e=this},_initializeDndNode:function(n){var r=this;var i=e("<span/>",{"class":"prepended",html:"<br/>"}).droppable({hoverClass:"over",drop:function(n,i){var s=e(this).closest("li");if(r.options.core.isRoot(s)){var o=t;var u=r.options.core.element}else{var o=s.parent().closest("li");var u=o;if(e(i.draggable.parent("li")).find(o).length){return}}var a=e(e(this).parent("li")).index()+1;r.options.core.moveNode(i.draggable.parent("li"),o,a);r._trigger("drop",n,{draggable:i.draggable,droppable:o})}});e(n).find(".daredevel-tree-label:first").after(i);e(n).find(".daredevel-tree-label:first").draggable({start:function(t,n){e(this).parent("li").find("ul, .prepended").css("visibility","hidden");e(this).parent("li").find(".droppable-label").css("display","none")},stop:function(t,n){e(this).parent("li").find("ul").css("visibility","visible");e(this).parent("li").find(".prepended").css("visibility","");e(this).parent("li").find(".droppable-label").css("display","inherit")},revert:true,revertDuration:0});var i=e("<span/>",{"class":"droppable-label",html:"<br/>"}).droppable({drop:function(t,n){var i=e(this).closest("li");if(e(n.draggable.parent("li")).find(i).length){return}r.options.core.moveNode(n.draggable.parent("li"),i,1);r._trigger("drop",t,{draggable:n.draggable,droppable:i})},over:function(t,n){e(this).parent("li").find(".daredevel-tree-label:first").addClass("ui-state-hover")},out:function(t,n){e(this).parent("li").find(".daredevel-tree-label:first").removeClass("ui-state-hover")}});e(n).find(".daredevel-tree-label:first").after(i)},_createSelectable:function(){var t=this;var n=".daredevel-tree-label:not(."+this.options.selectUiClass+")";this.element.on("click",n,function(){t.select(e(this).parent("li"))})},_deselect:function(e){e.find("span.daredevel-tree-label:first").removeClass(this.options.selectUiClass);this._trigger("deselect",true,e)},_destroySelectable:function(){},_initializeSelectableNode:function(e){},_select:function(e){e.find("span.daredevel-tree-label:first").addClass(this.options.selectUiClass);this._trigger("select",true,e)},deselect:function(){var t=this;this.element.find(".daredevel-tree-label."+this.options.selectUiClass).each(function(){t._deselect(e(this).parent("li"))})},select:function(t){t=e(t);this.deselect();this._select(t)},selected:function(){var t=this.element.find(".daredevel-tree-label."+this.options.selectUiClass);return e(t).parent()},options:{defaultNodeAttributes:{span:{html:"new node"},li:{"class":"leaf"},input:{type:"checkbox"}},nodes:null,checkbox:true,onCheck:{ancestors:"check",descendants:"check",node:"",others:""},onUncheck:{ancestors:"",descendants:"uncheck",node:"",others:""},collapsible:true,collapseDuration:500,collapseEffect:"blind",collapseUiIcon:"ui-icon-triangle-1-e",expandDuration:500,expandEffect:"blind",expandUiIcon:"ui-icon-triangle-1-se",leafUiIcon:"",dnd:true,drop:function(e,t){},selectable:true,deselect:function(e,t){},selectUiClass:"ui-state-active",select:function(e,t){}}});e.ui.draggable.prototype._getRelativeOffset=function(){if(this.cssPosition=="relative"){var e=this.element.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0),left:e.left-(parseInt(this.helper.css("left"),10)||0)}}else{return{top:0,left:0}}}})(jQuery);