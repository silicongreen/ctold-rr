
<% if @total_std.blank? %>
  <% if @grading_levels.blank? %>
  <% @grading_levels = GradingLevel.for_batch(@batch.id) %>
  <% if @grading_levels.blank? %>
    <% @grading_levels = GradingLevel.default %>
  <% end %>
  <% end %>
  <%

  @total_std = 0
  @student_list = []
  @subject_highest1 = {}
  @subject_highest2 = {}
  @subject_highest3 = {}
  @subject_highest4 = {}
  @subject_highest5 = {}
  @subject_highest6 = {}
  batchobj = Batch.find_by_id(@batch.id) 
  courseObj = Course.find_by_id(batchobj.course_id)
  all_courses = Course.find_all_by_course_name(courseObj.course_name)
  all_batch = Batch.find_all_by_course_id(all_courses.map(&:id))
  std_subject = StudentsSubject.find_all_by_batch_id(all_batch.map(&:id),:include=>[:subject])
  @std_subject_hash_type = []
  @std_subject_hash_code = []
  unless std_subject.blank?
    std_subject.each do |std_sub|
      if std_sub.student_id == 48812
        %>
          <%#= std_sub.student_id.to_s+"|||"+std_sub.subject_id.to_s+"|||"+std_sub.elective_type.to_s %>
        <%
      end
      @std_subject_hash_type << std_sub.student_id.to_s+"|||"+std_sub.subject_id.to_s+"|||"+std_sub.elective_type.to_s
      @std_subject_hash_code << std_sub.student_id.to_s+"|||"+std_sub.subject.code
    end
  end
  unless @tabulation_data.blank?
    connect_exam = 0
    batch_loop = 0
    @tabulation_data['report'].each do |tab|
      batch_subject = Subject.find_all_by_batch_id(@tabulation_data['batches'][batch_loop], :conditions=>"elective_group_id IS NULL and is_deleted=false")
      batch_subject_id = batch_subject.map(&:id)
      batch_loop = batch_loop+1
      connect_exam_id = @tabulation_data['connect_exams'][connect_exam]
      connect_exam = connect_exam+1
      grand_total = 0
      grand_grade_point = 0
      u_grade = 0
      tab['students'].each do |std| 
        @total_std = @total_std+1
        total_std_subject = StudentsSubject.find_all_by_student_id(std['id'].to_i)
        std_subject_id = total_std_subject.map(&:subject_id)
        total_subject = 0
        tab['subjects'].each do |sub|
          
          if sub['grade_subject'].to_i == 1
            next
          end  
          
          has_exam = false
          tab['exams'].each do |rs|
            if !rs['result'].blank? and !rs['result'][rs['exam_id']].blank? and !rs['result'][rs['exam_id']][sub['id']].blank? and !rs['result'][rs['exam_id']][sub['id']][std['id']].blank? and !rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
              has_exam = true
              break
            end  
          end 
          if has_exam == false
            next
          end 
          total_mark1 = 0
          total_mark2 = 0
          total_mark3 = 0
          total_mark4 = 0
          total_mark5 = 0
          total_mark6 = 0

          if batch_subject_id.include?(sub['id'].to_i) or std_subject_id.include?(sub['id'].to_i)
            
            tab['exams'].each do |rs|
              if !rs['result'].blank? and !rs['result'][rs['exam_id']].blank? and !rs['result'][rs['exam_id']][sub['id']].blank? and !rs['result'][rs['exam_id']][sub['id']][std['id']].blank?   
                if rs['quarter'] == '1'
                  total_mark1 = total_mark1+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end 
                if rs['quarter'] == '2'
                  total_mark2 = total_mark2+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end 
                if rs['quarter'] == '3'
                  total_mark3 = total_mark3+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end 
                if rs['quarter'] == '4'
                  total_mark4 = total_mark4+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end 
                if rs['quarter'] == '5'
                  total_mark5 = total_mark5+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end
                if rs['quarter'] == '6'
                  total_mark6 = total_mark6+rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                end 
                
              end    
            end
            
            
            if @subject_highest1[sub['id'].to_i].blank?
              @subject_highest1[sub['id'].to_i] = total_mark1.round().to_i
            elsif total_mark1.to_f > @subject_highest1[sub['id'].to_i].to_f
               @subject_highest1[sub['id'].to_i] = total_mark1.round().to_i
            end

            if @subject_highest2[sub['id'].to_i].blank?
              @subject_highest2[sub['id'].to_i] = total_mark2.round().to_i
            elsif total_mark2.to_f > @subject_highest2[sub['id'].to_i].to_f
               @subject_highest2[sub['id'].to_i] = total_mark2.round().to_i
            end

            if @subject_highest3[sub['id'].to_i].blank?
              @subject_highest3[sub['id'].to_i] = total_mark3.round().to_i
            elsif total_mark3.to_f > @subject_highest3[sub['id'].to_i].to_f
               @subject_highest3[sub['id'].to_i] = total_mark3.round().to_i
            end

            if @subject_highest4[sub['id'].to_i].blank?
              @subject_highest4[sub['id'].to_i] = total_mark4.round().to_i
            elsif total_mark4.to_f > @subject_highest4[sub['id'].to_i].to_f
               @subject_highest4[sub['id'].to_i] = total_mark4.round().to_i
            end

            if @subject_highest5[sub['id'].to_i].blank?
              @subject_highest5[sub['id'].to_i] = total_mark5.round().to_i
            elsif total_mark5.to_f > @subject_highest5[sub['id'].to_i].to_f
               @subject_highest5[sub['id'].to_i] = total_mark5.round().to_i
            end

            if @subject_highest6[sub['id'].to_i].blank?
              @subject_highest6[sub['id'].to_i] = total_mark6.round().to_i
            elsif total_mark6.to_f > @subject_highest6[sub['id'].to_i].to_f
               @subject_highest6[sub['id'].to_i] = total_mark6.round().to_i
            end

          end  
        end

      end
    end
   end
  end
    
   

%> 
