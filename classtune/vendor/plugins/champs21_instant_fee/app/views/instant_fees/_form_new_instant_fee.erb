<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<script type="text/javascript"> 
  function setOption(optn) 
  {
      if (optn=='guest')
      {
        $('payee_select').hide();
      }
      else
      {
        $('payee_select').show();
      }
      document.getElementById("option").value = optn;
  }
</script>
<div id="partial-content">
  <div id="search_box_bg">
    <form name="search_form" action="" style="display:inline;">
      <%= hidden_field_tag("option", params['option'], :value => "student") %>
        <div class="label-field-pair" id="payee_select" style="width: 99%;">  
          <div class="label-container" style="text-align: right; padding-top: 10px; font-weight: bold; font-size: 16px;">
            <%= t('select_payee') %>
          </div>
          <div class="input-container">
            <%= text_field_tag("query", params['query'], :autocomplete => 'off') %>
            <%= image_tag("loader.gif",
              :align => "absmiddle",
              :border => 0,
              :id => "loader",
              :style =>"display: none;" ) %>  
          </div>
        </div>
        <div class="radio_button">
          <div class="radio-label">
            <input type="radio" name="setopt" id="search_present_students_radio" checked="checked" onclick="setOption('student')" /><%= t('student_text') %>
            <input type="radio" name="setopt" id ="search_former_students_radio"onclick="setOption('employee')" /><%= t('employee_text') %>
            <!--input type="radio" name="setopt" id ="search_former_students_radio" onclick="setOption('guest')" /--><%#= t('guest')  %>
          </div>
        </div>  
    </form>
  </div>

  <div id="view_all">

  </div>



  <%= observe_fields ['query', 'option'],
    :frequency => 0.5,
    :update => 'information',
    :before => "Element.show('loader')",
    :success => "Element.hide('loader')",
    :url => {:action => 'tsearch_logic'} %>

  <div id="information"></div>
</div>
<div id="select-category-type"></div>
<div id="enter_custom_category"></div>
<div id="fee_window"></div>

<script type="text/javascript">
  function precision(x)
  {
    return Number.parseFloat(x).toFixed(2);
  }
  
  function validate_guest(){
    err_text = "";
    if ($('guest_payee').select('input')[0].value.trim()=="")
    {
      err_text = "Please Enter Guest Name";
    }
    if (err_text!="")
    {
      alert(err_text);
      return false;
    }
    else
    {
      return true;
    }
  }

  function validate_category(){
    err_text = "";
    if ($('custom_category_name').value.trim()=="")
    {
      err_text = "Please Enter a Category Name";
    }
    if (err_text!="")
    {
      alert(err_text);
      return false;
    }
    else
    {
      return validate_payment_mode();
    }
  }

  function validate_particular_name()
  {
    var flag = 0;
    var flags = 0;
    $$('.particular_name').each(function(el){

      if (el.value.trim()== "")
        flag = 1;
    });
    $$('.amount').each(function(el){

      if (el.value.trim()== "0.0" || el.value.trim()== "0" ||el.value.trim()== "-0" )
        flags = 1;
    });
    if(flag == 1){
      alert("Particular name missing");
      return false;
    }
    else if (flags==1){
      alert("Particular amount should be positive");
      return false;
    }
    else
      return true;
  }

  function validate_particular_select()
  {
    var flag = 0;
    $$('.par_check').each(function(el){

      if (el.checked == true){
        flag = 1;
      }
    });
    if(flag == 0){alert("Please select at least one particular");return false;}
    else
      return true;
  }
</script>
<script type="text/javascript">
  var i=1;
  function insRow()
  {
    var sn = parseInt(j("#instant_fee tr.particulars_tr:last td:first span").html());
    var current_sn = sn + 1;
    var clone_tr = j("#instant_fee tr.particulars_tr:last").clone();
    j(clone_tr).attr("id","tr_fee_particular_" + current_sn);
    if ( ! j(clone_tr).hasClass('particulars_tr_custom') )
    {
      j(clone_tr).addClass("particulars_tr_custom");
    }
    //clone_tr.hide();
    j("#instant_fee tr.particulars_tr:last").after(clone_tr);
    j("#instant_fee tr.particulars_tr:last td:first span").html(current_sn);
    j("#instant_fee tr.particulars_tr:last td:first span").attr("id", "sn_span_" + current_sn);
    
    var clonetxt = j("#instant_fee tr.particulars_tr:last td.feeamount div input").clone();
    j(clonetxt).attr("name","name[]");
    j(clonetxt).attr("id","name_" + current_sn);
    j(clonetxt).addClass("particular_name");
    j(clonetxt).removeClass("amount");
    j(clonetxt).removeClass("precision_text");
    j(clonetxt).removeAttr("onchange");
    j(clonetxt).removeAttr("disabled");
    j(clonetxt).attr("value","");
    j(clonetxt).css("margin-left","0");
    
    var cloneQuantityTxt = j("#instant_fee tr.particulars_tr:last td.feeamount div input").clone();
    j(cloneQuantityTxt).attr("name","quantity[]");
    j(cloneQuantityTxt).attr("id","quantity_" + current_sn);
    j(cloneQuantityTxt).removeClass("amount");
    j(cloneQuantityTxt).removeClass("precision_text");
    j(cloneQuantityTxt).removeAttr("disabled");
    j(cloneQuantityTxt).attr("onchange","update_total_by_quantity(this)");
    j(cloneQuantityTxt).attr("value","1");
    
    j("#instant_fee tr.particulars_tr:last td.feename").addClass('label-field-pair');
    j("#instant_fee tr.particulars_tr:last td.feename").html('<div class="input-container" style="width: 77%;">' + j('<div>').append(clonetxt).html() + '</div>');
    
    j("#instant_fee tr.particulars_tr:last td.feeamount div input").val(precision(0.0));
    j("#instant_fee tr.particulars_tr:last td.feeamount div input").attr("id","amount_" + current_sn);
    j("#instant_fee tr.particulars_tr:last td.feeamount div input").removeAttr("disabled");
    
    j("#instant_fee tr.particulars_tr:last td.feequantity").html('<div class="input-container" style="width: 40%;">' + j('<div>').append(cloneQuantityTxt).html() + '</div>');
    
    j("#instant_fee tr.particulars_tr:last td.feediscount div input").val(0);
    j("#instant_fee tr.particulars_tr:last td.feediscount div input").attr("id","discount_" + current_sn);
    j("#instant_fee tr.particulars_tr:last td.feediscount div input").removeAttr("disabled");
    
    j("#instant_fee tr.particulars_tr:last td.feetotal span").html(precision(0.0));
    j("#instant_fee tr.particulars_tr:last td.feetotal span").attr("id","total_check_span_" + current_sn);
    
    j("#instant_fee tr.particulars_tr:last td.feetotal div input").val(precision(0.0));
    j("#instant_fee tr.particulars_tr:last td.feetotal div input").attr("id","total_check_" + current_sn);
    j("#instant_fee tr.particulars_tr:last td.feetotal div input").removeAttr("disabled");
    
    j("#instant_fee tr.particulars_tr:last td.feecross").html('<a href="javascript:;" id="cross_' + current_sn + '" class="cross">&#10008;</a>');
    //j("#instant_fee tr.particulars_tr:last td.feecross input").val(current_sn);
    //j("#instant_fee tr.particulars_tr:last td.feecross input").prop("checked",true);
    //j("#instant_fee tr.particulars_tr:last td.feecross label").attr("for","check_" + current_sn);
  }

  function delRow(i)
  {
    document.getElementById('listing').deleteRow(i);
    col5total();
  }
</script>


<script type="text/javascript">
  function roundVal(val)
  {
    var dec = parseInt("<%= @precision%>") ;
    console.log('prec'+dec);
    var result = Math.round(val*Math.pow(10,dec))/Math.pow(10,dec);
    return result;
  }

  var total_global;
  function assign_amt(che)
  {
    var discount = che.id.replace('check',"discount");
    var amount = che.id.replace('check',"amount");
    var quantity = che.id.replace('check',"quantity");
    var name = che.id.replace('check',"name");
    var total = che.id.replace('check',"total_check");
    var total_span = che.id.replace('check',"total_check_span");
    var amount_text = document.getElementById(amount).value * document.getElementById(quantity).value;
    var discount_text = document.getElementById(discount).value;
    if (isNaN(discount_text) == false && isNaN(amount_text) == false)
    {
      if(che.checked)
      {
        document.getElementById(amount).removeAttribute('disabled');
        document.getElementById(quantity).removeAttribute('disabled');
        document.getElementById(discount).removeAttribute('disabled');
        document.getElementById(total).removeAttribute('disabled');
        if (j("#" + name).length == 1)
        {
            document.getElementById(name).removeAttribute('disabled');
        }
        if(amount_text == 0 || "")
        {
          document.getElementById(total).value = precision(0.0);
          document.getElementById(total_span).innerHTML = precision(0.0);
          amount_text = document.getElementById(amount).value = precision(0.0);
        }
        else
        {
          if(amount_text < 0)
          {
            alert("Amount can not be negative.")
            document.getElementById(amount).value = precision(0.0);
            col5total();
            return false;
          }
          if (discount_text == 0 || "")
          {
            document.getElementById(total).value = precision(amount_text.value)
            document.getElementById(total_span).innerHTML = precision(amount_text.value)
          }
          if (discount_text <= 100)
          {
            if(discount_text < 0)
            {
              alert("Discount cannot be negative.")
              document.getElementById(discount).value = 0;
              col5total();
              return false;
            }
            else
            {
              document.getElementById(total).value = precision(roundVal(parseFloat(amount_text - (amount_text * discount_text/100))));
              document.getElementById(total_span).innerHTML = precision(roundVal(parseFloat(amount_text - (amount_text * discount_text/100))));
            }
          }
        }

      }
      else
      {
        document.getElementById(total).value = precision(0.0);
        document.getElementById(total_span).innerHTML = precision(0.0);
        document.getElementById(amount).setAttribute('disabled','true');
        document.getElementById(discount).setAttribute('disabled','true');
        document.getElementById(total).setAttribute('disabled','true');
        document.getElementById(quantity).setAttribute('disabled','true');
        if (j("#" + name).length == 1)
        {
            document.getElementById(name).setAttribute('disabled','true');
        }
      }
      col5total();
    }
    else
      alert('Please enter numeric value for amount and discount');
    col5total();
  }

  function update_total_by_amount(text_box)
  {
    var quantity = text_box.id.replace('amount',"quantity");
    var discount = text_box.id.replace('amount',"discount");
    var total = text_box.id.replace('amount',"total_check");
    var total_span = text_box.id.replace('amount',"total_check_span");
    var discount_text = document.getElementById(discount).value
    var quantity_value = document.getElementById(quantity).value
    if (isNaN(discount_text) == false && isNaN(text_box.value)== false)
    {
      if(text_box.value < 0)
      {
          alert("Amount can not be negative.")
          text_box.value = precision(0.0);
          document.getElementById(total).value = precision(0.0);
          document.getElementById(total_span).innerHTML = precision(0.0);
          col5total();
          return false;
      }
      if(text_box.value == "")
      {
          text_box.value = precision(0.0);
          document.getElementById(total).value = precision(0.0);
          document.getElementById(total_span).innerHTML = precision(0.0);
          col5total();
          return false;
      }
      if (discount_text == 0 || "")
      {
        document.getElementById(total).value = precision(text_box.value * quantity_value);
        document.getElementById(total_span).innerHTML = precision(text_box.value * quantity_value);
        document.getElementById(discount).value = 0;
      }
      if (discount_text <= 100)
      {
        if(discount_text < 0)
        {
            alert("Discount can not be negative.")
            document.getElementById(discount).value = 0;
            col5total();
            return false;
        }
        else
        {
          document.getElementById(total).value = precision(roundVal(parseFloat((text_box.value * quantity_value) - ((text_box.value * quantity_value) * discount_text/100))));
          document.getElementById(total_span).innerHTML = precision(roundVal(parseFloat((text_box.value * quantity_value) - ((text_box.value * quantity_value) * discount_text/100))));
        }
      }
      else
        alert('Discount cannot be greater than 100% ');
      col5total();
    }
    else
    {
      text_box.value = precision(0.0);
      document.getElementById(total).value = precision(0.0);
      document.getElementById(total_span).innerHTML = precision(0.0);
      alert('Please enter numeric value for amount and discount')
      col5total();
    }
  }
  
  function update_total_by_quantity(quantity_box)
  {
    var amount = quantity_box.id.replace('quantity',"amount");
    var discount = quantity_box.id.replace('quantity',"discount");
    var total = quantity_box.id.replace('quantity',"total_check");
    var total_span = quantity_box.id.replace('quantity',"total_check_span");
    var discount_text = document.getElementById(discount).value
    var text_box = document.getElementById(amount)
    var quantity_value = quantity_box.value

    if (isNaN(discount_text) == false && isNaN(text_box.value)== false)
    {
      if(text_box.value < 0)
      {
          alert("Amount can not be negative.")
          text_box.value = precision(0.0);
          document.getElementById(total).value = precision(0.0);
          document.getElementById(total_span).innerHTML = precision(0.0);
          col5total();
          return false;
      }
      if(text_box.value == "")
      {
          text_box.value = precision(0.0);
          document.getElementById(total).value = precision(0.0);
          document.getElementById(total_span).innerHTML = precision(0.0);
          col5total();
          return false;
      }
      if (discount_text == 0 || "")
      {
        document.getElementById(total).value = precision(text_box.value * quantity_value);
        document.getElementById(total_span).innerHTML = precision(text_box.value * quantity_value);
        document.getElementById(discount).value = 0;
      }
      if (discount_text <= 100)
      {
        if(discount_text < 0)
        {
            alert("Discount can not be negative.")
            document.getElementById(discount).value = 0;
            col5total();
            return false;
        }
        else
        {
          document.getElementById(total).value = precision(roundVal(parseFloat((text_box.value * quantity_value) - ((text_box.value * quantity_value) * discount_text/100))));
          document.getElementById(total_span).innerHTML = precision(roundVal(parseFloat((text_box.value * quantity_value) - ((text_box.value * quantity_value) * discount_text/100))));
        }
      }
      else
        alert('Discount cannot be greater than 100% ');
      col5total();
    }
    else
    {
      text_box.value = precision(0.0);
      document.getElementById(total).value = precision(0.0);
      document.getElementById(total_span).innerHTML = precision(0.0);
      alert('Please enter numeric value for amount and discount')
      col5total();
    }
  }

  function update_total_by_discount(text_box)
  {
    var amount = text_box.id.replace('discount',"amount");
    var quantity = text_box.id.replace('discount',"quantity");
    var total = text_box.id.replace('discount',"total_check");
    var total_span = text_box.id.replace('discount',"total_check_span");
    var amount_text = document.getElementById(amount).value * document.getElementById(quantity).value;
    if (isNaN(amount_text) == false && isNaN(text_box.value)== false)
    {
      if(text_box.value == "")
      {
        text_box.value = precision(0.0);
        document.getElementById(total).value = precision(amount_text);
        document.getElementById(total_span).innerHTML = precision(amount_text);
        col5total();
        return false;
      }
      if (amount_text == 0 )
      {
        document.getElementById(total).value = precision(0.0);
        document.getElementById(total_span).innerHTML = precision(0.0);
      }
      if(amount_text < 0)
      {
        alert("Amount can not be negative.");
        document.getElementById(amount).value = precision(0.0);
        col5total();
        return false;
      }
      else
      {
        if (text_box.value <= 100)
        {
          if(text_box.value < 0)
          {
            alert("discount can not be negative.");
            text_box.value = precision(0.0);
            document.getElementById(total).value = precision(amount_text);
            document.getElementById(total_span).innerHTML = precision(amount_text);
            col5total();
            return false;
          }
          else
          {
            document.getElementById(total).value = precision(roundVal(parseFloat(amount_text - (amount_text * text_box.value/100))));
            document.getElementById(total_span).innerHTML = precision(roundVal(parseFloat(amount_text - (amount_text * text_box.value/100))));
          }
        }
        else
        {
          text_box.value = precision(0.0);
          alert('Discount cannot be greater than 100% ');
        }
        col5total();
      }
    }
    else
    {
      text_box.value = precision(0.0);
      document.getElementById(total).value = precision(amount_text);
      document.getElementById(total_span).innerHTML = precision(amount_text);
      alert('Please enter numeric value for amount and discount')
      col5total();
    }
  }

  function attacher()
  {
    $$('.par_check').invoke('observe','change', assign_amt);
    col5total()
  }

  function col5total()
  {
    var total = 0;
    $$('.particular_total').each(function(el)
    {
      if(isNaN(el.value) == false || el.value!="")
      {
        total = roundVal(total + parseFloat(el.value));}
      else{
        el.value = precision(0.0);
        alert ('please enter a numeric value for total');}
    });
    $("total_span").innerHTML = precision(roundVal(total));
    $('total_fees').value = precision(roundVal(total));
  }


</script>

<script type="text/javascript">
  function validate_make_fee()
  {
    if($$('.particular_name').length > 0)
    {
      if (validate_particular_name())
      {
        return validate_payment_mode();
      }
      else{
        return false;
      }
    }
    else
    {
      if(validate_particular_select())
        return true;
      else
      {

        {
          alert("Please enter at least one particular detail");
          return false;
        }
      }
    }
  }

  function validate_payment_mode()
  {
    if ($('payment')!=null)
    {
      if ($('payment').select('input')[0].value.trim()=="")
      {
        alert('<%= "#{t('select_one_payment_mode')}"%>');
        return false;
      }
      else
      {
        return true;
      }
    }
    else
    {
      return true;
    }
  }
  
  function validate_make_fee_from_custom_category()
  {
    if(validate_category())
    {
      if($$('.particular_name').length > 0)
      {
        if (validate_particular_name())
        {
          return validate_payment_mode();
        }
        else{
          return false;
        }
      }
      else
      {
        alert("Please enter at least one particular detail");
        return false;
      }
    }
    else
    {
      return false;
    }
  }

  function validate_make_fee_for_guest()
  {
    if( validate_guest())
    {
      return validate_particular_name();
    }
    else return true;
  }

  function validate_make_fee_for_guest_from_custom_category()
  {
    if( validate_guest())
    {
      if($$('.particular_name').length > 0)
      {
        if(validate_particular_name())
        {
          if ($('custom_category_name'))
          {
            return (validate_category())
          }
          else
          {
            return validate_payment_mode();
          }

        }
        else
        {
          return false
        }
      }
      else
      {
        if(validate_particular_select())
          return validate_payment_mode();
        else
        {

          {
            return false;
          }
        }
      }
    }
    else return false;
  }
</script>

<script>
  j(document).ready(function(){
      j(document).on("click", ".cross", function(){
          var id = this.id.replace("cross_","");
          j("#tr_fee_particular_" + id).remove();
          var no_particular = 1;
          j("#instant_fee tr.particulars_tr").each(function(){
               if ( ! j(this).hasClass("particulars_tr_custom") )
               {
                    no_particular++;
               }
          });
          j("#instant_fee tr.particulars_tr").each(function(){
              if ( j(this).hasClass("particulars_tr_custom") )
              {
                  var id = this.id;
                  j("#" + id + " td:first span").html(no_particular);
                  j("#" + id + " td:first span").attr("id", "sn_span_" + no_particular);
                  j("#" + id + " td.feeamount div input").attr("id","amount_" + no_particular);
                  j("#" + id + " td.feequantity div input").attr("id","amount_" + no_particular);
                  j("#" + id + " td.feediscount div input").attr("id","discount_" + no_particular);
                  j("#" + id + " td.feetotal span").attr("id","total_check_span_" + no_particular);
                  j("#" + id + " td.feetotal div input").attr("id","total_check_" + no_particular);
                  j("#" + id + " td.feecross a").attr("id","cross_" + no_particular);
                  j(this).attr("id","tr_fee_particular_" + no_particular);
      
                  no_particular++;
              }
          });
          col5total();
      });
  });
</script>

