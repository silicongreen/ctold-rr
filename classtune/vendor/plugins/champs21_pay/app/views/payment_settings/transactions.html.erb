<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<style>
    .table{
        font-family: verdana;
        font-size: 12px;
    }
    .table > thead > tr > th {
        vertical-align: middle !important;
    }  
    .table-sm td, .table-sm th {
        padding: .3rem !important;
    }
</style>
<div id="content-header">
<%= show_header_icon %>
  <h1><%= t('online_payment') %></h1>
<div class='header-sep'>|</div>
<div class='sub-header'><%= t('transactions') %></div>
<% authorization = Authorization.current_user.try(:role_symbols)  %>
<%  unless authorization.include?(:online_payment_report) %>
<div id="inner-tab-menu">
  <ul>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "Settings", settings_online_payments_path %></li>
  </ul>
</div>
<% end %>
</div>
<div id="page-yield">
  <div id="flash-box">
    <% unless flash[:notice].nil? %>
      <p class="flash-msg"> <%= flash[:notice] %> </p>
    <% end %>
  </div>
  <% form_for :payment_transaction,:url => transactions_online_payments_url do %>
    <div class="filter">
      <div class="label-field-pair" style="width: 40%;">
        <div class="label-container"><%= t('start_date') %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'start_date', params[:start_date].present? ? params[:start_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div class="label-field-pair" style="width: 40%;">
          <div class="label-container" style="width: 20%;"><%= t('end_date') %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'end_date', params[:end_date].present? ? params[:end_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div style="margin-left: 40%;">
        <%= submit_tag 'Search',:name => "search",:class => "submit-button" %>
      </div>
      <div style="clear: both; height: 20px;"></div>
      <hr style="border: 1px solid #ccc;" />  
      <div class="label-field-pair" style="width: 25%;">
          <div class="label-container" style="padding-top: 15px;">Ref No.:</div>
          <div class="input-container"><input type="text" name="ref_no" id="ref_no" /></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-left: 20px;">
          <div class="label-container" style="padding-top: 15px;">Order ID:</div>
          <div class="input-container"><input type="text" name="order_id" id="order_id" /></div>
      </div>
      <div class="label-field-pair" style="width: 25%;">
          <div class="label-container" style="padding-top: 15px;">Type:</div>
          <div class="input-container" style="padding-top: 10px;">
              <select name="payment_type" id="payment_type">
                  <option value="">Select a Payment Type</option>
                  <option value="MB">Mobile Banking</option>
                  <option value="ITCL">Card Online</option>
              </select>
          </div>
      </div>
      <div style="clear: both; height: 20px;"></div>
    </div>
  <% end %>
  <% unless @online_payments.empty? %>
    <div class="box" style="padding-top: 20px;">
      <table class="table table-sm table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
        <thead><!-- class="thead-inverse" -->
        <tr>
            <th style="width: 3%;"><%= "#" %></th>
            <th style="width: 10%;"><%= t("gateway_name") %></th>
            <th style="width: 10%;"><%= "Payee ID" %></th>
            <th style="width: 30%;"><%= t("payee_name") %></th>
            <th style="width: 10%;"><%= t("payment_type") %></th>
            <th style="width: 10%;"><%= t("fee_name") %></th>
            <th style="width: 10%;"><%= t("amount") %></th>
            <th style="width: 10%;"><%= t("gateway_status") %></th>
            <% if MultiSchool.current_school.id == 352 %>
            <th style="width: 10%;"><%= t("ref_id") %></th>
            <% else %>
            <th style="width: 10%;"><%= t("online_transaction_id") %></th>
            <% end %>
            <th style="width: 10%;"><%= t("transaction_date") %></th>
        </tr>
        </thead>
        <tbody>
        <% @online_payments.each_with_index do |payment,index| %>
          <tr>
            <td style="vertical-align: middle;"><%= ((@online_payments.current_page - 1) * @online_payments.per_page) + index + 1 %></td>
            <td style="text-align: center;">
              <% gateway_name = "Online Payment"  %>  
              <% gateway_name_data = "Online Payment"  %>  
              <% if (payment.gateway_response.keys.include? :x_trans_id) %>  
                <% gateway_name = "Authorize.net"  %>
                <% gateway_name_data = "Authorize.net"  %>
              <% elsif (payment.gateway_response.keys.include? :val) %>  
                <% gateway_name = "SSL Commerz"  %>
                <% gateway_name_data = "SSL Commerz"  %>
              <% elsif (payment.gateway_response.keys.include? :order_id) %>  
                <% gateway_name = '<img src="/images/gateway_images/trustbank.png" height="64px" />'  %>
                <% gateway_name_data = 'trustbank'  %>
              <% else %>
                <% gateway_name = "Paypal"  %>
                <% gateway_name_data = "Paypal"  %>
              <% end %>  
              <%= gateway_name %>  
            </td>
            <% payee_user = payment.payee.try(:user).try(:username) unless payment.payee.class.name == "Applicant" %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.payee_admission_no}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.payee_name}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.payment_type}" %></td>
            <% payment_type = String.new
            if payment.payment_type == "FinanceFee"
              payment_type = payment.finance_transaction.try(:finance).try(:finance_fee_collection).try(:name)
            elsif payment.payment_type == "HostelFee" 
              payment_type = payment.finance_transaction.try(:finance).try(:hostel_fee_collection).try(:name)
            elsif payment.payment_type == "TransportFee"
              payment_type = payment.finance_transaction.try(:finance).try(:transport_fee_collection).try(:name)
            else
              payment_type = "Application"
            end
          %>
            <td style="vertical-align: middle; text-align: center;"><%= payment_type %></td>
            <% amount = payment.gateway_response[:amount]
            amount ||= payment.gateway_response[:x_amount]%>

            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= amount %></td>
            <td style="vertical-align: middle; text-align: center;">
              <% gateway_status = "Failed"
              if gateway_name_data == "Paypal"
                gateway_status = "Completed" if payment.gateway_response[:status] == "Completed"
              elsif gateway_name_data == "trustbank"  
                gateway_status = "Completed" if payment.gateway_response[:status].to_i == 1
              elsif gateway_name_data == "SSL Commerz"  
                gateway_status = "Completed" if payment.gateway_response[:status] == "VALID"
              elsif gateway_name == "Authorize.net"
                gateway_status = "Completed" if payment.gateway_response[:x_response_reason_code] == "1"
              end %>
              <%= gateway_status %>
            </td>
            <td style="vertical-align: middle; text-align: center;">
              <% transaction_id = nil
              if gateway_name_data == "Paypal"
                transaction_id = payment.gateway_response[:transaction_id]
              elsif gateway_name_data == "Authorize.net"
                transaction_id = payment.gateway_response[:x_trans_id]
              elsif gateway_name_data == "SSL Commerz"
                transaction_id = payment.gateway_response[:transaction_id]
              elsif gateway_name_data == "trustbank"
                transaction_id = payment.gateway_response[:ref_id]
              end %>
              <%= transaction_id %>
            </td>
            <td style="vertical-align: middle; text-align: center;">
              <%= I18n.l(payment.created_at,:format=>"%d %b %Y") %>
            </td>
          </tr>
        <% end %>
        </tbody> 
      </table>
      <%= will_paginate @online_payments,:params=>{:start_date => params[:start_date],:end_date => params[:end_date]} %>
    </div>
  <% else %>
    <div id="flash-box">
      <p class="flash-msg"  style="float: left;margin-top: 50px;width: 100%;">No Payments present</p>
    </div>
  <% end %>

</div>
<style>
    .filter {
        border: 1px solid #ccc;
        width: 98%;
        padding: 20px 10px 9px 10px;
        border-radius: 7px;
        background: #E5E5E5;
    }    
    .text-input-bg select, .label-field-pair input {
        height: 22px;
    }
</style>