
<% if @total_std.blank? %>

  <%
  @subject_highest = {}
  @total_std = 0
  @student_list = []
  batchobj = Batch.find_by_id(@batch.id) 
  courseObj = Course.find_by_id(batchobj.course_id)
  unless @tabulation_data.blank?
    connect_exam = 0
    batch_loop = 0
    group_name = courseObj.group
    @tabulation_data['report'].each do |tab|
      batch_subject = Subject.find_all_by_batch_id(@tabulation_data['batches'][batch_loop], :conditions=>"elective_group_id IS NULL and is_deleted=false")
      batch_subject_id = batch_subject.map(&:id)
      batch_data = Batch.find(@tabulation_data['batches'][batch_loop])
      batch_loop = batch_loop+1
      std_group_name = batch_data.course.group
      if (std_group_name != group_name)
        next
      end
      if !tab.kind_of?(Array) and !tab.blank? and !tab['students'].blank?
        tab['students'].each do |std| 

          @total_std = @total_std+1
          total_std_subject = StudentsSubject.find_all_by_student_id(std['id'].to_i)
          std_subject_id = total_std_subject.map(&:subject_id)
          total_mark_result = 0
          total_gpa = 0
          total_mark = 0
          total_full_mark = 0
          u_grade = false
          tab['subjects'].each do |sub|
            has_exam = false
            tab['exams'].each do |rs|
              if !rs['result'].blank? and !rs['result'][rs['exam_id']].blank? and !rs['result'][rs['exam_id']][sub['id']].blank? and !rs['result'][rs['exam_id']][sub['id']][std['id']].blank? and !rs['result'][rs['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                has_exam = true
                break
              end  
            end 
            if has_exam == false
              next
            end
            if batch_subject_id.include?(sub['id'].to_i) or std_subject_id.include?(sub['id'].to_i)  
              total_100 = 0
              full_100 = 0
              tab['exams'].each do |report|
                grade_mark = 0
                full_mark = 0
                if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                  total_100 = total_100.to_f+report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f.round()
                  grade_mark = report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f.round()
                end
                if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                  full_100 = full_100+report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  full_mark = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                end 

                if full_mark > 0
                  if grade_mark > 0
                    point_mark = (grade_mark.to_f/full_mark.to_f)*100
                    grade = GradingLevel.percentage_to_grade(point_mark, @batch.id)
                    if !grade.blank? and !grade.name.blank? and !grade.credit_points.blank?
                      if grade.credit_points.to_i == 0
                        u_grade = true
                      end  
                    end
                  else
                    u_grade = true
                  end  
                end 

              end
              total_mark = total_mark+total_100
              total_full_mark = total_full_mark+full_100
              coverted_100 = 0
              if total_100 > 0
                coverted_100 = (total_100.to_f/full_100.to_f)*100
              end

              coverted_100 = coverted_100.round()
              total_mark_result = total_mark_result+coverted_100
              gp_point =0
              if coverted_100 != 0
                grade = GradingLevel.percentage_to_grade(coverted_100, @batch.id)
                if !grade.blank? and !grade.name.blank? and !grade.credit_points.blank?
                  gp_point = grade.credit_points
                  if grade.credit_points.to_i == 0
                    u_grade = true
                  end  
                end
              end


              total_gpa = total_gpa+gp_point
              if @subject_highest[sub['id'].to_i].blank?
                @subject_highest[sub['id'].to_i] = coverted_100
                elsif coverted_100.to_f > @subject_highest[sub['id'].to_i].to_f
                @subject_highest[sub['id'].to_i] = coverted_100.to_f
              end
            end

          end
          mark_less_obtain = 100000-total_mark_result.to_f
          grade_less_obtain = 100000-total_gpa.to_f
          if u_grade == false
            @student_list << [grade_less_obtain.to_f,mark_less_obtain.to_f,std['first_name']+" "+std['last_name'],std['id'].to_i]
          end


        end
      end
    end
  end

  @student_position = {}
  unless @student_list.blank?
    @sorted_students = @student_list.sort
    position = 0
    @sorted_students.each do|s|
      position = position+1
      @student_position[s[3].to_i] = position
    end
  end

  end

%> 
