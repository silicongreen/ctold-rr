<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css" />
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<link rel="stylesheet" href="/stylesheets/loader.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<% if @gateway_settings.keys.include?('bkash')  %>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> 
<% bkash_test = PaymentConfiguration.config_value("is_test_bkash") %>
<% if bkash_test.to_i == 0 %>
  <script src="https://scripts.pay.bka.sh/versions/1.2.0-beta/checkout/bKash-checkout.js"></script>
<% else %>
  <script src="https://scripts.sandbox.bka.sh/versions/1.2.0-beta/checkout/bKash-checkout-sandbox.js"></script>
<% end %>

<% end %>
<style>
  * {
      -webkit-box-sizing: content-box !important;
      -moz-box-sizing: content-box-box !important;
      box-sizing: content-box !important;
  }
  .modal{
    top: 20% !important;
  }
  .h2, h2 {
      font-size: 16px !important;
      font-weight: bold !important;
      margin-top: 2px !important;
      margin-bottom: 10px !important;
  }
  hr{
      margin-top: 2px !important;
      margin-bottom: 10px !important;
  }
</style>
<% unless params[:show_order_id].blank? %>
  <% if params[:show_order_id].to_i == 1 %>
    <div style="padding: 20px; border: 1px solid #ccc;">
      <%= @order_id %>
    </div>
  <% end %>
<% end %>

<% if MultiSchool.current_school.id == 352 %>
<%
  require "yaml"
  transport_config = YAML.load_file("#{RAILS_ROOT.to_s}/config/finance_transport.yml")['school']
  transport_particular_id = transport_config['transport_particular_id_' + MultiSchool.current_school.id.to_s]
  if transport_particular_id.blank?
    transport_particular_id = 0
  end
%>  
<% end %>  

<div id="content-header">
  <%= show_header_icon %>
  <h1><%= t('online_payment') %></h1>
  <div class='header-sep'>|</div>
  <div class='sub-header'><%= t('student_fee') %></div>

  <div id="inner-tab-menu">
    <ul>
      <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('fees_text')}", :controller => 'student', :action => 'fees', :id => @student.id %></li>
      <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('student_profile')}", :controller => 'student', :action => 'profile', :id => @student.id %></li>
    </ul>
  </div>
</div>
<% combine_fees_enabled = false %>
<% @include_combined_fees = PaymentConfiguration.find_by_config_key("include_combined_fees").try(:config_value)    %>
<% unless @include_combined_fees.blank? %>
<% combine_fees_enabled = true %>
<% end %>
<% student_fee_configuration = StudentFeeConfiguration.find(:first, :conditions => "student_id = #{@student.id} and config_key = 'combined_payment_student'") %>
<% unless student_fee_configuration.nil? %>
  <% if student_fee_configuration.config_value.to_i == 1 %>
    <% combine_fees_enabled = true %>
  <% else %>
    <% combine_fees_enabled = false %>
  <% end %>
<% end %>

<% unless params[:opt].nil? %>
  <% opt = params[:opt][0..params[:opt].length - 4].reverse %>
  <% opt = Base64.decode64(opt) %>
  <% a_opt = opt.split("-") %>
  <% if a_opt.length == 2 %>
    <% if a_opt[0].to_i == @student.id and a_opt[1].to_i == @date.id %>
      <% combine_fees_enabled = false %>
    <% end %>
  <% end %>
<% end %>

<div id="page-yield">
<% unless flash[:notice].nil? %>
  <div id="errorExplanation" class="errorExplanation"><p><%= t('there_were_pblm') %></p><ul><li><%= flash[:notice] %></li></ul></div>
<% end %>
  
<% unless flash[:success].nil? %>
  <div id="success" class="success" style="margin-bottom: 20px;"><%= flash[:success] %></div>
<% end %>

<% unless flash[:warning].nil? %><p class="flash-msg"><%= flash[:warning] %></p><% end %>
<% flash[:notice] = nil %>
 <div id="student_profile_heading">
        <div id="profile_picture_display">
            <% if @student.photo.file? %>
              <% @profile_image = @student.photo.url %>
              <% unless @profile_image.index("RackMultipart").nil? %>	
                  <% if @student.photo.exists? %>
                      <% @profile_image.gsub! '?', '.?' %>
                  <% else %>
                      <% @profile_image = "master_student/profile/default_student.png" %>
                  <% end %>
              <% end %>
            <% else %>
              <% @profile_image = "master_student/profile/default_student.png" %>
            <% end %>
            <%= image_tag "#{@profile_image}" %>
            <% if @student.photo.file? %>
            <% if @current_user.admin? or permitted_to? :remove_photo, :student %>
            <div class="image-delete-link" />
               <%= link_to '<img src="/images/buttons/delete-new.png" />', {:controller => 'student', :action => 'remove_photo', :id => @student.id}, :confirm => "Do you realy want to remove this photo?" %>
            </div>
            <% end %>
            <% end %>

        </div>

        <div id ="student_main_info">
            <div id="student_name" class="f2"><%= @student.full_name %></div>
            <div id="student_class"><%= @student.batch.course.course_name %></div>
        </div>
    </div>

    <div id="personal_info_wrapper">
        <div id="class_info">
          <% if Batch.active.find(:all, :group => "name").length > 1  %>
            <div class="infos">
                <div><%= @student.batch.name %></div>
                <div><%= t('batch_text') %></div>
            </div>
          <% end %>
          <div class="infos">
              <div><%= @student.admission_no %></div>
              <div><%= t('adm_no') %></div>
          </div>
          <div class="infos last">
              <% unless  @student.batch.course.section_name.empty? %>
              <div><%= @student.batch.course.section_name %></div>
              <div><%= t('profile_section_label') %></div>
              <% else %>
              <div> No Section</div>
              <div></div>
              <% end %>

          </div>
      </div>
    </div>
    <div style="clear: both; height:10px;"></div>
    <h2>Student Fee Information</h2>
<% unless MultiSchool.current_school.classpay_enabled %>    
    <hr style="border: 1px solid #ccc;" />
    <b style="display: block;">Fee For: <%= @date.name %></b>
<br />
<% total_fees =0 %>
<% total_payable =0 %>
<%
  advance_fee_particular = []
  unless @fee_collection_advances.nil?
    advance_fee_particular = @fee_collection_advances.map(&:particular_id)
  end
%>
<% fee_collection_name = @date.name %>
  <% if @student.has_dues %>
  <div style="clear: both; height: 4px;"></div>
  <div style="width: 100%; text-align: center; color: #f00;">***Please pay previous due first***</div>
  <div style="clear: both; height: 10px;"></div>
  <% end %>
  <% form_remote_for :fees, :url => {:controller => 'student',:action => 'fee_details',:id => @student.id,:id2 => @date.id}, :html => {:id => "fees_form"}, :before=>"prev_double();$('loader_pay').show();",:complete=>"set_back();$('loader_pay').hide();" do |form| %>
  <% unless @fee_particulars.nil? %>
    <% total_fees = 0  %>
    <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
      <thead><!-- class="thead-inverse" -->
        <tr>
          <th style="font-weight: normal; width: 8%; text-align: center;"><%= t('sl_no') %> </th>
          <th style="font-weight: normal; width: 50%; text-align: left;"><%= t('particulars') %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= t('amount') %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= "Paid" %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= "Remaining" %></th>
        </tr>
      </thead>
      <% i = 0 %>
      <tbody>
      <% fee_ids = [] %>
      <% @fee_particulars.each do |fee| %>
        <% unless fee_ids.include?(fee.id) %>  
        <% fee_particular_child = FinanceFeeParticular.find(:first, :conditions => "parent_id = #{fee.id} and receiver_type = 'Student' and receiver_id = #{@student.id}") %>  
        <% unless fee_particular_child.blank? %>  
        <% fee = fee_particular_child %>  
        <% fee_ids << fee_particular_child.id %>  
        <% end %>  
        <%  if fee.name.downcase != 'vat' %>
        <tr id="particular_<%= fee.id %>" class="particulars_tr">
            <% paidAmount = 0 %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
            
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% else %>
             <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% month = 1 %>
            <% start_month = "" %>
            <% end_month = "" %>
            <% unless @fee_collection_advances.nil? %>
              <% @fee_collection_advances.each do |fee_collection_advance| %>
                <% if fee_collection_advance.particular_id == fee.finance_fee_particular_category_id %>
                  <% month = fee_collection_advance.no_of_month.to_i %>
                  <% start_month = fee_collection_advance.start_month %>
                  <% end_month = fee_collection_advance.end_month %>
                <% end %>
              <% end %>
            <% end %>
            <% if @self_advance_fee %>
            <% fee_amount = (fee.amount * month.to_i).to_f - paidAmount %>
            <% else %>
            <% fee_amount = fee.amount - paidAmount %>
            <% end %>
            <% fee_amount = 0 if fee_amount < 0 %>
            <td class="col-1" style=" text-align: center;">
                <input type="hidden" name="fee_category_<%= fee.id %>" class="fee_category" id="fee_category_<%= fee.id %>" value="<%= fee.finance_fee_particular_category_id  %> " />
                <% if fee_amount > 0 %>
                <% if @self_advance_fee %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% else %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-square-o" style="color: #598A3D; font-size: 16px; cursor: pointer; color: #999;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% else %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% end %>
                <% end %>
                <% else %>
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% end %>
            </td>
            <td class="col-6">
              <%= fee.name %>
              <% if transport_particular_id.to_i == fee.finance_fee_particular_category_id.to_i %>
                <% unless fee.description.blank? %>
                <br /><small>(<%= fee.description.gsub("---","</b>").gsub("--","<b>") %>)</small>
                <% end %>
              <% end %>  
              <% if @self_advance_fee %>
                <br />(<small><%= month %> Month Advances</small>)
                <br /><small>(<%= start_month %> to <%= end_month %>)
              <% else %>
                   <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                    <br /><small>(Set for Advance Payment)</small>
                    <br />(<small><%= month %> Month Advances</small>)
                   <% end %>
              <% end %>  
            </td>
            <% if @self_advance_fee %>
            <td class="col-6" style="text-align: right;">(<%= precision_label fee.amount %> <%= "x " + month.to_s  %>)</td>
            <% else %>
              <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
              <td class="col-6" style="text-align: right;">(<%= precision_label fee.amount %> <%= "x " + month.to_s  %>)</td>
              <% else %>
              <td class="col-6" style="text-align: right;"><%= precision_label fee.amount %></td>
              <% end %>
            <% end %>
            <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %></td>
            <td class="col-6" style="text-align: right;">
                <% if fee_amount > 0 %>
                <% if @self_advance_fee %>
                <span style="color: #000;"> <span style="color: #000;"><%= precision_label fee_amount %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <% else %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                <span style="cursor: pointer; color: #999;"> <span style="color: #999;"><%= precision_label ( fee_amount.to_f * month.to_i) %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <% else %>
                <span class="fee_amount_particular editable"  name="fee_amount_particular_<%= fee.id %>" id="fee_amount_particular_<%= fee.id %>" style="color: #000;"><i class="fa fa-pencil" style="font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label fee_amount %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <% end %>
                <% end %>
                <% else %>
                0.00&nbsp;&nbsp;&nbsp;
                <% end %>
            </td>
        </tr>
        <% end %>
        <% if !(@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) )) %>
        <% total_fees += fee_amount %>
        <% total_payable += fee.amount %>
        <% elsif @self_advance_fee and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id)) %>
        <% total_fees += fee_amount %>
        <% total_payable += fee.amount %>
        <% end %>
        <% end %>
      <% end %>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_amount') %> </td>
        <td class="col-6" style="text-align: right;">
            <span id="fee_total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
            <input type="hidden" name="fee_total_amount" id="fee_total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
        </td>
      </tr>   
      
      <% unless @total_discount == 0 %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-1" ></td>
          <td class="col-1" colspan="4"><span class="themed_text"><%= t('discount') %></span></td>
        </tr>
        <% discount_total = 0 %>
        
        <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
          <% @onetime_discounts.each do |d| %>
            <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
              <% discount_amount = @onetime_discounts_amount[d.id] %>
            <% else %>
              <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
            <% end %>
            <% paidAmount = 0 %>
            <% discountPaid = false %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
               <% unless paidFess.blank? %> 
               <% discountPaid = true %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% end %>
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                        <% unless paidFess.blank? %> 
                        <% discountPaid = true %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% if discountPaid %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <% total_payable -= paidAmount %>
            </tr>  
            <% else %>
            <% discount_enable = true %>
            <% unless @paid_fees.blank? %>
              <% if d.finance_fee_particular_category_id == 0 %>
                <% if discount_amount > total_fees  %>
                <% discount_enable = false %>
                <% end %>
              <% else %>
              <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
              <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
              <% paidAmount = 0 %>
              <% finance_particular.each do |fee| %>
                <%  if fee.name.downcase != 'vat' %>
                  <% transaction_ids = @paid_fees.map(&:id) %> 
                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                  <% if !@self_advance_fee and @fee_has_advance_particular %>
                    <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                      <% unless @fee_collection_advances.nil? %>
                        <% unless @fee_collection_advances.nil? %>
                          <% @fee_collection_advances.each do |fee_collection_advance| %>
                            <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                            <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                            <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                            <% @paid_advance_fees = @advance_fees.finance_transactions %>
                            <% unless @paid_advance_fees.blank? %>
                              <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                              <% unless paidFess.blank? %> 
                              <% discountPaid = true %>
                              <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
              <% remaining_amount = amount_to_paid - paidAmount %>
              <% if discount_amount > remaining_amount  %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if discount_enable %>
              <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
              <% if !@self_advance_fee %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if @adv_fee_discount && @actual_discount == 0 %>
              <% discount_enable = false %>
            <% end %>
            <% if discount_enable %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1" style=" text-align: center;">
                <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %> " />  
                <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;">
                  <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label discount_amount %></span></span>
                  <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                  <% discount_total += discount_amount %>
              </td>
            </tr>
            <% else %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1" style=" text-align: center;">
                <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
            </tr>
            <% end %>
            <% end %>
            <% #i += 1 %>
          <% end %>
        <% end %>  
        <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
          <% @discounts.each do |d| %>
            <% unless @discounts_amount[d.id].nil? or @discounts_amount[d.id].blank? %>  
              <% discount_amount = @discounts_amount[d.id] %>
            <% else %>
              <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
            <% end %>
            <% paidAmount = 0 %>
            <% discountPaid = false %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
               <% unless paidFess.blank? %> 
               <% discountPaid = true %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% end %>
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                        <% unless paidFess.blank? %> 
                        <% discountPaid = true %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% if discountPaid %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <% total_payable -= paidAmount %>
            </tr>  
            <% else %>
            <% discount_enable = true %>
            <% unless @paid_fees.blank? %>
              <% if d.finance_fee_particular_category_id == 0 %>
                <% if discount_amount > total_fees  %>
                <% discount_enable = false %>
                <% end %>
              <% else %>
              <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
              <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
              <% paidAmount = 0 %>
              <% finance_particular.each do |fee| %>
                <%  if fee.name.downcase != 'vat' %>
                  <% transaction_ids = @paid_fees.map(&:id) %> 
                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                  <% if !@self_advance_fee and @fee_has_advance_particular %>
                    <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                      <% unless @fee_collection_advances.nil? %>
                        <% @fee_collection_advances.each do |fee_collection_advance| %>
                          <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                          <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                          <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                          <% @paid_advance_fees = @advance_fees.finance_transactions %>
                          <% unless @paid_advance_fees.blank? %>
                            <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                            <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                            <% unless paidFess.blank? %> 
                            <% discountPaid = true %>
                            <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
              <% remaining_amount = amount_to_paid - paidAmount %>
              <% if discount_amount > remaining_amount  %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if discount_enable %>
              <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
              <% if !@self_advance_fee %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if @adv_fee_discount && @actual_discount == 0 %>
              <% discount_enable = false %>
            <% end %>
            <% if discount_enable %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1" style=" text-align: center;">
                <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %> " />  
                <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;">
                  <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label discount_amount %></span></span>
                  <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                  <% discount_total += discount_amount %>
              </td>
            </tr>
            <% else %>
            <tr class="<%= cycle("odd","even") %>">
              <td class="col-1" style=" text-align: center;">
                <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
            </tr>
            <% end %>
            <% end %>
            <% #i += 1 %>
          <% end %>
        <% end %>

        <% if @paid_fees.blank? or discount_total > 0 %>    
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_discount') %> </td>
          <td class="col-6" style="text-align: right;">
              <span id="discount_total_amount_label" style="color: #000;"><%= precision_label(discount_total) %></span>
              <input type="hidden" name="discount_total_amount" id="discount_total_amount" value="<%= precision_label(discount_total) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>
        </tr>
        <% end %>

        <% unless @vat.nil? and @paid_fees.blank? %>
        <% if @vat.to_f == 0.00 %>
          <% vat_amount = 0 %>
          <% @paid_fees.each do |trans| %>
          <% if trans.vat_included %>
              <% if trans.vat_amount.to_f > 0.00 %>
                <%  vat_amount += trans.vat_amount.to_f %>
              <% end %>
          <% end %>
          <% end %>
          <% @vat = vat_amount %>
        <% end %>
        <% if @vat.to_f > 0.00 %>
        <tr id="vat_as_particular_blank_space_1" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_2" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_3" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_4" class="tr-blank"></tr>
        <tr id="vat_as_particular" class="<%= cycle("odd","even") %>">
          <% paidAmount = 0 %>
          <% unless @paid_fees.blank? %>
             <% transaction_ids = @paid_fees.map(&:id) %> 
             <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'VAT' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
             <% unless paidFess.blank? %> 
             <% discountPaid = true %>
             <% paidAmount += paidFess.map(&:amount).sum.to_f %>
             <% end %>
          <% end %>  
          <% remaining_amount = @vat.to_f - paidAmount  %>
          <% if remaining_amount < 0 %>  
            <% remaining_amount = 0 %>
          <% end %>  
          <% if remaining_amount == 0 %>  
            <% if @vat.to_f < paidAmount %>
              <% @vat = paidAmount %>
            <% end %>
            <td class="col-1 sl_no" style=" text-align: center;">
              <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2"><%= "VAT" %></td>
            <td class="col-2" style="text-align: right;"><%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;</td>
            <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
            <td class="col-2" style="text-align: right;"><%= precision_label remaining_amount.to_f %>&nbsp;&nbsp;&nbsp;</td>
          <% else %>  
            <% if @vat_as_particular %>
              <td class="col-1" style="text-align: center;">
                  <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                  <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2">
                  <span class="themed_text"><%= "VAT" %></span>
              </td>
              <td class="col-6" style="text-align: right;">
                  <%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;
              </td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;">
                <% if paidAmount > 0 %>  
                  <span class="only_enable_vat" name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><span style="color: #000;"><%= precision_label remaining_amount.to_f %></span></span>&nbsp;&nbsp;&nbsp;
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label remaining_amount.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" />
                <% else %>
                  <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @vat.to_f %></span></span>
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                  <% if @vat_as_particular == false and paidAmount == 0 %>
                  <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                      <br />Assign to the Student
                  </span>
                  <% end %>
                <% end %>
              </td>
            <% else %>
              <% if paidAmount > 0 %>
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2"><%= "VAT" %></td>
              <td class="col-2" style="text-align: right;"><%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
              <% else %>
              <td class="col-1" style="text-align: center;">
                  <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                  <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2">
                  <span class="themed_text"><%= "VAT" %></span>
              </td>
              <td class="col-6" style="text-align: right;">
                  <%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;
              </td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;">
                  <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @vat.to_f %></span></span>
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                  <% if @vat_as_particular == false and paidAmount == 0 %>
                  <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                      <br />Assign to the Student
                  </span>
                  <% end %>
              </td>
              <% end %>
            <% end %>
          <% end %>
        </tr>
        <% total_fees += remaining_amount %>
        <% total_payable += @vat.to_f %>
      <% end %>
      <% end %>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>  
      <% load_fine_amount_to_pay = false %>
      <% total_fees = (total_fees-discount_total)%>
      <% total_payable = (total_payable-discount_total)%>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_fees') %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
              <input type="hidden" name="total_amount" id="total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>
      </tr>
      <% end %>

      <% fine_paid = false %>
      <% unless @fine_rule%>
        <% unless @paid_fees.blank? %>
          <% paidAmount = 0 %>
          <% unless @paid_fees.blank? %>
            <% transaction_ids = @paid_fees.map(&:id) %> 
            <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
            <% unless paidFess.blank? %> 
            <% paidAmount += paidFess.map(&:amount).sum.to_f %>
            <% end %>
          <% end %>  
          <% if paidAmount > 0 %>
            <% fine_paid = true %>
            <% @fine = paidAmount %>
          <% end %>
        <% end %>
      <% end %>
      
      <% unless @fine.nil? %>
        <% if @fine.to_f > 0.00 %>
        <tr id="fine_blank_space_1" class="tr-blank"></tr>
        <tr id="fine_blank_space_2" class="tr-blank"></tr>
        <tr id="fine_blank_space_3" class="tr-blank"></tr>   
        <tr id="fine_blank_space_4" class="tr-blank"></tr>   
        <% if fine_paid %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
              <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2"><span class="themed_text">
            <%= t('fine_on') %> <%= @paid_fees.first.transaction_date %></span>
          </td>
          <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
          <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label 0 %>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <% else %>
        <% if total_fees > 0 %>
          <% total_fees += @fine.to_f %>
          <tr id="extra_fine" class="<%= cycle("odd","even") %>">
            <td class="col-1" style="text-align: center;">
                <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @fine.to_f %>">
                <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2"><span class="themed_text">
              <%= t('fine_on') %> <%= Date.today %></span>
              <span id="rm_fine" style="float: right; cursor: pointer;">
                  <i class="fa fa-minus-circle remove_fine" style="font-size: 20px; color: #990A10; " aria-hidden="true"></i>
              </span>
            </td>
            <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
            <td class="col-2"  style="text-align: right;"><%= precision_label 0 %></td>
            <td class="col-6"  style="text-align: right;">
                <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @fine.to_f %></span></span>
                <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @fine.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine) %>" /><i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <% load_fine_amount_to_pay = true %>
            </td>
          </tr>
        <% end %>
        <% end %>
      <% end %>
      <% end %>
      <%total_fees1=total_fees%>
      <% fine_amount_total = 0 %>  
      <%if @fine_rule%>
        <tr id="fine_blank_space_1" class="tr-blank"></tr>
        <tr id="fine_blank_space_2" class="tr-blank"></tr>
        <tr id="fine_blank_space_3" class="tr-blank"></tr>   
        <tr id="fine_blank_space_4" class="tr-blank"></tr>
        <% paidAmount = 0 %>
        <% fine_discount = 0 %>
        <% if @has_fine_discount %>    
        <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
          <% @discounts_on_lates.each do |d| %>
            <% if @discounts_late_amount[d.id] > 0 %>
              <% fine_discount += @discounts_late_amount[d.id] %>
            <% end %>
          <% end %>
        <% end %>
        <% end %>
        <% new_fine = @new_fine_amount.to_f - fine_discount.to_f %>
        <% unless @paid_fees.blank? %>
           <% transaction_ids = @paid_fees.map(&:id) %> 
           <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
           <% unless paidFess.blank? %> 
           <% paidAmount += paidFess.map(&:amount).sum.to_f %>
           <% end %>
        <% end %>  
        <% remaining_amount = new_fine.to_f - paidAmount.to_f  %>
        <% if remaining_amount <= 0 %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
             <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2">
            <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
          </td>
          <td class="col-6"  style="text-align: right;"><%= precision_label new_fine %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <% else %>
        <% if paidAmount > 0 %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
              <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label remaining_amount %>">
              <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2">
            <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
          </td>
          <td class="col-6"  style="text-align: right;"><%= precision_label @new_fine_amount %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
          <td class="col-6"  style="text-align: right;">
              <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label remaining_amount %></span></span>
              <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label remaining_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
              <% fine_amount_total += remaining_amount %>  
          </td>
        </tr>
        <% else %>
        <% if total_fees > 0 %>
          <tr id="extra_fine" class="<%= cycle("odd","even") %>">
            <td class="col-1" style="text-align: center;">
                <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @new_fine_amount %>">
                <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2">
              <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
            </td>
            <td class="col-6"  style="text-align: right;"><%= precision_label @new_fine_amount %></td>
            <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
            <td class="col-6"  style="text-align: right;">
                <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @new_fine_amount %></span></span>
                <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @new_fine_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                <% fine_amount_total += @new_fine_amount %>  
            </td>
          </tr>
        <% end %>
        <% end %>
        <% end %>
      <%end%>
      <% fine_discount = 0 %>  
      <% if @has_fine_discount %>    
        <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
          <% @discounts_on_lates.each do |d| %>
            <% if @discounts_late_amount[d.id] > 0 %>
              <% paidAmount = 0 %>
              <% unless @paid_fees.blank? %>
                <% transaction_ids = @paid_fees.map(&:id) %> 
                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'FineAdjustment' and transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = '#{d.id}'") %>
                <% unless paidFess.blank? %> 
                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                <% end %>
             <% end %>  
             <% remaining_amount = @discounts_late_amount[d.id].to_f - paidAmount.to_f  %>
             <% if paidAmount > 0 %>
             <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2" colspan="2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
             <% else %>
              <% if fine_amount_total > @discounts_late_amount[d.id] %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <input type="checkbox" name="fee_fine_discount_<%= d.id %>" id="fee_fine_discount_<%= d.id %>" class="fee_fine_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label @discounts_late_amount[d.id] %>">
                    <i name="fee_fine_discount_fa_<%= d.id %>" id="fee_fine_discount_fa_<%= d.id %>" class="fa fa-check-square-o fee_fine_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;">
                    <span class="fee_fine_amount_discount editable"  name="fee_fine_amount_discount_<%= d.id %>" id="fee_fine_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @discounts_late_amount[d.id] %></span></span>
                    <input type="hidden" name="fee_fine_discount_amount_<%= d.id %>" id="fee_fine_discount_amount_<%= d.id %>" value="<%= precision_label @discounts_late_amount[d.id] %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine_discount')" onkeydown="checkKey(event,this, 'fine_discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine_discount" name="fee_fine_discount_chk_<%= d.id %>" id="fee_fine_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px;  display: none;" aria-hidden="true"></i>
                    <% fine_discount += @discounts_late_amount[d.id] %>  
                </td>
              </tr>
              <% else %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2" colspan="2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label 0.00 %></td>
                <td class="col-6" style="text-align: right; text-decoration: line-through;"><%= precision_label @discounts_late_amount[d.id] %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
              <% end %>
              <% end %>
            <% end %>
            <% i += 1 %>
          <% end %>
        <% end %> 
        <% @fine_amount = fine_amount_total - fine_discount %>      
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>&nbsp;&nbsp;&nbsp;
              <% if load_fine_amount_to_pay == false %>
              <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
              <% load_fine_amount_to_pay = true %>
              <% end %>
          </td> 
        </tr>
      <% else %>  
        <% @fine_amount = fine_amount_total - fine_discount %>      
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
          <td class="col-6" style="text-align: right;">
              <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>
              <% if load_fine_amount_to_pay == false %>
              <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
              <% end %>
          </td> 
        </tr>
      <% end %>
      <% total_fees += fine_amount_total.to_f %>  
      <% unless @paid_fees.nil? %>
        <% paid=0 %>
        <% @paid_fees.each{|a| paid += a.amount.to_f} %>
        <%
          fine_amount_paid = 0.0
          paid_fine = 0.0
          unless @paid_fees.blank?
            transaction_ids = @paid_fees.map(&:id)
            unless transaction_ids.blank?
              paidFineFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")")
              unless paidFineFess.blank?
                paid_fine += paidFineFess.map(&:amount).sum.to_f
              end
            end
            unless @fine_amount == 0
              fine_amount_paid = @fine_amount
            else
              unless @new_fine_amount.blank?
                fine_amount_paid = @new_fine_amount
              else
                fine_amount_paid = 0
              end
            end
            unless paid_fine.nil?
              paid_fine = paid_fine - fine_amount_paid
            end
          else
            fine_amount_paid = @fine_amount
          end
          total_payable += fine_amount_paid.to_f
        %>
        <%
          advance_amount_paid = 0.0
          unless @paid_fees.nil? or @paid_fees.blank?
            transaction_ids = @paid_fees.map(&:id)
            unless transaction_ids.blank?
              paidAdvanceFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")")
              unless paidAdvanceFess.blank?
                advance_amount_paid += paidAdvanceFess.map(&:amount).sum.to_f
              end
            end
          end
          amount_advanced = advance_amount_paid
        %>
        <% if amount_advanced > 0 %>
        <%# amount_advanced = paid - ( total_payable + paid_fine ) %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><b><%= "Payment Done" %></b></td>
          <td class="col-6"  style="text-align: right;">
              <span id="remaining_amount_label" style="color: #000;"><%= precision_label(paid) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>  
        </tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><b><%= "Advanced Payment" %></b></td>
          <td class="col-6"  style="text-align: right;">
              <span id="remaining_amount_label" style="color: #000;"><%= precision_label(amount_advanced) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>  
        </tr>
        <% end %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= "Fees Information" %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="total_payable_label" style="color: #000;"><%= precision_label(total_payable) %></span>
              <input type="hidden" name="total_payable" id="total_payable" value="<%= precision_label(total_payable) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>  
          <td class="col-6"  style="text-align: right;">
              <span id="payment_done_label" style="color: #000;"><%= precision_label(paid - amount_advanced) %></span>
              <% if amount_advanced > 0 %>
                &nbsp;&nbsp;&nbsp;<br />
                <span id="payment_done_label" style="color: #000;">&nbsp;+&nbsp;<%= precision_label(amount_advanced) %></span>&nbsp;&nbsp;&nbsp;<br /><hr style="border: 1px solid #ccc;" />
                <span id="payment_done_label" style="color: #000;"><%= precision_label(paid) %></span>
              <% end %>
              <input type="hidden" name="payment_done" id="payment_done" value="<%= precision_label(paid) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>  
          <td class="col-6"  style="text-align: right;">
              <span id="remaining_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
              <input type="hidden" name="remaining_amount" id="remaining_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
          </td>  
        </tr>
      <% end %>
      
      <%balance=@financefee.balance.to_f+@fine.to_f+@vat.to_f%>
      <% if balance.to_f < 0 %>  
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('advance_payment') %>1 </td>
        <td class="col-6"  style="text-align: right;">
            <span id="advance_payment_label" style="color: #000;"><%= precision_label( (balance+@fine_amount.to_f) * -1 ) %></span>
            <input type="hidden" name="advance_payment" id="advance_payment" value="<%= precision_label( (balance+@fine_amount.to_f) * -1 ) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
        </td>
      </tr>  
      <% else %>  
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
        <% fee_to_pay = 0 %>  
        <% unless precision_label(balance+@fine_amount.to_f).to_f == 0 %>
          <% fee_to_pay = balance+@fine_amount.to_f %>
        <% end %>
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('amount_to_pay') %> </td>
        <td class="col-6"  style="text-align: right;">
            <span id="amount_to_pay_label" style="color: #000;"><%= precision_label(total_fees) %></span>
            <input type="hidden" name="amount_to_pay" id="amount_to_pay" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
        </td>  
      </tr>
      <% end %>
      
      <script type="text/javascript">
        j(document).ready(function(){
            if ( j("#remaining_amount").length > 0 )
            {
                if ( parseFloat(j("#remaining_amount").val()) <= 0 )
                {

                    j(".fine_info").remove();
                }
            }
        });
      </script>
      <% under_maintenance = false %>
      <% if MultiSchool.current_school.id == 352 %>
      <% @student_has_due = false %> 
      <% end %>
      <% if MultiSchool.current_school.id == 357 and !@current_user.admin? %>
        <% if @student.id != 44129 %>
        <% #@student_has_due = true %>
        <% end %>
      <% end %>
      <% if MultiSchool.current_school.id == 2461 %>
        <% unless @current_user.admin? %>
          <% under_maintenance = true %>
        <% end %>
      <% end %>
      <% prev_dues_school = [312] %>
      <% prev_dues_school = PaymentNewConfiguration.config_value("previous_dues") %>
      <%
        prev_dues_school = prev_dues_school.split(",").map(&:to_i) unless prev_dues_school.blank?
        prev_dues_school ||= Array.new
      %>
      <% unless prev_dues_school.include?(MultiSchool.current_school.id) %>
      <% @student_has_due = false %>
      <% end %>
      <% if @student_has_due == false #and @financefee.batch_id == @student.batch_id %>
        <%#= total_fees.to_s + " DID DID DID" %>
        <% if total_fees > 0 and under_maintenance == false  %>
            <% @amount_to_pay = precision_label(balance+@fine_amount.to_f) %> 
            <% unless combine_fees_enabled %>
            <tr>
              <td colspan="5" style="padding-bottom: 30px;">
                  <div class="pay_fees"><div class="pay_fees_buttons" style="position: relative;">
                  <input type="hidden" name="user_gateway" id="user_gateway" value="<%= @gateway_settings.keys[0].to_s %>" />
                  <input type="hidden" name="order_id" id="order_id" value="<%= @order_id %>" />                
                  <% if @gateway_settings.length == 1 %>
                    <% if @gateway_settings.keys.include?('bkash') %>
                      <i class='fa fa-spin fa-spinner loading_single_bkash' style="position: absolute; right: 10px; top: 5px; display: none;"></i>
                      <span style="float: right; display: block; padding-right: 80px; padding-bottom: 5px; font-size: 16px; width: 100%; text-align: right; color: #000;">Pay With</span><br />
                      <%= image_tag "/images/bkash-logo.png", :class => "gateway_image_single_bkash", :id => "pay_fees_multiple", :style => "", :onclick => "initBkash(this);" %>
                      <!--button type="button" id="pay_fees_multiple" class="submit_button"><%#= "► #{t('pay_fees')}" %></button-->
                    <% else %>
                    <%= submit_tag "► #{t('pay_fees')}",:class=>'submit_button' , :id => 'submit_button' %>
                    <% end %>
                  <% else %>
			<% if MultiSchool.current_school.id == 352 %>
		      <div style="width: 100%; float: right; text-align: right;">
			<% @gateway_settings.keys.each do |key| %>
                            <% if key == "trustbank" %>
			      <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                  <input type="radio" id="radio_<%= key %>" name="gateway_radio" class="gateway_radio" value="<%= key %>" style="position: absolute; top: 0; right: 4px;" autocomplete="off" />
                                  <%= image_tag "/images/gateway_images/#{key}-ico.png", :class => "gateway_image", :id => "#{key}", :style => "vertical-align: baseline; #{key == 'citybank' ? 'height:70px;' : 'height: 65px;'}" %>
                              </div>
                            <% end %>
                        <% end %>
			<% @gateway_settings.keys.each do |key| %>
                            <% if key == "citybank" %>
                            <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                <input type="radio" id="radio_<%= key %>" name="gateway_radio" class="gateway_radio" value="<%= key %>" style="position: absolute; top: 0; right: 4px;" autocomplete="off" />
                                <%= image_tag "/images/gateway_images/#{key}-ico.png", :class => "gateway_image", :id => "#{key}", :style => "vertical-align: baseline; #{key == 'citybank' ? 'height:70px;' : 'height: 65px;'}" %>
                            </div>
                            <% end %>
                        <% end %>
                        <% @gateway_settings.keys.each do |key| %>
                            <% if key == "bkash" %>
                            <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                <i class='fa fa-spin fa-spinner loading_single_bkash' style="position: absolute; right: 10px; top: 5px; display: none;"></i>
                                <%= image_tag "/images/bkash-logo.png", :class => "gateway_image_single_bkash", :id => "pay_fees_multiple", :style => "padding: 0;", :onclick => "j('#user_gateway').val('bkash'); initBkash(this);" %>
                            </div>
				<% end %>	
                        <% end %>
                      </div>
			<% else %>	
                      <div style="width: 100%; float: right; text-align: right;">
                        <% @gateway_settings.keys.each do |key| %>
                            <% if key == "citybank" %>
                            <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                <input type="radio" id="radio_<%= key %>" name="gateway_radio" class="gateway_radio" value="<%= key %>" style="position: absolute; top: 0; right: 4px;" autocomplete="off" />
                                <%= image_tag "/images/gateway_images/#{key}-ico.png", :class => "gateway_image", :id => "#{key}", :style => "vertical-align: baseline; #{key == 'citybank' ? 'height:70px;' : 'height: 65px;'}" %>
                            </div>
                            <% end %>
                        <% end %>
                        <% @gateway_settings.keys.each do |key| %>
                            <% if key == "bkash" %>
                            <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                <i class='fa fa-spin fa-spinner loading_single_bkash' style="position: absolute; right: 10px; top: 5px; display: none;"></i>
                                <%= image_tag "/images/bkash-logo.png", :class => "gateway_image_single_bkash", :id => "pay_fees_multiple", :style => "padding: 0;", :onclick => "j('#user_gateway').val('bkash'); initBkash(this);" %>
                            </div>
                            <% else %>
                              <% unless key == "citybank" %>
                              <div class="gateway_image_panel" data-gateway="<%= key %>" style="position: relative;">
                                  <input type="radio" id="radio_<%= key %>" name="gateway_radio" class="gateway_radio" value="<%= key %>" style="position: absolute; top: 0; right: 4px;" autocomplete="off" />
                                  <%= image_tag "/images/gateway_images/#{key}-ico.png", :class => "gateway_image", :id => "#{key}", :style => "vertical-align: baseline; #{key == 'citybank' ? 'height:70px;' : 'height: 65px;'}" %>
                              </div>
                              <% end %>
                            <% end %>
                        <% end %>
                      </div>    
			<% end %>
                      <button type="button" id="pay_fees_multiple" class="submit_button" disabled style="display: none;"><%= "► #{t('pay_fees')}" %></button>
                      <%= submit_tag "► #{t('pay_fees')}",:class=>'submit_button submit_pay' , :id => 'submit_button_multiple', :style=>"display: none;" %>
                  <% end %>
                  <% style = "" %>    
                  <% if @gateway_settings.length == 1 %>
                    <% if @gateway_settings.keys.include?('bkash') or @gateway_settings.keys.include?('citybank') %>
                      <% style = "padding: 14px 10px; margin: 18px 10px 0 !important;" %>    
                    <% end %>
                  <% end %>    
                <%# if @gateway_settings.length == 1 %>
                    <% if @gateway_settings.keys.include?('bkash') or @gateway_settings.keys.include?('citybank') %>
                      <%
                        if @gateway_settings.keys.include?('citybank')
                          no_charge_apply = [312] 
                          no_charge_apply = PaymentNewConfiguration.config_value("no_charge_apply_citybank") 

                          no_charge_apply = no_charge_apply.split(",").map(&:to_i) unless no_charge_apply.blank?
                          no_charge_apply ||= Array.new
                        end
                        if @gateway_settings.keys.include?('bkash')
                          no_charge_apply = [312] 
                          no_charge_apply = PaymentNewConfiguration.config_value("no_charge_apply_bkash") 

                          no_charge_apply = no_charge_apply.split(",").map(&:to_i) unless no_charge_apply.blank?
                          no_charge_apply ||= Array.new
                        end
                      %>
                      <% unless no_charge_apply.include?(MultiSchool.current_school.id) %>
			<% charge = "1.5% " %>
			<% sttr = "*" %>
			<% width = "100%" %>
			<% text_align = "right" %>
			<% extra = "" %>
			<% if MultiSchool.current_school.id == 352 %>
				<% charge = "" %>
			<% end %>
			<% if MultiSchool.current_school.id == 361 %>
                                <% charge = "1. " %>
				<% sttr = "" %>
				<% width = "40%; line-height: 30px" %>
				<% text_align = "left" %>
				<% extra = "2. Bkash - 1.5% of transaction value <br />3. 3. T-Cash = TK 10/00 (Fixed) Only <br />4. TBL Card = TK 10/00 (Fixed) Only <br /> <b>For TBL Card and T-Cash please click T-Cash logo</b>"%>
                        <% end %>
                        <span style="float: right; display: block; padding-top: 8px; width: <%= width %>; text-align: <%= text_align %>; color: #000;"><%= sttr %><%= charge%>convenience fee applicable.<br /><%= extra%></span>
                      <% end %>
                      <% if @gateway_settings.length == 1 and @gateway_settings.keys.include?('citybank') %>  
                        <%= image_tag "/images/card.png", :class => "", :id => "", :style => "float: right;" %>  
                      <% end %>  
                    <% end %>
                  <%# end %>  
		  <div style="width: 100%; float: right;">
                   <% if MultiSchool.current_school.id != 352 and MultiSchool.current_school.id != 2 %>  
                        <%= link_to "► #{t('print_receipt')}",
                           {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id},:target => '_blank', :class=> 'user_button', :style=> style + "; width: 20%;" %>
                   <% end %>       
		  </div>
                  </div></div>  
              </td>
            </tr>
            <% end %>
        <% else %>
            <% if under_maintenance %>
            <tr><td colspan="5" style="padding-bottom: 30px;">
                <div class="pay_fees"><div class="pay_fees_buttons">
                <img src="/images/under-maintenance.png" style="width: 150px; float: right;" /> 
                </div></div>  
            </td></tr>
            <% end %>
        <% end %>
      <% else %>
            <% if MultiSchool.current_school.id == 357 and !@current_user.admin? %>
             <tr>
                <td colspan="5">
                  <center><font color="red">***Online Payment is currently Disabled***</font></center> 
                </td>
            </tr>  
            <% else %>
              <% if @financefee.batch_id != @student.batch_id and total_fees > 0 %>
                <tr>
                    <td colspan="5">
                      <center><font color="red">***Your class or Section has been changes, Please contact admin to update your payment info***</font></center> 
                    </td>
                </tr>    
                <% elsif total_fees > 0 %>
                <tr>
                    <td colspan="5">
                      <center><font color="red">***Student Has Previous Due***</font></center> 
                    </td>
                </tr> 
              <% end %>
            <% end %>
      <% end %>    
    </table>
    <% if @gateway_settings.keys.include?('bkash') or @gateway_settings.keys.include?('citybank')  %>
      <button id="bKash_button" style="display:none;">Pay with bKash</button>
      <% unless params[:multiple].nil? %>
        <% if params[:multiple].to_s == "true" %>
          <input type="hidden" name="fees" id="fees" value="<%= params[:fees] %>" />
          <input type="hidden" name="student_fees" id="student_fees" value="<%= params[:id] %>" />
          <input type="hidden" name="multiple" id="multiple" value="1" />
        <% else %>
          <input type="hidden" name="fees" id="fees" value="<%= @financefee.id %>" />
          <input type="hidden" name="student_fees" id="student_fees" value="<%= params[:id] %>" />
          <input type="hidden" name="multiple" id="multiple" value="0" />
        <% end %>
      <% else %>
        <input type="hidden" name="fees" id="fees" value="<%= @financefee.id %>" />
        <input type="hidden" name="student_fees" id="student_fees" value="<%= params[:id] %>" />
        <input type="hidden" name="multiple" id="multiple" value="0" />
      <% end %> 
    <% end %>
    <% if @student.has_dues %>
    <div style="clear: both; height: 4px;"></div>
    <div style="width: 100%; text-align: center; color: #f00;">***Please pay previous due first***</div>
    <div style="clear: both; height: 10px;"></div>
    <% end %>
  <% end %>
  <% end %>
<% unless @paid_fees.empty? %>
    <div id="payments_details">
      <div class="label-field-pair3">
        <label style="font-size: 22px; margin-left: 0; padding-bottom: 10px;"><%= t('payment_history') %> </label>
      </div>
      <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
        <thead><!-- class="thead-inverse t" -->
        <tr>
          <th><%= t('sl_no') %></th>
          <th style="text-align: center;"><%= t('payment_date') %></th>
          <th style="text-align: center;"><%= t('payment_mode') %></th>
          <th><%= t('payment_notes') %></th>
          <th style="text-align: right;"><%= t('amount') %> (<%= currency %>  )</th>
          <% if MultiSchool.current_school.id == 352 %>
            <th>Action</th>
          <% end %>
        </tr>
        <tbody>
        <% @paid_fees.each_with_index do |f , i| %>
          <tr class="<%= cycle("odd","even") %>">
            <% transaction_payment = false %>
            <% transaction_payment_not_assign = false %>
            <% #if MultiSchool.current_school.id == 352 %>
              <% payment = Payment.find_by_finance_transaction_id_and_payment_id(f.id, @financefee.id) %>
              <% unless payment.present? %>
                <% payment = Payment.find_by_payment_id(@financefee.id) %>
                <% unless payment.nil? %>
                  <% if payment.gateway_response[:amount].to_f == f.amount.to_f %>
                    <% transaction_payment_not_assign = true %>
                  <% end %>
                <% end %>
              <% else %>
                <% transaction_payment = true %>
              <% end %>
            <% #end %>
            <% payment_mode = f.payment_mode %>
            <% if transaction_payment %>
              <% if payment.gateway_txt.downcase == "trustbank" %>
              <% payment_mode = "Trust Bank Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "bkash" %>
              <% payment_mode = "bKash Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "citybank" %>
              <% payment_mode = "Citybank Online Payment" %>
              <% end %>
            <% elsif transaction_payment_not_assign %>
              <% if payment.gateway_txt.downcase == "trustbank" %>
              <% payment_mode = "Trust Bank Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "bkash" %>
              <% payment_mode = "bKash Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "citybank" %>
              <% payment_mode = "Citybank Online Payment" %>
              <% end %>
              <% payment.update_attributes(:finance_transaction_id=>f.id) %>
              <%
                student_fee_ledgers = StudentFeeLedger.find(:all, :conditions => "student_id = #{@student.id} and fee_id = #{@finance_fee.id} and transaction_id = #{f.id} and is_fine = #{true}")
                unless student_fee_ledgers.blank?
                  student_fee_ledgers.each do |student_fee_ledger|
                    unless payment.transaction_datetime.blank?
                      student_fee_ledger.update_attributes(:ledger_date => payment.transaction_datetime.strftime("%Y-%m-%d"), :ledger_title => "Fine On " + payment.transaction_datetime.strftime("%d %B, %Y"))
                    else
                      student_fee_ledger.update_attributes(:ledger_date => f.transaction_date.strftime("%Y-%m-%d"), :ledger_title => "Fine On " + f.transaction_date.strftime("%d %B, %Y"))
                    end
                  end
                end
              
                student_fee_ledger = StudentFeeLedger.find(:first, :conditions => "student_id = #{@student.id} and fee_id = #{@financefee.id} and transaction_id = #{f.id} and is_fine = #{false}")
                unless student_fee_ledger.blank?
                  amount_paid = student_fee_ledger.amount_paid
                  if amount_paid.to_f != f.amount.to_f
                    student_fee_ledger.update_attributes(:amount_paid => f.amount.to_f)
                  end
                else
                  student_fee_ledger = StudentFeeLedger.new
                  student_fee_ledger.student_id = @student.id
                  unless payment.transaction_datetime.blank?
                    student_fee_ledger.ledger_date = payment.transaction_datetime.strftime("%Y-%m-%d")
                  else
                    student_fee_ledger.ledger_date = f.transaction_date.strftime("%Y-%m-%d")
                  end
                  student_fee_ledger.ledger_title = @financefee.finance_fee_collection.title  
                  student_fee_ledger.amount_to_pay = 0.00
                  student_fee_ledger.fee_id = @financefee.id
                  student_fee_ledger.amount_paid = f.amount.to_f
                  student_fee_ledger.transaction_id = f.id
                  student_fee_ledger.order_id = payment.order_id
                  student_fee_ledger.save
                end
              %>
            <% end %>
              
            <td class="col-1"><%= i +=1 %></td>
            <% if transaction_payment || transaction_payment_not_assign %>
              <td class="col-3" style="text-align: center;"><%= I18n.l((payment.transaction_datetime.to_time).to_datetime,:format=>"%d %b %Y<Br /> %I:%M %P") %></td>
            <% else %>
              <td class="col-3" style="text-align: center;"><%= f.transaction_date %></td>
            <% end %>
            <% if transaction_payment || transaction_payment_not_assign %>
              <td class="col-3" style="text-align: left;">
                <%= payment_mode %>
                <hr style="border: 1px solid #ccc;" />
                <div style="font-size: 12px; font-family: verdana;">
                  <h2>Online Payment Info</h2>
                  <p><b>Order ID: </b><%= payment.order_id %></p>
                  <%
                    trans_type = ""
                    if payment.gateway_txt.downcase == "trustbank"
                      if payment.gateway_response[:payment_type] == "MB"
                        trans_type = "TBL Mobile banking"
                      else
                        trans_type = "TBL Card Payment"
                      end
                    end
                  %>
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                  <p><b>Ref Id: </b><%= payment.gateway_response[:ref_id] %></p>
                  <% elsif payment.gateway_txt.downcase == "citybank" %>
                  <p><b>ApprovalCode: </b><%= payment.gateway_response[:Message][:ApprovalCode] %></p>
                  <p><b>Ref Id: </b><%= payment.gateway_response[:Message][:OrderID] %></p>
                  <% elsif payment.gateway_txt.downcase == "bkash" %>
                  <p><b>Payment Id: </b><%= payment.gateway_response[:paymentID] unless payment.gateway_response[:paymentID].blank? %></p>
                  <p><b>Transaction Id: </b><%= payment.gateway_response[:trxID] unless payment.gateway_response[:trxID].blank? %></p>
                  <% end %>
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                  <p><b>Transaction Type: </b><%= trans_type %></p>
                  <% end %>
                  <hr style="border: 1px solid #ccc;" />
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                    <% if payment.gateway_response[:verified].to_i == 1 %>
                      <i class="fa fa-check-circle-o" style="font-size: 18px; color: #49BB4B;"></i>&nbsp;&nbsp;Verified
                    <% else %>
                      <% unless payment.validation_response.nil? %>
                        <% if payment.validation_response[:verified].to_i == 0 %>
                        <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: #900;"></i>&nbsp;&nbsp;<span style="color: #900;">Not Verified</span>
                          </div>
                          <% if @current_user.admin? %>
                          <div style="width: 35%; display: inline-block; text-align: right;">
                            <%= link_to "(verify Now)", {:controller => "online_payments", :action => "order_verifications", :order_tid => payment.order_id},:target => '_blank' %>

                          </div>
                         <% end %>   
                        </div>
                        <% else %>
                        <i class="fa fa-check-circle-o" style="font-size: 18px; color: #49BB4B;"></i>&nbsp;&nbsp;Verified
                        <% end %>
                      <% else %>
                      <div style="width: 100%;">
                        <div style="width: 60%; display: inline-block;">
                          <i class="fa fa-circle-o" style="font-size: 18px; color: #900;"></i>&nbsp;&nbsp;<span style="color: #900;">Not Verified</span>
                        </div>
                        <% if @current_user.admin? %>
                        <div style="width: 35%; display: inline-block; text-align: right;">
                          <%= link_to "(verify Now)", {:controller => "online_payments", :action => "order_verifications", :order_tid => payment.order_id},:target => '_blank' %>

                        </div>
                       <% end %>   
                      </div>
                      <% end %>
                    <% end %>
                    <% elsif payment.gateway_txt.downcase == "bkash" %>
                      <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: <%= (payment.gateway_response[:transactionStatus] == "Completed") ? "#49BB4B" : "#900" %>;"></i>&nbsp;&nbsp;<span style="color: <%= (payment.gateway_response[:transactionStatus] == "Completed") ? "#145214" : "#900" %>;"><%= payment.gateway_response[:transactionStatus]  unless payment.gateway_response[:transactionStatus].blank?  %></span>
                          </div>  
                      </div>
                    <% elsif payment.gateway_txt.downcase == "citybank" %>
                      <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: <%= (payment.gateway_response[:Message][:OrderStatus] == "APPROVED") ? "#49BB4B" : "#900" %>;"></i>&nbsp;&nbsp;<span style="color: <%= (payment.gateway_response[:Message][:OrderStatus] == "APPROVED") ? "#145214" : "#900" %>;"><%= payment.gateway_response[:Message][:OrderStatus]  unless payment.gateway_response[:Message][:OrderStatus].blank?  %></span>
                          </div>  
                      </div>
                    <% end %>    
                    <div style="clear: both; height: 1px;"></div>
                </div>
              </td>
            <% else %>
              <td class="col-3" style="text-align: center;">
                <%= payment_mode %>
              </td>
            <% end %>
            <td class="col-2"><%= f.payment_note %></td>
            <td class="col-3" style="text-align: right;">
              <%= precision_label(f.amount.to_f) %>
            </td>
            <% if MultiSchool.current_school.id == 352 or MultiSchool.current_school.id == 357 %>
              <td>
                <%= link_to "► #{t('print_receipt')}", {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id, :trn_id=>f.id},:target => '_blank', :class=> 'user_button' %>
              </td>
            <% end %>
          </tr>
        <% end %>
        </tbody>
      </table>

    </div>
  <% end %>

</div>
<% if @financefee.is_paid == false %>
  <% if @financefee.balance.to_f != total_fees.to_f %>
    <% ffee = FinanceFee.find(@financefee.id) %>
    <% ffee.update_attributes(:balance => total_fees) %>
    <% if total_fees.to_i == 0 %>
      <% ffee.update_attributes(:is_paid => true) %>
    <% end %>
  <% end %>  
<% else %>
  <% if total_fees.to_f > 0 %>
    <% ffee = FinanceFee.find(@financefee.id) %>
    <% ffee.update_attributes(:balance => total_fees, :is_paid => false) %>
  <% end %>
<% end %>  
<% if @gateway_settings.keys.include?('bkash')  %>
  <div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
            <p style="margin: 1px 0 0; color: #ED1C24;"><i class="fa fa-exclamation-circle" aria-hidden="true" style="color: #ED1C24; margin-right: 8px;"></i>Payment Failed</p>
        </div>
        <div class="modal-body">
            <div style="width: 100%; text-align: center;">
                <h1><i class="fa fa-exclamation-circle" aria-hidden="true" style="color: #ED1C24; font-size: 70px;"></i><br />
                  <label id="error_label" style="font-size: 24px;">Error in payment</label></h1>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="close_pop_failed" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="paymentModalSuccess" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
              <div style="width: 100%; text-align: center;">
                  <h1><i class="fa fa-check" aria-hidden="true" style="color: #49BB4B; font-size: 60px;"></i><br />
                    <label id="success_label" style="font-size: 20px;">Successful Payment</label></h1>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" id="close_pop_success" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
<% end %>
<div class="loading">Loading&#8230;</div>

<style>
    #area-hidden {
        width: 100%;
        height: 100%;
        background-color: #000000;
        opacity: 0.60;
        filter: alpha(opacity=60);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 9999;
    }
    button[disabled]{
        background: #ccc !important;
        color: #000 !important;
    }
    button[disabled]:hover{
        background: #ccc !important;
    }
    <% if @gateway_settings.keys.include?('bkash')  %>
    #bKashFrameWrapper{
        display:none;
        position: fixed;
        overflow-y: scroll;
        z-index: 50000;
        top: 0;
        height: 100%;
        left: 0;
        width: 100%;
        min-height: 600px;
    }
    <% end %>
    .gateway_image_panel{
      /*border: 1px solid #ccc;*/
      border-radius: 5px;
      margin-right: 5px;
      display: inline-block;
      /*-webkit-box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);
      -moz-box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);
      box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);*/
      cursor: pointer;
    }
    .gateway_image{
      height: 65px;
      /*width: 100%;
      -webkit-box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);
      -moz-box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);
      box-shadow: 5px 6px 6px -3px rgba(0,0,0,0.42);*/
      cursor: pointer;
    }
    .gateway_image_single_bkash{
      height:65px;
      border: 1px solid #ccc;
      border-radius: 12px;
      -webkit-box-shadow: 1px 0px 5px -3px rgba(0,0,0,0.42);
      -moz-box-shadow: 1px 0px 5px -3px rgba(0,0,0,0.42);
      box-shadow: 1px 0px 5px -3px rgba(0,0,0,0.42);
      cursor: pointer;
      float: right;
      padding: 5px;
      background: #FFF;
    }
    .gateway_image_single_bkash_disabled{
      background: #e5e5e5;
    }
    .gateway_image_single_bkash:hover{
      background: #e5e5e5;
    }
</style>
<style>
.name{
    color: #999999;
    float: left;
    width: 220px;
    font-weight: bold;
    font-size: 13px;
    height:2px;
}

.details{
    margin-bottom: 45px;
    padding-bottom: 15px;
}
.height-fixer{
    float: left;
    width: 100%;
    min-height:15px;
}
.val {
    width: 750px;
    color: #bb0000;
    font-weight: bold;
    font-size: 13px;
    float: right;
}

.val span{
    margin-right:12px;
    color: black;
}
.val-align{
    float: right;
    width: 730px;
    word-wrap: break-word;
}
.pay_fees_buttons input {
    float: right;
}
.pay_fees_buttons a {
    float: right !important;
    margin: 18px 10px 0 !important;
}
a.user_button {
    padding: 7px 10px;
    color: #fff;
    background: #27292B;
    border-radius: 4px !important;
    -webkit-border-radius: 4px !important;
    -moz-border-radius: 4px !important;
    font-weight: bold;
    font-size: 14px;
    border: none;
    cursor: pointer;
    margin: 0 auto;
    text-decoration: none;
    float: right;
}
.submit_button {
    background: none repeat scroll 0 0 #27292B;
    border: medium none;
    color: #FFFFFF;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    margin: 18px 5px 0 5px;
    padding: 7px 10px;
    height: 34px;
    float: right;
    border-radius: 4px !important;
    -webkit-border-radius: 4px !important;
    -moz-border-radius: 4px !important;
}
.success
{
    padding: 10px 50px;
    background: #00FF00;
    color: black;
}
</style>   
<% else %>
<hr style="border: 1px solid #ccc;" />  
<div id="fee_div">
    <div style="background: url('/images/background_myfees.png'); height: 98px; width: 88%; margin-left: 4%; margin-bottom: 24px; padding: 20px;">
        <img src="/images/Apps-system-software-update-icon.png" style="height: 100%;">
        <h1 style="width: 80%; color: #fff; display: inline-table; padding-left: 13px; vertical-align: top; font-family: verdana; font-size: 22px;">Due to an upgradation of our payment system, you can't able to make any fees payment, Hope we will be back soon. Thanks  </h1>
    </div>

</div>
<% end %>
<%
require "openssl"
require 'digest/sha2'
require 'base64'

alg = "AES-256-CBC"

digest = Digest::SHA256.new
digest.update("symetric key")
key = digest.digest
kkp = [key].pack('m')
iv = OpenSSL::Cipher::Cipher.new(alg).random_iv
iip = [iv].pack('m')

data = @student.id.to_s + "---" + @financefee.id.to_s + "---" + @order_id.to_s

aes = OpenSSL::Cipher::Cipher.new(alg)
aes.encrypt
aes.key = key
aes.iv = iv

cipher = aes.update(data)
cipher << aes.final

encrypted = [cipher].pack('m')
%>
<% if @gateway_settings.keys.include?('bkash')  %>
<form id="data-form-val">
  <input type="hidden" name="total_fees" id="total_fees" value="<%= precision_label total_fees %>" />
  <input type="hidden" name="order_id" id="order_id" value="<%= @order_id.strip unless @order_id.blank? %>" />
  <input type="hidden" name="kmsee" id="kmsee" value="<%= kkp.strip %>" />
  <input type="hidden" name="imsee" id="imsee" value="<%= iip.strip %>" />
  <input type="hidden" name="mmsec" id="mmsec" value="<%= encrypted.strip %>" />
</form>

<%
  fee_percent = 0.00
  fee_percent = total_fees.to_f * (1.5 / 100)

  no_charge_apply_bkash = [312] 
  no_charge_apply_bkash = PaymentNewConfiguration.config_value("no_charge_apply_bkash") 

  no_charge_apply_bkash = no_charge_apply_bkash.split(",").map(&:to_i) unless no_charge_apply_bkash.blank?
  no_charge_apply_bkash ||= Array.new

  unless no_charge_apply_bkash.include?(MultiSchool.current_school.id)
    #total_fees = total_fees + fee_percent
    total_fees = '%.2f' % (total_fees.to_f  / (1 - (1.5/100)))
  end
%>


<% end %>
<script>
    var paymentID;
    var id_token;
    var bkashLoad = false;
    var bkash_clicked = false;
    function initBkash(obj){
        bkash_clicked = true;
        if ( j(obj).hasClass('gateway_image_single_bkash_disabled') )
        {
            bkash_clicked = false;
            return ;
        }
        if ( j("#user_gateway").val() == 'bkash' )
        {
            j('.submit_pay').hide();
            j(obj).addClass('gateway_image_single_bkash_disabled');
            //j(".loading_single_bkash").show();
            j(".loading").show();
            j(obj).prop('disabled',true);
            j(obj).html("<i class='fa fa-spin fa-spinner'></i> Please wait...");

            j(obj).prop('disabled',true);
            j(obj).html("<i class='fa fa-spin fa-spinner'></i> Pay Fees");

            j(obj).attr('id',"pay_fees_multiple_1");

            j.ajax({
                url: '/student/generate_bkash_token',
                type: 'POST',
                data: j("#fees_form").serialize() + "&student_id=<%= @student.id %>&" + j("#data-form-val").serialize(),
                success: function (data) {
                      if ( ! data.keys )
                      {
                          j(".loading").hide();
                          j('#error_label').html(data.errorMessage);
                          j("#paymentModal").modal();
                          j("#bKashFrameWrapper").css('display','none');
                          new Ajax.Request('/student/regenerate_order_id', 
                                {
                                  asynchronous:true, 
                                  evalScripts:true, 
                                  parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                                }
                          )
                          bkash_clicked = false;
                          //alert(data.errorMessage);
                      }
                      else
                      {
                          //id_token = data.id_token;
                          j.ajax({
                              url: '/student/generate_bkash_payment',
                              type: 'POST',
                              data: j("#data-form-val").serialize() + "&gateway=bkash",
                              success: function (data) {
                                    bkash_clicked = false;
                                    //j(".loading_single_bkash").hide();
                                    j(".loading").hide();
                                    j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                                    j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                                    if (data && data.paymentID != null) 
                                    {
                                      bkashLoad = true;
                                      j("#bKashFrameWrapper").css('display','block');
                                      j("#close_pop").trigger('click');
                                      paymentID = data.paymentID; 
                                      bKash.create().onSuccess(data); //pass the whole response data in bKash.create().onSucess() method as a parameter 
                                    } 
                                    else 
                                    { 
                                      j('#error_label').html(data.errorMessage);
                                      j("#paymentModal").modal();
                                      j("#bKashFrameWrapper").css('display','none');
                                      new Ajax.Request('/student/regenerate_order_id', 
                                            {
                                              asynchronous:true, 
                                              evalScripts:true, 
                                              parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                                            }
                                      )
                                      //alert(data.errorMessage);
                                    } 
                              },
                              error: function () {
                                  bkash_clicked = false;
                                  j(".loading").hide();
                                  j('#error_label').html(data.errorMessage);
                                  j("#paymentModal").modal();
                                  j("#bKashFrameWrapper").css('display','none');
                                  new Ajax.Request('/student/regenerate_order_id', 
                                        {
                                          asynchronous:true, 
                                          evalScripts:true, 
                                          parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                                        }
                                  )
                                  //alert(data.errorMessage);
                              }
                          });
                      }
                },
                error: function () {
                    bkash_clicked = false;
                    j(".loading").hide();
                    j('#error_label').html("Error in payment");
                    j("#paymentModal").modal();
                    j("#bKashFrameWrapper").css('display','none');
                    new Ajax.Request('/student/regenerate_order_id', 
                          {
                            asynchronous:true, 
                            evalScripts:true, 
                            parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                          }
                    )
                    //alert(data.errorMessage);

                }
            });

        }
        else
        {
          j(".loading").hide();
          bkash_clicked = false;
          j("#submit_button_multiple").trigger('click');
        }
    }
    j(document).ready(function(){
        <% if @gateway_settings.keys.include?('bkash')  %>
        bKash.init({ 
          paymentMode: 'checkout', //fixed value ‘checkout’ 
          //paymentRequest format: {amount: AMOUNT, intent: INTENT} 
          //intent options 
          //1) ‘sale’ – immediate transaction (2 API calls) 
          //2) ‘authorization’ – deferred transaction (3 API calls) 
          paymentRequest: { 
            amount: <%= precision_label total_fees %>, //max two decimal points allowed 
            intent: 'sale' 
          }, 
          onClose : function () {
              bkashLoad = false;
              j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
              j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
              //j(".loading_single_bkash").hide();
              j(".loading").hide();
              j("#bKashFrameWrapper").css('display','none');
              
              
              j("#pay_fees_multiple").addClass('gateway_image_single_bkash_disabled');
              j("#pay_fees_multiple").attr('id',"pay_fees_multiple_1");
              //j(".loading_single_bkash").show();
              //j(".loading").show();
              
              new Ajax.Request('/student/regenerate_order_id', 
                    {
                      asynchronous:true, 
                      evalScripts:true, 
                      parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                    }
              )
          },
          executeRequestOnAuthorization: function() { 
            j("#bKashFrameWrapper").css('display','none');
            j("#pay_fees_multiple").addClass('gateway_image_single_bkash_disabled');
            //j(".loading_single_bkash").show();
            //j(".loading").show();
            j("#pay_fees_multiple").prop('disabled',true);
            j("#pay_fees_multiple").attr('id',"pay_fees_multiple_1");
            j.ajax({
                url: '/student/complete_bkash_payment',
                type: 'POST',
                data: j("#data-form-val").serialize() + "&gateway=bkash&payment_id=" + paymentID,
                success: function (data) {
                      bkashLoad = false;
                      j(".loading").hide();
                      if (data && data.paymentID != null) 
                      {
                        j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                        j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                        //j(".loading_single_bkash").hide();
                        j("#bKashFrameWrapper").css('display','none');
                        //location.reload();
                        j('#success_label').html("Thanks for your payment, payment was Successfull. Your order ID is: " + j("#fees_form").find("input#order_id").val());
                        j("#paymentModalSuccess").modal();
                        j("#pay_fees_multiple").remove();
                      } 
                      else 
                      { 
                        bKash.create().onError(); 
                        j('#error_label').html(data.errorMessage);
                        j("#paymentModal").modal();
                        j("#bKashFrameWrapper").css('display','none');
                        new Ajax.Request('/student/regenerate_order_id', 
                              {
                                asynchronous:true, 
                                evalScripts:true, 
                                parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                              }
                        )
                      } 
                },
                error: function () {
                    j(".loading").hide();
                    bKash.create().onError(); 
                    j('#error_label').html(data.errorMessage);
                    j("#paymentModal").modal();
                    j("#bKashFrameWrapper").css('display','none');
                    new Ajax.Request('/student/regenerate_order_id', 
                          {
                            asynchronous:true, 
                            evalScripts:true, 
                            parameters:'student_id='+<%= @student.id %>+'&fee_id=<%= @financefee.id.to_s %>'+'&order_id='+j("#fees_form").find("input#order_id").val()+'&total_fees='+<%= total_fees %>+'&multiple=0'
                          }
                    )
                    //alert(data.errorMessage);
                }
            });
          } 
        });
        <% end %>
        j(document).on('click', "#close_pop", function(){
            if ( bkashLoad == false )
            {
              j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
              j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
              //j(".loading_single_bkash").hide();
              j(".loading").hide();

            }
        });
        
        j(document).on('click', "#close_pop_success", function(){
            location.reload();
        });
        
        /*j(document).on("click", "#pay_fees_multiple", function(){
            if ( j("#user_gateway").val() == 'bkash' )
            {
                j(this).addClass('gateway_image_single_bkash_disabled');
                //j(".loading_single_bkash").show();
                j(this).prop('disabled',true);
                j(this).html("<i class='fa fa-spin fa-spinner'></i> Please wait...");
            
                j(this).prop('disabled',true);
                j(this).html("<i class='fa fa-spin fa-spinner'></i> Pay Fees");
                
                j(this).attr('id',"pay_fees_multiple_1");
                
                j.ajax({
                    url: '/student/generate_bkash_token',
                    type: 'POST',
                    data: j("#fees_form").serialize() + "&student_id=<%= @student.id %>",
                    success: function (data) {
                          if ( ! data.id_token )
                          {
                              j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                              j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                              j(".loading_single_bkash").hide();
                              j('#error_label').html(data.errorMessage);
                              j("#paymentModal").modal();
                              //alert(data.errorMessage);
                          }
                          else
                          {
                              id_token = data.id_token;
                              j.ajax({
                                  url: '/student/generate_bkash_payment',
                                  type: 'POST',
                                  data: j("#data-form-val").serialize() + "&id_token=" + data.id_token + "&gateway=bkash",
                                  success: function (data) {
                                        j(".loading_single_bkash").hide();
                                        j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                                        j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                                        if (data && data.paymentID != null) 
                                        {
                                          bkashLoad = true;
                                          j("#bKashFrameWrapper").css('display','block');
                                          j("#close_pop").trigger('click');
                                          paymentID = data.paymentID; 
                                          bKash.create().onSuccess(data); //pass the whole response data in bKash.create().onSucess() method as a parameter 
                                        } 
                                        else 
                                        { 
                                          j('#error_label').html(data.errorMessage);
                                          j("#paymentModal").modal();
                                          //alert(data.errorMessage);
                                        } 
                                  },
                                  error: function () {
                                      j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                                      j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                                      j(".loading_single_bkash").hide();
                                      j('#error_label').html(data.errorMessage);
                                      j("#paymentModal").modal();
                                      //alert(data.errorMessage);
                                  }
                              });
                          }
                    },
                    error: function () {
                        j("#pay_fees_multiple_1").attr('id',"pay_fees_multiple");
                        j("#pay_fees_multiple").removeClass('gateway_image_single_bkash_disabled');
                        j(".loading_single_bkash").hide();
                        //bKash.create().onError();//run clean up code
                        j('#error_label').html("Error in payment");
                        j("#paymentModal").modal();
                        //alert(data.errorMessage);

                    }
                });

            }
            else
            {
              j("#submit_button_multiple").trigger('click');
            }
        });*/
      
        j(document).on("click", ".gateway_image_panel", function(){
            var gateway = j(this).data('gateway');
            if ( gateway != 'bkash' && bkash_clicked == false )
            {
                j("#radio_" + gateway).prop('checked', true);
                j("#user_gateway").val(gateway);
                j("#pay_fees_multiple").removeAttr('disabled');
                //j(".submit_pay").show();
                j(".submit_pay").trigger('click');
            }
            else
            {
               j(".gateway_radio").prop('checked', false);
            }
        });
      
        j(document).on("click", ".expand_tr", function(){
            var id = this.id.replace("expand_tr_", "");
            if ( j(this).children('td.expand_td').children('i.expand_i').hasClass('fa-plus-square-o') )
            {
                j(this).children('td.expand_td').children('i.expand_i').removeClass("fa-plus-square-o");
                j(this).children('td.expand_td').children('i.expand_i').addClass("fa-minus-square-o");
                
                j(".tr_fees_" + id).show();
                j(".blank_tr_" + id).show();
            }
            else
            {
                j(this).children('td.expand_td').children('i.expand_i').removeClass("fa-minus-square-o");
                j(this).children('td.expand_td').children('i.expand_i').addClass("fa-plus-square-o");
                j(".tr_fees_" + id).hide();
                j(".blank_tr_" + id).hide();
            }
        });
        
        j(document).on("click", ".expand_td", function(){
            var id = this.id.replace("expand_td_", "");
            if ( j(this).children('i.expand_i').hasClass('fa-plus-square-o') )
            {
                j(this).children('i.expand_i').removeClass("fa-plus-square-o");
                j(this).children('i.expand_i').addClass("fa-minus-square-o");
                
                j(".tr_fees_" + id).show();
                j(".blank_tr_" + id).show();
            }
            else
            {
                j(this).children('i.expand_i').removeClass("fa-minus-square-o");
                j(this).children('i.expand_i').addClass("fa-plus-square-o");
                j(".tr_fees_" + id).hide();
                j(".blank_tr_" + id).hide();
            }
        });
        
        j(document).on("click", ".expand_i", function(){
            var id = this.id.replace("expand_i_", "");
            if ( j(this).hasClass('fa-plus-square-o') )
            {
                j(this).removeClass("fa-plus-square-o");
                j(this).addClass("fa-minus-square-o");
                
                j(".tr_fees_" + id).show();
                j(".blank_tr_" + id).show();
            }
            else
            {
                j(this).removeClass("fa-minus-square-o");
                j(this).addClass("fa-plus-square-o");
                j(".tr_fees_" + id).hide();
                j(".blank_tr_" + id).hide();
            }
        });
    });
</script>
