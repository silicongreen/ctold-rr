<div class="box_content">
    <div class="partial_homework" style="padding: 0px 0px;">
        <!--<h2 class="f2 routine">HOMEWORK</h2>-->


        <div class="header-wrapper">
            <div class="header-title">
                <div class="header-icon">
                    <%= image_tag '/images/icons/homework.png', :html => {:alt => 'Homework'} %>
                </div>
                <div class="header-title-text-wrapper">
                    <div class="header-title-main-text f2">
                        <%= link_to "Homework", :controller => 'assignments', :action => 'index' %> 
                        <span style="float: left;clear:both;font-size: 15px;"><%= Time.now.strftime("%d %b %Y") %></span>
                    </div>      
                </div>    
            </div>

            <div class="tabbed-header-wrapper">
                <ul class="header-tabs">
                    <li class="active">
                        <%= link_to "All Homework",
                          {:controller=>"assignments", :action=>"index"},
                          {:class => 'f2'}
                      %>
                    </li>
                    <% @config = Configuration.find_by_config_key('HomeworkWillForwardOnly') %>
                    <% if (!@config.blank? and !@config.config_value.blank? and @config.config_value.to_i == 1) and (@current_user.admin? or (@current_user.employee? and @current_user.employee_entry.homework_publisher == 1)) %>
                      <li>
                          <%= link_to "Forwarded Homework",
                            {:controller=>"assignments", :action=>"publisher"},
                            {:class => 'f2'}
                        %>

                      </li>
                    <% end %>
                    <% if !@current_user.admin? %>
                      <% if  permitted_to? :new,:assignments %>
                        <li>          
                            <%= link_to t('create_new_assignment'), {:controller => "assignments", :action => "new"}, :class => 'f2' %>
                        </li>
                        <% if (!@config.blank? and !@config.config_value.blank? and @config.config_value.to_i == 1) %>
                          <li>          
                              <%= link_to "Approved Homework", {:controller => "assignments", :action => "approved_homework"}, :class => 'f2' %>
                          </li>
                        <% end %>
                      <% end %>
                    <% end %>    
                </ul>
            </div>

            <% if @current_user.employee?  %> 
              <div class="header-form-wrapper">
                  <div class="label-field-pair">
                      <label for="assignment_subject"><%= "#{t('subject_and_class')}"%></label>
                      <div class="text-input-bg">
                          <% unless @subjects.nil? %>
                            <%= select :assignment, :subject,
                              @subjects.map {|s| ["#{s.name}  - #{s.batch.full_name}",s.id]},
                              {:prompt => "#{t('select_subject_and_class')}"},
                              {:onChange => "#{remote_function(:url => {:action => "subject_assignments"},
                              :with => "'subject_id='+ value +'&due_date='+ $('assignment_duedate').value+'&is_published='+ $('assignment_is_published').value",
                              :before => "Element.show('loader')",
                              :success => "Element.hide('loader')"
                              )}"} %>
                        </div>
                        <%= image_tag("loader.gif",:align => "absmiddle",:border => 0,:id => "loader", :style =>"display: none;" ) %>
                    </div>

                    <div class="label-field-pair"  style="float:left; clear:both;">
                        <label for="duedate"><%= "#{t('due_date')}"%></label>
                        <div  class="text-input-bg">
                            <%= calendar_date_select_tag "assignment_duedate", '' ,
                              :class=>"text-input-bg",
                              :readonly=>true,
                              :popup=>:force,
                              :onchange => "#{remote_function(:url => {:action => "subject_assignments"},
                            :with => "'due_date='+ value +'&subject_id='+ $('assignment_subject').value+'&is_published='+ $('assignment_is_published').value",
                            :before => "Element.show('loader')",
                            :success => "Element.hide('loader')"
                            )}"
                          %>
                            <div class="clear-date">Clear</div>
                        </div>
                        <%= image_tag("loader.gif",:align => "absmiddle",:border => 0,:id => "loader", :style =>"display: none;" ) %>
                    </div>
                    <div class="label-field-pair" style="float:left; clear:both;">
                        <label for="assignment_is_published">Status</label>
                        <div class="text-input-bg">

                            <%= select :assignment, :is_published,
                              [['Published', 1], ['Draft', 0], ['Pending', 2], ['Approved', 3]],
                              {:prompt => "Select Homework Status"},
                              {:onChange => "#{remote_function(:url => {:action => "subject_assignments"},
                              :with => "'is_published='+ value +'&due_date='+ $('assignment_duedate').value+'&subject_id='+ $('assignment_subject').value",
                              :before => "Element.show('loader')",
                              :success => "Element.hide('loader')"
                              )}"} %>
                        </div>
                        <%= image_tag("loader.gif",:align => "absmiddle",:border => 0,:id => "loader", :style =>"display: none;" ) %>
                    </div>  
                  <% else %>
                    <p class="flash-msg"> <%= "#{t('there_are_no_subjects_assigned_to_this_employee')}"%> </p>
                  <% end %>
              </div>
            <% elsif @current_user.student? or @current_user.parent? %>
              <div class="header-form-wrapper">
                  <div class="label-field-pair">
                      <label for="assignment_subject"><%= "#{t('subject')}"%></label>
                      <div class="text-input-bg">
                          <% unless @subjects.nil? %>
                            <%= select :assignment, :subject,
                              @subjects.map {|s| ["#{s.name}",s.id]},
                              {:prompt => "#{t('select_a_subject')}"},
                              {:onChange => "#{remote_function(:url => {:action => "subject_assignments2"},
                              :with => "'subject_id='+ value +'&due_date='+ $('assignment_duedate').value+'&is_published='+ $('assignment_is_published').value",
                              :before => "Element.show('loader')",
                              :success => "Element.hide('loader')"
                              )}"} %>
                        </div>
                    </div>
                    <div class="label-field-pair"  style="float:left; clear:both;">
                        <label for="duedate"><%= "#{t('due_date')}"%></label>
                        <div  class="text-input-bg">
                            <%= calendar_date_select_tag "assignment_duedate", '' ,
                              :class=>"text-input-bg",
                              :readonly=>true,
                              :popup=>:force,
                              :onchange => "#{remote_function(:url => {:action => "subject_assignments2"},
                            :with => "'due_date='+ value +'&subject_id='+ $('assignment_subject').value",
                            :before => "Element.show('loader')",
                            :success => "Element.hide('loader')"
                            )}"
                          %>
                            <div class="clear-date">Clear</div>
                        </div>
                    </div>
                    <div style=" float: left; clear:both; margin: 15px 0px; width: 95%;">
                        <%= image_tag("loader.gif",:align => "absmiddle",:border => 0,:id => "loader", :style =>"display: none;" ) %>
                    </div>
                  <% else %>
                    <p class="flash-msg"> <%= "#{t('there_are_no_subjects_assigned_to_this_employee')}"%> </p>
                  <% end %>
              </div>
            <% end %>

            <div class="clearfix"></div>

        </div>  
        <% if @current_user.employee?  %>
          <div id="page-yield" class="bg-disable">
            <% elsif @current_user.student? %>
              <div id="page-yield" class="bg-disable">
                <% elsif @current_user.parent? %>
                  <div id="page-yield" class="bg-disable">
                    <% elsif @current_user.admin? %>
                      <div id="page-yield" style="margin-top: 0px;">
                        <% end %>

                        <% unless flash[:notice].nil? %>
                          <p class="flash-msg"> <%= flash[:notice] %> </p>
                        <% end %>

                        <% if @current_user.employee?  %>
                          <div id="subject_assignments_list" style="clear: both"></div>
                        <% elsif @current_user.student? or @current_user.parent? %>
                          <div id="listing">
                              <% unless @assignments.nil? %>
                                <% total_homework = @assignments.count %>
                                <% i = 1 %>
                                <% @assignments.each_with_index do |assignment,j| %>
                                  <% unless assignment.subject.nil? %>
                                    <div class="portlet-subcontent" style="width:100%">     
                                        <div class="timetable_left">
                                            <% if assignment.subject.icon_number? %>
                                              <%= image_tag("icons/subjects/"+assignment.subject.icon_number , :size=> "83x60", :alt=> assignment.subject.name) %>
                                            <% else %>
                                              <%= image_tag("icons/subjects/8.png" , :size=> "83x60", :alt=> assignment.subject.name) %>
                                            <% end %>

                                        </div>
                                        <%
                                        unless assignment.subject.employees.nil? or assignment.subject.employees.blank?
                                          emp_name = assignment.subject.employees[0].first_name
                                          unless assignment.subject.employees[0].middle_name.nil?
                                            emp_name += ' ' + assignment.subject.employees[0].middle_name
                                            end
                                          unless assignment.subject.employees[0].last_name.nil?
                                            emp_name += ' ' + assignment.subject.employees[0].last_name
                                          end
                                          end
                                      %>
                                        <div class="timetable_right"  style="float:left;height: 70px;width: 40%;padding: 10px 0;">
                                            <div class="subcontent-header themed_text">
                                                <%=  link_to assignment.subject.name.to_s+' - '+assignment.title, assignment%>

                                            </div>                           
                                            <div class="subcontent-info"><%= emp_name %> </div>              
                                        </div>
                                        <div class="timetable_right"  style="float:left;height: 70px;width: 35%;padding: 10px 0;border-left:1px dotted #cccccc">                            
                                            <div class="subcontent-date"><b style="color:#000;">Assign Date &nbsp;:&nbsp; </b><%= I18n.l(assignment.created_at,:format=>"%A, %d %B, %Y") %></div>  
                                            <div class="subcontent-date"><b style="color:#000;">Due Date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp; </b><%= I18n.l(assignment.duedate,:format=>"%A, %d %B, %Y") %></div>                                    
                                        </div> 
                                        <% if @current_user.student? %>
                                          <%  @assignment_answers = AssignmentAnswer.find_all_by_student_id_and_assignment_id(@current_user.student_record.id,assignment.id) if @current_user.student? %>

                                          <% if Date.today <= Date.parse(assignment.duedate.to_s) %>

                                            <% if @assignment_answers.empty? %>
                                              <div class="answer" id="done_<%= assignment.id %>">
                                                  <%= link_to_remote "#{t('done_this_assignment')}" , :url => {:controller => 'assignment_answers', :action => "done", :assignment_id => assignment.id } , :update=> 'done_'+assignment.id.to_s, :html => { :class  => "user_button",:style=>"margin-left:0px" }%>
                                              </div>
                                            <%  else %>
                                              <div class="answer">
                                                  <% unless @assignment_answers.empty? %>
                                                    <% @assignment_answers.each do |answer| %>
                                                      <% if answer.status == "REJECTED" %>
                                                        <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">REJECTED </a>
                                                      <% elsif answer.status=="ACCEPTED" %>
                                                        <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> ACCEPTED</a>
                                                      <% else  %>
                                                        <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> PENDING</a>
                                                      <% end %>
                                                      <% break %>
                                                    <% end %>
                                                  <% else %>
                                                    <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">NOT DONE</a> 
                                                  <% end %>
                                              </div>
                                            <% end %>
                                          <% else %>
                                            <div class="answer">
                                                <% unless @assignment_answers.empty? %>
                                                  <% @assignment_answers.each do |answer| %>
                                                    <% if answer.status == "REJECTED" %>
                                                      <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">REJECTED </a>
                                                    <% elsif answer.status=="ACCEPTED" %>
                                                      <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> ACCEPTED</a>
                                                    <% else  %>
                                                      <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> PENDING</a>
                                                    <% end %>
                                                    <% break %>
                                                  <% end %>
                                                <% else %>
                                                  <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">NOT DONE</a> 
                                                <% end %>
                                            </div>
                                          <% end %>
                                        <% end %>
                                        <% if @current_user.parent? %>
                                          <% std_id = @current_user.guardian_entry.current_ward_id %>
                                          <%  @assignment_answers = AssignmentAnswer.find_all_by_student_id_and_assignment_id(std_id,assignment.id) %>
                                          <div class="answer">
                                              <% unless @assignment_answers.empty? %>
                                                <% @assignment_answers.each do |answer| %>
                                                  <% if answer.status == "REJECTED" %>
                                                    <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">REJECTED </a>
                                                  <% elsif answer.status=="ACCEPTED" %>
                                                    <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> ACCEPTED</a>
                                                  <% else  %>
                                                    <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)"> PENDING</a>
                                                  <% end %>
                                                  <% break %>
                                                <% end %>
                                              <% else %>
                                                <a class="user_button" style="background:#cccccc !important; margin-left:0px;" href="javascript:void(0)">NOT DONE</a> 
                                              <% end %>
                                          </div>
                                        <% end %>

                                    </div>

                                    <% if i<total_homework %>
                                      <div style="float: left; margin: 7px; width: 95%;"></div> 
                                    <% else %>
                                      <div style=" margin: 7px;float: left; width: 95%;"></div> 
                                    <% end %>
                                    <% i = i+1 %>
                                  <% end %>
                                <% end %>
                              <% else %>
                                <div class="portlet-subcontent">    
                                    No Homework Submitted
                                </div>  
                              <% end  %>
                              <div class="pagination_div"><div class="div1"><%= will_paginate @assignments, :previous_label=>"<", :next_label=>">", :renderer => 'RemoteLinkRenderer' ,:remote => { :loading =>  "$('loader_paginate').show();",:complete =>"$('loader').hide();"  }, :params => {:controller=>:assignments,:action => "subject_assignments2"} %></div><div class="div2"><%= image_tag("loader.gif",
                                        :align => "absmiddle",
                                        :border => 0,
                                        :id => "loader_paginate",
                                        :style =>"display: none;" ) %></div></div>
                          </div>


                        <% elsif @current_user.admin? %>
                          <% form_for(@student, :url => {:action=> 'view_all'}, :html=> {:id=>'new_student'}) do |s| %>    
    <%# if Batch.active.find(:all, :group => "name").length > 1  %> 
                            <div class="label-field-pair" style="margin: 0px auto;">
                                <label for="student_grade"><%= t('shift_label') %></label>
                                <div class="text-input-bg">
                                    <%= select :student, :batch_name, options_for_select(Batch.active.find(:all, :group => "name").map {|b| [b.name, b.id]}, @batch_no.to_i), 
                                      {:prompt => "#{t('select')}"},
                                      {:onChange => "#{remote_function(:url => {:controller => "student", :action => "get_classes"}, :with => "'batch_id='+value+'&'+$('new_student').serialize()+'&page=course_assingment&partial_view=student/courses_assingment&section_page=section_assingment&section_partial=student/sections_assignment_view'" ,:before => "$('loading_2').show();",
                                      :success => "$('loading_2').hide();")}"} %>
                                    <%= image_tag("loader.gif", :align => "absmiddle", :border => 0, :id => "loading_2", :style =>"display: none;" ) %></div>
                            </div>
    <%# end %>
                            <div class="label-field-pair" style="margin: 0px auto;">
                                <label for="student_grade"><%= t('class_label') %></label>
                                <div class="text-input-bg"><div id="course_assingment"> <%= render :partial => 'student/courses_assingment', :object => @courses %></div></div>
                            </div>        
                            <div class="label-field-pair" id="sections_div" style="margin: 0px auto;">
                                <label for="student_grade"><%= t('section_label') %></label>
                                <div class="text-input-bg"><div id="section_assingment"> <%= render :partial => 'student/sections_assignment_view', :object => @classes %></div></div>
                            </div>             
                          <% end %><%# FORM END%>  


                          <div id="syllabus" class="news_label_field"></div>
                          <br />
                          <div id="listing"></div>   

                          <script type="text/javascript">
                            var jj = jQuery.noConflict();
                            jj("#student_batch_name").on("change", function (event) {
                                jj("#listing").html("");
                                jj("#syllabus").html("");
                                jj.get("assignments/get_homework_filter", {batch_name: jj("#student_batch_name").val()})
                                        .done(function (data) {

                                        });
                            });

                            jj(document).off("change", "#student_class_name").on("change", "#student_class_name", function (event) {
                                jj("#listing").html("");
                                jj("#syllabus").html("");
                                jj.get("assignments/get_homework_filter", {batch_name: jj("#student_batch_name").val(), student_class_name: jj("#student_class_name").val()})
                                        .done(function (data) {
                                        });
                            });

                            jj(document).off("change", "#student_section").on("change", "#student_section", function (event) {
                                jj("#listing").html("");
                                jj.get("assignments/get_homework_filter", {batch_name: jj("#student_batch_name").val(), student_class_name: jj("#student_class_name").val(), student_section: jj("#student_section").val()})
                                        .done(function (data) {
                                        });
                            });


                            jj(document).off("change", "#assignment_subject").on("change", "#assignment_subject", function (event) {
                                if (jj("#assignment_subject").val() == "")
                                {
                                    jj("#listing").html("");
                                    jj.get("assignments/get_homework_filter", {batch_name: jj("#student_batch_name").val(), student_class_name: jj("#student_class_name").val(), student_section: jj("#student_section").val()})
                                            .done(function (data) {
                                            });
                                }
                            });
                          </script>    



                        <% end %>

                    </div>
                </div>        
            </div>

            <%= stylesheet_link_tag 'list_table' %>

            <style type="text/css">
                .calendar_date_select_popup_icon{
                    margin: 9px 1px 0;
                }
                .attachment {
                    background: url("/images/assignment/paperclip.png") no-repeat left;
                    padding-left: 11px;
                    height: 35px;
                }
                .clear-date {
                    color: #db3434;
                    cursor: pointer;
                    float: right;
                    font-size: 12px;
                    margin-right: 45px;
                    margin-top: 9px;
                    width: 0;
                }
                div h2.routine
                {

                    width: 60%;
                }
                .pagination
                {
                    margin-bottom:30px;
                }


                .CSSTableGenerator table thead tr th{
                    text-align: center;
                    padding: 10px;
                }
                .CSSTableGenerator td a
                {
                    color: inherit;
                    padding : 0;
                    background-color: inherit;
                    float: none;  
                    display: block;

                }
                .CSSTableGenerator td a:hover
                {
                    color: inherit;
                    padding : 0;
                    background-color: inherit;
                    float: none;
                    display: block;

                }
                .CSSTableGenerator table tr td 
                {
                    text-align: center;
                    font-weight: bold;
                    overflow: hidden;
                    padding: 5px !important;
                }
                .CSSTableGenerator table tr td:last-child
                {
                    padding: 0;
                    width: 15%;
                }
                .select2-container
                {
                    margin-left:10px;
                    width: 200px !important;
                }
                .select2-container--open .select2-dropdown--above
                {
                    margin-left: -10px;
                }
                .select2-container--open .select2-dropdown--below
                {
                    margin-left: -10px;
                }
            </style>

            <% content_for :head do %>
              <%= javascript_include_tag "custom/assignment" %>
            <% end %>
            <%= stylesheet_link_tag 'pagination_and_table' %>
            <%= stylesheet_link_tag 'tadded-header' %> 

            <script>
              var jq = jQuery.noConflict();
              jq(document).ready(function () {
                  jq('#assignment_subject').select2();
              });

            </script>
