<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<div class="clearfix"></div>
<div class="CSSTableGenerator" style="width: 97%;margin-top: 10px;">

    <table id="listing table-design">
        <thead>
            <tr class="tr-head">

                <th>Roll</th>
                <th>Student Name</th>
                <th>Status</th>
                <% if school_smartcard_allowed? %>
                <th></th>
                <% end %>
                <th style="text-align: center;"><input type="radio" value="1" checked="checked" name="check_all" class="check_all" />&nbsp;&nbsp;Present</th>
                <th style="text-align: center;"><input type="radio" value="2" name="check_all" class="check_all" />&nbsp;&nbsp;Absent</th>
                <th style="text-align: center;"><input type="radio" value="3" name="check_all" class="check_all" />&nbsp;&nbsp;Late</th>


            </tr>
        </thead>
        
        <% @students.each do |student| %>

          <tr class="tr-<%= cycle('odd', 'even') %>">
              <td class="col-2"><%= student['roll_no'] %></td>
              <td class="col-2 student-name-attendance tooltips" id="student-name-attendance-<%=student['student_id']%>">

                  <%= student['student_name'] %>
                  <% if @current_user.admin? %>
                  <div class="attendance-log" id="attednace-log-<%=student['student_id']%>" >Getting Attendance Log Info...</div>
                  <% end %>
              </td>
              <td class="col-2">
                  <% if student['status']==1 %>
                    <span class="checkmark">
                        <div class="checkmark_circle"></div>
                        <div class="checkmark_stem"></div>
                        <div class="checkmark_kick"></div>
                    </span>
                  <% else %>
                    <span class="checkmark">
                        <div class="checkmark_circle absent"></div>
                        <div class="checkmark_stem"></div>
                        <div class="checkmark_kick"></div>
                    </span>
                  <% end %>

              </td> 
              <% if school_smartcard_allowed? %>
              <td class="col-2 status-class" id="status-force-<%=student['student_id']%>" style="text-align: center;<% if @stdids.include?(student['student_id'].to_i) %>background-color:#D92313; color:white;<% end %>">
                  <div class="image_loading">
                      <%= image_tag("loader.gif",:align => "absmiddle",:border => 0,:id => "loader_force_#{student['student_id']}",:style =>"display: none; float:left;" ) %>
                  </div>
                  
                    <%= link_to_remote "Force",
                      :before => "Element.show('loader_force_#{student['student_id']}')",
                      :success => "Element.hide('loader_force_#{student['student_id']}')",
                      :url=>{:controller=>"attendances", :action=>"show"},
                      :with => "'batch_id=#{params[:batch_id]}'+'&student_id=#{student['student_id']}'+'&status_change=5&attandence_date='+$('attandence_date').value"%>
                 
              </td>
              <% end %>
              <td class="col-2 status-class" >
                  <div class="image_loading">
                      <input type="radio" value="1" <% if student['status']==1 %> checked="checked" <% end %> name="attendance_<%= student['student_id'] %>" class="absent_student present_std" id="<%= student['student_id'] %>" />&nbsp;&nbsp;Present

                  </div>
              </td>

              <td class="col-2 status-class">
                  <div class="image_loading">
                      <input type="radio" value="2" <% if student['status']==0 %> checked="checked" <% end %> name="attendance_<%= student['student_id'] %>" class="absent_student absent_std" id="<%= student['student_id'] %>" />&nbsp;&nbsp;Absent

                  </div>
              </td>
              <td class="col-2 status-class">
                  <div class="image_loading">
                      <input type="radio" value="3" <% if student['status']==2 %> checked="checked" <% end %> name="attendance_<%= student['student_id'] %>" class="absent_student late_std" id="<%= student['student_id'] %>" />&nbsp;&nbsp;Late

                  </div>
              </td>
              
          </tr>          
        <% end %>
    </table>
    <br/>
    <input type="button" name="save" id="attendance_save_all" value="Save Attendance"  style=" cursor: pointer;"  />
    <br/>
    <h4 style="color:green; display:none;" id="att_taken">Attendance Successfully Saved</h4>
    <%= image_tag("loader.gif", :align => "absmiddle", :border => 0, :id => "loading-att", :style =>"display: none;" ) %>


</div>
<%= stylesheet_link_tag 'list_table' %>
<style>
    .CSSTableGenerator td a
    {
        color: inherit;
        padding : 0;
        background-color: inherit;
        float: none;  
        display: block;
        margin: -20px;
        padding: 20px;
    }
    .CSSTableGenerator td a:hover
    {
        color: inherit;
        padding : 0;
        background-color: inherit;
        float: none;
        display: block;
        margin: -20px;
        padding: 20px;
    }
    .CSSTableGenerator table tr td 
    {
        font-weight: bold;
    }
    .CSSTableGenerator table tr td:last-child
    {
        padding: 0;
        width: 15%;
    }
    .checkmark {
        display:inline-block;
        width: 22px;
        height:22px;
        -ms-transform: rotate(45deg); /* IE 9 */
        -webkit-transform: rotate(45deg); /* Chrome, Safari, Opera */
        transform: rotate(45deg);
    }

    span div.absent {
        position: absolute;
        width:22px;
        height:22px;
        background-color: #B3B9BB;
        border-radius:11px;
        left:0;
        top:0;
    }

    .checkmark_circle {
        position: absolute;
        width:22px;
        height:22px;
        background-color: #0691D5;
        border-radius:11px;
        left:0;
        top:0;
    }

    .checkmark_stem {
        position: absolute;
        width:3px;
        height:9px;
        background-color:#fff;
        left:11px;
        top:6px;
    }

    .checkmark_kick {
        position: absolute;
        width:3px;
        height:3px;
        background-color:#fff;
        left:8px;
        top:12px;
    }
    .status-class {
        text-align: center !important;
    }
    .approved {
        /*background-color: #9F38E7;*/
        color: #ffffff !important;
    }
    .declined {
        /*background-color: #CB232A;*/
        color: #ffffff !important;
    }
    .leave_sts {
        clear: both;
        float: left;
        margin-bottom: 7px;
        width: 100%;
    }
    .leave_sts_appr, .leave_sts_deny {
        background-color: #cb232a;
        float: left;
        margin-left: 5px;
        padding: 6px 5px;
    }
    .leave_sts_deny {
        float: left !important;
    }
    .leave_sts_appr a, .leave_sts_deny a {
        color: #ffffff !important;
        float: left !important;
        margin: 0 !important;
        padding: 0 !important;
    }
</style> 
<% if @current_user.admin? %>
<style>
    td.tooltips {
      position: relative !important;
      display: inline;
      cursor: pointer;
    }
    td.tooltips:hover {
      background:#D4F7DA;
    }
    
  
    td.tooltips div {
      position: absolute;
      color: #FFFFFF;
      background: #000000;
      height: 30px;
      line-height: 30px;
      text-align: center;
      visibility: hidden;
      border-radius: 0px;
    }
    td.tooltips div:after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -8px;
      width: 0; height: 0;
      border-top: 8px solid #000000;
      border-right: 8px solid transparent;
      border-left: 8px solid transparent;
    }
    td:hover.tooltips div {
      visibility: visible;
      opacity: 0.8;
      bottom: 75px;
      left: 27%;
      margin-left: -76px;
      min-width: 100%;
      height: auto;
      z-index: 999;
      
    }
</style> 
<script>
  var jj = jQuery.noConflict();
  jj(document).ready(function() {
    jj('.check_all').click(function () {
      
        if(jj(this).val() == 1)
        {
          jj('.present_std').trigger("click");
        } 
        if(jj(this).val() == 2)
        {
          jj('.absent_std').trigger("click");
        }
        if(jj(this).val() == 3)
        {
          jj('.late_std').trigger("click");
        } 
      });
    jj('#attendance_save_all').click(function () {
      
          var student_ids = new Array;
          var late = new Array;
          jj('input.absent_student').each(function (checkbox)
          {
         
              if (jj(this).is(":checked") && jj(this).val() != 1)
              {
                  if (jj(this).val() == 2)
                  {
                      Array.prototype.push.call(late, 0);
                  }
                  else
                  {
                      Array.prototype.push.call(late, 1);
                  }
                  Array.prototype.push.call(student_ids, this.id);
              }
          });
          Element.show('loading-att');
          new Ajax.Request('/attendances/save_attendance_day', {
              method: 'post',
              onSuccess: function (request) {
                Element.hide('loading-att');
                Element.show('att_taken');
                setTimeout(function(){ Element.hide('att_taken'); }, 3000);
              },
              parameters: {
                  student_id: student_ids.toString(),
                  late: late.toString(),
                  attandence_date: jj('#attandence_date').val(),
                  batch_id: <%= @batch_data.id %>
              }
          });



      });
    
    jj(".student-name-attendance").on({
      mouseenter: function () {
        var this_id = this.id;
        std_id = this_id.replace("student-name-attendance-","");
        jj.getJSON("/attendances/get_att_log", {
          student_id: std_id,
          date: jj('#attandence_date').val()
        })
        .done(function( data ) {
          var log_string = "";
          jj.each( data, function( i, item ) {
            log_string +="<span style='white-space: nowrap; padding: 10px 20px;'>"+item.employee_name+"&nbsp;&nbsp;"+item.status+"&nbsp;&nbsp;"+item.date+"</span><br/>";
          });
          
          if(log_string!="")
          {
            jj('#attednace-log-'+std_id).html(log_string);
          }
          else
          {
            jj('#attednace-log-'+std_id).html("No Log Found");
          }  
        });
      }  
    });
  });
</script> 
<% end %>
