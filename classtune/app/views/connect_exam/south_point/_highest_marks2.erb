<%
if @subject_highest_mark_first_term.blank? and @subject_highest_mark_final_term.blank? and @subject_highest_quarter.blank?
  @subject_highest_mark_first_term = {}
  @subject_highest_mark_final_term = {}
  @subject_highest_quarter = {}
  @subject_highest_mock_test = {}
  unless @tabulation_data.blank?
    @tabulation_data['report']['students'].each do |std| 
      @tabulation_data['report']['subjects'].each do |sub|
        obtained_mark = 0
        full_mark = 0
        highest_mark = 0

        mock_test_total = 0
        mock_test_full_mark = 0
        st_full_mark1 = 0
        ct_full_mark1 = 0

        st_marks1 = []
        ct_marks1 = []
        avg_mark_st1 = 0;
        avg_mark_ct1 = 0;
        full_mark1 = 0

        st_full_mark2 = 0
        ct_full_mark2 = 0

        st_marks2 = []
        ct_marks2 = []
        avg_mark_st2 = 0;
        avg_mark_ct2 = 0;
        full_mark2 = 0

        st_full_mark3 = 0
        ct_full_mark3 = 0

        st_marks3 = []
        ct_marks3 = []
        avg_mark_st3 = 0;
        avg_mark_ct3 = 0;
        full_mark3 = 0

        st_full_mark4 = 0
        ct_full_mark4 = 0

        st_marks4 = []
        ct_marks4 = []
        avg_mark_st4 = 0;
        avg_mark_ct4 = 0;
        full_mark4 = 0

        first_term_mark = 0
        first_term_full_mark = 0
        first_term_avg_mark = 0

        final_term_mark = 0
        final_term_full_mark = 0
        final_term_avg_mark = 0
        unless @tabulation_data['report']['exams'].blank?  
          @tabulation_data['report']['exams'].each do |report|
            if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank? and !report['result'][report['exam_id']][sub['id']][std['id']].blank?

              #Calculation First Quarter Mark
              if report['quarter'] == '1'
                if st_full_mark1 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark1 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark1 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark1 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks1 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks1 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks1 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks1 << 0
                  end      
                end
                end 

              #Calculation 2nd Quarter Mark
              if report['quarter'] == '2'
                if st_full_mark2 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark2 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark2 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark2 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks2 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks2 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks2 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks2 << 0
                  end      
                end
                end


              #Calculation 3rd Quarter Mark
              if report['quarter'] == '3'
                if st_full_mark3 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark3 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark3 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark3 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks3 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks3 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks3 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks3 << 0
                  end      
                end
                end 


              #Calculation 4th Quarter Mark
              if report['quarter'] == '4'
                if st_full_mark4 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark4 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark4 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark4 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks4 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks4 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks4 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks4 << 0
                  end      
                end
              end 



            end

          end
          end 
        #Calculation First Quarter Mark
        st_marks1.sort! {|x,y| y <=> x }
        ct_marks1.sort! {|x,y| y <=> x }

        if ct_full_mark1.to_i == 20 
          avg_mark_ct1 = ct_marks1[0].to_f+ct_marks1[1].to_f+ct_marks1[2].to_f
          ct_full_mark1 = ct_full_mark1*3
          else 
          avg_mark_ct1 = ct_marks1[0].to_f+ct_marks1[1].to_f
          ct_full_mark1 = ct_full_mark1*2
          end 

        if st_full_mark1.to_i == 10 
          avg_mark_st1 = st_marks1[0].to_f+st_marks1[1].to_f+st_marks1[2].to_f+st_marks1[3].to_f
          st_full_mark1 = st_full_mark1*4
          else st_full_mark1.to_i == 5  
          avg_mark_st1 = st_marks1[0].to_f+st_marks1[1].to_f+st_marks1[2].to_f
          st_full_mark1 = st_full_mark1*3
          end

        obtained_mark1 = avg_mark_ct1.to_f+avg_mark_st1.to_f
        full_mark1 = ct_full_mark1.to_i+st_full_mark1.to_i

        if full_mark1 == 100
          obtained_mark1 = obtained_mark1/2
          obtained_mark1 = obtained_mark1.round()
          full_mark1 = 50
          else
          obtained_mark1 = (obtained_mark1/35)*25
          obtained_mark1 = obtained_mark1.round()
          full_mark1 = 25
          end

        #Calculation 2nd Quarter Mark
        st_marks2.sort! {|x,y| y <=> x }
        ct_marks2.sort! {|x,y| y <=> x }




        if ct_full_mark2.to_i == 20 
          avg_mark_ct2 = ct_marks2[0].to_f+ct_marks2[1].to_f+ct_marks2[2].to_f
          ct_full_mark2 = ct_full_mark2*3
          else 
          avg_mark_ct2 = ct_marks2[0].to_f+ct_marks2[1].to_f
          ct_full_mark2 = ct_full_mark2*2
          end 

        if st_full_mark2.to_i == 10 
          avg_mark_st2 = st_marks2[0].to_f+st_marks2[1].to_f+st_marks2[2].to_f+st_marks2[3].to_f
          st_full_mark2 = st_full_mark2*4
          else st_full_mark2.to_i == 5  
          avg_mark_st2 = st_marks2[0].to_f+st_marks2[1].to_f+st_marks2[2].to_f
          st_full_mark2 = st_full_mark2*3
          end

        obtained_mark2 = avg_mark_ct2.to_f+avg_mark_st2.to_f
        full_mark2 = ct_full_mark2.to_i+st_full_mark2.to_i

        if full_mark2 == 100
          obtained_mark2 = obtained_mark2/2
          obtained_mark2 = obtained_mark2.round()
          full_mark2 = 50
        else
          obtained_mark2 = (obtained_mark2/35)*25
          obtained_mark2 = obtained_mark2.round()
          full_mark2 = 25
        end

        #Calculation First Term (40/20) Mark
        full_mark = full_mark1+full_mark2
        obtained_mark = obtained_mark1.round()+obtained_mark2.round()
        main_mark = (obtained_mark.round().to_f/full_mark.to_f)*100

       

        if @subject_highest_mark_first_term[sub['id'].to_i].blank?
          @subject_highest_mark_first_term[sub['id'].to_i] = obtained_mark
        elsif obtained_mark.to_i > @subject_highest_mark_first_term[sub['id'].to_i].to_i
          @subject_highest_mark_first_term[sub['id'].to_i] = obtained_mark.to_i
        end

      end
    end
  end
  end

%> 