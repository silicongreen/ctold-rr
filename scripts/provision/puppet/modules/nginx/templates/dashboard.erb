server {

    listen <%= listen %> ;

    server_name  <% real_server_name.each do |s_n| -%><%= s_n %> <% end -%>;

    access_log  <%= real_access_log %>;
    error_log   <%= real_error_log %>;

    root <%= root %>;

    <% if listen == '443' %>
        ssl  on;
        ssl_certificate  <%= real_ssl_certificate %>;
        ssl_certificate_key  <%= real_ssl_certificate_key %>;
        ssl_session_timeout  <%= ssl_session_timeout %>;

        ssl_protocols  SSLv2 SSLv3 TLSv1;
        ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
        ssl_prefer_server_ciphers   on;
    <% end -%>

    index index.php app_dev.php index.html;

    #rewrite screen/([0-9]+)/([0-9]+).jpg /v2/content/screenshots/view_screen.php?user_id=$1&screenID=$2;
    location = /robots.txt  { access_log off; log_not_found off; error_log /dev/null crit; }
    location = /favicon.ico { access_log off; log_not_found off; error_log /dev/null crit; }
    location ~ /\.          { access_log off; log_not_found off; deny all; }
    rewrite ^/v2/views/min/([bfg]=.*) /v2/views/min/index.php?$1;

    location ~ storage.*$ {
        root /var/www/cysoco;
    }


    location ~ (v2|admin_settings|staff_watched).*$ {
        root /var/www/cysoco;

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
            expires 7d;
            log_not_found off;
    }

    location ~ .*\.(php|htm|html)$ {
        if (!-e $document_root$document_uri){return 404;}

        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APPLICATION_ENV development;
        include /etc/nginx/includes/fastcgi_params.inc;
        fastcgi_cache off;
    }

    }

    location / {
        # try to serve file directly, fallback to rewrite
        try_files $uri @rewriteapp;
        
#        if (-f $request_filename) {
#                break;
#        }
    
#        if (!-e $request_filename) {
#                rewrite ^(.+)$ /index.php?_url=$1 last;
#                break;
#        }
    }

    location @rewriteapp {
        # rewrite all to app.php
        rewrite ^(.*)$ /app_dev.php/$1 last;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires 7d;
        log_not_found off;
    }

    location ~ ^/(app|app_dev|config)\.php(/|$) {
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include /etc/nginx/includes/fastcgi_params.inc;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param   APPLICATION_ENV development;
        fastcgi_param HTTPS on;
    }
#    location ~ .*\.php$ {
#      root /var/www/cysoco/public;
#      fastcgi_pass unix:/var/run/php5-fpm.sock;
#      fastcgi_index  index.php;
#      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#      fastcgi_param   APPLICATION_ENV development;
#      fastcgi_connect_timeout 50;
#      fastcgi_send_timeout 50;
#      fastcgi_read_timeout 50;
#      fastcgi_ignore_client_abort off;
#      fastcgi_cache off;
#      include /etc/nginx/includes/fastcgi_params.inc;
#    }
}