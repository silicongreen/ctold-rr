<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<style>
    .table{
        font-family: verdana;
        font-size: 12px;
    }
    .table > thead > tr > th {
        vertical-align: middle !important;
    }  
    .table-sm td, .table-sm th {
        padding: .3rem !important;
    }
</style>
<div id="content-header">
<%= show_header_icon %>
  <h1><%= t('online_payment') %></h1>
<div class='header-sep'>|</div>
<div class='sub-header'><%= t('transactions') %></div>
<% authorization = Authorization.current_user.try(:role_symbols)  %>
<%  unless authorization.include?(:online_payment_report) %>
<div id="inner-tab-menu">
  <ul>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "Settings", settings_online_payments_path %></li>
  </ul>
</div>
<% end %>
</div>
<div id="page-yield">
  <div id="flash-box">
    <% unless flash[:notice].nil? %>
      <p class="flash-msg"> <%= flash[:notice] %> </p>
    <% end %>
  </div>
  <% form_for :payment_transaction,:url => transactions_online_payments_url do %>
    <div class="filter">
      <div class="label-field-pair" style="width: 25%;">
        <div class="label-container" style="padding-top: 15px;"><%= "Start" %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'start_date', params[:start_date].present? ? params[:start_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-left: 20px;"">
          <div class="label-container" style="padding-top: 15px;"><%= "To" %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'end_date', params[:end_date].present? ? params[:end_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-top: 0;">
          <div class="label-container" style="padding-top: 15px;">Status:</div>
          <div class="input-container" style="padding-top: 10px;">
              <select name="payment_status" id="payment_status">
                  <option value="">Select a Status</option>
                  <option value="1" <%= 'selected' if params[:payment_status].to_i == 1 %>>Completed</option>
                  <option value="0" <%= 'selected' if params[:payment_status].to_i == 0 %>>Failed</option>
              </select>
          </div>
      </div>
      <div style="clear: both; height: 20px;"></div>
      <hr style="border: 1px solid #ccc;" />  
      <div class="label-field-pair" style="width: 25%;">
          <div class="label-container" style="padding-top: 15px;">Ref No.:</div>
          <div class="input-container"><input type="text" name="ref_no" id="ref_no" value="<%= params[:ref_no] %>" /></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-left: 20px;">
          <div class="label-container" style="padding-top: 15px;">Order ID:</div>
          <div class="input-container"><input type="text" name="order_id" id="order_id" value="<%= params[:order_id] %>" /></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-top: 0;">
          <div class="label-container" style="padding-top: 15px;">Type:</div>
          <div class="input-container" style="padding-top: 10px;">
              <select name="payment_type" id="payment_type">
                  <option value="">Select a Payment Type</option>
                  <option value="MB" <%= 'selected' if params[:payment_type] == "MB" %>>Mobile Banking</option>
                  <option value="ITCL" <%= 'selected' if params[:payment_type] == "ITCL" %>>Card Online</option>
              </select>
          </div>
      </div>
      <div style="clear: both; height: 20px;"></div>
      <div style="margin-left: 40%;">
        <%= submit_tag 'Search',:name => "search",:class => "submit-button" %>
      </div>
      <div style="clear: both; height: 20px;"></div>
    </div>
  <% end %>
  <% unless @online_payments.empty? %>
    <div class="box" style="padding-top: 20px;">
      <h2 style="font-size: 14px;">Total Records: <%= @online_payments.total_entries %></h2>  
      <table class="table table-sm table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
        <thead><!-- class="thead-inverse" -->
        <tr>
            <th style="width: 3%;"><%= "#" %></th>
            <th style="width: 10%;"><%= t("gateway_name") %></th>
            <th style="width: 30%;"><%= t("user_id_name") %></th>
            <% if MultiSchool.current_school.id == 352 %>
            <th style="width: 10%;"><%= t("payment_type") %></th>
            <th style="width: 10%;"><%= t("ref_id") %></th>
            <th style="width: 10%;"><%= t("order_id") %></th>
            <% end %>
            <th style="width: 10%;"><%= t("amount") %></th>
            <% if MultiSchool.current_school.id == 352 %>
            <th style="width: 10%;"><%= t("service_charge") %></th>
            <% end %>
            <th style="width: 10%;"><%= t("gateway_status") %></th>
            <% unless MultiSchool.current_school.id == 352 %>
            <th style="width: 10%;"><%= t("online_transaction_id") %></th>
            <% end %>
            <th style="width: 10%;"><%= t("transaction_date") %></th>
        </tr>
        </thead>
        <tbody>
        <% @online_payments.each_with_index do |payment,index| %>
          <tr>
            <td style="vertical-align: middle;"><%= ((@online_payments.current_page - 1) * @online_payments.per_page) + index + 1 %></td>
            <td style="text-align: center;">
              <% gateway_name = "Online Payment"  %>  
              <% gateway_name_data = "Online Payment"  %>  
              <% if (payment.gateway_response.keys.include? :x_trans_id) %>  
                <% gateway_name = "Authorize.net"  %>
                <% gateway_name_data = "Authorize.net"  %>
              <% elsif (payment.gateway_response.keys.include? :val) %>  
                <% gateway_name = "SSL Commerz"  %>
                <% gateway_name_data = "SSL Commerz"  %>
              <% elsif (payment.gateway_response.keys.include? :order_id) %>  
                <% gateway_name = '<img src="/images/gateway_images/trustbank.png" height="64px" />'  %>
                <% gateway_name_data = 'trustbank'  %>
              <% else %>
                <% gateway_name = "Paypal"  %>
                <% gateway_name_data = "Paypal"  %>
              <% end %>  
              <%= gateway_name %>  
            </td>
            <% payee_user = payment.payee.try(:user).try(:username) unless payment.payee.class.name == "Applicant" %>
            <td style="vertical-align: middle; text-align: left; padding-left: 10px;"><%= "#{payment.payee_admission_no}" %><br /><%= "#{payment.payee_name}" %></td>
            <% if MultiSchool.current_school.id == 352 %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:payment_type]}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:ref_id]}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:order_id]}" %></td>
            <% end %>
            <% 
              amount = payment.gateway_response[:amount]
              amount ||= payment.gateway_response[:x_amount]
            %>

            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= precision_label(amount.to_f) %></td>
            <% if MultiSchool.current_school.id == 352 %>
            <% 
              service_charge = payment.gateway_response[:service_charge]
            %>
            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= precision_label(service_charge) %></td>
            <% end %>
            <td style="vertical-align: middle; text-align: center;">
              <% 
                b_pos = 0
                gateway_status = "Failed"
                if gateway_name_data == "Paypal"
                  gateway_status = "Completed" if payment.gateway_response[:status] == "Completed"
                  b_pos = 1 if payment.gateway_response[:status] == "Completed"
                elsif gateway_name_data == "trustbank"  
                  gateway_status = "Completed" if payment.gateway_response[:status].to_i == 1
                  b_pos = 1 if payment.gateway_response[:status].to_i == 1
                elsif gateway_name_data == "SSL Commerz"  
                  gateway_status = "Completed" if payment.gateway_response[:status] == "VALID"
                  b_pos = 1 if payment.gateway_response[:status] == "VALID"
                elsif gateway_name == "Authorize.net"
                  gateway_status = "Completed" if payment.gateway_response[:x_response_reason_code] == "1"
                  b_pos = 1 if payment.gateway_response[:x_response_reason_code] == "1"
                end 
              %>
              <% if b_pos == 1 %>  
                <i class="fa fa-check" style="color: #49BB4B; font-size: 14px;"></i><br />
              <% else %>  
                <i class="fa fa-close" style="color: #AB0D14; font-size: 14px;"></i><br />
              <% end %>  
              <%= gateway_status %>
            </td>
            <td style="vertical-align: middle; text-align: center;">
              <%= I18n.l((payment.created_at.to_time + 6.hours).to_datetime,:format=>"%d %b %Y %I:%M %P") %>
            </td>
          </tr>
        <% end %>
        </tbody> 
      </table>
      <% unless params[:page].blank?  %>
        <% pg = ( (params[:page].to_i - 1) * 30) + 1 %>
      <% else %>
        <% pg = 1 %>
      <% end %>
      <% showing = (pg + 30) - 1 %>
      <span style="font-family: verdana; font-size: 12px;">Showing <%= pg %> to <%= showing %> of <%= @online_payments.total_entries %> Records</span> 
      <%= will_paginate @online_payments,:params=>{:start_date => params[:start_date],:end_date => params[:end_date], :ref_no => params[:ref_no], :order_id => params[:order_id], :payment_type => params[:payment_type], :payment_status => params[:payment_status]} %>
    </div>
  <% else %>
    <div id="flash-box">
      <p class="flash-msg"  style="float: left;margin-top: 50px;width: 100%;">No Payments present</p>
    </div>
  <% end %>

</div>
<style>
    .filter {
        border: 1px solid #ccc;
        width: 98%;
        padding: 20px 10px 9px 10px;
        border-radius: 7px;
        background: #E5E5E5;
    }    
    .text-input-bg select, .label-field-pair input {
        height: 22px;
    }
</style>