<!DOCTYPE html>
<html>
  <!-- Latest compiled and minified CSS -->
  <head>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />

      <!-- Optional theme -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
      <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css" />

      <%= javascript_include_tag 'jquery/jquery-1.9.1.min.js' %>
      <!-- Latest compiled and minified JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

      <%#= javascript_include_tag 'finance.js' %>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

      <title>Pay Fees</title>
      <script>
        var j = jQuery.noConflict();
      </script>
  </head>
  <body>
      <% if MultiSchool.current_school.id == 352 %>
      <%
        require "yaml"
        transport_config = YAML.load_file("#{RAILS_ROOT.to_s}/config/finance_transport.yml")['school']
        transport_particular_id = transport_config['transport_particular_id_' + MultiSchool.current_school.id.to_s]
        if transport_particular_id.blank?
          transport_particular_id = 0
        end
      %>  
      <% end %>  
      
      <% if @current_user.parent? %>
        <% student_id = @current_user.guardian_entry.current_ward_id %>
      <% end %>
      <nav aria-label="breadcrumb" style="display: none;">
          <ol class="breadcrumb">
              <li class="breadcrumb-item"> <%= link_to "All Fees", {:controller => 'student',:action=>:fees, :id=>student_id,:mobile_view=>1} %></li>
          </ol>
      </nav>

      <div class="alert alert-info header-info" role="alert" style="display: none;">
          <p style="width: 48%; display: inline-block; float: left;"><%= @student.admission_no %> <Br /> <%= @student.full_name %><p>
          <p style="width: 50%; display: inline-block; float: right; text-align: right;"><%= @student.batch.full_name %></p>
      </div>

      <% unless flash[:success].nil? %>
        <div class="alert alert-success" role="alert"><%= flash[:success] %></div>
      <% end %>
      <% unless flash[:warning].nil? %>
        <div class="alert alert-danger" role="alert"><%= flash[:warning] %></div>
      <% end %>

      <% total_fees =0 %>
      <% total_payable =0 %>  
      
      <% form_remote_for :fees, :url => {:controller => 'student',:action => 'fee_details',:id => @student.id,:id2 => @date.id,:mobile_view=>1}, :html => {:id => "fees_form"}, :before=>"prev_double();$('loader_pay').show();",:complete=>"set_back();$('loader_pay').hide();" do |form| %>
        <% unless @fee_particulars.nil? %>
          <% total_fees = 0  %>
        
          <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 100%;">
          <thead><!-- class="thead-inverse" -->
            <tr>
              <th style="font-weight: normal; width: 8%; text-align: center;"><%= t('sl_no') %> </th>
              <th style="font-weight: normal; width: 50%; text-align: left;"><%= t('particulars') %></th>
              <th style="font-weight: normal; width: 14%; text-align: right;"><%= "Amount" %></th>
            </tr>    
          </thead>
          
          <% i = 0 %>
          <tbody>
              <% fee_ids = [] %>
              <% particular_amount_paid = 0 %>
              <% discount_paid = 0 %>
              <% fine_amount_paid_student = 0 %>
              <% @fee_particulars.each do |fee| %>
                <% unless fee_ids.include?(fee.id) %>  
                <% fee_particular_child = FinanceFeeParticular.find(:first, :conditions => "parent_id = #{fee.id} and receiver_type = 'Student' and receiver_id = #{@student.id}") %>  
                <% unless fee_particular_child.blank? %>  
                <% fee = fee_particular_child %>  
                <% fee_ids << fee_particular_child.id %>  
                <% end %>  
                <%  if fee.name.downcase != 'vat' %>
                <tr id="particular_<%= fee.id %>" class="particulars_tr">
                    <% paidAmount = 0 %>
                    <% unless @paid_fees.blank? %>
                       <% transaction_ids = @paid_fees.map(&:id) %> 
                       <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                       <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                       <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                       <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                       <% particular_amount_paid += paidAmount.to_f %>

                       <% if !@self_advance_fee and @fee_has_advance_particular %>
                        <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                          <% unless @fee_collection_advances.nil? %>
                            <% @fee_collection_advances.each do |fee_collection_advance| %>
                              <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                              <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                              <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                              <% @paid_advance_fees = @advance_fees.finance_transactions %>
                              <% unless @paid_advance_fees.blank? %>
                                <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                <% particular_amount_paid += paidAmount.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% else %>
                     <% if !@self_advance_fee and @fee_has_advance_particular %>
                        <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                          <% unless @fee_collection_advances.nil? %>
                            <% @fee_collection_advances.each do |fee_collection_advance| %>
                              <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                              <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                              <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                              <% @paid_advance_fees = @advance_fees.finance_transactions %>
                              <% unless @paid_advance_fees.blank? %>
                                <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                <% particular_amount_paid += paidAmount.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                    <% month = 1 %>
                    <% start_month = "" %>
                    <% end_month = "" %>
                    <% unless @fee_collection_advances.nil? %>
                      <% @fee_collection_advances.each do |fee_collection_advance| %>
                        <% if fee_collection_advance.particular_id == fee.finance_fee_particular_category_id %>
                          <% month = fee_collection_advance.no_of_month.to_i %>
                          <% start_month = fee_collection_advance.start_month %>
                          <% end_month = fee_collection_advance.end_month %>
                        <% end %>
                      <% end %>
                    <% end %>
                    <% if @self_advance_fee %>
                    <% fee_amount = (fee.amount * month.to_i).to_f - paidAmount %>
                    <% else %>
                    <% fee_amount = fee.amount - paidAmount %>
                    <% end %>
                    <% fee_amount = 0 if fee_amount < 0 %>
                    <td class="col-1" style=" text-align: center;">
                        <input type="hidden" name="fee_category_<%= fee.id %>" class="fee_category" id="fee_category_<%= fee.id %>" value="<%= fee.finance_fee_particular_category_id  %> " />
                        <% if fee_amount > 0 %>
                        <% if @self_advance_fee %>
                        <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                        <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                        <% else %>
                        <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                        <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" data-fee_amount="<%= precision_label fee.amount %>">
                        <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-square-o" style="color: #598A3D; font-size: 16px; cursor: pointer; color: #999;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                        <% else %>
                        <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                        <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                        <% end %>
                        <% end %>
                        <% else %>
                        <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"></span>
                        <% end %>
                    </td>
                    <td class="col-6">
                      <%= fee.name %>
                      <% if transport_particular_id.to_i == fee.finance_fee_particular_category_id.to_i %>
                        <% unless fee.description.blank? %>
                        <br /><small>(<%= fee.description.gsub("---","</b>").gsub("--","<b>") %>)</small>
                        <% end %>
                      <% end %>  
                      <% if @self_advance_fee %>
                        <br />(<small><%= month %> Month Advances</small>)
                        <br /><small>(<%= start_month %> to <%= end_month %>)
                      <% else %>
                           <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                            <br /><small>(Set for Advance Payment)</small>
                            <br />(<small><%= month %> Month Advances</small>)
                           <% end %>
                      <% end %>  
                    </td>
                    <td class="col-6" style="text-align: right;">
                        <% if fee_amount > 0 %>
                        <% if @self_advance_fee %>
                        <span style="color: #000;"> <span style="color: #000;"><%= precision_label fee_amount %></span></span>
                        <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% else %>
                        <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                        <span style="cursor: pointer; color: #999;"> <span style="color: #999;"><%= precision_label ( fee_amount.to_f * month.to_i) %></span></span>
                        <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% else %>
                        <span class="fee_amount_particular editable"  name="fee_amount_particular_<%= fee.id %>" id="fee_amount_particular_<%= fee.id %>" style="color: #000;"><i class="fa fa-pencil" style="font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label fee_amount %></span></span>
                        <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% end %>
                        <% end %>
                        <% else %>
                        <%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;<span style="font-size: 12px; font-weight: bold; display: none;"><br/>(paid)&nbsp;&nbsp;&nbsp;</span>
                        <% end %>
                    </td>
                </tr>
                <% end %>
                <% if !(@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) )) %>
                <% total_fees += fee_amount %>
                <% total_payable += fee.amount %>
                <% elsif @self_advance_fee and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id)) %>
                <% total_fees += fee_amount %>
                <% total_payable += fee.amount %>
                <% end %>
                <% end %>
              <% end %>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_amount') %> </td>
                <td class="col-6" style="text-align: right;">
                    <div style="display: none;">
                      <span id="fee_total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
                      <input type="hidden" name="fee_total_amount" id="fee_total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    </div>
                    <span id="fee_total_amount_tmp_label" style="color: #000;"><%= precision_label(total_fees.to_f + particular_amount_paid.to_f) %></span>
                    <input type="hidden" name="fee_total_amount_tmp" id="fee_total_amount" value="<%= precision_label(total_fees.to_f + particular_amount_paid.to_f ) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>
              </tr>
              
              <% unless @total_discount == 0 %>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-1" ></td>
                <td class="col-1" colspan="4"><span class="themed_text"><%= t('discount') %></span></td>
              </tr>
              <% discount_total = 0 %>

              <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
                <% @onetime_discounts.each do |d| %>
                  <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
                    <% discount_amount = @onetime_discounts_amount[d.id] %>
                  <% else %>
                    <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                  <% end %>
                  <% paidAmount = 0 %>
                  <% discountPaid = false %>
                  <% unless @paid_fees.blank? %>
                     <% transaction_ids = @paid_fees.map(&:id) %> 
                     <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                     <% unless paidFess.blank? %> 
                     <% discountPaid = true %>
                     <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                     <% discount_paid += paidAmount.to_f %>
                     <% end %>
                     <% if !@self_advance_fee and @fee_has_advance_particular %>
                      <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                        <% unless @fee_collection_advances.nil? %>
                          <% @fee_collection_advances.each do |fee_collection_advance| %>
                            <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                            <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                            <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                            <% @paid_advance_fees = @advance_fees.finance_transactions %>
                            <% unless @paid_advance_fees.blank? %>
                              <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                              <% unless paidFess.blank? %> 
                              <% discountPaid = true %>
                              <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                              <% discount_paid += paidAmount.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if discountPaid %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1 sl_no" style=" text-align: center;">
                      <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
                    <% total_payable -= paidAmount %>
                  </tr>  
                  <% else %>
                  <% discount_enable = true %>
                  <% unless @paid_fees.blank? %>
                    <% if d.finance_fee_particular_category_id == 0 %>
                      <% if discount_amount > total_fees  %>
                      <% discount_enable = false %>
                      <% end %>
                    <% else %>
                    <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
                    <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
                    <% paidAmount = 0 %>
                    <% finance_particular.each do |fee| %>
                      <%  if fee.name.downcase != 'vat' %>
                        <% transaction_ids = @paid_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% discount_paid += paidAmount.to_f %>
                        <% if !@self_advance_fee and @fee_has_advance_particular %>
                          <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                            <% unless @fee_collection_advances.nil? %>
                              <% unless @fee_collection_advances.nil? %>
                                <% @fee_collection_advances.each do |fee_collection_advance| %>
                                  <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                                  <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                                  <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                                  <% @paid_advance_fees = @advance_fees.finance_transactions %>
                                  <% unless @paid_advance_fees.blank? %>
                                    <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                                    <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                    <% unless paidFess.blank? %> 
                                    <% discountPaid = true %>
                                    <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                    <% discount_paid += paidAmount.to_f %>
                                    <% end %>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                    <% remaining_amount = amount_to_paid - paidAmount %>
                    <% if discount_amount > remaining_amount  %>
                    <% discount_enable = false %>
                    <% end %>
                    <% end %>
                  <% end %>
                  <% if discount_enable %>
                    <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
                    <% if !@self_advance_fee %>
                    <% discount_enable = false %>
                    <% end %>
                    <% end %>
                  <% end %>
                  <% if @adv_fee_discount && @actual_discount == 0 %>
                    <% discount_enable = false %>
                  <% end %>
                  <% if discount_enable %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1" style=" text-align: center;">
                      <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %> " />  
                      <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                      <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right;">
                        <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label discount_amount %></span></span>
                        <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% discount_total += discount_amount %>
                    </td>
                  </tr>
                  <% else %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1" style=" text-align: center;">
                      <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
                  </tr>
                  <% end %>
                  <% end %>
                  <% #i += 1 %>
                <% end %>
              <% end %>  
              <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
                <% @discounts.each do |d| %>
                  <% unless @discounts_amount[d.id].nil? or @discounts_amount[d.id].blank? %>  
                    <% discount_amount = @discounts_amount[d.id] %>
                  <% else %>
                    <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                  <% end %>
                  <% paidAmount = 0 %>
                  <% discountPaid = false %>
                  <% unless @paid_fees.blank? %>
                     <% transaction_ids = @paid_fees.map(&:id) %> 
                     <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                     <% unless paidFess.blank? %> 
                     <% discountPaid = true %>
                     <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                     <% discount_paid += paidAmount.to_f %>
                     <% end %>
                     <% if !@self_advance_fee and @fee_has_advance_particular %>
                      <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                        <% unless @fee_collection_advances.nil? %>
                          <% @fee_collection_advances.each do |fee_collection_advance| %>
                            <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                            <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                            <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                            <% @paid_advance_fees = @advance_fees.finance_transactions %>
                            <% unless @paid_advance_fees.blank? %>
                              <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                              <% unless paidFess.blank? %> 
                              <% discountPaid = true %>
                              <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                              <% discount_paid += paidAmount.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if discountPaid %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1 sl_no" style=" text-align: center;">
                      <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
                    <% total_payable -= paidAmount %>
                  </tr>  
                  <% else %>
                  <% discount_enable = true %>
                  <% unless @paid_fees.blank? %>
                    <% if d.finance_fee_particular_category_id == 0 %>
                      <% if discount_amount > total_fees  %>
                      <% discount_enable = false %>
                      <% end %>
                    <% else %>
                    <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
                    <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
                    <% paidAmount = 0 %>
                    <% finance_particular.each do |fee| %>
                      <%  if fee.name.downcase != 'vat' %>
                        <% transaction_ids = @paid_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% discount_paid += paidAmount.to_f %>
                        <% if !@self_advance_fee and @fee_has_advance_particular %>
                          <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                            <% unless @fee_collection_advances.nil? %>
                              <% @fee_collection_advances.each do |fee_collection_advance| %>
                                <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                                <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                                <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                                <% @paid_advance_fees = @advance_fees.finance_transactions %>
                                <% unless @paid_advance_fees.blank? %>
                                  <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                                  <% unless paidFess.blank? %> 
                                  <% discountPaid = true %>
                                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                                  <% discount_paid += paidAmount.to_f %>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                    <% remaining_amount = amount_to_paid - paidAmount %>
                    <% if discount_amount > remaining_amount  %>
                    <% discount_enable = false %>
                    <% end %>
                    <% end %>
                  <% end %>
                  <% if discount_enable %>
                    <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
                    <% if !@self_advance_fee %>
                    <% discount_enable = false %>
                    <% end %>
                    <% end %>
                  <% end %>
                  <% if @adv_fee_discount && @actual_discount == 0 %>
                    <% discount_enable = false %>
                  <% end %>
                  <% if discount_enable %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1" style=" text-align: center;">
                      <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %> " />  
                      <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                      <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right;">
                        <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label discount_amount %></span></span>
                        <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% discount_total += discount_amount %>
                    </td>
                  </tr>
                  <% else %>
                  <tr class="<%= cycle("odd","even") %>">
                    <td class="col-1" style=" text-align: center;">
                      <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                    <td class="col-2" colspan="3"><%= discount_text %></td>
                    <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
                  </tr>
                  <% end %>
                  <% end %>
                  <% #i += 1 %>
                <% end %>
              <% end %>
                  
              <% if @paid_fees.blank? or discount_total > 0 %>    
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_discount') %> </td>
                <td class="col-6" style="text-align: right;">
                    <span id="discount_total_amount_label" style="color: #000;"><span style="font-size: 12px;">(<B>-</B>)</span>&nbsp;<%= precision_label(discount_total) %></span>
                    <input type="hidden" name="discount_total_amount" id="discount_total_amount" value="<%= precision_label(discount_total) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>
              </tr>
              <% end %>

              <% unless @vat.nil? and @paid_fees.blank? %>
              <% if @vat.to_f == 0.00 %>
                <% vat_amount = 0 %>
                <% @paid_fees.each do |trans| %>
                <% if trans.vat_included %>
                    <% if trans.vat_amount.to_f > 0.00 %>
                      <%  vat_amount += trans.vat_amount.to_f %>
                    <% end %>
                <% end %>
                <% end %>
                <% @vat = vat_amount %>
              <% end %>
              <% if @vat.to_f > 0.00 %>
              <tr id="vat_as_particular_blank_space_1" class="tr-blank"></tr>
              <tr id="vat_as_particular_blank_space_2" class="tr-blank"></tr>
              <tr id="vat_as_particular_blank_space_3" class="tr-blank"></tr>
              <tr id="vat_as_particular_blank_space_4" class="tr-blank"></tr>
              <tr id="vat_as_particular" class="<%= cycle("odd","even") %>">
                <% paidAmount = 0 %>
                <% unless @paid_fees.blank? %>
                   <% transaction_ids = @paid_fees.map(&:id) %> 
                   <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'VAT' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
                   <% unless paidFess.blank? %> 
                   <% discountPaid = true %>
                   <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                   <% end %>
                <% end %>  
                <% remaining_amount = @vat.to_f - paidAmount  %>
                <% if remaining_amount < 0 %>  
                  <% remaining_amount = 0 %>
                <% end %>  
                <% if remaining_amount == 0 %>  
                  <% if @vat.to_f < paidAmount %>
                    <% @vat = paidAmount %>
                  <% end %>
                  <td class="col-1 sl_no" style=" text-align: center;">
                    <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>
                  </td>
                  <td class="col-2"><%= "VAT" %></td>
                  <td class="col-2" style="text-align: right;"><%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;</td>
                  <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
                  <td class="col-2" style="text-align: right;"><%= precision_label remaining_amount.to_f %>&nbsp;&nbsp;&nbsp;</td>
                <% else %>  
                  <% if @vat_as_particular %>
                    <td class="col-1" style="text-align: center;">
                        <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                        <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <td class="col-2">
                        <span class="themed_text"><%= "VAT" %></span>
                    </td>
                    <td class="col-2" style="text-align: right;">
                      <% if paidAmount > 0 %>  
                        <span class="only_enable_vat" name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><span style="color: #000;"><%= precision_label remaining_amount.to_f %></span></span>&nbsp;&nbsp;&nbsp;
                        <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label remaining_amount.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" />
                      <% else %>
                        <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @vat.to_f %></span></span>
                        <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% if @vat_as_particular == false and paidAmount == 0 %>
                        <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                            <br />Assign to the Student
                        </span>
                        <% end %>
                      <% end %>
                    </td>
                  <% else %>
                    <% if paidAmount > 0 %>
                    <td class="col-1 sl_no" style=" text-align: center;">
                      <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <td class="col-2"><%= "VAT" %></td>
                    <td class="col-2" style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
                    <% else %>
                    <td class="col-1" style="text-align: center;">
                        <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                        <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                    </td>
                    <td class="col-2">
                        <span class="themed_text"><%= "VAT" %></span>
                    </td>
                    <td class="col-2" style="text-align: right;">
                        <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @vat.to_f %></span></span>
                        <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                        <% if @vat_as_particular == false and paidAmount == 0 %>
                        <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                            <br />Assign to the Student
                        </span>
                        <% end %>
                    </td>
                    <% end %>
                  <% end %>
                <% end %>
              </tr>
              <% total_fees += remaining_amount %>
              <% total_payable += @vat.to_f %>
            <% end %>
            <% end %>
              
            <tr class="tr-blank"></tr>
            <tr class="tr-blank"></tr>
            <tr class="tr-blank"></tr>
            <tr class="tr-blank"></tr>  
            <% load_fine_amount_to_pay = false %>
            <% total_fees = (total_fees-(discount_total))%>
            <% total_payable = (total_payable-(discount_total))%>
            <%#= discount_paid %>
            <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('total_fees') %> </td>
                <td class="col-6"  style="text-align: right;">
                    <div style="display: none;">
                      <span id="total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
                      <input type="hidden" name="total_amount" id="total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    </div>
                    <span id="total_amount_label_tmp" style="color: #000;"><%= precision_label((total_fees.to_f + particular_amount_paid.to_f) - discount_paid.to_f) %></span>
                    <input type="hidden" name="total_amount_tmp" id="total_amount" value="<%= precision_label((total_fees.to_f + particular_amount_paid.to_f) - discount_paid.to_f) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>
            </tr>
            <% end %>
            
            <% fine_paid = false %>
            <% unless @fine_rule%>
              <% unless @paid_fees.blank? %>
                <% paidAmount = 0 %>
                <% unless @paid_fees.blank? %>
                  <% transaction_ids = @paid_fees.map(&:id) %> 
                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
                  <% unless paidFess.blank? %> 
                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                  <% fine_amount_paid_student += paidAmount.to_f %>
                  <% end %>
                <% end %>  
                <% if paidAmount > 0 %>
                  <% fine_paid = true %>
                  <% @fine = paidAmount %>
                <% end %>
              <% end %>
            <% end %>

            <% unless @fine.nil? %>
              <% if @fine.to_f > 0.00 %>
              <tr id="fine_blank_space_1" class="tr-blank"></tr>
              <tr id="fine_blank_space_2" class="tr-blank"></tr>
              <tr id="fine_blank_space_3" class="tr-blank"></tr>   
              <tr id="fine_blank_space_4" class="tr-blank"></tr>   
              <% if fine_paid %>
              <tr id="extra_fine" class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>
                </td>
                <td class="col-2"><span class="themed_text">
                  <%= t('fine_on') %> <%= @paid_fees.first.transaction_date %></span>
                </td>
                <td class="col-6"  style="text-align: right;"><%= precision_label @fine.to_f %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
              <% else %>
              <% total_fees += @fine.to_f %>
              <tr id="extra_fine" class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @fine.to_f %>">
                    <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>
                <td class="col-2"><span class="themed_text">
                  <%= t('fine_on') %> <%= Date.today %></span>
                  <span id="rm_fine" style="float: right; cursor: pointer;">
                      <i class="fa fa-minus-circle remove_fine" style="font-size: 20px; color: #990A10; " aria-hidden="true"></i>
                  </span>
                </td>
                <td class="col-6"  style="text-align: right;">
                    <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @fine.to_f %></span></span>
                    <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @fine.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine) %>" /><i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <% load_fine_amount_to_pay = true %>
                </td>
              </tr>
              <% end %>
            <% end %>
            <% end %>
            <%total_fees1=total_fees%>
            <% fine_amount_total = 0 %>  
            <%if @fine_rule%>
              <tr id="fine_blank_space_1" class="tr-blank"></tr>
              <tr id="fine_blank_space_2" class="tr-blank"></tr>
              <tr id="fine_blank_space_3" class="tr-blank"></tr>   
              <tr id="fine_blank_space_4" class="tr-blank"></tr>
              <% paidAmount = 0 %>
              <% fine_discount = 0 %>
              <% if @has_fine_discount %>    
              <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
                <% @discounts_on_lates.each do |d| %>
                  <% if @discounts_late_amount[d.id] > 0 %>
                    <% fine_discount += @discounts_late_amount[d.id] %>
                  <% end %>
                <% end %>
              <% end %>
              <% end %>
              <% new_fine = @new_fine_amount.to_f - fine_discount.to_f %>
              <% unless @paid_fees.blank? %>
                 <% transaction_ids = @paid_fees.map(&:id) %> 
                 <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
                 <% unless paidFess.blank? %> 
                 <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                 <% fine_amount_paid_student += paidAmount.to_f %>
                 <% end %>
              <% end %>  
              <% remaining_amount = new_fine.to_f - paidAmount.to_f  %>
              <% if remaining_amount <= 0 %>
              <tr id="extra_fine" class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                   <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>
                </td>
                <td class="col-2">
                  <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
                </td>
                <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
              <% else %>
              <% if paidAmount > 0 %>
              <tr id="extra_fine" class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label remaining_amount %>">
                    <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>
                <td class="col-2">
                  <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
                </td>
                <td class="col-6"  style="text-align: right;">
                    <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label remaining_amount %></span></span>
                    <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label remaining_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <% fine_amount_total += remaining_amount %>  
                </td>
              </tr>
              <% else %>
              <tr id="extra_fine" class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @new_fine_amount %>">
                    <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>
                <td class="col-2">
                  <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
                </td>
                <td class="col-6"  style="text-align: right;">
                    <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @new_fine_amount %></span></span>
                    <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @new_fine_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <% fine_amount_total += @new_fine_amount %>  
                </td>
              </tr>
              <% end %>
              <% end %>
            <%end%>
            <% fine_discount = 0 %>  
            <% if @has_fine_discount %>    
              <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
                <% @discounts_on_lates.each do |d| %>
                  <% if @discounts_late_amount[d.id] > 0 %>
                    <% paidAmount = 0 %>
                    <% unless @paid_fees.blank? %>
                      <% transaction_ids = @paid_fees.map(&:id) %> 
                      <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'FineAdjustment' and transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = '#{d.id}'") %>
                      <% unless paidFess.blank? %> 
                      <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                      <% end %>
                   <% end %>  
                   <% remaining_amount = @discounts_late_amount[d.id].to_f - paidAmount.to_f  %>
                   <% if paidAmount > 0 %>
                   <tr class="<%= cycle("odd","even") %>">
                      <td class="col-1" style="text-align: center;">
                          <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                      </td>  
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="col-2"><%= discount_text %></td>
                      <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
                    </tr>
                   <% else %>
                    <% if fine_amount_total > @discounts_late_amount[d.id] %>
                    <tr class="<%= cycle("odd","even") %>">
                      <td class="col-1" style="text-align: center;">
                          <input type="checkbox" name="fee_fine_discount_<%= d.id %>" id="fee_fine_discount_<%= d.id %>" class="fee_fine_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label @discounts_late_amount[d.id] %>">
                          <i name="fee_fine_discount_fa_<%= d.id %>" id="fee_fine_discount_fa_<%= d.id %>" class="fa fa-check-square-o fee_fine_discount_fa" style="color: #598A3D; font-size: 20px; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                      </td>  
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="col-2"><%= discount_text %></td>
                      <td class="col-6" style="text-align: right;">
                          <span class="fee_fine_amount_discount editable"  name="fee_fine_amount_discount_<%= d.id %>" id="fee_fine_amount_discount_<%= d.id %>" style="color: #000;"><i class="fa fa-pencil" style="color: #598A3D; font-size: 12px; display: none;" aria-hidden="true"></i> <span style="color: #000;"><%= precision_label @discounts_late_amount[d.id] %></span></span>
                          <input type="hidden" name="fee_fine_discount_amount_<%= d.id %>" id="fee_fine_discount_amount_<%= d.id %>" value="<%= precision_label @discounts_late_amount[d.id] %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine_discount')" onkeydown="checkKey(event,this, 'fine_discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine_discount" name="fee_fine_discount_chk_<%= d.id %>" id="fee_fine_discount_chk_<%= d.id %>" style="color: #598A3D; font-size: 20px;  display: none;" aria-hidden="true"></i>
                          <% fine_discount += @discounts_late_amount[d.id] %>  
                      </td>
                    </tr>
                    <% else %>
                    <tr class="<%= cycle("odd","even") %>">
                      <td class="col-1" style="text-align: center;">
                          <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                      </td>  
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="col-2"><%= discount_text %></td>
                      <td class="col-6" style="text-align: right; text-decoration: line-through;"><%= precision_label @discounts_late_amount[d.id] %>&nbsp;&nbsp;&nbsp;</td>
                    </tr>
                    <% end %>
                    <% end %>
                  <% end %>
                  <% i += 1 %>
                <% end %>
              <% end %> 
              <% @fine_amount = fine_amount_total - fine_discount %>      
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
                <td class="col-6"  style="text-align: right;">
                    <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>&nbsp;&nbsp;&nbsp;
                    <% if load_fine_amount_to_pay == false %>
                    <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <% load_fine_amount_to_pay = true %>
                    <% end %>
                </td> 
              </tr>
            <% else %>  
              <% @fine_amount = fine_amount_total - fine_discount %>      
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
                <td class="col-6" style="text-align: right;">
                    <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>
                    <% if load_fine_amount_to_pay == false %>
                    <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    <% end %>
                </td> 
              </tr>
            <% end %>
            <% total_fees += fine_amount_total.to_f %>  
            <% total_pay = total_payable %>  
            <% unless @paid_fees.nil? %>
              <% paid=0 %>
              <% @paid_fees.each{|a| paid += a.amount.to_f} %>
              <%
                fine_amount_paid = 0.0
                paid_fine = 0.0
                unless @paid_fees.blank?
                  transaction_ids = @paid_fees.map(&:id)
                  unless transaction_ids.blank?
                    paidFineFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")")
                    unless paidFineFess.blank?
                      paid_fine += paidFineFess.map(&:amount).sum.to_f
                    end
                  end
                  unless @fine_amount == 0
                    fine_amount_paid = @fine_amount
                  else
                    unless @new_fine_amount.blank?
                      fine_amount_paid = @new_fine_amount
                    else
                      fine_amount_paid = 0
                    end
                  end
                  unless paid_fine.nil?
                    paid_fine = paid_fine - fine_amount_paid
                  end
                else
                  fine_amount_paid = @fine_amount
                end
                total_payable += fine_amount_paid.to_f
              %>
              <% fine_amount_paid_student = fine_amount_paid.to_f %>
              <% paid_amount = (particular_amount_paid.to_f + fine_amount_paid_student) - discount_paid %>
              
              <% unless @paid_fees.blank? %>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><b><%= "Total Fees" %></b></td>
                <td class="col-6"  style="text-align: right;">
                    <span id="remaining_amount_label" style="color: #000;"><%= precision_label(total_payable) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>  
              </tr>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><b><%= "Paid" %></b></td>
                <td class="col-6"  style="text-align: right;">
                    <span id="remaining_amount_label" style="color: #000;"><%= precision_label(paid_amount) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>  
              </tr>
              <% end %>
              <% if (total_payable + paid_fine) < paid %>
              <% amount_advanced = paid - ( total_payable + paid_fine ) %>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><b><%= "Payment Done" %></b></td>
                <td class="col-6"  style="text-align: right;">
                    <span id="remaining_amount_label" style="color: #000;"><%= precision_label(paid) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>  
              </tr>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><b><%= "Advanced Payment" %></b></td>
                <td class="col-6"  style="text-align: right;">
                    <span id="remaining_amount_label" style="color: #000;"><%= precision_label(amount_advanced) %></span>&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>  
              </tr>
              <% end %>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="tr-blank"></tr>
              <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
                <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= "Fees Information" %> </td>
                <td class="col-6"  style="text-align: right;">
                    <div style="display: none;">
                        <span id="total_payable_label" style="color: #000;"><%= precision_label(total_payable) %></span>
                        <input type="hidden" name="total_payable" id="total_payable" value="<%= precision_label(total_payable) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    </div>
                    <div style="display: none;">
                        <span id="payment_done_label" style="color: #000;"><%= precision_label(paid) %></span>
                        <input type="hidden" name="payment_done" id="payment_done" value="<%= precision_label(paid) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                    </div>
                    <span id="remaining_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
                    <input type="hidden" name="remaining_amount" id="remaining_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
                </td>  
              </tr>
            <% end %>
              
            <%balance=@financefee.balance.to_f+@fine.to_f+@vat.to_f%>
            <% if balance.to_f < 0 %>  
            <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
              <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('advance_payment') %>1 </td>
              <td class="col-6"  style="text-align: right;">
                  <span id="advance_payment_label" style="color: #000;"><%= precision_label( (balance+@fine_amount.to_f) * -1 ) %></span>
                  <input type="hidden" name="advance_payment" id="advance_payment" value="<%= precision_label( (balance+@fine_amount.to_f) * -1 ) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
              </td>
            </tr>  
            <% else %>  
            <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
              <% fee_to_pay = 0 %>  
              <% unless precision_label(balance+@fine_amount.to_f).to_f == 0 %>
                <% fee_to_pay = balance+@fine_amount.to_f %>
              <% end %>
              <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= t('amount_to_pay') %> </td>
              <td class="col-6"  style="text-align: right;">
                  <span id="amount_to_pay_label" style="color: #000;"><%= precision_label(total_fees) %></span>
                  <input type="hidden" name="amount_to_pay" id="amount_to_pay" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="color: #598A3D; font-size: 20px; display: none;" aria-hidden="true"></i>
              </td>  
            </tr>
            <% end %>

            <script type="text/javascript">
              j(document).ready(function(){
                  if ( j("#remaining_amount").length > 0 )
                  {
                      if ( parseFloat(j("#remaining_amount").val()) <= 0 )
                      {

                          j(".fine_info").remove();
                      }
                  }
              });
            </script>
            
            <% under_maintenance = false %>
            <% if MultiSchool.current_school.id == 352 %>
            <% @student_has_due = false %>
            <% end %>
              
            <% if @student_has_due == false #and @financefee.batch_id == @student.batch_id %>
              <%#= total_fees.to_s + " DID DID DID" %>
              <% if total_fees > 0 and under_maintenance == false  %>
                  <% @amount_to_pay = precision_label(balance+@fine_amount.to_f) %>
                  <tr>
                    <td colspan="5" style="padding-bottom: 30px;">
                        <div class="pay_fees"><div class="pay_fees_buttons" style="text-align: center;">
                      <% if @active_gateway == "Paypal" %>
                        <%= paypal_pay_button(@certificate,@merchant_id,"FEE #{@fee_collection.name}",total_fees,"http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1",@paid_fees,"float: right;margin: 18px 0 0;") %>
                      <% elsif @active_gateway == "Authorize.net" %>
                        <%= authorize_net_pay_button(@merchant_id,@certificate,total_fees,"Fee (#{@student.full_name}-#{@student.admission_no}-#{@fee_collection.name})","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1&only_path=false",@paid_fees,"float: right;margin: 18px 0 0;") %>
                      <% elsif @active_gateway == "ssl.commerce" %>
                        <%= ssl_commerce_pay_button(@store_id,@store_password,total_fees,"Fee (#{@student.full_name}-#{@student.admission_no}-#{@fee_collection.name})","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_cancel_transaction=1","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}","http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_fail_transaction=3",@trans_id_ssl_commerce,@paid_fees,"float: right;margin: 18px 0 0;") %>
                      <% elsif @active_gateway == "trustbank" %>
                        <input type="hidden" name="order_id" id="order_id" value="<%= @order_id %>" />
                        <%= submit_tag "► #{t('pay_fees')}",:class=>'user_button_new' , :id => 'submit_button' %>
                        <% 
                        require 'securerandom'
                        o = [('a'..'z'), (1..9)].map(&:to_a).flatten
                        string = (0...8).map { o[rand(o.length)] }.join 
                        %>
                        <% email = '-' %>
                        <% unless @student.immediate_contact.nil? or @student.immediate_contact.blank? %>
                             <% unless @student.immediate_contact.email.blank? %>
                                <% email = @student.immediate_contact.email %>
                             <% end %>
                        <% end %>      
                        <%#= trustbank_pay_button(@merchant_id,total_fees,@student.admission_no, email, "http://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1", SecureRandom.random_number(1000000)) %>
                      <% end %>
                      <% if MultiSchool.current_school.id != 352 %>  
                      <%= link_to "► #{t('print_receipt')}",
                        {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id},:target => '_blank', :class=> 'user_button_new' %>
                      </div></div>  
                      <% end %>  
                    </td>
                  </tr>
              <% else %>
                  <% if under_maintenance %>
                  <tr><td colspan="5" style="padding-bottom: 30px;">
                      <div class="pay_fees"><div class="pay_fees_buttons">
                      <img src="/images/under-maintenance.png" style="width: 150px; float: right;" /> 
                      </div></div>  
                  </td></tr>
                  <% end %>
              <% end %>
            <% else %>
                  <% if @financefee.batch_id != @student.batch_id and total_fees > 0 %>
                  <tr>
                      <td colspan="5">
                        <center><font color="red">***Your class or Section has been changes, Please contact admin to update your payment info***</font></center> 
                      </td>
                  </tr>    
                  <% elsif total_fees > 0 %>
                  <tr>
                      <td colspan="5">
                        <center><font color="red">***Student Has Previous Due***</font></center> 
                      </td>
                  </tr> 
                  <% end %>
            <% end %>
        <% end %>
      <% end %>
  </body>
</html>

<style>
    .header-info {
        //background-image: url('/images/backgrounds/top_profile.png'); 
        background-image: linear-gradient(to bottom,#DB3434 0,#820d0d 100%);
        color: #fff; 
        font-size: 16px; 
        font-weight: bold;
        float: left;
        width: 100%;
    }
    .alert-info
    {
        border-top: 0px;
        border-right: 0px;
        border-left: 0px;
        border-radius: 0px !important;
        margin-bottom: 10px;
    }
    .list-special .list-group-item:first-child {
        border-top-right-radius: 0px !important;
        border-top-left-radius: 0px !important;
    }

    .list-special .list-group-item:last-child {
        border-bottom-right-radius: 0px !important;
        border-bottom-left-radius: 0px !important;
    }
    .alert > p + p{
        margin-top: 0px;
    }
    
    .user_button_new {
        background: #49bb4b none repeat scroll 0 0 !important;
        border: medium none;
        color: #FFFFFF;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin: 18px 5px 0 5px;
        padding: 7px 10px;
        height: 34px;
        border-radius: 4px !important;
        -webkit-border-radius: 4px !important;
        -moz-border-radius: 4px !important;

    }
    .table thead tr th{
      font-size: 14px;
      font-weight: bold;
    }
    .table tbody tr td{
      font-size: 13px;
      font-weight: bold;
    }
    .fees_particular_fa{
      display: none;
    }
    .fees_discount_fa {
      display: none;
    }
    .fee_vat_fa {
      display: none;
    }
    .fee_fine_fa {
      display: none;
    }
    .fee_fine_discount_fa {
      display: none;
    }
    .expand_tr {
      cursor: pointer;
    }
</style>