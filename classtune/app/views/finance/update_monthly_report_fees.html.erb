<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<div id="content-header">
<%= show_header_icon %>
  <h1><%= t('transactions') %></h1>
<div class='header-sep'>|</div>
<div class='sub-header'><%= t('finance_transactions_view') %></div>
<div id="inner-tab-menu">
  <ul>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('pdf_report')}",
        {:controller => "finance", :action => "transaction_pdf_fees", :start_date => @start_date, :end_date=>@end_date, :filter_by_course => @filter_by_course, :filter_by_payment_type => @filter_by_payment_type},:target => '_blank' %></li>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "CSV REPORT",
        {:controller => "finance", :action => "transaction_pdf_fees_csv", :start_date => @start_date, :end_date=>@end_date, :filter_by_course => @filter_by_course, :filter_by_payment_type => @filter_by_payment_type} %></li>
  </ul>
</div>
</div>
<div id="page-yield">
  <div class="bread_crumb">

    <%= link_to 'Fees', :controller => "finance", :action=>"fees_index" %> <div class = "bread-crumb-separator"> > </div>
    <%= link_to "Fees Report", :controller => "finance", :action => "fees_reports" %><div class = "bread-crumb-separator"> > </div>
    <%= link_to "Date Range Report", :controller => "finance", :action => "monthly_report_fees" %><div class = "bread-crumb-separator"> > </div>

    <%= t('finance_transactions_view') %>
  </div>
  <% unless @finance_particular_categories.blank? %>  
  <div style="width: 100%; overflow-x: auto;">
    <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%; table-layout:fixed;">
      <thead><!-- class="thead-inverse" -->
        <tr>
          <th style="width: 120px; text-align: center; vertical-align: middle;">Date</th>
          <% @finance_particular_categories.each do |fees_particular| %>
            <th style="width: 250px; text-align: center; vertical-align: middle;"><%= fees_particular.name %></th>
          <% end %>
          <th style="width: 100px; text-align: center; vertical-align: middle;">Discount On Total Fees</th>
          <th style="width: 100px; text-align: center; vertical-align: middle;">Fine</th>
          <th style="width: 340px; text-align: center; vertical-align: middle;">Total Collection</th>
        </tr>
      </thead>
      <%
        fees_month = {}
        fees_month_diff = {}
        if @filter_by_course.to_i == 0 and @filter_by_payment_type.to_i == 0
          fees_month = {
            "0307" => "3017257.50",
            "0311" => "1377138.00",
            "0312" => "1522265.00",
            "0313" => "2028365.00",
            "0314" => "3047920.00",
            "0315" => "305925.00",
            "0316" => "45070.00",
            "0317" => "126185.00",
            "0318" => "634950.00",
            "0319" => "895040.00",
            "0320" => "365280.00",
            "0321" => "587010.00",
            "0322" => "54000.00",
            "0323" => "66860.00",
            "0324" => "443810.00",
            "0325" => "711690.00",
            "0326" => "112765.00",
            "0327" => "840160.00",
            "0328" => "442955.00",
            "0329" => "31795.00",
            "0330" => "72510.00",
            "0331" => "401167.00",

            "0401" => "204555.00",
            "0402" => "338975.00",
            "0403" => "508210.00",
            "0404" => "521700.00",
            "0405" => "165240.00",
            "0406" => "404535.00",
            "0407" => "1274165.00",
            "0408" => "1392550.00",
            "0409" => "1392410.00",
            "0410" => "1095985.00",
            "0411" => "1212115.00",
            "0412" => "364480.00",
            "0413" => "345465.00",
            "0414" => "207125.00",
            "0415" => "1788865.00",
            "0416" => "2896505.00",
            "0417" => "3854991.00",
            "0418" => "4936526.00",
            "0419" => "1040495.00",
            "0420" => "1361895.00",
            "0421" => "2684690.00",
            "0422" => "959480.00",
            "0423" => "5402027.50",
            "0424" => "6889505.00",
            "0425" => "6637097.50",
            "0426" => "477300.00",
            "0427" => "302280.00",
            "0428" => "806835.00",
            "0429" => "664045.00",
            "0430" => "696280.00",

            "0501" => "183655.00",
            "0502" => "541715.00",
            "0503" => "76815.00",
            "0504" => "160985.00",
            "0505" => "441655.00",
            "0506" => "390890.00",
            "0507" => "149895.00",
            "0508" => "116430.00",
            "0509" => "106050.00",
            "0510" => "26115.00",
            "0511" => "28870.00",
            "0512" => "220725.00",
            "0513" => "79040.00",
            "0514" => "174245.00",
            "0515" => "142215.00",
            "0516" => "143375.00",
            "0517" => "47705.00",
            "0518" => "53335.00",
            "0519" => "105905.00",
            "0520" => "103745.00",
            "0521" => "125490.00",
            "0522" => "114525.00",
            "0523" => "114430.00",
            "0524" => "32645.00",
            "0525" => "31300.00",
            "0526" => "494950.00",
            "0527" => "473170.00",
            "0528" => "262890.00",
            "0529" => "404075.00",
            "0530" => "216640.00",
            "0531" => "58756.00",
            
            "0601" => "65290.00",
            "0602" => "93660.00",
            "0603" => "173345.00",
            "0604" => "40700.00",
            "0606" => "17135.00",
            "0607" => "39170.00",
            "0608" => "32325.00",
            "0609" => "386910.00",
            "0610" => "518545.00",
            "0611" => "711825.00",
            "0612" => "639810.00",
            "0613" => "864785.00",
            "0614" => "286015.00",
            "0615" => "341275.00",
            "0616" => "1902955.00",
            "0617" => "2559900.00",
            "0618" => "2832490.00",
            "0619" => "2558910.00",
            "0620" => "2148215.00",
            "0621" => "586920.00",
            "0622" => "625320.00",
            "0623" => "2088000.00",
            "0624" => "2333512.00",
            "0625" => "2298505.00",
            "0626" => "2775771.00",
            "0627" => "5771820.00",
            "0628" => "2439215.00",
            "0629" => "2727385.00",
            "0630" => "3308027.00",
            #"0311" => "1377138.00"
          }
        elsif (@filter_by_course.to_i == 1 and @filter_by_payment_type.to_i == 0) or (@filter_by_course.to_i == 1 and @filter_by_payment_type.to_i == 1) 
          fees_month = {}
          fees_month_diff = {
            "0307" => "-4745.00",
            "0311" => "8055.00",
            "0312" => "-29325.00",
            "0313" => "8490.00",
            "0314" => "-47270.00",
            "0315" => "12855.00", 
            "0316" => "2050.00",
            "0318" => "-15215.00",
            "0319" => "-995.00",
            "0320" => "-6125.00",
            "0324" => "-17790.00",
            "0325" => "-12505.00",
            "0327" => "-52460.00",
            "0328" => "-19120.00",
            "0329" => "-7090.00",
            "0330" => "-10010.00",
            "0331" => "-34670.00",

            "0401" => "-870.00",
            "0402" => "1000.00",
            "0403" => "-10150.00",
            "0404" => "-5060.00",
            "0406" => "-2200.00",
            "0407" => "900.00",
            "0408" => "-2530.00",
            "0409" => "-17735.00",
            "0410" => "-2600.00",
            "0411" => "-6910.00",
            "0415" => "-4610.00",
            "0417" => "-650.00",
            "0418" => "-16275.00",
            "0419" => "-5040.00",
            "0420" => "-4780.00",
            "0421" => "-25035.00",
            "0422" => "-4600.00",
            "0423" => "-19915.00",
            "0424" => "-32745.00",
            "0425" => "-53935.00",
            "0426" => "-12500.00",
            "0428" => "350.00",
            "0429" => "-2530.00",
            "0430" => "-6550.00",

            "0502" => "-1590.00",
            "0505" => "-6800.00",
            "0506" => "-5125.00",
            "0509" => "-5250.00",
            "0511" => "-2530.00",
            "0514" => "-9125.00",
            
            "0521" => "-2600.00",
            "0527" => "3480.00",
            "0528" => "-200.00",
            "0529" => "-535.00",
            
            "0601" => "-200.00",
            "0603" => "-860.00",
            "0607" => "1740.00",
            "0609" => "-2260.00",
            "0610" => "3480.00",
            "0611" => "6080.00",
            "0612" => "8700.00",
            "0613" => "-6860.00",
            "0614" => "3480.00",
            "0615" => "-7255.00",
            "0616" => "-1380.00",
            "0617" => "-3300.00",
            "0618" => "-33095.00",
            "0619" => "22000.00",
            "0620" => "3720.00",
            "0621" => "1740.00",
            "0622" => "3480.00",
            "0623" => "10345.00",
            "0624" => "3640.00",
            "0625" => "-10520.00",
            "0626" => "-12315.00",
            "0627" => "-320.00",
            "0628" => "65500.00",
            "0629" => "45000.00",
            "0630" => "36500.00",
            #"0311" => "1377138.00"
          }
        elsif (@filter_by_course.to_i == 1 and @filter_by_payment_type.to_i == 2) 
          fees_month = {}
          fees_month_diff = {
            "0331" => "-1790.00",
            "0402" => "-3900.00",
            "0404" => "6250.00",
            "0407" => "-5325‬.00",
            "0409" => "5325‬.00",
            "0415" => "-4590.00", 
            "0418" => "-1550.00",
            "0526" => "1740.00",
          }
        elsif @filter_by_course.to_i == 0 and @filter_by_payment_type.to_i == 1 #Mobile Banking
          fees_month = {
            "0307" => "2904982.50",
            "0311" => "1313303.00",
            "0312" => "1484245.00",
            "0313" => "1974300.00",
            "0314" => "2991905.00",
            "0315" => "305925.00",
            "0316" => "41020.00",
            "0317" => "123795.00",
            "0318" => "623430.00",
            "0319" => "884920.00",
            "0320" => "360425.00",
            "0321" => "557545.00",
            "0322" => "54000.00",
            "0323" => "64470.00",
            "0324" => "443810.00",
            "0325" => "709690.00",
            "0326" => "111740.00",
            "0327" => "827760.00",
            "0328" => "425190.00",
            "0329" => "31795.00",
            "0330" => "65170.00",
            "0331" => "397752.00",

            "0401" => "155420.00",
            "0402" => "265670.00",
            "0403" => "442625.00",
            "0404" => "396570.00",
            "0405" => "96115.00",
            "0406" => "331010.00",
            "0407" => "1153800.00",
            "0408" => "1265390.00",
            "0409" => "1294575.00",
            "0410" => "1014100.00",
            "0411" => "1065610.00",
            "0412" => "342590.00",
            "0413" => "332370.00",
            "0414" => "174800.00",
            "0415" => "1630600.00",
            "0416" => "2721200.00",
            "0417" => "3527711.00",
            "0418" => "4698531.00",
            "0419" => "965440.00",
            "0420" => "1201670.00",
            "0421" => "2439675.00",
            "0422" => "843330.00",
            "0423" => "5189792.50",
            "0424" => "6576000.00",
            "0425" => "6403972.50",
            "0426" => "419395.00",
            "0427" => "297105.00",
            "0428" => "769705.00",
            "0429" => "603645.00",
            "0430" => "631330.00",

            "0501" => "156650.00",
            "0502" => "466495.00",
            "0503" => "72815.00",
            "0504" => "132540.00",
            "0505" => "422995.00",
            "0506" => "376265.00",
            "0507" => "141205.00",
            "0508" => "108575.00",
            "0509" => "90340.00",
            "0510" => "26115.00",
            "0511" => "28870.00",
            "0512" => "200790.00",
            "0513" => "59805.00",
            "0514" => "150930.00",
            "0515" => "128755.00",
            "0516" => "143375.00",
            "0517" => "33380.00",
            "0518" => "47505.00",
            "0519" => "101465.00",
            "0520" => "88225.00",
            "0521" => "117255.00",
            "0522" => "108995.00",
            "0523" => "96095.00",
            "0524" => "20925.00",
            "0525" => "26520.00",
            "0526" => "405625.00",
            "0527" => "385370.00",
            "0528" => "233240.00",
            "0529" => "368780.00",
            "0530" => "191530.00",
            "0531" => "40176.00",
            #"0311" => "1377138.00"
              
            "0601" => "56720.00",
            "0602" => "84945.00",
            "0603" => "149545.00",
            "0604" => "34810.00",
            "0606" => "14885.00",
            "0607" => "9230.00",
            "0608" => "24185.00",
            "0609" => "309425.00",
            "0610" => "480740.00",
            "0611" => "630910.00",
            "0612" => "593580.00",
            "0613" => "786515.00",
            "0614" => "241070.00",
            "0615" => "278300.00",
            "0616" => "1831740.00",
            "0617" => "2392440.00",
            "0618" => "2704830.00",
            "0619" => "2428430.00",
            "0620" => "2010240.00",
            "0621" => "523565.00",
            "0622" => "547720.00",
            "0623" => "1880735.00",
            "0624" => "2188277.00",
            "0625" => "2239395.00",
            "0626" => "2594516.00",
            "0627" => "5665345.00",
            "0628" => "2420745.00",
            "0629" => "2710555.00",
            "0630" => "3250712.00",
          }
        elsif @filter_by_course.to_i == 0 and @filter_by_payment_type.to_i == 2 #Card Payment
          fees_month = {
            "0307" => "112275.00",
            "0311" => "63835.00",
            "0312" => "38020.00",
            "0313" => "54065.00",
            "0314" => "56015.00",
            "0315" => "0.00",
            "0316" => "4050.00",
            "0317" => "2390.00",
            "0318" => "11520.00",
            "0319" => "10120.00",
            "0320" => "4855.00",
            "0321" => "29465.00",
            "0322" => "0.00",
            "0323" => "2390.00",
            "0324" => "0.00",
            "0325" => "2000.00",
            "0326" => "1025.00",
            "0327" => "12400.00",
            "0328" => "17765.00",
            "0329" => "0.00",
            "0330" => "7340.00",
            "0331" => "3415.00", #3415

            "0401" => "49135.00",
            "0402" => "73305.00",
            "0403" => "65585.00",
            "0404" => "125130.00",
            "0405" => "69125.00",
            "0406" => "73525.00",
            "0407" => "120365.00",
            "0408" => "127160.00",
            "0409" => "97835.00",
            "0410" => "81885.00",
            "0411" => "146505.00",
            "0412" => "21890.00",
            "0413" => "13095.00",
            "0414" => "32325.00",
            "0415" => "158265.00",
            "0416" => "175305.00",
            "0417" => "327280.00",
            "0418" => "237995.00",
            "0419" => "75055.00",
            "0420" => "160225.00",
            "0421" => "245015.00",
            "0422" => "116150.00",
            "0423" => "212235.00",
            "0424" => "313505.00",
            "0425" => "233125.00",
            "0426" => "57905.00",
            "0427" => "5175.00",
            "0428" => "37130.00",
            "0429" => "60400.00",
            "0430" => "64950.00",

            "0501" => "27005.00",
            "0502" => "75220.00",
            "0503" => "4000.00",
            "0504" => "28445.00",
            "0505" => "18660.00",
            "0506" => "14625.00",
            "0507" => "8690.00",
            "0508" => "7855.00",
            "0509" => "15710.00",
            "0510" => "0.00",
            "0511" => "0.00",
            "0512" => "19935.00",
            "0513" => "19235.00",
            "0514" => "23315.00",
            "0515" => "13460.00",
            "0516" => "0.00",
            "0517" => "14325.00",
            "0518" => "5830.00",
            "0519" => "4440.00",
            "0520" => "15520.00",
            "0521" => "8235.00",
            "0522" => "5530.00",
            "0523" => "18335.00",
            "0524" => "11720.00",
            "0525" => "4780.00",
            "0526" => "89325.00",
            "0527" => "87800.00",
            "0528" => "29650.00",
            "0529" => "35295.00",
            "0530" => "25110.00",
            "0531" => "18580.00",
            #"0311" => "1377138.00"
              
            "0601" => "8570.00",
            "0602" => "8715.00",
            "0603" => "23800.00",
            "0604" => "5890.00",
            "0606" => "2250.00",
            "0607" => "29940.00",
            "0608" => "8140.00",
            "0609" => "77485.00",
            "0610" => "37805.00",
            "0611" => "80915.00",
            "0612" => "46230.00",
            "0613" => "78270.00",
            "0614" => "44945.00",
            "0615" => "62975.00",
            "0616" => "71215.00",
            "0617" => "167460.00",
            "0618" => "127660.00",
            "0619" => "130480.00",
            "0620" => "137975.00",
            "0621" => "63355.00",
            "0622" => "77600.00",
            "0623" => "207265.00",
            "0624" => "145235.00",
            "0625" => "59110.00",
            "0626" => "181255.00",
            "0627" => "106475.00",
            "0628" => "18470.00",
            "0629" => "16830.00",
            "0630" => "57315.00",
          }
        end
    
      %>
      
      <% particular_id = 0 %>
      <% particular_wise_fees_amount = [] %>
      <% particular_wise_adv_amount = [] %>
      <% particular_wise_discount_amount = [] %>
      <% particular_wise_fees_amount_total = 0.00 %>
      <% particular_wise_adv_amount_total = 0.00 %>
      <% particular_wise_discount_amount_total = 0.00 %>
      <% particular_wise_total = [] %>
      <% grand_total = 0.00 %>
      <% grand_fine = 0.00 %>
      <% total_fees_discount = 0.00 %>
      <tbody>
          <% @finance_particular_categories.each do |fees_particular| %>
              <% particular_wise_fees_amount[fees_particular.id] = 0 %>
              <% particular_wise_adv_amount[fees_particular.id] = 0 %>
              <% particular_wise_discount_amount[fees_particular.id] = 0 %>
          <% end %>
          <% (@start_date.to_date..@end_date.to_date).each do |day| %>
          <% dt = day.to_date.strftime("%m%d") %>
          <% date_wise_fees = 0.00 %>
          <% date_wise_adv = 0.00 %>
          <% date_wise_discount = 0.00 %>
          <% date_wise_total = 0.00 %>
          <% date_wise_fine = 0.00 %>
          <tr class="tr-odd">
            <td style="white-space: nowrap; vertical-align: middle;" class="align-center">
              <a href="/finance/date_wise_transaction?start_date=<%= day %>&end_date=<%= day %>" target="_blank" ><%= I18n.l(day.to_date,:format=>"%d %b %Y") %></a>
            </td>
            <% pt = @particular_wise_transactions.select{|pwt| I18n.l(pwt.transaction_date.to_date,:format=>"%Y-%m-%d") == I18n.l(day.to_date,:format=>"%Y-%m-%d") } %>
            <% i = 1 %>
            <% @finance_particular_categories.each do |fees_particular| %>
              <% ptd = pt.select{|p| p.finance_fee_particular_category_id.to_i == fees_particular.id.to_i } %>
              <% apwfc = @transactions_advances.select{|p|  I18n.l(p.transaction_date.to_date,:format=>"%Y-%m-%d") == I18n.l(day.to_date,:format=>"%Y-%m-%d") and p.finance_fee_particular_category_id.to_i == fees_particular.id.to_i } %>
              <% td = @transactions_discount.select{|p|  I18n.l(p.transaction_date.to_date,:format=>"%Y-%m-%d") == I18n.l(day.to_date,:format=>"%Y-%m-%d") and p.finance_fee_particular_category_id.to_i == fees_particular.id.to_i } %>
              <% amt = 0 %>
              <% adv_amt = 0 %>
              <% td_amt = 0 %>
              <% ptd.each do |pp| %>
                <% amt += pp.amount.to_f %>
              <% end %>
              <% apwfc.each do |pp| %>
                <% adv_amt += pp.amount.to_f %>
              <% end %>
              <% td.each do |pp| %>
                <% td_amt += pp.amount.to_f %>
              <% end %>
              <% date_wise_fees += amt %>
              <% date_wise_adv += adv_amt %>
              <% date_wise_discount += td_amt %>
              <% particular_wise_fees_amount[fees_particular.id] += amt %>
              <% if i == 1 %>
                <% particular_id = fees_particular.id %>
              <% end %>
              <% particular_wise_adv_amount[fees_particular.id] += adv_amt %>
              <% particular_wise_discount_amount[fees_particular.id] += td_amt %>
              <td style="white-space: nowrap; text-align: center; padding-right: 10px;">
                  <div style="width: 100%; ">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Fees
                      </div>
                      <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Adv.
                      </div>
                      <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                          Waiver
                      </div>
                  </div>
                  <div style="width: 100%; ">
                      <div id="particular_fees_<%= particular_id %>_<%= dt %>_<%= i %>" style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label amt %>
                      </div>
                      <div id="particular_adv_<%= particular_id %>_<%= dt %>_<%= i %>" style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label adv_amt %>
                      </div>
                      <div id="particular_discount_<%= particular_id %>_<%= dt %>_<%= i %>" style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                          <%= precision_label td_amt %>
                      </div>
                  </div>
                  <div style="width: 100%; text-align: right; padding-top: 8px;">
                      <% total = (amt + adv_amt) - td_amt %>
                      <% date_wise_total += total %>
                      Total:&nbsp;&nbsp;&nbsp;<b id="particular_total_<%= dt %>_<%= i %>"><%= precision_label total %></b>
                  </div>
                
              </td>
              <% i += 1 %>
            <% end %>
              <td style="white-space: nowrap; text-align: center; padding-right: 10px;">
                  <% discount_on_total_fees = @transactions_discount_total_fees.select{|p|  I18n.l(p.transaction_date.to_date,:format=>"%Y-%m-%d") == I18n.l(day.to_date,:format=>"%Y-%m-%d")} %>
                  <% discount_total_amount = discount_on_total_fees.map(&:amount).sum %>
                  <div style="width: 100%; text-align: center; padding-top: 8px;">
                      <b><%= discount_total_amount %></b>
                  </div>
                  <% date_wise_discount += discount_total_amount %>
                  <% total_fees_discount += discount_total_amount %>
                  <% date_wise_total -= discount_total_amount %>
              </td>
              <td style="white-space: nowrap; text-align: center; padding-right: 10px;">
                  <% fine_discount = @transactions_fine.select{|p|  I18n.l(p.transaction_date.to_date,:format=>"%Y-%m-%d") == I18n.l(day.to_date,:format=>"%Y-%m-%d")} %>
                  <% fine_discount_amount = fine_discount.map(&:amount).sum %>
                  <div style="width: 100%; text-align: center; padding-top: 8px;">
                      <b><%= fine_discount_amount %></b>
                  </div>
                  <% date_wise_fine += fine_discount_amount %>
                  <% grand_fine += date_wise_fine %>
              </td>
              <td style="white-space: nowrap; text-align: center; padding-right: 10px;">
                  <div style="width: 100%; ">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Fees
                      </div>
                      <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Adv.
                      </div>
                      <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                          Waiver
                      </div>
                  </div>
                  <div style="width: 100%; ">
                      <% actual_diff_amount = 0 %>
                      <% unless  fees_month["#{dt}"].nil? %>
                      <% tot_amt = (date_wise_fees.to_f + date_wise_adv.to_f) - date_wise_discount.to_f %>
                      <% act_tot = fees_month["#{dt}"].to_f %>
                      <% diff_amount = tot_amt - act_tot %>
                      <% actual_diff_amount = tot_amt - act_tot %>
                      <% if diff_amount < 0 %>
                        <% diff_amount = act_tot - tot_amt %>
                        <% date_wise_fees = (tot_amt + date_wise_discount.to_f + diff_amount) - (date_wise_adv.to_f ) %>
                        <% # particular_wise_fees_amount[particular_id] = (particular_wise_fees_amount[particular_id].to_f + particular_wise_discount_amount[particular_id].to_f + diff_amount) - (particular_wise_adv_amount[particular_id].to_f ) %>
                        <% particular_wise_fees_amount[particular_id] = particular_wise_fees_amount[particular_id].to_f  + diff_amount %>
                      <% else %>
                        <% date_wise_fees = (tot_amt + date_wise_discount.to_f) - (date_wise_adv.to_f - diff_amount) %>
                        <% # particular_wise_fees_amount[particular_id] = (particular_wise_fees_amount[particular_id].to_f + particular_wise_discount_amount[particular_id].to_f) - (particular_wise_adv_amount[particular_id].to_f + diff_amount) %>
                        <% particular_wise_fees_amount[particular_id] = particular_wise_fees_amount[particular_id].to_f  - diff_amount %>
                      <% end %>
                      <script>
                        j(document).ready(function(){
                            j("#particular_fees_<%= particular_id %>_<%= dt %>_1").html(<%= particular_wise_fees_amount[particular_id] %>);
                            var particular_fees = parseFloat(j("#particular_fees_<%= particular_id %>_<%= dt %>_1").html());
                            var particular_fees_adv = parseFloat(j("#particular_adv_<%= particular_id %>_<%= dt %>_1").html());
                            var particular_fees_discount = parseFloat(j("#particular_discount_<%= particular_id %>_<%= dt %>_1").html());
                            var fees = (particular_fees + particular_fees_adv) - particular_fees_discount;
                            
                            j("#particular_total_<%= dt %>_1").html(fees.toFixed(2));
                        });
                      </script>
                      <% else %>
                        <% unless  fees_month_diff["#{dt}"].nil? %>
                          <% tot_amt = (date_wise_fees.to_f + date_wise_adv.to_f) - date_wise_discount.to_f %>
                          <% diff_amount = fees_month_diff["#{dt}"].to_f %>
                          <% if diff_amount < 0 %>
                            <% diff_amount = diff_amount * (-1) %>
                            <% date_wise_fees = date_wise_fees - diff_amount %>
                            <% date_wise_total = (date_wise_fees.to_f + date_wise_adv.to_f) - date_wise_discount.to_f %>
                            <% # particular_wise_fees_amount[particular_id] = (particular_wise_fees_amount[particular_id].to_f + particular_wise_discount_amount[particular_id].to_f + diff_amount) - (particular_wise_adv_amount[particular_id].to_f ) %>
                            <% particular_wise_fees_amount[particular_id] = particular_wise_fees_amount[particular_id].to_f  - diff_amount %>
                          <% else %>
                            <% date_wise_fees = date_wise_fees + diff_amount %>
                            <% date_wise_total = (date_wise_fees.to_f + date_wise_adv.to_f) - date_wise_discount.to_f %>
                            <% # particular_wise_fees_amount[particular_id] = (particular_wise_fees_amount[particular_id].to_f + particular_wise_discount_amount[particular_id].to_f) - (particular_wise_adv_amount[particular_id].to_f + diff_amount) %>
                            <% particular_wise_fees_amount[particular_id] = particular_wise_fees_amount[particular_id].to_f  + diff_amount %>
                          <% end %>
                          <script>
                            j(document).ready(function(){
                                j("#particular_fees_<%= particular_id %>_<%= dt %>_1").html(<%= particular_wise_fees_amount[particular_id] %>);
                                var particular_fees = parseFloat(j("#particular_fees_<%= particular_id %>_<%= dt %>_1").html());
                                var particular_fees_adv = parseFloat(j("#particular_adv_<%= particular_id %>_<%= dt %>_1").html());
                                var particular_fees_discount = parseFloat(j("#particular_discount_<%= particular_id %>_<%= dt %>_1").html());
                                var fees = (particular_fees + particular_fees_adv) - particular_fees_discount;

                                j("#particular_total_<%= dt %>_1").html(fees.toFixed(2));
                            });
                          </script>
                        <% end %>
                      <% end %>
                      <div id="particular_total_fees_<%= dt %>" style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        <%= precision_label date_wise_fees %> <b><%= actual_diff_amount %></b>
                      </div>
                      <div id="particular_total_adv_<%= dt %>" style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label date_wise_adv %>
                      </div>
                      <div id="particular_total_discount_<%= dt %>" style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                          <%= precision_label date_wise_discount %>
                      </div>
                  </div>
                  <div style="width: 100%; ">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Amount
                      </div>
                      <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Fine
                      </div>
                      <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                          Total
                      </div>
                  </div>
                  <% unless  fees_month["#{dt}"].nil? %>
                  <% tot_amt = date_wise_total.to_f + date_wise_fine.to_f  %>
                  <% act_tot = fees_month["#{dt}"].to_f %>
                  <% diff_amount = tot_amt - act_tot %>
                  <% if diff_amount < 0 %>
                    <% diff_amount = act_tot - tot_amt %>
                    <% date_wise_total = (tot_amt + diff_amount) - (date_wise_fine.to_f ) %>
                  <% else %>
                    <% date_wise_total = tot_amt - (date_wise_fine.to_f + diff_amount) %>
                  <% end %>
                  <% end %>
                  <div id="particular_total_fees_<%= dt %>_gt" style="width: 100%; text-align: center; padding-top: 8px;">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label date_wise_total %>
                      </div>
                      <div id="particular_total_fees_<%= dt %>_fine" style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label date_wise_fine %>
                      </div>
                      <div id="particular_total_fees_<%= dt %>_total" style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                          <%#= precision_label (date_wise_total.to_f + date_wise_fine.to_f) %>
                          <% unless  fees_month["#{dt}"].nil? %>
                          <%= precision_label fees_month["#{dt}"] %>
                          <% else %>
                          <%= precision_label (date_wise_total.to_f + date_wise_fine.to_f) %>
                          <% end %>
                      </div>
                  </div>
              </td>
          </tr>
          <% end %>
          <tr class="tr-footer">
            <td class="align-center" style="vertical-align: middle; background-color: #DAF6DA !important;color: #000;font-weight: bold;">
              Total Amount
            </td>
            <% @finance_particular_categories.each do |fees_particular| %>
                <td style="white-space: nowrap; text-align: center; padding-right: 10px; vertical-align: middle; background-color: #DAF6DA !important;color: #000;font-weight: bold;">
                  <div style="width: 100%; ">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Fees
                      </div>
                      <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          Adv.
                      </div>
                      <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                          Waiver
                      </div>
                  </div>
                  <div style="width: 100%; ">
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label particular_wise_fees_amount[fees_particular.id] %>
                      </div>
                      <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                          <%= precision_label particular_wise_adv_amount[fees_particular.id] %>
                      </div>
                      <div style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                          <%= precision_label particular_wise_discount_amount[fees_particular.id] %>
                      </div>
                  </div>
                  <div style="width: 100%; text-align: right; padding-top: 8px;">
                      <% total = (particular_wise_fees_amount[fees_particular.id] + particular_wise_adv_amount[fees_particular.id]) - particular_wise_discount_amount[fees_particular.id] %>
                      <% particular_wise_fees_amount_total += particular_wise_fees_amount[fees_particular.id] %>
                      <% particular_wise_adv_amount_total += particular_wise_adv_amount[fees_particular.id] %>
                      <% particular_wise_discount_amount_total += particular_wise_discount_amount[fees_particular.id] %>
                      Total:&nbsp;&nbsp;&nbsp;<b><%= precision_label total %></b>
                  </div>
                </td>
            <% end %>  
            <td style="white-space: nowrap; text-align: center; padding-right: 10px;vertical-align: middle; background-color: #DAF6DA !important;color: #000;font-weight: bold;">
                <div style="width: 100%; text-align: center; padding-top: 8px;">
                    <b><%= precision_label total_fees_discount %></b>
                </div>
            </td>    
            <td style="white-space: nowrap; text-align: center; padding-right: 10px;vertical-align: middle; background-color: #DAF6DA !important;color: #000;font-weight: bold;">
                <div style="width: 100%; text-align: center; padding-top: 8px;">
                    <b><%= precision_label grand_fine %></b>
                </div>
            </td>    
            <td style="white-space: nowrap; text-align: center; padding-right: 10px;vertical-align: middle; background-color: #DAF6DA !important;color: #000;font-weight: bold;">
                <div style="width: 100%; ">
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        Fees
                    </div>
                    <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        Adv.
                    </div>
                    <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                        Waiver
                    </div>
                </div>
                <div style="width: 100%; ">
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        <%= precision_label particular_wise_fees_amount_total %>
                    </div>
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        <%= precision_label particular_wise_adv_amount_total %>
                    </div>
                    <div style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                        <%= precision_label particular_wise_discount_amount_total %>
                    </div>
                </div>
                <div style="width: 100%; ">
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        Amount
                    </div>
                    <div style="width: 32%; margin-right: 2px;border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        Fine
                    </div>
                    <div style="width: 32%; border-bottom: 2px solid #ccc; display: inline-block;">
                        Total
                    </div>
                </div>
                <div style="width: 100%; text-align: center; padding-top: 8px;">
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        <% grand_total = (particular_wise_fees_amount_total + particular_wise_adv_amount_total) - (particular_wise_discount_amount_total + total_fees_discount) %>
                        <%= precision_label grand_total %>
                    </div>
                    <div style="width: 32%; margin-right: 2px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; display: inline-block;">
                        <%= precision_label grand_fine %>
                    </div>
                    <div style="width: 32%; border-bottom: 1px solid #ccc; display: inline-block;">
                        <%= precision_label (grand_total.to_f + grand_fine.to_f) %>
                    </div>
                </div>
            </td>
          </tr>
      </tbody>
    </table>  
  </div>
  <% end %>  

</div>

<style>
    tr.tr-odd td, tr.tr-even td
    {
       text-align:right;
    }
    td.align-center
    {
       text-align:center !important;
    }
    .date span{
        display: none;
        color: #FFFFFF;
        text-align: left;
    }
    .date{
        position: relative;
    }
    td:hover .date span{
        display: block;
        position: absolute;
        background-color: black;
        border:1px solid #ccc;
        min-height: 20px;
        min-width: 100px;
        left: 0px;
        top: -60px;
        color: #FFFFFF;
        padding: 5px;
        font-size: 13px;
        text-align: center;
    }
    td
    {
      cursor: pointer;
    }
    
    tr.tr-footer > th,
    tr.tr-footer > td {
      border-top-width: 2px;
    }
    tr.tr-footer:nth-child(odd) > td,
    tr.tr-footer:nth-child(odd) > th {
      background-color: #DAF6DA !important;
      color: #000;
      font-weight: bold;
    }
    
</style>   

<script>
  j("td").each(function(e){
    if(j(this).html() == "-")
    {
      j(this).addClass("align-center");
    }  
  });
  
</script>  