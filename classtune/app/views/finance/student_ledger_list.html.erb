<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<div id="content-header">
<%= show_header_icon %>
  <h1><%= "Student Ledger" %></h1>
<div class='header-sep'>|</div>
<div class='sub-header'><%= "Ledger" %></div>
<div id="inner-tab-menu">
  <ul>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('pdf_report')}",
        {:controller => "finance", :action => "ledger_pdf_fees", :filter_by_course => @filter_by_course, :filter_by_dues => @filter_by_dues, :admission_no => @admission_no},:target => '_blank' %></li>
    <li class='themed_bg themed-dark-hover-background'><%= link_to "CSV REPORT",
        {:controller => "finance", :action => "ledger_csv_fees", :filter_by_course => @filter_by_course, :filter_by_dues => @filter_by_dues, :admission_no => @admission_no} %></li>
  </ul>
</div>
</div>
<div id="page-yield">
  <% unless @student_fee_ledgers.blank? %>  
  <h2 style="border-bottom: 2px solid #ccc; padding-bottom: 10px;">Student Ledger List</h2>
  <div id="filter" style="width: 100%;">
      <div style="width: 50%; display: inline-block;">
        <div class="label-field-pair" style="width: 45%; display: block; float: left; margin-top: 6px; margin-right: 1%;">
          <select name="filter_by_course" id="filter_by_course" style="width: 100% !important;">
              <option value="0" <%= @filter_by_course.to_i == 0 ? 'selected' : '' %>>All Batches</option>
              <option value="1" <%= @filter_by_course.to_i == 1 ? 'selected' : '' %>>School</option>
              <option value="2" <%= @filter_by_course.to_i == 2 ? 'selected' : '' %>>College</option>
          </select>

        </div>
        <div class="label-field-pair" style="width: 45%; display: block; float: left; margin-top: 6px; margin-right: 1%;">
          <select name="filter_by_dues" id="filter_by_dues" style="width: 100% !important;">
              <option value="0" <%= @filter_by_dues.to_i == 0 ? 'selected' : '' %>>All Records</option>
              <option value="1" <%= @filter_by_dues.to_i == 1 ? 'selected' : '' %>>No Dues</option>
              <option value="2" <%= @filter_by_dues.to_i == 2 ? 'selected' : '' %>>Dues</option>
              <option value="3" <%= @filter_by_dues.to_i == 3 ? 'selected' : '' %>>Advances</option>
          </select>

        </div>
      </div>
      <div style="width: 49%; display: inline-block;">
        <div class="label-field-pair" style="width: 70%; display: block; float: right; ">
          <div class="form-group has-search" style="position: relative;">
              <span class="fa fa-search form-control-feedback"></span>
              <input type="text" id="admission_no" class="form-control" placeholder="Admission No..." style="width: 82%; height: 21px; border-radius: 6px;">
          </div>
        </div>
      </div>
  </div>
  <div style="clear: both; height: 20px;"></div>
  <div id="data-records">  
    <h3 style="font-size: 14px; letter-spacing: 1.5px;">Total Record: <%= @count_students %></h3>
    <div id="table-scroll" class="table-scroll" style="display: block;">
        <table class="table-bordered main-table" id="table-scroll" cellspacing="0" cellpadding="0" border="0" style="table-layout:fixed;">
            <thead><!-- class="thead-inverse" -->
              <tr>
                <th class="fixed-side" scope="col" style="width: 200px; text-align: center; vertical-align: middle;">Student Info</th>
                <th style="text-align: center; vertical-align: middle;">Amount to Pay</th>
                <th style="text-align: center; vertical-align: middle;">Paid Amount</th>
                <th style="text-align: center; vertical-align: middle;">Dues</th>
                <th style="text-align: center; vertical-align: middle;">Advance</th>
              </tr>
            </thead>
            <tbody>
                <% @student_fee_ledgers.each do |student_fee_ledger| %>
                  <tr class="tr-odd">
                      <% student = Student.find(:first, :conditions => "id = #{student_fee_ledger.student_id}") %>
                      <% if student.nil?  %>
                      <% student = ArchivedStudent.find(:first, :conditions => "former_id = #{student_fee_ledger.student_id}") %>
                      <% end %>
                      <th style="vertical-align: middle; text-align: left;" class="fixed-side">
                          <a href="/finance/student_ledger/<%= student_fee_ledger.student_id %>" target="_blank" style="color: #444; line-height: 23px; font-size: 16px;">
                            <%= student.full_name unless student.full_name.nil? %><br />
                            <small>ID: <%= student.admission_no unless student.admission_no.nil? %></small><br />
                            <small><%= student.batch.full_name %></small><br />
                          </a>
                      </th>
                      <td style="text-align: right;"><%= to_comma_seperated_precision_label student_fee_ledger.amount_to_pay %></td>
                      <td style="text-align: right;"><%= to_comma_seperated_precision_label student_fee_ledger.amount_paid %></td>
                      <% if student_fee_ledger.diff_amount.to_f <= 0 %>
                      <td style="text-align: right;"><%= to_comma_seperated_precision_label 0.00 %></td>
                      <% else %>
                      <td style="text-align: right;"><%= to_comma_seperated_precision_label student_fee_ledger.diff_amount.to_f %></td>
                      <% end %>
                      <% if student_fee_ledger.diff_amount.to_f >= 0 %>
                      <td style="text-align: right;"><%=  to_comma_seperated_precision_label 0.00 %></td>
                      <% else %>
                      <td style="text-align: right;"><%= to_comma_seperated_precision_label student_fee_ledger.diff_amount.to_f * (-1) %></td>
                      <% end %>
                  </tr>
                <% end %>

            </tbody>
        </table>
    </div>
    <div style="padding-top: 20px;">
      <%= will_paginate @students,:params=>{:filter_by_course => params[:filter_by_course]} %>
    </div>
  </div>
  <% else %>
  <h2 style="border-bottom: 2px solid #ccc; padding-bottom: 10px;">Student Ledger List</h2>
  <p>No records found</p>
  <% end %>  

</div>

<style>
    .pagination {
        margin-right: 0;
    }
    .has-search .form-control {
        padding-left: 2.375rem;
    }

    .has-search .form-control-feedback {
        position: absolute;
        z-index: 2;
        display: block;
        width: 2.375rem;
        height: 2.375rem;
        line-height: 2.375rem;
        text-align: center;
        pointer-events: none;
        color: #aaa;
        left: 9px;
        top: -1px;
    }
    .table-scroll {
	position:relative;
	max-width:1000px;
	margin:auto;
	overflow:hidden;
    }
    .table-wrap {
            width:100%;
            overflow:auto;
    }
    .table-scroll table {
            width:100%;
            margin:auto;
            border-collapse:separate;
            border-spacing:0;
    }
    .table-scroll th, .table-scroll td {
            padding:5px 10px;
            background:#fff;
            vertical-align:top;
    }
    .table-scroll thead, .table-scroll tfoot {
            background:#f9f9f9;
    }
    .clone {
            position:absolute;
            top:0;
            left:0;
    }
    .clone th, .clone td {
            visibility:hidden
    }
    .clone td, .clone th {
            border-color:transparent
    }
    .clone tbody th {
            visibility:visible;
            color:red;
    }
    .clone .fixed-side {
            background:#eee;
            visibility:visible;
            z-index: 1;
    }
    a:hover {
        text-decoration: none !important;
    }
    .clone thead, .clone tfoot{background:transparent;}
</style>   

<script>
  var req = false;
  var filter = false;
  j("td").each(function(e){
    if(j(this).html() == "-")
    {
      j(this).addClass("align-center");
    }  
  });
  
  j(document).ready(function() {
      j(".main-table").clone(true).appendTo('#table-scroll').addClass('clone');   
      
      j(document).on("change", "#filter_by_course", function(){
          var filter_by_dues = j("#filter_by_dues").val();
          var filter_by_course = j(this).val();
          
          location.href = '/finance/student_ledger_list?filter_by_course=' + filter_by_course + "&filter_by_dues=" + filter_by_dues;
      });
      
      j(document).on("change", "#filter_by_dues", function(){
          var filter_by_dues = j(this).val();
          var filter_by_course = j("#filter_by_course").val();
          
          location.href = '/finance/student_ledger_list?filter_by_course=' + filter_by_course + "&filter_by_dues=" + filter_by_dues;
      });
      
      j(document).on("keyup", "#admission_no", function(){
          if ( this.value.length >= 4 )
          {
              if ( req == false )
              {
                  req = true;
                  filter = true;
                  var admission_no = this.value;
                  var filter_by_dues = j("#filter_by_dues").val();
                  var filter_by_course = j("#filter_by_course").val();

                  new Ajax.Request('/finance/ajax_student_ledger_list', 
                          {
                            asynchronous:true, 
                            evalScripts:true, 
                            parameters:'filter_by_dues='+filter_by_dues+'&filter_by_course='+filter_by_course+'&admission_no='+admission_no
                          }
                  )
              }
          }
          else
          {
              if ( filter )
              {
                  if ( this.value.length == 0 )
                  {
                      filter = false;
                      req = true;
                      var filter_by_dues = j("#filter_by_dues").val();
                      var filter_by_course = j("#filter_by_course").val();

                      new Ajax.Request('/finance/ajax_student_ledger_list', 
                              {
                                asynchronous:true, 
                                evalScripts:true, 
                                parameters:'filter_by_dues='+filter_by_dues+'&filter_by_course='+filter_by_course
                              }
                      )
                  }
                  else
                  {
                      req = true;
                      var admission_no = this.value;
                      var filter_by_dues = j("#filter_by_dues").val();
                      var filter_by_course = j("#filter_by_course").val();

                      new Ajax.Request('/finance/ajax_student_ledger_list', 
                              {
                                asynchronous:true, 
                                evalScripts:true, 
                                parameters:'filter_by_dues='+filter_by_dues+'&filter_by_course='+filter_by_course+'&admission_no='+admission_no
                              }
                      )
                  }
              }
          }
      });
    
  });
  
</script>  