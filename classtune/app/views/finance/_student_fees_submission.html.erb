<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<% 
  if @financefee.balance <= 0
    @financefee.is_paid = true
  end
%>
<%#= @new_fine_amount %>
<input type="hidden" name="is_student_fees" id="is_student_fees" value="<%= @from_batch_fee ? "0" : "1" %>"
<% if MultiSchool.current_school.id == 352 %>
<%
  require "yaml"
  transport_config = YAML.load_file("#{RAILS_ROOT.to_s}/config/finance_transport.yml")['school']
  transport_particular_id = transport_config['transport_particular_id_' + MultiSchool.current_school.id.to_s]
  if transport_particular_id.blank?
    transport_particular_id = 0
  end
%>  
<% end %>  
<div class="fee_structure">
    <h2 style="display: none;"><%#= @fee_category.name %> (<%#= @fee_collection.name %>)</h2>
    <h2>Fee: <%= @fee_collection.name %></h2>
    <hr style="border-top: 1px solid #ccc;" />
    <div class="extender"></div>
</div>
<% unless @show_only_structure %>
<style>
    span.editable{
      border-bottom: 1px dashed #990A10; 
      cursor: pointer;
    }
    span.editable span{
      color: #990A10; 
      cursor: pointer;
    }
</style>
<% else %>
<style>
    span.editable{
        color: #000;
    }
    span.editable span{
        color: #000;
    }
    span.editable i{
        display: none;
    }
</style>
<% end %>
<% unless @from_batch_fee %>
<h2 style='text-align: center; background: #ECECEC; padding: 4px; border-radius: 4px;'><%= @student.full_name %></h2>
<% end %>
<%= error_messages_for "financefee" ,:header_message => nil%>
<% unless @show_only_structure %>
  <% unless @financefee.is_paid == true or (@total_payable-@total_discount==0) or @self_advance_fee %>
    <% particularNames = @fee_particulars.map{|fee| fee.name.downcase} %>
    <% @vat_as_particular = false %>
    <% @vat_particular_id = 0 %>
    <% if particularNames.include?('vat')  %>
      <% @fee_particulars.each do |fee| %>
        <%  if fee.name.downcase == 'vat' %>
          <% @vat = fee.amount.to_f %>
          <% @vat_as_particular = true %>
          <% @vat_particular_id = fee.id %>
        <% end %>
      <% end %>
    <% end %>
    <div style="width: 100%; text-align: right">

      <%= render :partial => "fine_submission" if (@fine.nil? or @fine.to_i==0) && (@new_fine_amount.nil? or @new_fine_amount.to_i==0) %>
      <%= render :partial => "vat_submission" if (@vat.nil? or @vat.to_i==0) && (@paid_fees.blank?) %>
        
      <% if @vat_as_particular %>  
        <div id="vat_div"></div>
      <% else %>  
        <% unless @vat.nil? %>
          <div id="vat_div"></div>
        <% end %>
      <% end %>  
    </div>
  <% end %>
<% end %>

<div class="height-fixer"> </div>
<% if @from_batch_fee %>
<div id="register">
  <div class="header">
    <div class="prev">
      <%= link_to_remote '◄',:url => {:action => 'load_fees_submission_batch', :batch_id => @batch.id, :student => @prev_student.id, :date=> @date.id, :student_fees => @from_batch_fee }%>
    </div>
    <div class="month">
      <%= @student.full_name %><%="(#{t('transfered_to_batch')}:#{@student.batch.full_name})" unless @batch==@student.batch%>
    </div>
    <div class="next">
      <%= link_to_remote '►',:url => {:action => 'load_fees_submission_batch', :batch_id => @batch.id, :student => @next_student.id, :date=> @date.id, :student_fees => @from_batch_fee }%>
    </div>
    <div class="extender"></div>
  </div>
</div>
<% if @current_user.admin? %>
<div style="clear: both; height: 2px;"></div>
<div style="border: 1px solid #ccc; margin: 0 auto; border-radius: 6px; width: 40%; padding: 10px; line-height: 24px;">
    <b>Student Info: <b>
    <hr style="border: 1px solid #ccc;" />
    <b>Name: </b><span style="font-weight: normal;"><%= @student.full_name %></span><Br />
    <b>Admission No: </b><span style="font-weight: normal;"><%= @student.admission_no %></span><Br />
    <b>Batch: </b><span style="font-weight: normal;"><%= @student.batch.full_name %></span>
    <% if @financefee.batch_id != @student.batch.id %>
    <hr style="border: 1px solid #ccc;">
    <b>Fee Batch: </b><span style="font-weight: normal;"><%= @financefee.batch.full_name %></span>
    <hr style="border: 1px solid #ccc;">
    <div style="width: 100%; text-align: center; padding-top: 10px; padding-bottom: 10px;">
      <span class="small danger-btn" style="text-align: center; float: none; background: #dc3545 !important; padding: 10px; border: 1px solid #dc3545;">
        <%= link_to_remote "Remove User Fee", :url => {:action => 'delete_student_fees_from_collection', :fee_id => @financefee.id, :batch_id => @batch.id, :student => @next_student.id, :date=> @date.id, :student_fees => @from_batch_fee},:confirm => "Are You sure to Delete?" %>
      </span> 
    </div>
    <% end %>
</div>
<% end %>
<% end %>
<input type="hidden" name="batch_id_particular" id="batch_id_particular" value="<%= @batch.id %>" />
<input type="hidden" name="student_id_particular" id="student_id_particular" value="<%= @student.id %>" />
<input type="hidden" name="date_id_particular" id="date_id_particular" value="<%= @date.id %>" />
<div style="clear: both; height: 4px;"></div>
<% unless @financefee.is_paid == true or (@total_payable-@total_discount==0) or @self_advance_fee %>
<span class="small" style="margin: 0 20px 20px 0;">
  <%= link_to_remote t('assign_discount_text'), :url => {:action => 'fee_collection_assign_discount_student', :id => @date.id,:batch_id=>@batch.id, :student_id => @student.id} %>
</span>
<% end %>
<% total_fees =0 %>
<% total_payable =0 %>
<% if @student.has_dues %>
<div style="clear: both; height: 4px;"></div>
<div style="width: 100%; text-align: center; color: #f00;">***Student has previous Dues***</div>
<div style="clear: both; height: 10px;"></div>
<% end %>
<%
  advance_fee_particular = []
  unless @fee_collection_advances.nil?
    advance_fee_particular = @fee_collection_advances.map(&:particular_id)
  end
%>
<%#= debug @batch.inspect %>
<% form_remote_for :fees, :url => {:action => 'update_ajax',:student => @student.id,:batch_id => @batch.id,:date => @date.id, :fine=>@fine, :vat=>@vat,:special_fine=>@fine_amount, :from_batch => @from_batch_fee, :from_admin => 1}, :html => {:id => "fees_form"}, :before=>"prev_double();$('loader_pay').show();",:complete=>"set_back();$('loader_pay').hide();" do |form| %>
  <% unless @fee_particulars.nil? %>
    <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
      <thead><!-- class="thead-inverse" -->
        <tr>
          <th style="font-weight: normal; width: 8%; text-align: center;"><%= t('sl_no') %> </th>
          <th style="font-weight: normal; width: 50%; text-align: left;"><%= t('particulars') %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= t('amount') %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= "Paid" %></th>
          <th style="font-weight: normal; width: 14%; text-align: right;"><%= "Remaining" %></th>
        </tr>
      </thead>
      <% i = 0 %>
      <tbody>
      <% fee_ids = [] %>    
      <% @fee_particulars.each do |fee| %>
        <% unless fee_ids.include?(fee.id) %>    
        <% fee_particular_child = FinanceFeeParticular.find(:first, :conditions => "parent_id = #{fee.id} and receiver_type = 'Student' and receiver_id = #{@student.id}") %>  
        <% unless fee_particular_child.blank? %>  
        <% fee = fee_particular_child %>  
        <% fee_ids << fee_particular_child.id %>  
        <% end %>      
        <%  if fee.name.downcase != 'vat' %>
        <tr id="particular_<%= fee.id %>" class="particulars_tr">
            <% paidAmount = 0 %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
            
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% else %>
             <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Advance' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% month = 1 %>
            <% start_month = "" %>
            <% end_month = "" %>
            <% unless @fee_collection_advances.nil? %>
              <% @fee_collection_advances.each do |fee_collection_advance| %>
                <% if fee_collection_advance.particular_id == fee.finance_fee_particular_category_id %>
                  <% month = fee_collection_advance.no_of_month.to_i %>
                  <% start_month = fee_collection_advance.start_month %>
                  <% end_month = fee_collection_advance.end_month %>
                <% end %>
              <% end %>
            <% end %>
            <% if @self_advance_fee %>
            <% fee_amount = (fee.amount * month.to_i).to_f - paidAmount %>
            <% else %>
            <% fee_amount = fee.amount - paidAmount %>
            <% end %>
            <% fee_amount = 0 if fee_amount < 0 %>
            <td class="col-1" style=" text-align: center;">
                <input type="hidden" name="fee_category_<%= fee.id %>" class="fee_category" id="fee_category_<%= fee.id %>" value="<%= fee.finance_fee_particular_category_id  %> " />
                <% if fee_amount > 0 %>
                <% if @self_advance_fee %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% else %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-square-o" style="font-size: 16px; cursor: pointer; color: #999;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% else %>
                <input type="checkbox" name="fee_particular_<%= fee.id %>" id="fee_particular_<%= fee.id %>" class="fees_particular" style="display: none;" checked="" data-fee_amount="<%= precision_label fee.amount %>">
                <i name="fee_particular_fa_<%= fee.id %>" id="fee_particular_fa_<%= fee.id %>" class="fa fa-check-square-o fees_particular_fa" style="font-size: 16px; cursor: pointer; " aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% end %>
                <% end %>
                <% else %>
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                <% end %>
            </td>
            <td class="col-6">
              <%= fee.name %>
              <% if transport_particular_id.to_i == fee.finance_fee_particular_category_id.to_i %>
                <% unless fee.description.blank? %>
                <br /><small>(<%= fee.description.gsub("---","</b>").gsub("--","<b>") %>)</small>
                <% end %>
              <% end %>  
              <% if @self_advance_fee %>
                <br />(<small><%= month %> Month Advances</small>)
                <br /><small>(<%= start_month %> to <%= end_month %>)
              <% else %>
                   <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                    <br /><small>(Set for Advance Payment)</small>
                    <br />(<small><%= month %> Month Advances</small>)
                   <% end %>
              <% end %>  
              <% if fee.is_tmp and paidAmount == 0 %>
                <span style="float: right;"><%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_particular_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :particular_id=>fee.id },:confirm => 'Are you sure, you want to remove this particular?'%></span>
              <% else %>
                <% if paidAmount == 0 %>
                  <% if fee.finance_fee_particular_category_id == 78 and MultiSchool.current_school.id == 352 %>
                    <span style="float: right;"><%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_particular_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :particular_id=>fee.id },:confirm => 'Are you sure, you want to remove this particular?'%></span>
                  <% end %>
                <% end %>
              <% end %>  
            </td>
            <% if @self_advance_fee %>
            <td class="col-6" style="text-align: right;">(<%= precision_label fee.amount %> <%= "x " + month.to_s  %>)</td>
            <% else %>
              <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
              <td class="col-6" style="text-align: right;">(<%= precision_label fee.amount %> <%= "x " + month.to_s  %>)</td>
              <% else %>
              <td class="col-6" style="text-align: right;"><%= precision_label fee.amount %></td>
              <% end %>
            <% end %>
            <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %></td>
            <td class="col-6" style="text-align: right;">
                <% if fee_amount > 0 %>
                <% if @self_advance_fee %>
                <span style="color: #000;"> <span style="color: #000;"><%= precision_label fee_amount %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <% else %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) ) %>
                <span style="cursor: pointer; color: #999;"> <span style="color: #999;"><%= precision_label ( fee_amount.to_f * month.to_i) %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <% else %>
                <span class="fee_amount_particular editable"  name="fee_amount_particular_<%= fee.id %>" id="fee_amount_particular_<%= fee.id %>"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label fee_amount %></span></span>
                <input type="hidden" name="fee_particular_amount_<%= fee.id %>" id="fee_particular_amount_<%= fee.id %>" value="<%= precision_label fee_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'particular')" onkeydown="checkKey(event,this, 'particular')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_particular" name="fee_particular_chk_<%= fee.id %>" id="fee_particular_chk_<%= fee.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <% end %>
                <% end %>
                <% else %>
                0.00&nbsp;&nbsp;&nbsp;
                <% end %>
            </td>
        </tr>
        
        <% if !(@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id) )) %>
        <% total_fees += fee_amount %>
        <% total_payable += fee.amount %>
        <% elsif @self_advance_fee and (advance_fee_particular.include?(0) or advance_fee_particular.include?(fee.finance_fee_particular_category_id)) %>
        <% total_fees += fee_amount %>
        <% total_payable += fee.amount %>
        <% end %>
        <% end %>
        <% end %>
      <% end %>
      <%# if total_fees > 0 %>
      <% if  @fee_particulars.length == 0 %>
        <tr class="particulars_tr" style="display: none;"><td colspan="5"></td></tr>
      <% end %>  
      <tr>
          <td class="col-1" style=" text-align: center;">&nbsp;</td>
          <td colspan="4" id="add_extra_particular" class="col-2" style="font-size: 14px; font-weight: bold; cursor: pointer;"><i class="fa fa-plus-square-o" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;Add Extra Particulars
          </td>
      </tr>
      <%# end %>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_amount') %> </td>
        <td class="col-6" style="text-align: right;">
            <span id="fee_total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
            <input type="hidden" name="fee_total_amount" id="fee_total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
        </td>
      </tr>  
      
      <% discount_total = 0 %>
      <% add_discount_link = false %>
      <% unless @total_discount == 0 %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-1" ></td>
          <td class="col-1" colspan="4"><span class="themed_text"><%= t('discount') %></span></td>
        </tr>
        
        <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
          <% @onetime_discounts.each do |d| %>
            <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
              <% discount_amount = @onetime_discounts_amount[d.id] %>
            <% else %>
              <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
            <% end %>
            <% paidAmount = 0 %>
            <% discountPaid = false %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
               <% unless paidFess.blank? %> 
               <% discountPaid = true %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% end %>
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                        <% unless paidFess.blank? %> 
                        <% discountPaid = true %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% if discountPaid %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <% total_payable -= paidAmount %>
            </tr>  
            <% else %>
            <% discount_enable = true %>
            <% unless @paid_fees.blank? %>
              <% if d.finance_fee_particular_category_id == 0 %>
                <% if discount_amount > total_fees  %>
                <% discount_enable = false %>
                <% end %>
              <% else %>
              <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
              <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
              <% paidAmount = 0 %>
              <% finance_particular.each do |fee| %>
                <%  if fee.name.downcase != 'vat' %>
                  <% transaction_ids = @paid_fees.map(&:id) %> 
                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                  <% if !@self_advance_fee and @fee_has_advance_particular %>
                    <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                      <% unless @fee_collection_advances.nil? %>
                        <% unless @fee_collection_advances.nil? %>
                          <% @fee_collection_advances.each do |fee_collection_advance| %>
                            <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                            <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                            <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                            <% @paid_advance_fees = @advance_fees.finance_transactions %>
                            <% unless @paid_advance_fees.blank? %>
                              <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                              <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                              <% unless paidFess.blank? %> 
                              <% discountPaid = true %>
                              <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                              <% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
              <% remaining_amount = amount_to_paid - paidAmount %>
              <% if discount_amount > remaining_amount  %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if discount_enable %>
              <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
              <% if !@self_advance_fee %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if @adv_fee_discount && @actual_discount == 0 %>
              <% discount_enable = false %>
            <% end %>
            <% if discount_enable %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1" style=" text-align: center;">
                <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %>" data-is-onetime="1" />  
                <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3">
                <%= discount_text %>
                <%  if d.is_visible %>  
                <span style="float: right;"><%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_discount_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :discount_id=>d.id },:confirm => 'Are you sure, you want to unassign this discount?'%></span>    
                <% else %>
                <span style="float: right;"><%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_discount_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :discount_id=>d.id },:confirm => 'Are you sure, you want to remove this discount?'%></span>    
                <% end %>
              </td>
              <td class="col-6" style="text-align: right;">
                  <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label discount_amount %></span></span>
                  <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                  <% discount_total += discount_amount %>
              </td>
            </tr>
            <% else %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1" style=" text-align: center;">
                <i class="fa fa-close" style="font-size: 16px; cursor: pointer; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
            </tr>
            <% end %>
            <% end %>
            <% #i += 1 %>
          <% end %>
        <% end %>  
        <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
          <% @discounts.each do |d| %>
            <% unless @discounts_amount[d.id].nil? or @discounts_amount[d.id].blank? %>  
              <% discount_amount = @discounts_amount[d.id] %>
            <% else %>
              <% discount_amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
            <% end %>
            <% paidAmount = 0 %>
            <% discountPaid = false %>
            <% unless @paid_fees.blank? %>
               <% transaction_ids = @paid_fees.map(&:id) %> 
               <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
               <% unless paidFess.blank? %> 
               <% discountPaid = true %>
               <% paidAmount += paidFess.map(&:amount).sum.to_f %>
               <% end %>
               <% if !@self_advance_fee and @fee_has_advance_particular %>
                <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                  <% unless @fee_collection_advances.nil? %>
                    <% @fee_collection_advances.each do |fee_collection_advance| %>
                      <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                      <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                      <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                      <% @paid_advance_fees = @advance_fees.finance_transactions %>
                      <% unless @paid_advance_fees.blank? %>
                        <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                        <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                        <% unless paidFess.blank? %> 
                        <% discountPaid = true %>
                        <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% if discountPaid %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <% total_payable -= paidAmount %>
            </tr>  
            <% else %>
            <% discount_enable = true %>
            <% unless @paid_fees.blank? %>
              <% if d.finance_fee_particular_category_id == 0 %>
                <% if discount_amount > total_fees  %>
                <% discount_enable = false %>
                <% end %>
              <% else %>
              <% finance_particular = @fee_particulars.select{|fp| fp.finance_fee_particular_category_id == d.finance_fee_particular_category_id} %>
              <% amount_to_paid = finance_particular.map(&:amount).sum.to_f %>
              <% paidAmount = 0 %>
              <% finance_particular.each do |fee| %>
                <%  if fee.name.downcase != 'vat' %>
                  <% transaction_ids = @paid_fees.map(&:id) %> 
                  <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                  <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                  <% if !@self_advance_fee and @fee_has_advance_particular %>
                    <% if @fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) ) %>
                      <% unless @fee_collection_advances.nil? %>
                        <% @fee_collection_advances.each do |fee_collection_advance| %>
                          <% advance_collection_id = fee_collection_advance.fee_collection_id %>
                          <% @advance_collection = FinanceFeeCollection.find(advance_collection_id) %>
                          <% @advance_fees = @student.finance_fee_by_date @advance_collection %>
                          <% @paid_advance_fees = @advance_fees.finance_transactions %>
                          <% unless @paid_advance_fees.blank? %>
                            <% transaction_ids = @paid_advance_fees.map(&:id) %> 
                            <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Particular' AND transaction_type = 'Fee Collection' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{fee.id}") %>
                            <% unless paidFess.blank? %> 
                            <% discountPaid = true %>
                            <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
              <% remaining_amount = amount_to_paid - paidAmount %>
              <% if discount_amount > remaining_amount  %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if discount_enable %>
              <% if  (@fee_has_advance_particular and (advance_fee_particular.include?(0) or advance_fee_particular.include?(d.finance_fee_particular_category_id) )) %>
              <% if !@self_advance_fee %>
              <% discount_enable = false %>
              <% end %>
              <% end %>
            <% end %>
            <% if @adv_fee_discount && @actual_discount == 0 %>
              <% discount_enable = false %>
            <% end %>
            <% if discount_enable %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1" style=" text-align: center;">
                <input type="hidden" class="discount_category" name="discount_category_<%= d.id %>" id="discount_category_<%= d.id %>" value="<%= d.finance_fee_particular_category_id  %>" data-is-onetime="0" />  
                <input type="checkbox" name="fee_discount_<%= d.id %>" id="fee_discount_<%= d.id %>" class="fee_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label discount_amount %>">
                <i name="fee_discount_fa_<%= d.id %>" id="fee_discount_fa_<%= d.id %>" class="fa fa-check-square-o fees_discount_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3">
                <%= discount_text %>
              </td>
              <td class="col-6" style="text-align: right;">
                  <span class="fee_amount_discount editable"  name="fee_amount_discount_<%= d.id %>" id="fee_amount_discount_<%= d.id %>"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label discount_amount %></span></span>
                  <input type="hidden" name="fee_discount_amount_<%= d.id %>" id="fee_discount_amount_<%= d.id %>" value="<%= precision_label discount_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'discount')" onkeydown="checkKey(event,this, 'discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_discount" name="fee_discount_chk_<%= d.id %>" id="fee_discount_chk_<%= d.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                  <% discount_total += discount_amount %>
              </td>
            </tr>
            <% else %>
            <tr id="discount_<%= d.id %>" class="<%= cycle("odd","even") %> discount_tr">
              <td class="col-1" style=" text-align: center;">
                <i class="fa fa-close" style="font-size: 16px; cursor: pointer; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
              <td class="col-2" colspan="3"><%= discount_text %></td>
              <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label discount_amount %></span>&nbsp;&nbsp;&nbsp;</td>
            </tr>
            <% end %>
            <% end %>
            <% #i += 1 %>
          <% end %>
        <% end %>
        
        <% if discount_total > 0 %>  
            <% total_fees = (total_fees-discount_total)%>
            <% total_payable = (total_payable-discount_total)%>
        <% end %>
        <% if total_fees > 0 and !@self_advance_fee %>  
          <% add_discount_link = true %>  
            <!-- Add Discount -->
          <tr>
              <td class="col-1" style=" text-align: center;">
                  <div id="discount_on_div" style="display: none;">
                    <select name="discount_on_tmp" id="discount_on_tmp" style="padding: 4px 12px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="">Discount On</option>
                        <option value="0">Total Fees</option>
                        <% @fee_particulars.each do |fee| %>
                        <option value="<%= fee.finance_fee_particular_category_id %>"><%= fee.name %></option>
                        <% end %>
                    </select>
                  </div>
                  &nbsp;
              </td>
              <td colspan="4" id="add_extra_discount" class="col-2" style="font-size: 14px; font-weight: bold; cursor: pointer;"><i class="fa fa-plus-square-o" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;Add Discount</td>
          </tr>  
        <% end %>    
           
        <% if @paid_fees.blank? or discount_total > 0 %>    
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_discount') %> </td>
          <td class="col-6" style="text-align: right;">
              <span id="discount_total_amount_label" style="color: #000;"><%= precision_label(discount_total) %></span>
              <input type="hidden" name="discount_total_amount" id="discount_total_amount" value="<%= precision_label(discount_total) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>
        </tr>
        <% end %>
      <% end %>
      <% if total_fees > 0 and !@self_advance_fee and !add_discount_link %>  
        <tr id="discount_0" class="<%= cycle("odd","even") %> discount_tr" style="display: none;">
          <td class="col-1" style=" text-align: center;">
            <i class="fa fa-close" style="font-size: 16px; cursor: pointer; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;">0</span>
          </td>
          <td class="col-2" colspan="3"></td>
          <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label 0 %></span>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <tr id="discount_0" class="<%= cycle("odd","even") %> discount_tr" style="display: none;">
          <td class="col-1" style=" text-align: center;">
            <i class="fa fa-close" style="font-size: 16px; cursor: pointer; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;">0</span>
          </td>
          <td class="col-2" colspan="3"></td>
          <td class="col-6" style="text-align: right; "><span style="color: #666; text-decoration: line-through;"><%= precision_label 0 %></span>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <tr>
            <td class="col-1" style=" text-align: center;">
                  <div id="discount_on_div" style="display: none;">
                    <select name="discount_on_tmp" id="discount_on_tmp" style="padding: 4px 12px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="">Discount On</option>
                        <option value="0">Total Fees</option>
                        <% @fee_particulars.each do |fee| %>
                        <option value="<%= fee.finance_fee_particular_category_id %>"><%= fee.name %></option>
                        <% end %>
                    </select>
                  </div>
                  &nbsp;
              </td>
            <td colspan="4" id="add_extra_discount" class="col-2" style="font-size: 14px; font-weight: bold; cursor: pointer;"><i class="fa fa-plus-square-o" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;Add Discount</td>
        </tr>   
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_discount') %> </td>
          <td class="col-6" style="text-align: right;">
              <span id="discount_total_amount_label" style="color: #000;"><%= precision_label(discount_total) %></span>
              <input type="hidden" name="discount_total_amount" id="discount_total_amount" value="<%= precision_label(discount_total) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>
        </tr>
      <% end %>      
        
      <% unless @vat.nil? and @paid_fees.blank? %>
        <% if @vat.to_f == 0.00 %>
          <% vat_amount = 0 %>
          <% @paid_fees.each do |trans| %>
          <% if trans.vat_included %>
              <% if trans.vat_amount.to_f > 0.00 %>
                <%  vat_amount += trans.vat_amount.to_f %>
              <% end %>
          <% end %>
          <% end %>
          <% @vat = vat_amount %>
        <% end %>
        <% if @vat.to_f > 0.00 %>
        <tr id="vat_as_particular_blank_space_1" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_2" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_3" class="tr-blank"></tr>
        <tr id="vat_as_particular_blank_space_4" class="tr-blank"></tr>
        <tr id="vat_as_particular" class="<%= cycle("odd","even") %>">
          <% paidAmount = 0 %>
          <% unless @paid_fees.blank? %>
             <% transaction_ids = @paid_fees.map(&:id) %> 
             <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'VAT' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
             <% unless paidFess.blank? %> 
             <% discountPaid = true %>
             <% paidAmount += paidFess.map(&:amount).sum.to_f %>
             <% end %>
          <% end %>  
          <% remaining_amount = @vat.to_f - paidAmount  %>
          <% if remaining_amount < 0 %>  
            <% remaining_amount = 0 %>
          <% end %>  
          <% if remaining_amount == 0 %>  
            <% if @vat.to_f < paidAmount %>
              <% @vat = paidAmount %>
            <% end %>
            <td class="col-1 sl_no" style=" text-align: center;">
              <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2"><%= "VAT" %></td>
            <td class="col-2" style="text-align: right;"><%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;</td>
            <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
            <td class="col-2" style="text-align: right;"><%= precision_label remaining_amount.to_f %>&nbsp;&nbsp;&nbsp;</td>
          <% else %>  
            <% if @vat_as_particular %>
              <td class="col-1" style="text-align: center;">
                  <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                  <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2">
                  <span class="themed_text"><%= "VAT" %></span>
                  <% if @vat_as_particular and paidAmount == 0 %>
                    <span id="rm_vat" style="float: right;">
                        <%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_particular_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :particular_id=>@vat_particular_id },:confirm => 'Are you sure, you want to remove this particular?'%>
                    </span>
                  <% else %>  
                    <span id="rm_vat" style="float: right;"></span>
                  <% end %> 
              </td>
              <td class="col-6" style="text-align: right;">
                  <%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;
              </td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;">
                <% if paidAmount > 0 %>  
                  <span class="only_enable_vat" name="fee_amount_vat" id="fee_amount_vat" style="color: #000;"><span style="color: #000;"><%= precision_label remaining_amount.to_f %></span></span>&nbsp;&nbsp;&nbsp;
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label remaining_amount.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" />
                <% else %>
                  <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label @vat.to_f %></span></span>
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                  <% if @vat_as_particular == false and paidAmount == 0 %>
                  <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                      <br />Assign to the Student
                  </span>
                  <% end %>
                <% end %>
              </td>
            <% else %>
              <% if paidAmount > 0 %>
              <td class="col-1 sl_no" style=" text-align: center;">
                <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2"><%= "VAT" %></td>
              <td class="col-2" style="text-align: right;"><%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
              <% else %>
              <td class="col-1" style="text-align: center;">
                  <input type="checkbox" name="fee_vat" id="fee_vat" class="fee_vat" style="display: none;" checked="" data-fee_amount="<%= precision_label @vat.to_f %>">
                  <i name="fee_vat" id="fee_vat" class="fa fa-check-square-o fee_vat_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
              </td>
              <td class="col-2">
                  <span class="themed_text"><%= "VAT" %></span>
                  <% if @vat_as_particular and paidAmount == 0 %>
                    <span id="rm_vat" style="float: right;">
                        <%= link_to_remote '<i class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>',:url => {:action => 'remove_tmp_particular_from_fee', :batch_id => @batch.id, :student => @student.id, :date=> @date.id, :particular_id=>@vat_particular_id },:confirm => 'Are you sure, you want to remove this particular?'%>
                    </span>
                  <% else %>  
                    <span id="rm_vat" style="float: right;"></span>
                  <% end %> 
              </td>
              <td class="col-6" style="text-align: right;">
                  <%= precision_label @vat.to_f %>&nbsp;&nbsp;&nbsp;
              </td>
              <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %>&nbsp;&nbsp;&nbsp;</td>
              <td class="col-2" style="text-align: right;">
                  <span class="fee_amount_vat editable"  name="fee_amount_vat" id="fee_amount_vat"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label @vat.to_f %></span></span>
                  <input type="hidden" name="fee_vat_amount" id="fee_vat_amount" value="<%= precision_label @vat.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'vat')" onkeydown="checkKey(event,this, 'vat')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_vat" name="fee_vat_chk" id="fee_vat_chk" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                  <% if @vat_as_particular == false and paidAmount == 0 %>
                  <span name="assign_vat_to_user" id="assign_vat_to_user" class="assign_vat_to_user" style="font-size: 12px; display: none; cursor: pointer; border-bottom: 1px dashed #990A10;">
                      <br />Assign to the Student
                  </span>
                  <% end %>
              </td>
              <% end %>
            <% end %>
          <% end %>
        </tr>
        <% total_fees += remaining_amount %>
        <% total_payable += @vat.to_f %>
      <% end %>  
      
      <% end %>
      <% if  total_fees == 0 %>
      <% @fine = 0.00 %>
      <% end %>
      
      <% fine_paid = false %>
      <% unless @fine_rule%>
        <% unless @paid_fees.blank? %>
          <% paidAmount = 0 %>
          <% unless @paid_fees.blank? %>
            <% transaction_ids = @paid_fees.map(&:id) %> 
            <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
            <% unless paidFess.blank? %> 
            <% paidAmount += paidFess.map(&:amount).sum.to_f %>
            <% end %>
          <% end %>  
          <% if paidAmount > 0 %>
            <% fine_paid = true %>
            <% @fine = paidAmount %>
          <% end %>
        <% end %>
      <% end %>
        
      <% if discount_total > 0 %>  
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>
      <tr class="tr-blank"></tr>  
      <% load_fine_amount_to_pay = false %>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_fees') %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
              <input type="hidden" name="total_amount" id="total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>
      </tr>   
      <% else %>
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('total_fees') %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="total_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
              <input type="hidden" name="total_amount" id="total_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>
      </tr>  
      <% end %>
        
      <% unless @fine.nil? %>
        <% if @fine.to_f > 0.00 %>
        <tr id="fine_blank_space_1" class="tr-blank"></tr>
        <tr id="fine_blank_space_2" class="tr-blank"></tr>
        <tr id="fine_blank_space_3" class="tr-blank"></tr>   
        <tr id="fine_blank_space_4" class="tr-blank"></tr>   
        <% if fine_paid %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
              <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2"><span class="themed_text">
            <%= t('fine_on') %> <%= @paid_fees.first.transaction_date %></span>
          </td>
          <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
          <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label 0 %>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <% else %>
        <% if total_fees > 0 %>
          <% total_fees += @fine.to_f %>
          <tr id="extra_fine" class="<%= cycle("odd","even") %>">
            <td class="col-1" style="text-align: center;">
                <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @fine.to_f %>">
                <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2"><span class="themed_text">
              <%= t('fine_on') %> <%= Date.today %></span>
              <span id="rm_fine" style="float: right; cursor: pointer;">
                  <i class="fa fa-minus-circle remove_fine" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i>
              </span>
            </td>
            <td class="col-2"  style="text-align: right;"><%= precision_label @fine.to_f %></td>
            <td class="col-2"  style="text-align: right;"><%= precision_label 0 %></td>
            <td class="col-6"  style="text-align: right;">
                <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label @fine.to_f %></span></span>
                <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @fine.to_f %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine.to_f) %>" /><i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <% load_fine_amount_to_pay = true %>
            </td>
          </tr>
          <% end %>
        <% end %>
      <% end %>
      <% end %>
      <%total_fees1=total_fees%>
      
      <% if  total_fees == 0 %>
        <% if @paid_fees.blank? %>
          <% @new_fine_amount = 0.00 %>
        <% end %>
      <% end %>
      
    
      <% fine_amount_total = 0 %>  
      <%if @fine_rule%>
        <tr id="fine_blank_space_1" class="tr-blank"></tr>
        <tr id="fine_blank_space_2" class="tr-blank"></tr>
        <tr id="fine_blank_space_3" class="tr-blank"></tr>   
        <tr id="fine_blank_space_4" class="tr-blank"></tr>
        <% paidAmount = 0 %>
        <% fine_discount = 0 %>
        <% if @has_fine_discount %>    
        <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
          <% @discounts_on_lates.each do |d| %>
            <% if @discounts_late_amount[d.id] > 0 %>
              <% fine_discount += @discounts_late_amount[d.id] %>
            <% end %>
          <% end %>
        <% end %>
        <% end %>
        
        <% #new_fine = @new_fine_amount.to_f - fine_discount.to_f %>
        <% new_fine = @new_fine_amount.to_f - fine_discount.to_f %>
        <% unless @paid_fees.blank? %>
           <% transaction_ids = @paid_fees.map(&:id) %> 
           <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")") %>
           <% unless paidFess.blank? %> 
           <% paidAmount += paidFess.map(&:amount).sum.to_f %>
           <% end %>
        <% end %>  
        <% remaining_amount = new_fine.to_f - paidAmount.to_f  %>
        <% if remaining_amount <= 0 %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
             <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2">
            <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
          </td>
          <td class="col-6"  style="text-align: right;"><%= precision_label new_fine %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
        </tr>
        <% else %>
        <% if paidAmount > 0 %>
        <tr id="extra_fine" class="<%= cycle("odd","even") %>">
          <td class="col-1" style="text-align: center;">
              <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label remaining_amount %>">
              <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
          </td>
          <td class="col-2">
            <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
          </td>
          <td class="col-6"  style="text-align: right;"><%= precision_label @new_fine_amount %></td>
          <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
          <td class="col-6"  style="text-align: right;">
              <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label remaining_amount %></span></span>
              <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label remaining_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
              <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(remaining_amount) %>" /><i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
              <% load_fine_amount_to_pay = true %>
              <% fine_amount_total += remaining_amount %>  
          </td>
        </tr>
        <% else %>
          <% if total_fees > 0 %>
          <tr id="extra_fine" class="<%= cycle("odd","even") %>">
            <td class="col-1" style="text-align: center;">
                <input type="checkbox" name="fee_fine" id="fee_fine" class="fee_fine" style="display: none;" checked="" data-fee_amount="<%= precision_label @new_fine_amount %>">
                <i name="fee_fine" id="fee_fine" class="fa fa-check-square-o fee_fine_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
            </td>
            <td class="col-2">
              <span class="themed_text"><%= t('fine_on') %> <%= @date.due_date.to_date+@fine_rule.fine_days.days %><%= discount_text = @fine_rule.is_amount ? "" :  " (#{@fine_rule.fine_amount}&#x200E;%)" %></span>
            </td>
            <td class="col-6"  style="text-align: right;"><%= precision_label @new_fine_amount %></td>
            <td class="col-6"  style="text-align: right;"><%= precision_label paidAmount %></td>
            <td class="col-6"  style="text-align: right;">
                <span class="fee_amount_fine editable"  name="fee_amount_fine" id="fee_amount_fine"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label @new_fine_amount %></span></span>
                <input type="hidden" name="fee_fine_amount" id="fee_fine_amount" value="<%= precision_label @new_fine_amount %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine')" onkeydown="checkKey(event,this, 'fine')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine" name="fee_fine_chk" id="fee_fine_chk" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@new_fine_amount) %>" /><i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                <% load_fine_amount_to_pay = true %>
                <% fine_amount_total += @new_fine_amount %>  
            </td>
          </tr>
          <% end %>
        <% end %>
        <% end %>
      <%end%>
      <% fine_discount = 0 %>  
      <% if @has_fine_discount %>    
        <% unless @discounts_on_lates.nil? or @discounts_on_lates.empty? or @discounts_on_lates.blank? %>
          <% @discounts_on_lates.each do |d| %>
            <% if @discounts_late_amount[d.id] > 0 %>
              <% paidAmount = 0 %>
              <% unless @paid_fees.blank? %>
                <% transaction_ids = @paid_fees.map(&:id) %> 
                <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'FineAdjustment' and transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = '#{d.id}'") %>
                <% unless paidFess.blank? %> 
                <% paidAmount += paidFess.map(&:amount).sum.to_f %>
                <% end %>
             <% end %>  
             <% remaining_amount = @discounts_late_amount[d.id].to_f - paidAmount.to_f  %>
             <% if paidAmount > 0 %>
             <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <i class="fa fa-check" style="font-size: 20px; color: #49BB4B;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2" colspan="2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label paidAmount %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label 0.00 %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
             <% else %>
              <% if fine_amount_total > @discounts_late_amount[d.id] %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <input type="checkbox" name="fee_fine_discount_<%= d.id %>" id="fee_fine_discount_<%= d.id %>" class="fee_fine_discount" style="display: none;" checked="" data-fee_amount="<%= precision_label @discounts_late_amount[d.id] %>">
                    <i name="fee_fine_discount_fa_<%= d.id %>" id="fee_fine_discount_fa_<%= d.id %>" class="fa fa-check-square-o fee_fine_discount_fa" style="font-size: 16px; cursor: pointer;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;">
                    <span class="fee_fine_amount_discount editable"  name="fee_fine_amount_discount_<%= d.id %>" id="fee_fine_amount_discount_<%= d.id %>"><i class="fa fa-pencil" style="font-size: 12px;" aria-hidden="true"></i> <span><%= precision_label @discounts_late_amount[d.id] %></span></span>
                    <input type="hidden" name="fee_fine_discount_amount_<%= d.id %>" id="fee_fine_discount_amount_<%= d.id %>" value="<%= precision_label @discounts_late_amount[d.id] %>" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 70%;" onkeypress="return isNumberKey(event,this, 'fine_discount')" onkeydown="checkKey(event,this, 'fine_discount')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_fine_discount" name="fee_fine_discount_chk_<%= d.id %>" id="fee_fine_discount_chk_<%= d.id %>" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
                    <% fine_discount += @discounts_late_amount[d.id] %>  
                </td>
              </tr>
              <% else %>
              <tr class="<%= cycle("odd","even") %>">
                <td class="col-1" style="text-align: center;">
                    <i class="fa fa-close" style="font-size: 20px; color: #990A10;" aria-hidden="true"></i>&nbsp;&nbsp;<span class="sl_no" style="color: #000;"><%= i+=1 %></span>
                </td>  
                <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                <td class="col-2" colspan="2"><%= discount_text %></td>
                <td class="col-6" style="text-align: right;"><%= precision_label 0.00 %></td>
                <td class="col-6" style="text-align: right; text-decoration: line-through;"><%= precision_label @discounts_late_amount[d.id] %>&nbsp;&nbsp;&nbsp;</td>
              </tr>
              <% end %>
              <% end %>
            <% end %>
            <% i += 1 %>
          <% end %>
        <% end %> 
        <% @fine_amount = fine_amount_total - fine_discount %>      
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>&nbsp;&nbsp;&nbsp;
              <% if load_fine_amount_to_pay == false %>
              <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
              <% load_fine_amount_to_pay = true %>
              <% end %>
          </td> 
        </tr>
      <% else %>  
        <% @fine_amount = fine_amount_total - fine_discount %>      
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
          <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%="Fine Amount" %> </td>
          <td class="col-6" style="text-align: right;">
              <span id="fine_amount_to_pay_label" style="color: #000;"><%= precision_label(@fine_amount) %></span>
              <% if load_fine_amount_to_pay == false %>
              <input type="hidden" name="fine_amount_to_pay" id="fine_amount_to_pay" value="<%= precision_label(@fine_amount) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
              <% end %>
          </td> 
        </tr>
      <% end %>
      <% total_fees += fine_amount_total.to_f %>  
      <%
        fine_amount_paid = 0.0
        paid_fine = 0.0
      %>  
      <% unless @paid_fees.nil? %>
        <% paid=0 %>
        <% @paid_fees.each{|a| paid += a.amount.to_f} %>
        
        <%
          fine_amount_paid = 0.0
          paid_fine = 0.0
          unless @paid_fees.blank?
            transaction_ids = @paid_fees.map(&:id)
            unless transaction_ids.blank?
              paidFineFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")")
              unless paidFineFess.blank?
                paid_fine += paidFineFess.map(&:amount).sum.to_f
              end
            end
            unless @fine_amount == 0
              fine_amount_paid = @fine_amount
            else
              unless @new_fine_amount.blank?
                fine_amount_paid = @new_fine_amount
              else
                fine_amount_paid = 0
              end
            end
            unless paid_fine.nil?
              paid_fine = paid_fine - fine_amount_paid
            end
          else
            fine_amount_paid = @fine_amount
          end
          total_payable += fine_amount_paid.to_f
        %>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="tr-blank"></tr>
        <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
          <td class="col-8" colspan="2"  style="text-align: right; font-weight: bold;"><%= "Fees Information" %> </td>
          <td class="col-6"  style="text-align: right;">
              <span id="total_payable_label" style="color: #000;"><%= precision_label(total_payable) %></span>
              <input type="hidden" name="total_payable" id="total_payable" value="<%= precision_label(total_payable) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>  
          <td class="col-6"  style="text-align: right;">
              <span id="payment_done_label" style="color: #000;"><%= precision_label(paid) %></span>
              <input type="hidden" name="payment_done" id="payment_done" value="<%= precision_label(paid) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>  
          <td class="col-6"  style="text-align: right;">
              <span id="remaining_amount_label" style="color: #000;"><%= precision_label(total_fees) %></span>
              <input type="hidden" name="remaining_amount" id="remaining_amount" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
          </td>  
        </tr>
      <% end %>
      
      <%# balance=@financefee.balance.to_f+@fine.to_f+@vat.to_f%>
      <% balance = (total_payable.to_f + paid_fine.to_f) %>
      <% if balance < paid %>  
      <% amount_advanced = paid - ( total_payable + paid_fine ) %>  
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1">
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('advance_payment') %> </td>
        <td class="col-6"  style="text-align: right;">
            <span id="advance_payment_label" style="color: #000;"><%= precision_label(amount_advanced) %></span>
            <input type="hidden" name="advance_payment" id="advance_payment" value="<%= precision_label(amount_advanced) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
        </td>
      </tr>  
      <% else %>  
      <tr class="<%= cycle("odd","even") %>" cellpadding="1" cellspacing="1" style="display: none;">
        <% fee_to_pay = 0 %>  
        <% unless precision_label(balance+@fine_amount.to_f).to_f == 0 %>
          <% fee_to_pay = balance+@fine_amount.to_f %>
        <% end %>
        <td class="col-8" colspan="4"  style="text-align: right; font-weight: bold;"><%= t('amount_to_pay') %> </td>
        <td class="col-6"  style="text-align: right;">
            <span id="amount_to_pay_label" style="color: #000;"><%= precision_label(total_fees) %></span>
            <input type="hidden" name="amount_to_pay" id="amount_to_pay" value="<%= precision_label(total_fees) %>" />&nbsp;&nbsp;<i class="fa fa-check-square" style="font-size: 16px; cursor: pointer; display: none;" aria-hidden="true"></i>
        </td>  
      </tr>
      <% end %>
      
      <script type="text/javascript">
        j(document).ready(function(){
            if ( j("#remaining_amount").length > 0 )
            {
                if ( parseFloat(j("#remaining_amount").val()) <= 0 )
                {

                    j(".fine_info").remove();
                }
            }
        });
      </script>

       
      <% if total_fees > 0 and @show_only_structure == false %>
        <tr>
          <td colspan="5" style="background: #f9f9f9; ">
            <div class="payment_details" style="width: 100%;">
                <div style="width: 59%; float: left; border-right: 1px solid #ccc;">
                    <div class="label-field-pair" style="width: 99%;">
                      <div class="label-container"><%= t('payment_mode') %>  <%= image_tag("loader.gif",
                        :align => "absmiddle",
                        :border => 0,
                        :id => "loader1",
                        :style =>"display: none;" ) %></div>
                      <div class="input-container">
                          <%= select :fees, :payment_mode, [["#{t('pbl_std')}", "#{t('pbl_std')}"],["#{t('cash')}", "#{t('cash')}"],["#{t('online_payment')}", "#{t('online_payment')}"],["#{t('cheque')}", "#{t('cheque')}"],["#{t('dd')}","#{t('dd')}"],["Admission Payment", "Admission Payment"],["#{t('others')}", "#{t('others')}"]], {} ,{:onChange => "#{remote_function(:url => {:action => "select_payment_mode"},
                              :with => "'payment_mode='+value",:before => "$('loader1').show();",
                              :success => "$('loader1').hide();")}"}  %>
                      </div>
                  </div>
                  <div id="payment_mode"></div>  
                  <div class="label-field-pair" style="width: 99%;">
                    <div class="label-container"><%= t('payment_notes') %> </div>
                    <div class="input-container"><%= form.text_area :payment_note,:cols => 50, :rows => 1 %></div>
                  </div>
              </div>
              <div style="width: 38%; float: left; padding-left: 2%;">
                <div class="label-field-pair" style="width: 99%;">
                  <div class="label-container" style="padding-top: 10px;"><%= t('amount') %> </div>
                  <div class="input-container">
                      <input type="hidden" name="current_balnce" id="current_balnce" value="<%= precision_label total_fees %>" />
                      <input type="hidden" name="tot_fee_amount" id="tot_fee_amount" value="<%= precision_label total_fees %>" />
                      <label id="total_fees_payment_record" style="padding: 6px; border: 1px solid #ccc; margin: 6px 11px; width: 154px; border-radius: 5px; font-family: verdana; font-size: 14px; font-weight: normal;"><%= precision_label total_fees %></label>
                    <%#= form.text_field :fees_paid, :value=> precision_label(balance+@fine_amount.to_f), :class=>'precision_text' %>
                    <%=  hidden_field_tag :total_fees, total_fees1 %>
                  </div>
                </div>
                <div class="label-field-pair" style="width: 99%;">
                  <div class="label-container">Transaction Date</div>
                  <%
                    if @submission_date.nil? or @submission_date.blank?
                      @submission_date = Date.today
                    end
                  %>
                  <div class="input-container calendar-input"><%= calendar_date_select_tag 'fees[transaction_date]',I18n.l(@submission_date,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force",:onchange => "reloadFeeSubmission('#{@batch.id}', '#{@date.id}', '#{@student.id}',new Date($F(this)));" %></div>
                </div>
              </div>      
              <div style="clear: both; height: 1px;"></div>  
              
                
            </div>
          </td>
        </tr>
      <% end %>
      <tr>
        <td colspan="5" style="background: #fff;">
          <div class="pay_fees">
            <%  if total_fees > 0 and @show_only_structure == false %>
              <div class="pay_fees_buttons">
                <%= submit_tag "► #{t('pay_fees')}",:class=>'submit_button' , :id => 'submit_button',:onClick => "return validate_payment_mode()" %>
                <%= image_tag("loader.gif",
                        :align => "absmiddle",
                        :border => 0,
                        :id => "loader_pay",
                        :style =>"display: none;" ) %>
                <%= link_to "► #{t('print_receipt')}",
                  {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id},:target => '_blank', :class=> 'user_button' unless @trans.nil? %>
                <%= link_to "► #{t('print_receipt')}",
                  {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id,:batch_id=>@student.batch_id,:admission=>1 },:target => '_blank', :class=> 'user_button' %>
                <%= link_to "► Print ALL Receipt",
                  {:controller => "finance", :action => "student_fee_receipt_all_pdf", :id=>@date.id,:batch_id=>@student.batch_id},:target => '_blank', :class=> 'user_button' %>
              </div>
            <% else %>
              <div class="pay_fees_buttons">
                <% if total_fees == 0  %>  
                  <% if @paid_fees.empty? %>
                    <span style='border: 1px solid #ccc; background: #F5F5F5; float: right; padding: 10px; border-radius: 6px;'>Amount to pay is Zero, Nothing to pay</span>
                  <% else %>
                    <h4 class="info" style="padding: 4px 10px; margin: 18px 10px 0 !important;  border-radius: 4px;"><%= t('fees_paid') %></h4>
                  <% end %>
                <% end %>
                <% unless MultiSchool.current_school.id == 352 %>
                  <%= link_to "► #{t('print_receipt')}",
                              {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id,:batch_id=>@batch.id},:target => '_blank', :class=> 'user_button' %>
          <% end %>

              </div>
            <% end %>
          </div>
        </td>
      </tr>
    <%#*<tr>%>
    <%#*<td colspan="3">%>
    <%# unless @paid_fees.nil? or not total_fees.to_f == 0 %>
    <%#= link_to "► #{t('print_receipt')}",
    {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id},:target => '_blank', :class=> 'user_button' %>
    <%# end %>
    <%#*</td>%>
    <%#*</tr>%>

    <%end%>
    </tbody>  
  </table>
  <% if @student.has_dues %>
  <div style="clear: both; height: 4px;"></div>
  <div style="width: 100%; text-align: center; color: #f00;">***Student has previous Dues***</div>
  <div style="clear: both; height: 10px;"></div>
  <% end %>
<% end %>
<% payment_table = MultiSchool.current_school.id == 352 ? "payments" : MultiSchool.current_school.code + "_payments" %>  
<% if @show_only_structure == false %>  
  <% unless @paid_fees.empty? %>
    <div id="payments_details" style="padding-top: 10px;">
      <div class="label-field-pair3" style="padding-bottom: 15px;">
          <label style="font-size: 22px;"><%= t('payment_history') %> </label>
      </div>
      <table class="table table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
        <thead><!-- class="thead-inverse t" -->
          <tr>
            <th><%= t('sl_no') %></th>
            <th style="text-align: center;"><%= t('payment_date') %></th>
            <th style="text-align: center;"><%= t('payment_mode') %></th>
            <th><%= t('payment_notes') %></th>
            <th style="text-align: right;"><%= t('amount') %> (<%= currency %>  )</th>
            <% if @current_user.admin? %>
            <th class="col-3" style="width:2%; text-align: center;"></th>
            <% end %>
            <% if MultiSchool.current_school.id == 352 %>
            <th>&nbsp;</th>
            <% end %>
        </tr>
        <tbody>
        <% @paid_fees.each_with_index do |f , i| %>
          <tr id="paid_fees_tr_<%= f.id %>" class="<%= cycle("odd","even") %> paid_fees_tr">
            <% transaction_payment = false %>
            <% transaction_payment_not_assign = false %>
            <% #if MultiSchool.current_school.id == 352 %>
              <% payment = Payment.find_by_finance_transaction_id_and_payment_id(f.id, @financefee.id) %>
              <% unless payment.present? %>
                <% payment = Payment.find_by_payment_id(@financefee.id) %>
                <% unless payment.nil? %>
                  <% if payment.gateway_response[:amount].to_f == f.amount.to_f %>
                    <% transaction_payment_not_assign = true %>
                  <% else %>  
                    <% payments = Payment.find(:all, :joins => "left join finance_transactions ON finance_transactions.id = #{payment_table}.finance_transaction_id", :conditions => "#{payment_table}.payee_id = '#{@student.id}' and finance_transactions.id IS NULL") %>
                  <% end %>
                <% else %>  
                  <% payments = Payment.find(:all, :joins => "left join finance_transactions ON finance_transactions.id = #{payment_table}.finance_transaction_id", :conditions => "#{payment_table}.payee_id = '#{@student.id}' and finance_transactions.id IS NULL") %>
                <% end %>
              <% else %>
                <% transaction_payment = true %>
              <% end %>
            <% #end %>
              
              
            <%#= transaction_payment %>  
            <% payment_mode = f.payment_mode %>
            <% if transaction_payment %>
              <% if payment.gateway_txt.downcase == "trustbank" %>
              <% payment_mode = "Trust Bank Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "bkash" %>
              <% payment_mode = "bKash Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "citybank" %>
              <% payment_mode = "Citybank Online Payment" %>
              <% end %>
            <% elsif transaction_payment_not_assign %>
              <% if payment.gateway_txt.downcase == "trustbank" %>
              <% payment_mode = "Trust Bank Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "bkash" %>
              <% payment_mode = "bKash Online Payment" %>
              <% elsif payment.gateway_txt.downcase == "citybank" %>
              <% payment_mode = "Citybank Online Payment" %>
              <% end %>
              <% payment.update_attributes(:finance_transaction_id=>f.id) %>
              <%
                student_fee_ledgers = StudentFeeLedger.find(:all, :conditions => "student_id = #{@student.id} and fee_id = #{@finance_fee.id} and transaction_id = #{f.id} and is_fine = #{true}")
                unless student_fee_ledgers.blank?
                  student_fee_ledgers.each do |student_fee_ledger|
                    unless payment.transaction_datetime.blank?
                      student_fee_ledger.update_attributes(:ledger_date => payment.transaction_datetime.strftime("%Y-%m-%d"), :ledger_title => "Fine On " + payment.transaction_datetime.strftime("%d %B, %Y"))
                    else
                      student_fee_ledger.update_attributes(:ledger_date => f.transaction_date.strftime("%Y-%m-%d"), :ledger_title => "Fine On " + f.transaction_date.strftime("%d %B, %Y"))
                    end
                  end
                end
              
                student_fee_ledger = StudentFeeLedger.find(:first, :conditions => "student_id = #{@student.id} and fee_id = #{@financefee.id} and transaction_id = #{f.id} and is_fine = #{false}")
                unless student_fee_ledger.blank?
                  amount_paid = student_fee_ledger.amount_paid
                  if amount_paid.to_f != f.amount.to_f
                    student_fee_ledger.update_attributes(:amount_paid => f.amount.to_f)
                  end
                else
                  student_fee_ledger = StudentFeeLedger.new
                  student_fee_ledger.student_id = @student.id
                  unless payment.transaction_datetime.blank?
                    student_fee_ledger.ledger_date = payment.transaction_datetime.strftime("%Y-%m-%d")
                  else
                    student_fee_ledger.ledger_date = f.transaction_date.strftime("%Y-%m-%d")
                  end
                  student_fee_ledger.ledger_title = @financefee.finance_fee_collection.title  
                  student_fee_ledger.amount_to_pay = 0.00
                  student_fee_ledger.fee_id = @financefee.id
                  student_fee_ledger.amount_paid = f.amount.to_f
                  student_fee_ledger.transaction_id = f.id
                  student_fee_ledger.order_id = payment.order_id
                  student_fee_ledger.save
                end
              
              %>
            <% end %>
            <td class="col-1"><%= i +=1 %></td>
            <% if transaction_payment || transaction_payment_not_assign %>
              <td class="col-3" style="text-align: center;"><%= I18n.l((payment.transaction_datetime.to_time).to_datetime,:format=>"%d %b %Y<Br /> %I:%M %P") %></td>
            <% else %>
              <td class="col-3" style="text-align: center;"><%= f.transaction_date %></td>
            <% end %>
            <% if transaction_payment || transaction_payment_not_assign %>
              <td class="col-3" style="text-align: left;">
                <%= payment_mode %>
                <hr style="border: 1px solid #ccc;" />
                <div style="font-size: 12px; font-family: verdana;">
                  <h2>Online Payment Info</h2>
                  <p><b>Order ID: </b><%= payment.order_id %></p>
                  <%
                    trans_type = ""
                    if payment.gateway_txt.downcase == "trustbank"
                      if payment.gateway_response[:payment_type] == "MB"
                        trans_type = "TBL Mobile banking"
                      else
                        trans_type = "TBL Card Payment"
                      end
                    end
                  %>
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                  <p><b>Ref Id: </b><%= payment.gateway_response[:ref_id] %></p>
                  <% elsif payment.gateway_txt.downcase == "citybank" %>
                  <p><b>ApprovalCode: </b><%= payment.gateway_response[:Message][:ApprovalCode] %></p>
                  <p><b>Ref Id: </b><%= payment.gateway_response[:Message][:OrderID] %></p>
                  <% elsif payment.gateway_txt.downcase == "bkash" %>
                  <p><b>Payment Id: </b><%= payment.gateway_response[:paymentID] unless payment.gateway_response[:paymentID].blank? %></p>
                  <p><b>Transaction Id: </b><%= payment.gateway_response[:trxID] unless payment.gateway_response[:trxID].blank? %></p>
                  <% end %>
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                  <p><b>Transaction Type: </b><%= trans_type %></p>
                  <% end %>
                  <hr style="border: 1px solid #ccc;" />
                  <% if payment.gateway_txt.downcase == "trustbank" %>
                    <% if payment.gateway_response[:verified].to_i == 1 %>
                      <i class="fa fa-check-circle-o" style="font-size: 18px; color: #49BB4B;"></i>&nbsp;&nbsp;Verified
                    <% else %>
                      <% unless payment.validation_response.nil? %>
                        <% if payment.validation_response[:verified].to_i == 0 %>
                        <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: #900;"></i>&nbsp;&nbsp;<span style="color: #900;">Not Verified</span>
                          </div>
                          <% if @current_user.admin? %>
                          <div style="width: 35%; display: inline-block; text-align: right;">
                            <%= link_to "(verify Now)", {:controller => "online_payments", :action => "order_verifications", :order_tid => payment.order_id},:target => '_blank' %>

                          </div>
                         <% end %>   
                        </div>
                        <% else %>
                        <i class="fa fa-check-circle-o" style="font-size: 18px; color: #49BB4B;"></i>&nbsp;&nbsp;Verified
                        <% end %>
                      <% else %>
                      <div style="width: 100%;">
                        <div style="width: 60%; display: inline-block;">
                          <i class="fa fa-circle-o" style="font-size: 18px; color: #900;"></i>&nbsp;&nbsp;<span style="color: #900;">Not Verified</span>
                        </div>
                        <% if @current_user.admin? %>
                        <div style="width: 35%; display: inline-block; text-align: right;">
                          <%= link_to "(verify Now)", {:controller => "online_payments", :action => "order_verifications", :order_tid => payment.order_id},:target => '_blank' %>

                        </div>
                       <% end %>   
                      </div>
                      <% end %>
                      <% end %>
                      <% elsif payment.gateway_txt.downcase == "bkash" %>
                      <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: <%= (payment.gateway_response[:transactionStatus] == "Completed") ? "#49BB4B" : "#900" %>;"></i>&nbsp;&nbsp;<span style="color: <%= (payment.gateway_response[:transactionStatus] == "Completed") ? "#145214" : "#900" %>;"><%= payment.gateway_response[:transactionStatus]  unless payment.gateway_response[:transactionStatus].blank?  %></span>
                          </div>  
                      </div>
                      <% elsif payment.gateway_txt.downcase == "citybank" %>
                      <div style="width: 100%;">
                          <div style="width: 60%; display: inline-block;">
                            <i class="fa fa-circle-o" style="font-size: 18px; color: <%= (payment.gateway_response[:Message][:OrderStatus] == "APPROVED") ? "#49BB4B" : "#900" %>;"></i>&nbsp;&nbsp;<span style="color: <%= (payment.gateway_response[:Message][:OrderStatus] == "APPROVED") ? "#145214" : "#900" %>;"><%= payment.gateway_response[:Message][:OrderStatus]  unless payment.gateway_response[:Message][:OrderStatus].blank?  %></span>
                          </div>  
                      </div>
                    <% end %>      
                    <div style="clear: both; height: 1px;"></div>
                </div>
              </td>
            <% else %>
              <td class="col-3" id="payment_mode_order_id" style="text-align: center;">
                <%= payment_mode %>
                <% if payment_mode.strip == "Online Payment" %>  
                  <div style="width: 100%; text-align: left; padding-top: 5px; font-family: verdana; font-size: 12px;">
                      <hr style="border: 1px solid #ccc;" />
                      <p style="font-family: verdana; font-size: 12px;">Assign an Order ID with this transaction</p>
                      <%= select :fees_defaulters, :filter_by_course, payments.map{|s| [s.order_id, s.id]},
                        {:prompt => "Select an Order ID"},
                        {:class => "select2-combo", :onChange => "#{remote_function(:url => {:action => "set_order_id_with_finance_transaction"},
                        :with => "'payment_id='+value+'&transaction_id='+" + f.id.to_s + "+'&finance_id='+" + @financefee.id.to_s + "+'&student_id='+" + @student.id.to_s,
                        :before => "Element.show('loader_order_id')",
                        :success => "Element.hide('loader_order_id');")}", :autocomplete => "off", :style=>"width: 100% !important; text-align: left;"
                      }%>
                      <%= image_tag("loader.gif",
                          :align => "absmiddle",
                          :border => 0,
                          :id => "loader_order_id",
                          :style =>"display: none; " ) %>  
                  </div>  
                <% end %>  
              </td>
            <% end %>
            <td class="col-2"><%= f.payment_note %></td>
            <td class="col-3" style="text-align: right;">
              <%= precision_label(f.amount.to_f) %>
            </td>
            <% if @current_user.admin? %>
              <% student_fees = @from_batch_fee ? 0 : 1  %>
              <td class="col-3" style="width:2%; vertical-align: top;"> 
                  <div class="cancel" style="font-weight: bold; border: 1px solid #ccc; border-radius: 5px; padding: 1px 4px 1px 4px; margin-top: 0; color: #f00;">
                    <%=link_to_remote ("<i id='trans_id_#{f.id}' class='fa fa-trash'></i>"),{:url=>{:controller=>:finance,:action=>:delete_transaction_by_batch,:id=>@student.id,:date=>@date.id,:transaction_id=>f.id,:batch_id => @batch.id, :student_fees => student_fees, :from_admin => 1},:confirm=>"#{t('are_you_sure_want_delete_this_transaction')}", :before => "j('#trans_id_#{f.id}').removeClass('fa-trash');j('#trans_id_#{f.id}').addClass('fa-spinner');j('#trans_id_#{f.id}').addClass('fa-spin');"},{:style=> "color: #f00;"}%>
                  </div>
              </td>
            <% end %>
            <% if MultiSchool.current_school.id == 352 %>
              <td>
                <%= link_to "► #{t('print_receipt')}", {:controller => "finance", :action => "student_fee_receipt_pdf", :id => @student.id, :id2=>@date.id, :trn_id=>f.id},:target => '_blank', :class=> 'user_button' %>
              </td>
            <% end %>
          </tr>
        <% end %>
        </tbody>  
      </table>

    </div>
  <% end %>
<% end %>
<% if @financefee.is_paid == false %>
  <% if @financefee.balance.to_f != total_fees.to_f %>
    <% ffee = FinanceFee.find(@financefee.id) %>
    <% ffee.update_attributes(:balance => total_fees) %>
    <% if total_fees.to_i == 0 %>
      <% ffee.update_attributes(:is_paid => true) %>
    <% end %>
  <% end %>  
<% else %>
  <% if total_fees.to_f > 0 %>
    <% ffee = FinanceFee.find(@financefee.id) %>
    <% ffee.update_attributes(:balance => total_fees, :is_paid => false) %>
  <% end %>
<% end %>  
<script type="text/javascript">
  <%# unless @finance_fee_particular_categories.nil? %>
  j(document).off('change','#selectParticular').on('change','#selectParticular',function(){
      var selectedText = j("#selectParticular option:selected").text();
      j("#extra_particular_name").val(selectedText);
  }); 
  j(document).off('click','#add_extra_particular').on('click','#add_extra_particular',function(){
      if ( j("#particulars_tr_extra").length == 0 )
      {
          j.ajax({
              url: '/finance/load_fees_submission_batch/',
              data: {batch_id : '<%= @batch.id %>',student : '<%= @student.id %>',date : <%= @date.id %>, student_fees: <%= @from_batch_fee %>, option: 2},
              type: 'POST',
              asynchronous: true,
              dataType: 'json',
              success: function(data){
                  j('#particulars_tr_extra').remove();
                  particularList = data;
                  var html = '<tr id="particulars_tr_extra">';
                  html += '<td class="col-1" style=" text-align: center;"><i id="remove-extra-particular" class="fa fa-minus-circle" style="font-size: 16px; color: #990A10; cursor: pointer;" aria-hidden="true"></i></td>';
                  html += '<td class="col-2" style="font-size: 14px; font-weight: bold;">';
                  html += '<div class="input-container">';
                  html += '<select id="selectParticular">';
                  html += '<option value="">';
                  html += 'Select a Category';
                  html += '</option>';
                  if(particularList){
                      particularList.each(function(k,v){
                          html += '<option value="'+k.finance_fee_particular_category.id+'">';
                          html += k.finance_fee_particular_category.name;
                          html += '</option>';
                      });
                  }else{
                      html += '<option value="">';
                      html += 'No Categories Found';
                      html += '</option>';
                  }

                  html += '<select>';
                  html += '</div>';
                  html += '<div class="input-container" style="padding: 10px; ">';
                  html += '<input type="text" name="extra_particular_name" id="extra_particular_name" value="" style="border-radius: 4px; border: 1px solid #ccc; padding: 10px; width: 89%;" />';
                  html += '</div>';
                  html += '</td><td class="col-6" colspan="3" style="text-align: right;">';
                  html += '<input type="text" name="extra_particular_amount" id="extra_particular_amount" value="" style="border-radius: 4px; border: 1px solid #999; padding: 4px; width: 40%;" onkeypress="return isNumberKey(event,this, \'particular_extra\')" onkeydown="checkKey(event,this, \'particular_extra\')" />&nbsp;&nbsp;<i class="fa fa-check-square chk_extra_particular" name="extra_particular_chk" id="extra_particular_chk" style="font-size: 16px; cursor: pointer; " aria-hidden="true"></i></td></tr>';
                  j('.particulars_tr').last().after(html);
                  j('#selectParticular').select2();
              }
          });
      }
  });
  <%# end %>
  $('submit_button').disable();
  setTimeout(function(){$('submit_button').enable();},3000);

</script>
<style>
    a{
      text-decoration: none !important;
    }
    a:hover{
      text-decoration: none !important;
    }
    .cancel{
        text-decoration: none;
    }
    .cancel:hover{
        background: #49BB4B;
    }
    .cancel a:hover{
        text-decoration: none !important;
        color: #fff !important;
        font-weight: bold !important;
    }
</style>
