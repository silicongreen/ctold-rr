<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>
<%
  copy = []
  copy << "Parent/Student Copy"
  copy << "Office Copy"
  copy << "Bank Copy"
%>

<div id="page-yield" class="available_sections">
    <% copy.each do |cp| %>
    <div class="div-33" >
            
               <!--table class="vat_area">
                   <tr>
                       <td class="left">&nbsp;</td>
                       <td class="right"><b></b></td>
                   </tr>
               </table-->
               
            <div class="logo-left-div"><%= wicked_pdf_image_tag "/"+("#{Rails.root}/"+ ("public/images/school_logo/bncd/logo.png")),:width=> '95%' %></div>
            <div class="school-left-div">
              <%#=Configuration.get_config_value('InstitutionName').upcase; %>B N COLLEGE DHAKA<br /><small style="font-weight: normal;">Nabik Colony, Dhaka</small>
              <center style="font-weight: normal; font-size: 10px;">Trust Bank Limited, Kafrul Branch, Dhaka-1206</center>
              <center>Account Number: 0041-0210001201</center>
            </div>
            <div class="left-clear"></div>
            <div style="clear:both;"></div>
            <div class="payment-reference-div">
              <center>Payment Reference Code: <%= @order_id %></center>
            </div>
            <div style="clear:both;"></div>
            <div class="payment-name-div">
              <center>Payment Slip for <%= @date.name %></center>
            </div>
            <div style="clear:both; height: 5px;"></div>
            <div class="payment-reference-div" style="">
              <center>Last Date of Payment: <%= @date.due_date.strftime("%d %b' %y") %></center>
            </div>
            <% total_fees = 0 %>
            
            <table class="std_info_no_border" style=" width: 100% !important; ">
                <tr class="table-header">
                    <td class="left border-left-none" colspan="2" style="width: 100%;">Name of Student:&nbsp;&nbsp;&nbsp;<span style='font-weight: bold;'><%=  "#{@student.full_name}" %></span></td>
                </tr>
                <tr class="table-header">
                    <td class="left border-left-none" style="width: 70%; text-align: left;">Shift:&nbsp;&nbsp;&nbsp;<span style='font-weight: bold;'><%=  "#{@student.batch.name}" %></span></td> 
                    <td style="width: 27%; text-align: right;">Class:&nbsp;<span style='font-weight: bold;'><%=  "#{@student.batch.course.course_name}" %></span>&nbsp;&nbsp;</td>
                </tr>
                <tr class="table-header">
                    <td class="left border-left-none" style="width: 70%; text-align: left;">Section:&nbsp;&nbsp;&nbsp;<span style='font-weight: bold;'><%=  "#{@student.batch.course.section_name}" %></span></td> 
                    <td style="width: 27%; text-align: right;">Roll:&nbsp;<span style='font-weight: bold;'><%= @student.class_roll_no.blank? ? '-' : "#{@student.class_roll_no}" %></span>&nbsp;&nbsp;</td>
                </tr>
                <tr class="table-header">
                    <td class="left border-left-none" colspan="2" style="width: 100%;">Category:&nbsp;&nbsp;&nbsp;<span style='font-weight: bold;'><%=  "#{@student.student_category.name}" %></span></td>
                </tr>
            </table> 
            
            <% tr_count = 0 %>
            <table class="std_info" id="pdf-table" style="margin-top: 1px;">
                <tr class="table-header">
                    <td colspan="1" class="align-center" style="font-weight: bold;"><%= "Fee Details" %></td>
                    <td class="mark-td border-right-none no-warp align-right" style='font-weight: bold; padding-right: 6px !important;'> <%= "Taka" %></td>
                    <td class="name-td left border-left-none"  colspan="1" style="font-weight: bold;"><%= "Ps" %></td>
                </tr>
                <% disabled_late_fine = false %>
                <% disabled_previous_due = false %>
                <% tr_count = tr_count+1 %>
                <%k=0%>
                <% i = 0  %>
                <% c= 'even' %>
                <% vat_amount = 0 %>
                <% @fee_particulars.each do |fee| %>
                      <% if fee.finance_fee_particular_category_id == 258 %>
                        <% disabled_late_fine = true %>
                      <% end %>
                      <% if fee.finance_fee_particular_category_id == 256 %>
                        <% disabled_previous_due = true %>
                      <% end %>
                      <tr  class="table-header">
                          <%k+=1%>
                          <td class="name-td left" colspan="1"><%= fee.name %></td>
                          <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'><% if fee.amount.to_i > 0 %><%= "#{fee.amount.to_i}" %><% else %>-<% end %></td>
                          <td class="name-td left border-left-none" colspan="1"><% if fee.amount.to_i >= 0 %><% a,b = (sprintf "%.2f", (fee.amount - fee.amount.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                      </tr>
                      <% total_fees += fee.amount %>   
                <% end %>
                      <%#= "tot_row" %>
                
                
                      
                <% total_discount = 0 %>
                <% unless @onetime_discounts.nil? or @onetime_discounts.empty? or @onetime_discounts.blank? %>
                  <% @onetime_discounts.each do |d| %>
                    <% amount = 0 %>
                    <% already_paid = false %>
                    <% unless @paid_fees.blank? %>
                      <% transaction_ids = @paid_fees.map(&:id) %> 
                      <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                      <% already_paid = true %>
                      <% amount =  paidFess.map(&:amount).sum  %>
                    <% else %>  
                      <% unless @onetime_discounts_amount[d.id].nil? or @onetime_discounts_amount[d.id].blank? %>  
                        <% amount = @onetime_discounts_amount[d.id] %>
                      <% else %>
                        <% amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                      <% end %>
                    <% end %>
                    <% k += 1 %>
                    <% if amount > 0 and already_paid %>
                    <tr  class="table-header">
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="name-td left" colspan="1"><%= discount_text %></td>
                      <td class="amount">
                          <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= amount.to_i %>
                          <% total_discount += amount %>
                      </td>
                      <td class="name-td left border-left-none" colspan="1"><% if amount.to_i >= 0 %><% a,b = (sprintf "%.2f", (amount - amount.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>
                    <% elsif already_paid == false and amount.to_i > 0 %>
                    <tr  class="table-header">
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="name-td left" colspan="1"><%= discount_text %></td>
                      <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                          <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= amount.to_i %>
                          <% total_discount += amount %>
                      </td>
                      <td class="name-td left border-left-none" colspan="1"><% if amount.to_i >= 0 %><% a,b = (sprintf "%.2f", (amount - amount.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>
                    <% end %>
                  <% end %>
                <% end %> 

                <% unless @discounts.nil? or @discounts.empty? or @discounts.blank? %>  
                  <% @discounts.each do |d| %>
                    <% amount = 0 %>
                    <% already_paid = false %>
                    <% unless @paid_fees.blank? %>
                      <% transaction_ids = @paid_fees.map(&:id) %> 
                      <% paidFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Adjustment' AND transaction_type = 'Discount' AND finance_transaction_id IN (" + transaction_ids.join(",") + ") AND particular_id = #{d.id}") %>
                      <% already_paid = true %>
                      <% amount =  paidFess.map(&:amount).sum  %>
                    <% else %>  
                      <% unless @discounts[d.id].nil? or @discounts[d.id].blank? %>  
                        <% amount = @discounts_amount[d.id] %>
                      <% else %>
                        <% amount = @total_payable * d.discount.to_f/ (d.is_amount?? @total_payable : 100) %>
                      <% end %>
                    <% end %>
                    <%  k += 1%>
                    <% if amount > 0 and already_paid %>
                    <tr  class="table-header">
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="name-td left" colspan="1"><%= discount_text %></td>
                      <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                          <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= amount.to_i %>
                          <% total_discount += amount %>
                      </td>
                      <td class="name-td left border-left-none" colspan="1"><% if amount.to_i >= 0 %><% a,b = (sprintf "%.2f", (amount - amount.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>
                    <% elsif already_paid == false and amount.to_i > 0 %>
                    <tr  class="table-header">
                      <% discount_text = d.is_amount == true ? "#{d.name}" : "#{d.name}&#x200E; (#{d.discount})% &#x200E;" %>
                      <td class="name-td left" colspan="1"><%= discount_text %></td>
                      <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                          <b>(-)</b>&nbsp;&nbsp;&nbsp;<%= amount.to_i %>
                          <% total_discount += amount %>
                      </td>
                      <td class="name-td left border-left-none" colspan="1"><% if amount.to_i >= 0 %><% a,b = (sprintf "%.2f", (amount - amount.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>
                    <% end %>
                  <% end %>
                <% end %>

                <% total_fees = (@total_payable-total_discount) %>
                
                <tr class="table-header">
                    <td class="name-td left" colspan="1" style='font-weight: bold;'><%= "Previous Due #{@previous_dues_fees_name}" %></td>
                    <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                        &nbsp;&nbsp;&nbsp;<%= @previous_dues.to_i %>
                        <% total_fees += @previous_dues %>
                    </td>
                    <td class="name-td left border-left-none" colspan="1"><% if @previous_dues.to_i >= 0 %><% a,b = (sprintf "%.2f", (@previous_dues - @previous_dues.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                </tr>
                <% unless disabled_late_fine %>
                  <%  k += 1%> 
                  <%
                    fine_amount_paid = 0.0
                    unless @paid_fees.blank?
                      transaction_ids = @paid_fees.map(&:id)
                      unless transaction_ids.blank?
                        paidFineFess = FinanceTransactionParticular.find(:all, :conditions => "particular_type = 'Fine' AND finance_transaction_id IN (" + transaction_ids.join(",") + ")")
                        unless paidFineFess.blank?
                          fine_amount_paid += paidFineFess.map(&:amount).sum.to_f
                        end
                      end
                    else
                      fine_amount_paid = @fine_amount.blank? ? 0 : @fine_amount
                    end
                  %>
                  <% fine_amount_paid = fine_amount_paid.to_f %>
                  <% if fine_amount_paid > 0 %>
                    <tr  class="table-header">
                        <td class="name-td left" colspan="1" style='font-weight: bold;'><%= "Late Payment Fine" %></td>
                        <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                            &nbsp;&nbsp;&nbsp;<%= fine_amount_paid.to_i %>
                            <% total_fees += fine_amount_paid %>
                        </td>
                        <td class="name-td left border-left-none" colspan="1"><% if fine_amount_paid.to_i >= 0 %><% a,b = (sprintf "%.2f", (fine_amount_paid - fine_amount_paid.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>      
                  <% else %>
                    <tr class="table-header">
                        <td class="name-td left" colspan="1" style='font-weight: bold;'><%= "Late Payment Fine" %></td>
                        <td class="mark-td border-right-none align-right" style='padding-right: 6px !important;'>
                            &nbsp;&nbsp;&nbsp;<%= fine_amount_paid.to_i %>
                            <% total_fees += fine_amount_paid %>
                        </td>
                        <td class="name-td left border-left-none" colspan="1"><% if fine_amount_paid.to_i >= 0 %><% a,b = (sprintf "%.2f", (fine_amount_paid - fine_amount_paid.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                    </tr>      
                  <% end %>
                <% end %>
                  
                <% unless disabled_previous_due %>
                <tr class="table-header">
                    <td class="name-td left" colspan="1" style='font-weight: normal; text-align: right; padding-right: 6px !important; font-size: 14px;'><%= "Total Payable Amount" %></td>
                    <td class="mark-td border-right-none align-right" style='padding-right: 6px !important; font-size: 14px;'>
                        &nbsp;&nbsp;&nbsp;<%= total_fees.to_i %>
                    </td>
                    <td class="name-td left border-left-none" colspan="1" style="font-size: 14px;"><% if total_fees.to_i >= 0 %><% a,b = (sprintf "%.2f", (total_fees - total_fees.to_i).to_f).split('.') %><%= b %><% else %>-<% end %></td>
                </tr> 
                <% end %>
                
                <tr class="table-header">
                    <td class="name-td left" colspan="3" style='font-weight: normal; line-height: 15px;'>
                        Amount in words: <b style='font-size: 12px;'><%= in_words(total_fees.to_i).split.map(&:capitalize).join(' ') if total_fees.to_i > 0 %></b>
                    </td>
                </tr>  
                
              </table>
              
              <table class="std_info_no_border" style=" width: 100% !important; ">
                  <tr class="table-header">
                      <td style="font-size: 12px; line-height: 18x;">If payment is not made within the last date of payment, this invoice will become invalid. Payment must be made through new invoice with late fine and dues</td>
                  </tr>
              </table>
              </center>
              <% tot_row = @fee_particulars.length %>
              <% unless @onetime_discounts.blank? %>
              <% tot_row += @onetime_discounts.length %>
              <% end %>
              <% unless @discounts.blank? %>
              <% tot_row += @discounts.length %>
              <% end %>
              
              <% if tot_row == 1 %>
                <% margintop = "40%" %>
              <% elsif tot_row == 2 %>
                <% margintop = "36%" %>
              <% elsif tot_row == 3 %>
                <% margintop = "34%" %>
              <% elsif tot_row == 4 %>
                <% margintop = "30%" %>
              <% elsif tot_row == 5 %>
                <% margintop = "24%" %>
              <% elsif tot_row == 6 %>
                <% margintop = "19%" %>
              <% elsif tot_row == 7 %>
                <% margintop = "14%" %>
              <% elsif tot_row == 8 %>
                <% margintop = "9%" %>
              <% elsif tot_row == 9 %>
                <% margintop = "3%" %>
              <% else %>
                <% margintop = "0%" %>
              <% end %>
              <table class="signature" style="margin-top: <%= margintop %>;">
                  <tr>
                      <td class="top-border">Parent/Student</td>
                      <td style='width: 3%;'></td>
                      <td class="top-border"'>Cashier</td>
                      <td style='width: 3%;'></td>
                      <td class="top-border">Officer</td>
                  </tr>
              </table>
              <div style="width: 100%; text-align: center; font-weight: normal; font-size: 12px; padding-top: 10px; padding-bottom: 5px; ">
                - Please Don't Write/Stamp Inside Barcode Area -
              </div>
              <div style="width: 100%; text-align: center;"><%= wicked_pdf_image_tag "/"+("#{Rails.root}/"+ ("public/barcode-1.gif")),:width=> '50%' %></div>
              <div style="width: 100%; text-align: center; font-weight: bold; font-size: 14px; padding-top: 5px; padding-bottom: 10px; ">
                <%= cp %>
              </div>
              <div style="width: 100%; text-align: center; font-weight: normal; font-size: 10px; padding-top: 5px; ">
                Computerized Fees Receipt By: ClassTune 
              </div>
                   
              
    </div>
    
    <% end %>
    
    
</div>
<style>

#page-yield div.div-33
{
    float:left;
    width: 31%;
    padding-right: 1%;
    padding-left: 1%;
    border-right: 2px dashed black;
    min-height: 680px
    
} 
#page-yield div.div-33:last-child
{
    border-right: none;
    
} 
#page-yield div.div-33 .section .general-header
{
    width: 100%;
}
#page-yield div.div-33:last-child
{
    margin-right: 0px;
}
table.vat_area tr td
{
    font-size: 10px;
   
}
.registration_numer
{
  font-size: 10px;
}
.logo-left-div
{
  float:left;
  width: 16%;
  margin-left: 2%;
  margin-top: 5%;
}
.payment-reference-div
{
  width: 98%;
  border: 2px solid #000;
  text-align: center;
  font-size: 16px;
  font-weight: bold;
}
.payment-name-div
{
  width: 98%;
  text-align: center;
  font-size: 16px;
  font-weight: bold;
  padding-top: 5px;
}
.school-left-div
{
  float: left;
  width: 75%;
  margin-left: 2%;
  font-size: 14px;
  font-weight: bold;
  margin-top: 10px;
  margin-bottom: 10px;
  text-align: center;
}
.left-clear
{
  float:left;
  clear:both;
}
center.due
{
  clear:both;
  margin-top: 30px;
  font-size: 12px;
  font-weight: bold;
}
center
{
  clear:both;
  margin-top: 1px;
  font-size: 11px;
}
center.small
{
    font-size: 9px;
    margin-top:10px;
    margin-bottom: -15px;
}
.std_info .table-header td{
    padding: 3px !important;
    border: 1px solid black !important;
    font-weight: normal;
    background: #fff;
    font-size: 11px;
   
}
.std_info_no_border{
    border: 0px solid black !important;
   padding-top: 5px;
}
.std_info_no_border .table-header td{
    padding: 3px !important;
    border: 0px solid black !important;
    font-size: 12px;
    font-weight: normal;
   
}
table#pdf-table{
    border: none;
    border-bottom: 1px solid black;
    border-collapse:collapse;
    margin-top:20px;
}
table.std_info
{
    width:99.6%;
    margin-left: 1px;
}
table.signature
{
    width: 100%;
    margin-top:40px;
}
table.signature tr td
{
    border-top: 0px solid #ccc;
    padding: 3px 10px;
    text-align: center;
    font-size: 11px;
    
}
table.signature tr td.top-border
{
    border-top: 1px solid #000;
    width: 30%;
    text-align: center;
    font-size: 11px;
    
}
.in-words
{
  float:left;
  clear:both;
  margin-top: 10px;
  padding: 3px;
  font-size: 11px;
  letter-spacing:normal !important;
  
}
div.no-padding-no-margin
{
    padding: 0px 5px !important;
    font-size: 11px;
    margin-top: 5px !important;
    margin-bottom: -15px !important;
    font-weight: bold;
}
tr.table-header td.align-right
{
    text-align: right !important;
}
tr.table-header td.align-center
{
    text-align: center;
}
.no-warp
{
    white-space: nowrap;
}
</style>    