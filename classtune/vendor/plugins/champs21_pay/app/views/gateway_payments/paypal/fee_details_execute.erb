<%-# Champs21
#Copyright 2010 teamCreative Private Limited
#
#This product includes software developed at
#Project Champs21 - http://www.champs21.com/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<!doctype html>
<title>Payment Page</title>
<style>
  body { text-align: center; }
  h1 { font-size: 20px; }
  body { font: 20px Helvetica, sans-serif; color: #333; }
  article { display: block; text-align: center; width: 100%; margin: 20% auto; }
  a { color: #dc8100; text-decoration: none; }
  a:hover { color: #333; text-decoration: none; }
</style>
<script src="/javascripts/jquery/jquery-1.9.1.min.js?1526281034" type="text/javascript"></script>
<body>
  <article>
      <h1>You're redirect to payment page, Please wait...</h1>
  </article>
  <% email = '-' %>
  <% unless @student.immediate_contact.nil? or @student.immediate_contact.blank? %>
       <% unless @student.immediate_contact.email.blank? %>
          <% email = @student.immediate_contact.email %>
       <% end %>
  <% end %>  
    
  <% extra_string = "" %>
  <% unless params[:mobile_view].blank? %>
    <% extra_string = "&mobile_view=1" %>
  <% end %>
      
    
  <% gateway = @user_gateway.to_s %>
  <% if gateway == "Paypal" %>
    <%= paypal_pay_button(@certificate, @merchant_id,"FEE #{fee_collection_name}",total_fees,"https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1",paid_fee,"float: right;margin: 18px 0 0;") %>
  <% elsif gateway == "Authorize.net" %>
    <%= authorize_net_pay_button(@merchant_id,@certificate,total_fees,"Fee (#{@student.full_name}-#{@student.admission_no}-#{fee_collection_name})","https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1&only_path=false",paid_fee,"float: right;margin: 18px 0 0;") %>
  <% elsif gateway == "sslcommerce" %>
    <% options = {} %>
    <% options['tran_id'] = @finance_order.order_id %>
    <% options['store_id'] = @gateway_settings[gateway]['store_id'] %>
    <% options['store_passwd'] = @gateway_settings[gateway]['store_password'] %>
    <% options['amount'] = 1 %>
    <% options['product'] = "Fee (#{@student.full_name}-#{@student.admission_no}-#{@fee_collection_name})" %>
    <% options['total_amount'] = sprintf("%0.2f",@total_amount).to_f  %>
    <% options['success_url'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1&target_gateway=#{gateway}" + extra_string %>
    <% options['fail_url'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_fail_transaction=3&target_gateway=#{gateway}" + extra_string %>
    <% options['ret_url'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}" + extra_string %>
    <% options['cancel_url'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_cancel_transaction=1&target_gateway=#{gateway}" + extra_string %>
    <% options['version'] = "2.00" %>
    <%= pay_button(options, gateway) %>  
  <% elsif gateway == "trustbank" %>  
    <% options = {} %>
    <% options['MerchantID'] = @gateway_settings[gateway]['merchant_id'] %>
    <% options['Amount'] = sprintf("%0.2f",@total_amount).to_f  %>
    <% options['FullName'] = @student.admission_no %>
    <% options['Email'] = email %>
    <% options['orderID'] = @finance_order.order_id %>
    <% success_url = "https://#{request.host_with_port}#{request.fullpath}" %>
    <% #success_url %>
    <% success_url += success_url.index("?").nil? ? '?t=1' : "" %>
    <% options['PaymentSuccessUrl'] = "#{success_url}&create_transaction=1&target_gateway=#{gateway}" + extra_string %>
    <%#= options['PaymentSuccessUrl']  %>
    <% #options['PaymentSuccessUrl'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=1&target_gateway=#{gateway}" + extra_string %>
    <%
      now = I18n.l(@local_tzone_time.to_datetime, :format=>'%Y-%m-%d %H:%M:%S')
      activity_log = ActivityLog.new
      activity_log.user_id = current_user.id
      activity_log.controller = "SUM LOG - generate"
      activity_log.action = params[:id].to_s
      activity_log.post_requests =  options['PaymentSuccessUrl']
      activity_log.ip = request.remote_ip
      activity_log.user_agent = request.user_agent
      activity_log.created_at = now
      activity_log.updated_at = now
      activity_log.save
    %>
    <%= pay_button(options, gateway) %>  
  <% elsif gateway == "citybank" %>  
    <% options = {} %>
    <% options['merchantId'] = @gateway_settings[gateway]['merchant_id'] %>
    <% options['userName'] = @gateway_settings[gateway]['api_user_name'] %>
    <% options['password'] = @gateway_settings[gateway]['api_password'] %>
    <% options['amount'] = sprintf("%0.2f",@total_amount).to_f  %>
    <% options['currency'] = "050" %>
    <% options['description'] = "Student Fees, Student ID: #{@student.id}-#{@student.admission_no}, Order ID: #{@finance_order.order_id}"  %>
    <% unless params[:mobile_view].blank? %>
      <% extra_string = "-mobile_view" %>
    <% end %>
    <% extra_string = "" %>
    <% success_url = "https://#{request.host_with_port}#{request.fullpath}" %>
    
    <%#= debug params.inspect %>
    <% #if success_url.index("?").nil? %>
    <% #success_url += '?t=1' %>
    <% #else %>
    <% #success_url = success_url.gsub('?','?t=1&') %>
    <% #end %>
    <% success_url += success_url.index("?").nil? ? '?t=1' : "" %>
      
    <% options['approveUrl'] = ("#{success_url}&order_id_in_trans=#{params[:order_id]}&create_transaction=1&target_gateway=#{gateway}" + extra_string).gsub("&","--") %>
    <% options['declineUrl'] = ("#{success_url}&order_id_in_trans=#{params[:order_id]}&create_fail_transaction=4&target_gateway=#{gateway}" + extra_string).gsub("&","--") %>
    <% options['cancelUrl'] = ("#{success_url}&order_id_in_trans=#{params[:order_id]}&create_cancel_transaction=5&target_gateway=#{gateway}" + extra_string).gsub("&","--") %>
    <% options['transactionId'] = @finance_order.order_id %>
    <% options['studentId'] = @student.id %>
    <% options['fee_url'] = ("#{success_url}").gsub("&","--") %>
    <% options['gateway'] = gateway %>
    <%= pay_button(options, gateway) %>  
  <% elsif gateway == "bkash" %>  
    <% options = {} %>
    <% options['merchantId'] = @gateway_settings[gateway]['merchant_id'] %>
    <% options['userName'] = @gateway_settings[gateway]['api_user_name'] %>
    <% options['password'] = @gateway_settings[gateway]['api_password'] %>
    <% options['amount'] = sprintf("%0.2f",@total_amount).to_f  %>
    <% options['currency'] = "050" %>
    <% options['description'] = @fee_collection_name %>
    <% unless params[:mobile_view].blank? %>
      <% extra_string = "-mobile_view" %>
    <% end %>
    <% options['approveUrl'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_transaction=2" + extra_string %>
    <% options['declineUrl'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_fail_transaction=4" + extra_string %>
    <% options['cancelUrl'] = "https://#{request.host_with_port}/student/fee_details/#{params[:id]}/#{params[:id2]}?create_cancel_transaction=5" + extra_string %>
    <% options['transactionId'] = @finance_order.order_id %>
    <% options['fee_url'] = "https://#{request.host_with_port}/#{request.fullpath}" %>
    <% options['gateway'] = gateway %>
    <%= pay_button(options, gateway) %>  
  <% end %>
</body>
