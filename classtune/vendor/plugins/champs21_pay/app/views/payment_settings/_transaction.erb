<% gateway_name = '<img src="/images/gateway_images/' + ((@gateway == "citybank") ? @gateway + "-ico".downcase : @gateway.downcase) + '.png" height="64px" />'  %>
<h2>Transaction List</h2>
<hr style="border: 1px solid #ccc;" />
<%= gateway_name %>
<% form_for :payment_transaction,:url => transactions_online_payments_url, :html => {:id => "transaction_form"} do %>
    <input type="hidden" name="gateway" id="gateway" value="<%= @gateway %>" />
    <div class="filter">
      <div class="label-field-pair" style="width: 25%;">
        <div class="label-container" style="padding-top: 15px;"><%= "Start" %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'start_date', params[:start_date].present? ? params[:start_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-left: 20px;"">
          <div class="label-container" style="padding-top: 15px;"><%= "To" %>:</div>
        <div class="input-container calendar-input"><%= calendar_date_select_tag 'end_date', params[:end_date].present? ? params[:end_date] : I18n.l(Date.today,:format=>"%d %b %Y"),:readonly=>true,:popup=>"force" %></div>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-top: 0;">
          <div class="label-container" style="padding-top: 15px;">Status:</div>
          <div class="input-container" style="padding-top: 10px;">
              <% if @gateway == "trustbank" %>
              <select name="payment_status" id="payment_status">
                  <option value="">Select a Status</option>
                  <option value="1" <%= 'selected' if params[:payment_status].to_i == 1 %>>Completed</option>
                  <option value="2" <%= 'selected' if params[:payment_status].to_i == 2 %>>Failed</option>
              </select>
              <% elsif @gateway == "citybank" %>
              <select name="order_status" id="order_status">
                  <option value="">Select a Status</option>
                  <option value="APPROVED" <%= 'selected' if params[:order_status] == "APPROVED" %>>Approved</option>
                  <option value="DECLINED" <%= 'selected' if params[:order_status] == "DECLINED" %>>Declined</option>
                  <option value="CANCELED" <%= 'selected' if params[:order_status] == "CANCELED" %>>Cancel</option>
              </select>
              <% elsif @gateway == "bkash" %>
              <select name="transactionStatus" id="transactionStatus">
                  <option value="">Select a Status</option>
                  <option value="Initiated" <%= 'selected' if params[:transactionStatus] == "Initiated" %>>Initiated</option>
                  <option value="Completed" <%= 'selected' if params[:transactionStatus] == "Completed" %>>Completed</option>
                  <option value="Pending" <%= 'selected' if params[:transactionStatus] == "Pending" %>>Pending</option>
                  <option value="Authorized" <%= 'selected' if params[:transactionStatus] == "Authorized" %>>Authorized</option>
                  <option value="Expired" <%= 'selected' if params[:transactionStatus] == "Expired" %>>Expired</option>
                  <option value="Cancelled" <%= 'selected' if params[:transactionStatus] == "Cancelled" %>>Cancelled</option>
                  <option value="Declined" <%= 'selected' if params[:transactionStatus] == "Declined" %>>Declined</option>
              </select>
              <% end %>
          </div>
      </div>
      <div style="clear: both; height: 20px;"></div>
      <hr style="border: 1px solid #ccc;" />  
      <div class="label-field-pair" style="width: 25%;">
          <% if @gateway == "trustbank" %>
          <div class="label-container" style="padding-top: 15px;">Ref No.:</div>
          <div class="input-container"><input type="text" name="ref_no" id="ref_no" value="<%= params[:ref_no] %>" /></div>
          <% elsif @gateway == "citybank" %>
          <div class="label-container" style="padding-top: 15px;">Ref No.:</div>
          <div class="input-container">
              <input type="text" name="citybank_order_id" id="citybank_order_id" value="<%= params[:citybank_order_id] %>" />
              <small style="margin-left: 10%; padding-top: 2px;">(Citybank Order ID)</small>
          </div>
          <% elsif @gateway == "bkash" %>
          <div class="label-container" style="padding-top: 15px;">trxID.:</div>
          <div class="input-container"><input type="text" name="trxID" id="trxID" value="<%= params[:trxID] %>" /></div>
          <% end %>
      </div>
      <div class="label-field-pair" style="width: 25%; padding-left: 20px;">
          <div class="label-container" style="padding-top: 15px;">Order ID:</div>
          <div class="input-container"><input type="text" name="order_id" id="order_id" value="<%= params[:order_id] %>" /></div>
      </div>
      <% if @gateway == "trustbank" %>
      <div class="label-field-pair" style="width: 25%; padding-top: 0;">
          <div class="label-container" style="padding-top: 15px;">Type:</div>
          <div class="input-container" style="padding-top: 10px;">
              <select name="payment_type" id="payment_type">
                  <option value="">Select a Payment Type</option>
                  <option value="MB" <%= 'selected' if params[:payment_type] == "MB" %>>Mobile Banking</option>
                  <option value="ITCL" <%= 'selected' if params[:payment_type] == "ITCL" %>>Card Online</option>
              </select>
          </div>
      </div>
      <% elsif @gateway == "citybank" %>
      <div class="label-field-pair" style="width: 33%; padding-left: 20px;">
          <div class="label-container" style="padding-top: 15px; ">Session ID:</div>
          <div class="input-container"><input type="text" name="session_id" id="session_id" value="<%= params[:session_id] %>" /></div>
      </div>
      <% elsif @gateway == "bkash" %>
      <div class="label-field-pair" style="width: 33%; padding-left: 20px;">
          <div class="label-container" style="padding-top: 15px; ">Payment ID:</div>
          <div class="input-container"><input type="text" name="paymentID" id="paymentID" value="<%= params[:paymentID] %>" /></div>
      </div>
      <% end %>
      <div style="clear: both; height: 20px;"></div>
      <input type="hidden" name="export" id="export" value="0" />
      <div style="text-align: center;">
        <%= submit_tag 'Search',:name => "search",:class => "submit-button", :onclick => "j('#export').val(0)", :style=>"float: none;" %>
      </div>
      <div style="clear: both; height: 20px;"></div>
    </div>

  <% unless @online_payments.blank? %>
    <div class="box" style="padding-top: 20px;">
      <h2 style="font-size: 14px;">Total Records: <%= @online_payments.total_entries %></h2>  
      <table class="table table-sm table-striped table-bordered" id="example" cellspacing="0" cellpadding="0" border="0" style="width: 98%;">
        <thead><!-- class="thead-inverse" -->
        <tr>
            <th style="width: 3%;"><%= "#" %></th>
            <th style="width: 30%;"><%= t("user_id_name") %></th>
            <% if @gateway == "trustbank" %>
            <th style="width: 10%;"><%= t("payment_type") %></th>
            <th style="width: 10%;"><%= t("ref_id") %></th>
            <% elsif @gateway == "citybank" %>
            <th style="width: 20%;"><%= t("payment_info") %></th>
            <th style="width: 10%;"><%= t("ref_id") %></th>
            <% elsif @gateway == "bkash" %>
            <th style="width: 10%;"><%= "Payment Id" %></th>
            <th style="width: 10%;"><%= "trxID" %></th>
            <% end %>
            <th style="width: 10%;"><%= t("order_id") %></th>
            <% if @gateway == "trustbank" %>
            <th style="width: 10%;"><%= "Fees" %></th>
            <% elsif @gateway == "bkash" %>
            <th style="width: 10%;"><%= "Fees" %></th>
            <th style="width: 10%;"><%= t("service_charge") %></th>
            <th style="width: 10%;"><%= "Total Amount" %></th>
            <% end %>
            <% if @gateway == "citybank" %>
            <th style="width: 10%;"><%= "Fees" %></th>
            <th style="width: 10%;"><%= t("service_charge") %></th>
            <th style="width: 10%;"><%= "Total Amount" %></th>
            <% end %>
            <% if @gateway == "trustbank" %>
              <th style="width: 10%;"><%= t("service_charge") %></th>
            <% end %>
            <th style="width: 10%;"><%= t("gateway_status") %></th>
            
            <% if @gateway == "trustbank" %>
              <!--th style="width: 10%;"><%#= t("online_transaction_id") %></th-->
            <% end %>
            <th style="width: 10%;"><%= t("transaction_date") %></th>
            <% if @gateway == "trustbank" %>
            <th style="width: 10%;"><%= "Verified" %></th>
            <% end %>
        </tr>
        </thead>
        <tbody>
        
        <% @online_payments.each_with_index do |payment,index| %>
          <tr>
            <td style="vertical-align: middle;"><%= ((@online_payments.current_page - 1) * @online_payments.per_page) + index + 1 %></td>
            <% payee_user = payment.payee.try(:user).try(:username) unless payment.payee.class.name == "Applicant" %>
            
            <td style="vertical-align: middle; text-align: left; padding-left: 20px !important;"><%= "#{payment.payee_admission_no}" %><br /><%= "#{payment.payee_name}" %><hr style="border: 1px solid #ccc;"><%= "Roll No: #{payment.payee_roll_no}" %><br /><%= "#{payment.payee_batch_full_name}" %></td>
            <% if @gateway == "trustbank" %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:payment_type] unless payment.gateway_response[:payment_type].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:ref_id] unless payment.gateway_response[:ref_id].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:order_id] unless payment.gateway_response[:order_id].blank?}" %></td>
            <% elsif @gateway == "citybank" %>
            <% unless payment.gateway_response[:Message].blank? %>
            <td style="vertical-align: middle; text-align: left;"><%= "Card Holder Name: <br />#{payment.gateway_response[:Message][:CardHolderName] unless payment.gateway_response[:Message][:CardHolderName].blank?}<hr style='border:1px solid #ccc;' />Card No.: <br />#{payment.gateway_response[:Message][:PAN] unless payment.gateway_response[:Message][:PAN].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:Message][:OrderID] unless payment.gateway_response[:Message][:OrderID].blank?}" %></td>
            <% else %>
            <td style="vertical-align: middle; text-align: left;">&nbsp;</td>
            <td style="vertical-align: middle; text-align: center;">&nbsp;</td>
            <% end %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.order_id}" %></td>
            <% elsif @gateway == "citybank" %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:payment_type] unless payment.gateway_response[:payment_type].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:ref_id] unless payment.gateway_response[:ref_id].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:order_id] unless payment.gateway_response[:order_id].blank?}" %></td>
            <% elsif @gateway == "bkash" %>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:paymentID] unless payment.gateway_response[:paymentID].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:trxID] unless payment.gateway_response[:trxID].blank?}" %></td>
            <td style="vertical-align: middle; text-align: center;"><%= "#{payment.gateway_response[:merchantInvoiceNumber] unless payment.gateway_response[:merchantInvoiceNumber].blank?}" %></td>
            <% end %>
            
            <% 
              if @gateway == "trustbank"
                amount = payment.gateway_response[:amount]
                amount ||= payment.gateway_response[:x_amount]
              elsif @gateway == "citybank"
                fee_percent = 0.00
                unless payment.gateway_response[:Message].blank? 
                  amount_return = payment.gateway_response[:Message][:TotalAmount].to_f / 100
                else
                end
                amount = amount_return
                paid_amount = 0
                total_payments = Payment.find(:all, :conditions => "order_id = '#{payment.order_id}' and gateway_response like \'%OrderDescription:%\'")
                unless total_payments.blank?
                  total_payments.each do |p|
                    unless p.finance_transaction.nil?
                      paid_amount += p.finance_transaction.amount.to_f
                    else
                      fee_id = p.payment_id
                      fee = FinanceFee.find(:first, :conditions => "id = #{fee_id}") 
                      unless fee.nil? 
                        date = FinanceFeeCollection.find(:first, :conditions => "id = #{fee.fee_collection_id}")
                        unless date.blank?
			  @std = Student.find(:first, :conditions => "id = #{payment.payee_id}")
                          if @std.nil?
			  	@std = ArchivedStudent.find(:first, :conditions => "former_id = #{payment.payee_id}")
                            #@std = ArchivedStudent.find_by_former_id(payment.payee_id)
                          end
                          paid_amount += FinanceFee.get_student_balance(date, @std, fee)
                          #paid_amount += FinanceFee.get_student_balance(date, payment.payee, fee)
                        end
                        #paid_amount += FinanceFee.get_student_balance(date, payment.payee, fee)
                      end
                    end
                  end
                end
                if payment.gateway_response[:Message].blank? 
                  amount_return = paid_amount
                  amount = amount_return
                end
                fee_percent = paid_amount.to_f * (1.5 / 100)
                
                no_charge_apply_citybank = [312] 
                no_charge_apply_citybank = PaymentNewConfiguration.config_value("no_charge_apply_citybank") 

                no_charge_apply_citybank = no_charge_apply_citybank.split(",").map(&:to_i) unless no_charge_apply_citybank.blank?
                no_charge_apply_citybank ||= Array.new
              
                unless no_charge_apply_citybank.include?(MultiSchool.current_school.id)
                  unless paid_amount == amount_return
                    amount = amount.to_f - fee_percent.to_f
                  end
                end
                total_amount = amount + fee_percent
                amount ||= payment.gateway_response[:Message][:PurchaseAmount]
              elsif @gateway == "bkash"
                fee_percent = 0.00
                amount_return = payment.gateway_response[:amount].to_f 
                amount = amount_return
                paid_amount = 0
                total_payments = Payment.find(:all, :conditions => "order_id = '#{payment.order_id}' and gateway_response like \'%:transactionStatus:%\'")
                unless total_payments.blank?
                  total_payments.each do |p|
                    unless p.finance_transaction.nil?
                      paid_amount += p.finance_transaction.amount.to_f
                    else
                      fee_id = p.payment_id
                      fee = FinanceFee.find(:first, :conditions => "id = #{fee_id}") 
                      unless fee.nil? 
                        date = FinanceFeeCollection.find(:first, :conditions => "id = #{fee.fee_collection_id}")
			
                        unless date.blank?
			  @std = Student.find(:first, :conditions => "id = #{payment.payee_id}")
                          if @std.nil?
			  	@std = ArchivedStudent.find(:first, :conditions => "former_id = #{payment.payee_id}")
                            #@std = ArchivedStudent.find_by_former_id(payment.payee_id)
                          end
                          paid_amount += FinanceFee.get_student_balance(date, @std, fee)
                        end
                        #paid_amount += FinanceFee.get_student_balance(date, payment.payee, fee)
                      end
                    end
                  end
                else
                  
                end
                #fee_percent = paid_amount.to_f * (1.5 / 100)
                
                no_charge_apply_bkash = [312] 
                no_charge_apply_bkash = PaymentNewConfiguration.config_value("no_charge_apply_bkash") 

                no_charge_apply_bkash = no_charge_apply_bkash.split(",").map(&:to_i) unless no_charge_apply_bkash.blank?
                no_charge_apply_bkash ||= Array.new
              
                unless no_charge_apply_bkash.include?(MultiSchool.current_school.id)
                  unless paid_amount == amount_return
                    amount = paid_amount.to_f
                    #amount = '%.2f' % (paid_amount.to_f  / (1 - (1.5/100)))
                  end
                end
                total_amount = amount_return.to_f #+ fee_percent
                fee_percent = amount_return.to_f - amount.to_f
                amount ||= payment.gateway_response[:x_amount]
              end
            %>
            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= to_comma_seperated_precision_label(amount.to_f) %></td>
            <% if @gateway == "trustbank" or @gateway == "citybank" or @gateway == "bkash" %>
            <% 
              if @gateway == "trustbank"
                service_charge = payment.gateway_response[:service_charge]
              else
                service_charge = fee_percent
              end
            %>
            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= precision_label(service_charge) %></td>
            <% end %>
            <% if @gateway == "citybank" or @gateway == "bkash" %>
            <td style="vertical-align: middle; text-align: right; padding-right: 4px;"><%= precision_label(total_amount) %></td>
            <% end %>
            <% if @gateway == "trustbank" %>
            <td style="vertical-align: middle; text-align: center;">
              <% 
                b_pos = 0
                gateway_status = "Failed"
                if @gateway == "Paypal"
                  gateway_status = "Completed" if payment.gateway_response[:status] == "Completed"
                  b_pos = 1 if payment.gateway_response[:status] == "Completed"
                elsif @gateway == "trustbank"  
                  gateway_status = "Completed" if payment.gateway_response[:status].to_i == 1
                  b_pos = 1 if payment.gateway_response[:status].to_i == 1
                elsif @gateway == "SSL Commerz"  
                  gateway_status = "Completed" if payment.gateway_response[:status] == "VALID"
                  b_pos = 1 if payment.gateway_response[:status] == "VALID"
                elsif @gateway == "Authorize.net"
                  gateway_status = "Completed" if payment.gateway_response[:x_response_reason_code] == "1"
                  b_pos = 1 if payment.gateway_response[:x_response_reason_code] == "1"
                end 
              %>
              <% if b_pos == 1 %>  
                <i class="fa fa-check" style="color: #49BB4B; font-size: 14px;"></i><br />
              <% else %>  
                <i class="fa fa-close" style="color: #AB0D14; font-size: 14px;"></i><br />
              <% end %>  
              <%= gateway_status %>
            </td>
            <% elsif @gateway == "citybank" %>
              <td style="vertical-align: middle; text-align: center;">
                <% unless payment.gateway_response[:Message].blank?  %>  
                  <% if payment.gateway_response[:Message][:OrderStatus] == "APPROVED" %>  
                    <i class="fa fa-check" style="color: #49BB4B; font-size: 14px;"></i><br />
                  <% else %>  
                    <i class="fa fa-close" style="color: #AB0D14; font-size: 14px;"></i><br />
                  <% end %>  
                  <%= payment.gateway_response[:Message][:OrderStatus] %>
                <% end %>  
              </td>
            <% elsif @gateway == "bkash" %>
              <td style="vertical-align: middle; text-align: center;">
                <% if payment.gateway_response[:transactionStatus] == "Completed" %>  
                  <i class="fa fa-check" style="color: #49BB4B; font-size: 14px;"></i><br />
                <% else %>  
                  <i class="fa fa-close" style="color: #AB0D14; font-size: 14px;"></i><br />
                <% end %>  
                <%= payment.gateway_response[:transactionStatus] %>
              </td>
            <% end %>
            <td style="vertical-align: middle; text-align: center;">
              <%= I18n.l((payment.transaction_datetime.to_time).to_datetime,:format=>"%d %b %Y %I:%M %P") %>
            </td>
            <% if @gateway == "trustbank" %>
              <% if payment.gateway_response[:verified].to_i == 0 %>
              <% unless payment.validation_response.nil? %>
                <% if payment.validation_response[:verified].to_i == 0 %>
                  <td style="text-align: center; vertical-align: middle;"><i id="payment<%= payment.id %>" class="fa fa-square-o payment_verify" style="color: #49BB4B; font-size: 24px; cursor: pointer;"></i><br /></td>
                <% else %>
                  <td style="text-align: center; vertical-align: middle;"><i class="fa fa-check-square-o" style="color: #49BB4B; font-size: 24px;"></i><br /></td>
                <% end %>
              <% else %>
              <td style="text-align: center; vertical-align: middle;"><i id="payment<%= payment.id %>" class="fa fa-square-o payment_verify" style="color: #49BB4B; font-size: 24px; cursor: pointer;"></i><br /></td>
              <% end %>
              <% else %>
              <td style="text-align: center; vertical-align: middle;"><i class="fa fa-check-square-o" style="color: #49BB4B; font-size: 24px;"></i><br /></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
        </tbody> 
      </table>
      <% unless params[:page].blank?  %>
        <% pg = ( (params[:page].to_i - 1) * 30) + 1 %>
      <% else %>
        <% pg = 1 %>
      <% end %>
      <% showing = (pg + 30) - 1 %>
      <% if showing.to_i > @online_payments.total_entries.to_i %>
      <% showing = @online_payments.total_entries %>
      <% end %>
      <span style="font-family: verdana; font-size: 12px;">Showing <%= pg %> to <%= showing %> of <%= @online_payments.total_entries %> Records</span> 
      <% no_paginate_params = ['authenticity_token','export','controller','action','search'] %>
      <% paginate_params = params.select{|k,v| {k.to_sym => v} unless no_paginate_params.include?(k.to_s) or v.blank? } %>
      
      
      <%#= will_paginate @student_finance_fees, :previous_label=>"<", :next_label=>">", :renderer => 'RemoteLinkRenderer' ,:remote => { :loading =>  "$('loader_paginate').show();",:complete =>"$('loader_paginate').hide();"  }, :params => {:controller=>:finance,:action => "load_bill_generation_reports", :opt => @opt, :filter_by_course => @filter_by_course, :date => @date.id} %>
      <% if @payment_gateway.length > 1 %>
      <%= will_paginate @online_payments,:params=> paginate_params, :renderer => 'RemoteLinkRenderer' ,:remote => { :loading =>  "$('loader_paginate').show();",:complete =>"$('loader_paginate').hide();"  } %>
      <% else %>
      <%= will_paginate @online_payments,:params=> paginate_params %>
      <% end %>
      <% if @payment_gateway.length > 1 %>
      <div class="div2"><%= image_tag("loader.gif",
        :align => "absmiddle",
        :border => 0,
        :id => "loader_paginate",
        :style =>"display: none;" ) %></div>
      <% end %>
    </div>
  <% else %>
    <div id="flash-box">
      <p class="flash-msg"  style="float: left;margin-top: 50px;width: 100%;">No Payments present</p>
    </div>
  <% end %>
  <% unless @online_payments.blank? %>  
    <div style="width: 100%; text-align: center; padding-top: 20px;">
      <%= submit_tag 'Export Transaction',:name => "export_transaction",:class => "submit-button", :onclick => "j('#export').val(1);", :style => "float: none;" %>
    </div>  
  <% end %>
  <% end %>
