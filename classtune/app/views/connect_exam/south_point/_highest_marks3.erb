<%
if @subject_highest_mark_first_term.blank? and @subject_highest_mark_final_term.blank? and @subject_highest_quarter.blank?
  @subject_highest_mark_first_term = {}
  @subject_highest_mark_final_term = {}
  @subject_highest_quarter = {}
  @subject_highest_mock_test = {}
  unless @tabulation_data.blank?
    @tabulation_data['report']['students'].each do |std| 
      @tabulation_data['report']['subjects'].each do |sub|
        obtained_mark = 0
        full_mark = 0
        highest_mark = 0

        mock_test_total = 0
        mock_test_full_mark = 0
        st_full_mark1 = 0
        ct_full_mark1 = 0

        st_marks1 = []
        ct_marks1 = []
        avg_mark_st1 = 0;
        avg_mark_ct1 = 0;
        full_mark1 = 0

        st_full_mark2 = 0
        ct_full_mark2 = 0

        st_marks2 = []
        ct_marks2 = []
        avg_mark_st2 = 0;
        avg_mark_ct2 = 0;
        full_mark2 = 0

        st_full_mark3 = 0
        ct_full_mark3 = 0

        st_marks3 = []
        ct_marks3 = []
        avg_mark_st3 = 0;
        avg_mark_ct3 = 0;
        full_mark3 = 0

        st_full_mark4 = 0
        ct_full_mark4 = 0

        st_marks4 = []
        ct_marks4 = []
        avg_mark_st4 = 0;
        avg_mark_ct4 = 0;
        full_mark4 = 0

        first_term_mark = 0
        first_term_full_mark = 0
        first_term_avg_mark = 0

        final_term_mark = 0
        final_term_full_mark = 0
        final_term_avg_mark = 0
        unless @tabulation_data['report']['exams'].blank?  
          @tabulation_data['report']['exams'].each do |report|
            if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank? and !report['result'][report['exam_id']][sub['id']][std['id']].blank?

              #Calculation First Quarter Mark
              if report['quarter'] == '1'
                if st_full_mark1 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark1 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark1 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark1 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks1 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks1 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks1 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks1 << 0
                  end      
                end
                end 

              #Calculation 2nd Quarter Mark
              if report['quarter'] == '2'
                if st_full_mark2 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark2 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark2 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark2 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks2 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks2 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks2 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks2 << 0
                  end      
                end
                end


              #Calculation 3rd Quarter Mark
              if report['quarter'] == '3'
                if st_full_mark3 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark3 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark3 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark3 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks3 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks3 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks3 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks3 << 0
                  end      
                end
                end 


              #Calculation 4th Quarter Mark
              if report['quarter'] == '4'
                if st_full_mark4 == 0 and report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    st_full_mark4 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end                     
                if ct_full_mark4 == 0 and report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    ct_full_mark4 = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                  end

                if report['exam_category'] == '4'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    st_marks4 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    st_marks4 << 0
                  end      
                  end

                if report['exam_category'] == '1'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    ct_marks4 << report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                    else
                    ct_marks4 << 0
                  end      
                end
                end 

              #Calculation First Term (40/20) Mark
              if report['quarter'] == '5'
                if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                  first_term_full_mark = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                  end
                if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                  first_term_mark = report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                  end

                if(first_term_full_mark == 100)
                  first_term_full_mark = 40
                  else
                  first_term_full_mark = 20
                  end

                unless first_term_mark.to_i == 0
                  if first_term_full_mark == 40
                    first_term_mark = (first_term_mark/100)*40
                    else
                    first_term_mark = (first_term_mark/50)*20
                  end
                end

                end

              #Calculation Final Term Mark
              if report['quarter'] == '6'
                if report['exam_category'] != '6'
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                    final_term_full_mark = report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                    end
                  if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                    final_term_mark = report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                  end

                  if(final_term_full_mark == 100)
                    final_term_full_mark = 40
                    else
                    final_term_full_mark = 20
                    end

                  unless final_term_mark.to_i == 0
                    if first_term_full_mark == 40
                      final_term_mark = (final_term_mark/100)*40
                      else
                      final_term_mark = (final_term_mark/50)*20
                    end
                  end
                end  
              end
              
              if report['exam_category'] == '6'
                 if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].blank?
                   mock_test_full_mark = mock_test_full_mark+report['result'][report['exam_id']][sub['id']][std['id']]['full_mark'].to_i
                 end
                 if !report['result'].blank? and !report['result'][report['exam_id']].blank? and !report['result'][report['exam_id']][sub['id']].blank?  and !report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].blank?
                   mock_test_total = mock_test_total+report['result'][report['exam_id']][sub['id']][std['id']]['marks_obtained'].to_f
                 end
              end  

            end

          end
          end 
        #Calculation First Quarter Mark
        st_marks1.sort! {|x,y| y <=> x }
        ct_marks1.sort! {|x,y| y <=> x }
        
        main_full_mark1 = 0
        main_full_mark2 = 0
        main_full_mark3 = 0
        main_full_mark4 = 0
        
        if @exam_type_course == 1
          avg_mark_ct1 = ct_marks1[0].to_f
          if st_full_mark1.to_i == 10 
            avg_mark_st1 = (st_marks1[0].to_f+st_marks1[1].to_f)/2
          else
            avg_mark_st1 = st_marks1[0].to_f
          end
          full_mark1 = ct_full_mark1.to_i+st_full_mark1.to_i
          obtained_mark1 = avg_mark_ct1.to_f+avg_mark_st1.to_f
        end   
        if @exam_type_course == 2
          if ct_full_mark1.to_i == 30 
              avg_mark_ct1 = ct_marks1[0].to_f+ct_marks1[1].to_f
              main_full_mark1 = main_full_mark1+ct_full_mark1.to_i+ct_full_mark1.to_i
          else 
              avg_mark_ct1 = ct_marks1[0].to_f
              main_full_mark1 = main_full_mark1+ct_full_mark1.to_i
          end 

          if st_full_mark1.to_i == 20 
              avg_mark_st1 = st_marks1[0].to_f+st_marks1[1].to_f
              main_full_mark1 = main_full_mark1+st_full_mark1.to_i+st_full_mark1.to_i
          else 
              avg_mark_st1 = st_marks1[0].to_f
              main_full_mark1 = main_full_mark1+st_full_mark1.to_i
          end

          total_mark1 = avg_mark_ct1+avg_mark_st1
          full_mark1 = ct_full_mark1.to_i+st_full_mark1.to_i

          if main_full_mark1 == 100
            full_mark1 = 50
            obtained_mark1 = (total_mark1.to_f/2.00)
          else
            obtained_mark1 = (total_mark1.to_f/main_full_mark1.to_f)*25
            full_mark1 = 25
          end  
        end 

        if @exam_type_course == 3
          avg_mark_ct1 = (ct_marks1[0].to_f+ct_marks1[1].to_f)/2
          obtained_mark1 = avg_mark_ct1
          full_mark1 = ct_full_mark1
        end 

        main_mark1 = (obtained_mark1.to_f/full_mark1.to_f)*100

        #Calculation 2nd Quarter Mark
        st_marks2.sort! {|x,y| y <=> x }
        ct_marks2.sort! {|x,y| y <=> x }
        
        if @exam_type_course == 1
          avg_mark_ct2 = ct_marks2[0].to_f
          if st_full_mark2.to_i == 10 
            avg_mark_st2 = (st_marks2[0].to_f+st_marks2[1].to_f)/2
          else
            avg_mark_st2 = st_marks2[0].to_f
          end
          full_mark2 = ct_full_mark2.to_i+st_full_mark2.to_i
          obtained_mark2 = avg_mark_ct2.to_f+avg_mark_st2.to_f
        end   
        if @exam_type_course == 2
          if ct_full_mark2.to_i == 30 
              avg_mark_ct2 = ct_marks2[0].to_f+ct_marks2[1].to_f
              main_full_mark2 = main_full_mark2+ct_full_mark2.to_i+ct_full_mark2.to_i
          else 
              avg_mark_ct2 = ct_marks2[0].to_f
              main_full_mark2 = main_full_mark2+ct_full_mark2.to_i
          end 

          if st_full_mark2.to_i == 20 
              avg_mark_st2 = st_marks2[0].to_f+st_marks2[1].to_f
              main_full_mark2 = main_full_mark2+st_full_mark2.to_i+st_full_mark2.to_i
          else 
              avg_mark_st2 = st_marks2[0].to_f
              main_full_mark2 = main_full_mark2+st_full_mark2.to_i
          end

          total_mark2 = avg_mark_ct2+avg_mark_st2
          full_mark2 = ct_full_mark2.to_i+st_full_mark2.to_i

          if main_full_mark2 == 100
            full_mark2 = 50
            obtained_mark2 = (total_mark2.to_f/2.00)
          else
            obtained_mark2 = (total_mark2.to_f/main_full_mark2.to_f)*25
            full_mark2 = 25
          end  
        end 

        if @exam_type_course == 3
          avg_mark_ct2 = (ct_marks2[0].to_f+ct_marks2[1].to_f)/2
          obtained_mark2 = avg_mark_ct2
          full_mark2 = ct_full_mark2
        end 

        main_mark2 = (obtained_mark2.to_f/full_mark2.to_f)*100
       

        #Calculation 3rd Quarter Mark
        st_marks3.sort! {|x,y| y <=> x }
        ct_marks3.sort! {|x,y| y <=> x }
        
        if @exam_type_course == 1
          avg_mark_ct3 = ct_marks3[0].to_f
          if st_full_mark3.to_i == 10 
            avg_mark_st3 = (st_marks3[0].to_f+st_marks3[1].to_f)/2
          else
            avg_mark_st3 = st_marks3[0].to_f
          end
          full_mark3 = ct_full_mark3.to_i+st_full_mark3.to_i
          obtained_mark3 = avg_mark_ct3.to_f+avg_mark_st3.to_f
        end   
        if @exam_type_course == 2
          if ct_full_mark3.to_i == 30 
              avg_mark_ct3 = ct_marks3[0].to_f+ct_marks3[1].to_f
              main_full_mark3 = main_full_mark3+ct_full_mark3.to_i+ct_full_mark3.to_i
          else 
              avg_mark_ct3 = ct_marks3[0].to_f
              main_full_mark3 = main_full_mark3+ct_full_mark3.to_i
          end 

          if st_full_mark3.to_i == 20 
              avg_mark_st3 = st_marks3[0].to_f+st_marks3[1].to_f
              main_full_mark3 = main_full_mark3+st_full_mark3.to_i+st_full_mark3.to_i
          else 
              avg_mark_st3 = st_marks3[0].to_f
              main_full_mark3 = main_full_mark3+st_full_mark3.to_i
          end

          total_mark3 = avg_mark_ct3+avg_mark_st3
          full_mark3 = ct_full_mark3.to_i+st_full_mark3.to_i

          if main_full_mark3 == 100
            full_mark3 = 50
            obtained_mark3 = (total_mark3.to_f/2.00)
          else
            obtained_mark3 = (total_mark3.to_f/main_full_mark3.to_f)*25
            full_mark3 = 25
          end  
        end 

        if @exam_type_course == 3
          avg_mark_ct3 = (ct_marks3[0].to_f+ct_marks3[1].to_f)/2
          obtained_mark3 = avg_mark_ct3
          full_mark3 = ct_full_mark3
        end 

        main_mark3 = (obtained_mark3.to_f/full_mark3.to_f)*100
        

        #Calculation 4th Quarter Mark
        st_marks4.sort! {|x,y| y <=> x }
        ct_marks4.sort! {|x,y| y <=> x }
        
        
        if @exam_type_course == 1
          avg_mark_ct4 = ct_marks4[0].to_f
          if st_full_mark4.to_i == 10 
            avg_mark_st4 = (st_marks4[0].to_f+st_marks4[1].to_f)/2
          else
            avg_mark_st4 = st_marks4[0].to_f
          end
          full_mark4 = ct_full_mark4.to_i+st_full_mark4.to_i
          obtained_mark4 = avg_mark_ct4.to_f+avg_mark_st4.to_f
        end   
        if @exam_type_course == 2
          if ct_full_mark4.to_i == 30 
              avg_mark_ct4 = ct_marks4[0].to_f+ct_marks4[1].to_f
              main_full_mark4 = main_full_mark4+ct_full_mark4.to_i+ct_full_mark4.to_i
          else 
              avg_mark_ct4 = ct_marks4[0].to_f
              main_full_mark4 = main_full_mark4+ct_full_mark4.to_i
          end 

          if st_full_mark4.to_i == 20 
              avg_mark_st4 = st_marks4[0].to_f+st_marks4[1].to_f
              main_full_mark4 = main_full_mark4+st_full_mark4.to_i+st_full_mark4.to_i
          else 
              avg_mark_st4 = st_marks4[0].to_f
              main_full_mark4 = main_full_mark4+st_full_mark4.to_i
          end

          total_mark4 = avg_mark_ct4+avg_mark_st4
          full_mark4 = ct_full_mark4.to_i+st_full_mark4.to_i

          if main_full_mark4 == 100
            full_mark4 = 50
            obtained_mark4 = (total_mark4.to_f/2.00)
          else
            obtained_mark4 = (total_mark4.to_f/main_full_mark4.to_f)*25
            full_mark4 = 25
          end  
        end 

        if @exam_type_course == 3
          avg_mark_ct4 = (ct_marks4[0].to_f+ct_marks4[1].to_f)/2
          obtained_mark4 = avg_mark_ct4
          full_mark4 = ct_full_mark4
        end 

        main_mark4 = (obtained_mark4.to_f/full_mark4.to_f)*100

      


        quarter_mark = 0
        if obtained_mark1>0
          quarter_mark = obtained_mark1.round()
        elsif obtained_mark2>0
          quarter_mark = obtained_mark2.round()
        elsif obtained_mark3>0 
          quarter_mark = obtained_mark3.round()
        elsif obtained_mark4>0
          quarter_mark = obtained_mark4.round()
        end
      
        if obtained_mark1>0 && obtained_mark2 > 0
          quarter_mark = obtained_mark2.round()+obtained_mark1.round()
        end  
        
       

        if @subject_highest_quarter[sub['id'].to_i].blank?
          @subject_highest_quarter[sub['id'].to_i] = quarter_mark
        elsif quarter_mark.to_i > @subject_highest_quarter[sub['id'].to_i].to_i
          @subject_highest_quarter[sub['id'].to_i] = quarter_mark.to_i
        end

       
      end
    end
  end
  end

%> 